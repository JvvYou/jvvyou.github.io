{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u6700\u8fd1\u66f4\u65b0","text":"<ul> <li> <p>istio-virtualservice-\u914d\u7f6e\u793a\u4f8b</p> </li> <li> <p>\u4ece\u5e72\u4e866\u5e74\u7684\u516c\u53f8\u6bd5\u4e1a</p> </li> <li> <p>\u4ece\u6545\u969c\u81ea\u6108\u7cfb\u7edf\u53d8\u6210\u8fd0\u7ef4\u7cfb\u7edf</p> </li> <li> <p>mysql\u6570\u636e\u5e93\u6743\u9650\u6821\u9a8c</p> </li> <li> <p>k8s1.30.2\u5806\u53e0\u96c6\u7fa4\u90e8\u7f72</p> </li> <li> <p>sql\u56de\u653e</p> </li> <li> <p>\u5f53\u6211\u9047\u5230\u4e86\u722c\u866b</p> </li> <li> <p>\u5bb9\u5668\u7f51\u7edc\u7406\u89e3</p> </li> <li> <p>simpleui layer\u81ea\u52a8\u52a0\u8f7d</p> </li> <li> <p>\u66f4\u591a&gt;&gt;&gt;</p> </li> </ul>"},{"location":"blog/2024/07/29/frodo%20sql%E5%9B%9E%E6%94%BE/","title":"frodo sql\u56de\u653e","text":"<p>mysql \u8fc1\u79fb\uff0c\u6307\u5b9a\u67d0\u4e00\u65f6\u95f4\u7684\u5ba1\u8ba1\u65e5\u5fd7\u8fdb\u884c\u56de\u653e\u3002</p>","tags":["mysql","frodo"]},{"location":"blog/2024/07/29/frodo%20sql%E5%9B%9E%E6%94%BE/#_1","title":"\u524d\u8a00","text":"<p>\u8fd9\u4e2a\u8f6f\u4ef6\u6211\u4eec\u5728\u4ece\u817e\u8baf\u8fc1\u79fb\u6570\u636e\u5e93\u5230\u963f\u91cc\u7684\u65f6\u5019\uff0c\u963f\u91cc\u7684\u540c\u5b66\u7ed9\u6211\u4eec\u7528\u8fc7\uff0c\u6240\u4ee5\u89c9\u5f97\u5f88\u597d\u7528\uff0c\u7136\u540e\u6211\u5c31\u53bbgithub\u67e5\u627e\u4e86\u4e00\u4e0b\uff0c\u963f\u91cc\u5c45\u7136\u5f00\u6e90\u4e86\u3002\u4e3b\u8981\u7528\u7684\u662ffrodo\uff0c \u5f00\u6e90\u7248\u672c\u7684\u8ddf\u4ed6\u4eec\u63d0\u4f9b\u7ed9\u5ba2\u6237\u7684\u53c2\u6570\u4e0a\u548c\u7248\u672c\u4e0a\u4e5f\u662f\u6709\u533a\u522b\u7684\uff0c\u4f46\u662f\u5f00\u6e90\u4e5f\u591f\u7528\u4e86\u3002</p> <p>\u6211\u7684\u6e90\u6570\u636e\u662f\u4ece\u817e\u8baf\u4e91\u7684\u5ba1\u8ba1\u65e5\u5fd7\u91cc\u9762\u63d0\u53d6\u7684\uff0c\u5e76\u4e14\u8f6c\u6362\u6210frodo\u80fd\u8bc6\u522b\u7684\u65e5\u5fd7\u3002</p>","tags":["mysql","frodo"]},{"location":"blog/2024/07/29/frodo%20sql%E5%9B%9E%E6%94%BE/#1maven","title":"1\u3001\u914d\u7f6e\u963f\u91cc\u7684maven\u4ed3\u5e93","text":"<p>\u589e\u52a0\u4e00\u4e2a\u914d\u7f6e\u5c31\u884c,\u539f\u6587 <pre><code>&lt;mirror&gt;\n  &lt;id&gt;aliyunmaven&lt;/id&gt;\n  &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;\n  &lt;name&gt;\u963f\u91cc\u4e91\u516c\u5171\u4ed3\u5e93&lt;/name&gt;\n  &lt;url&gt;https://maven.aliyun.com/repository/public&lt;/url&gt;\n&lt;/mirror&gt;\n</code></pre></p>","tags":["mysql","frodo"]},{"location":"blog/2024/07/29/frodo%20sql%E5%9B%9E%E6%94%BE/#2frodo","title":"2\u3001\u7f16\u8bd1\u5b89\u88c5frodo","text":"<p>\u53c2\u8003github\u4e2d\u7684readme</p>","tags":["mysql","frodo"]},{"location":"blog/2024/07/29/frodo%20sql%E5%9B%9E%E6%94%BE/#3","title":"3\u3001\u89e3\u6790\u817e\u8baf\u4e91\u5ba1\u8ba1\u65e5\u5fd7","text":"<p><pre><code>from datetime import datetime\nimport pandas as pd\nimport json\n\ninput_filename = '123.csv'\noutput_filename = 'sql.txt'\ncolumns_to_read = ['Sql', 'User', 'ExecTime', 'ThreadId', 'Timestamp', 'DBName']\ndate_format = \"%Y-%m-%d %H:%M:%S\"\n\ndf = pd.read_csv(input_filename, usecols=columns_to_read)\n\nfor index, row in df.iterrows():\n   dt_object = datetime.strptime(row['Timestamp'], date_format)\n   timestamp_in_seconds = dt_object.timestamp()\n   timestamp_in_microseconds = int(timestamp_in_seconds * 1_000_000)\n\n   _dict={\n     \"schema\":row['DBName'],\n     \"session\":row['ThreadId'],\n     \"execTime\":row['ExecTime'],\n     \"startTime\":timestamp_in_microseconds,\n     \"convertSqlText\":row['Sql'],\n     \"user\":row['User']\n   }\n   print(json.dumps(_dict))\n\n   #with open(output_filename, 'w+') as json_file:\n   # json.dump(json.dumps(_dict), json_file, indent=4)\n</code></pre> \u6700\u7ec8\u751f\u6210\u7684\u62a5\u544a\u4e2d\uff0c\u6a21\u677f\u7684\u6210\u529f\u7387\u8d8a\u9ad8\u8d8a\u597d\uff0c\u4f4e\u7684\u8bdd\uff0c\u56de\u653e\u51fa\u6765\u7684\u6570\u636e\u5e93\u76d1\u63a7\u6570\u636e\u4e0d\u4e00\u5b9a\u51c6\u786e\u3002</p> <ul> <li>convertSqlText\u4e2d\u7684\u5185\u5bb9\u4e0d\u8981\u4e3aNaN</li> <li>\u5305\u542b\u2019/\u2018 \u53ef\u80fd\u4f1a\u6267\u884c\u5931\u8d25 </li> </ul> <p>\u751f\u6210\u7684\u6570\u636e\u683c\u5f0f\uff1a <pre><code>{\"schema\": \"dbname\", \"session\": 6666, \"execTime\": 83, \"startTime\": 1721666395000000, \"convertSqlText\": \"SELECT  * FROM test WHERE  id = '6666' LIMIT 1\", \"user\": \"test\"}\n</code></pre></p>","tags":["mysql","frodo"]},{"location":"blog/2024/07/29/frodo%20sql%E5%9B%9E%E6%94%BE/#4frodo","title":"4\u3001\u6267\u884cfrodo","text":"<pre><code>java -Xmx8G -Xms1G -jar frodo.jar --file=/root/789.json --source-db=mysql --replay-to=mysql --port=3306 --host=xxxxx --username=xxx --password='xxxx' --concurrency=15 --time=2400 --task=0723-00-40 --schema-map=xxx --log-level=info --rate-factor=1 --database=xxx --filter=DQL\n</code></pre>","tags":["mysql","frodo"]},{"location":"blog/2023/09/11/Django%20NoReverseMatch/","title":"Django NoReverseMatch","text":"<p>\u5728django\u7684\u540e\u53f0\u3002\u60f3\u5728\u5217\u8868\u91cc\u9762\u65b0\u589e\u4e00\u5217\uff0c\u4f5c\u4e3a\u8d85\u94fe\u63a5\u5230\u53e6\u4e00\u4e2a\u6a21\u578b\u7684change\u9875\u9762\u53bb</p>","tags":["python","django","simpleui"]},{"location":"blog/2023/09/11/Django%20NoReverseMatch/#1","title":"1\u3001\u62a5\u9519\u5982\u4e0b\uff1a","text":"<pre><code>Reverse for 'receive_ServerMetricExtendAnalysisData_change' not found. 'receive_ServerMetricExtendAnalysisData_change' is not a valid view function or pattern name.\n</code></pre>","tags":["python","django","simpleui"]},{"location":"blog/2023/09/11/Django%20NoReverseMatch/#2","title":"2\u3001\u9519\u8bef\u6e90\u5934","text":"<p>\u6211\u5f97\u9879\u76ee\u662f\u7528\u7684django\uff0cdrf\uff0csimpleui\uff0c\u7136\u540e\u8fd9\u4e2a\u64cd\u4f5c\u662f\u53d1\u751f\u5728django\u7684\u540e\u53f0\u3002\u60f3\u5728\u5217\u8868\u91cc\u9762\u65b0\u589e\u4e00\u5217\uff0c\u4f5c\u4e3a\u8d85\u94fe\u63a5\u5230\u53e6\u4e00\u4e2a\u6a21\u578b\u7684change\u9875\u9762\u53bb\u3002 <pre><code>from rest_framework.reverse import reverse\nfrom django.urls import reverse\n\ntarget_model_url = reverse('admin:receive_ServerMetricExtendAnalysisData_change', args=[smead_obj.id])\n</code></pre> \u8d77\u521d\u7684\u64cd\u4f5c\u662f\u8fd9\u6837\u7684\uff0c\u7136\u540e\u53cd\u590d\u62a5\u9519\uff0c\u4e5f\u770b\u4e86\u5b98\u7f51\u5173\u4e8ereverse\u7684\u89e3\u91ca\uff1ahttps://docs.djangoproject.com/zh-hans/4.2/ref/urlresolvers/#reverse-lazy\uff0c \u6700\u7ec8\u5c31\u662f\u59b9\u7684\u6ca1\u6709\u7528\uff0cdrf\u7684reverse\u8ddfdjango\u7684\u6ca1\u591a\u5927\u7684\u533a\u522b\uff0c\u8d77\u521d\u4ee5\u4e3a\u540e\u53f0\u4e0d\u80fd\u7528drf\u7684reverse\uff0c\u540e\u6765\u6d4b\u8bd5\u4e24\u8005\u90fd\u53ef\u4ee5\u3002</p>","tags":["python","django","simpleui"]},{"location":"blog/2023/09/11/Django%20NoReverseMatch/#3debug","title":"3\u3001\u5f00\u59cbdebug","text":"<p>\u6293\u4f4f target_model_url\uff0c\u53d1\u73b0\u4ed6\u59b9\u7684\uff0creverse\u652f\u6301\u4e24\u79cd\u53c2\u6570\u6a21\u5f0f\uff0c\u4e00\u79cd\u662f\u4e0d\u5e26\u53c2\u6570\uff0c\u4e00\u79cd\u5e26\u53c2\u6570</p> <p>admin:myapp_mymodel_change\uff0c\u6211\u6240\u914d\u7f6e\u7684mymodel\u540d\u5b57\u91cc\u9762\u6709\u5927\u5199\u5b57\u7b26\u7684\uff0cdebug\u51fa\u6765\u7684\u522b\u7684app\u7684name\u90fd\u662f\u5168\u5c0f\u5199\u7684\uff0c\u770b\u5230\u8fd9\u89c9\u5f97\u8fd9\u600e\u4e48\u8fd9\u4e48\u50bb\u903c\uff0c\u7acb\u9a6c\u6539\u4e86\u6211\u7684\u679c\u7136\u751f\u6548\u3002</p> <p></p>","tags":["python","django","simpleui"]},{"location":"blog/2023/09/11/Django%20NoReverseMatch/#4","title":"4\u3001\u9644\u4e0a\u6211\u53ef\u884c\u7684\u4e24\u79cd\u65b9\u5f0f","text":"<pre><code>target_model_url = f'/admin/receive/servermetricextendanalysisdata/{smead_obj.id}/change/'\nreturn format_html('&lt;a href=\"{}\"&gt;\u70b9\u51fb\u67e5\u770b\u7ed3\u679c&lt;/a&gt;', target_model_url)\n\nfrom django.urls import reverse\ntarget_model_url = reverse('admin:receive_servermetricextendanalysisdata_change', args=[smead_obj.id])\nreturn format_html('&lt;a href=\"{}\"&gt;\u70b9\u51fb\u67e5\u770b\u7ed3\u679c&lt;/a&gt;', target_model_url)\n</code></pre>","tags":["python","django","simpleui"]},{"location":"blog/2023/09/11/Django%20NoReverseMatch/#5","title":"5\u3001\u53c2\u8003","text":"<p>\u53cd\u67e5\u7ba1\u7406 URL\uff1ahttps://docs.djangoproject.com/zh-hans/3.2/ref/contrib/admin/#reversing-admin-urls</p>","tags":["python","django","simpleui"]},{"location":"blog/2023/04/24/celery%E4%BC%A0%E5%8F%82%E6%97%B6%E7%9A%84%E5%AF%B9%E8%B1%A1%E8%BD%AC%E6%8D%A2/","title":"celery\u4f20\u53c2\u65f6\u7684\u5bf9\u8c61\u8f6c\u6362","text":"<p>celery\u4f20\u53c2\u65f6\u7684\u5bf9\u8c61\u8f6c\u6362</p>","tags":["python","django","celery"]},{"location":"blog/2023/04/24/celery%E4%BC%A0%E5%8F%82%E6%97%B6%E7%9A%84%E5%AF%B9%E8%B1%A1%E8%BD%AC%E6%8D%A2/#_1","title":"\u524d\u8a00","text":"<p>\u9047\u5230\u4e00\u4e2a\u6709\u8da3\u7684\u95ee\u9898\uff0ccelery delay\u4f20\u5165SSH\u7684\u5bf9\u8c61\u65f6\uff0c\u62a5\u9519Object of type SSH is not JSON serializable\uff0c\u5206\u6790\u4e00\u4e0b\u5c31\u662f\u53ea\u80fd\u4f20json\u7684\u6570\u636e\u3002\u628a\u6240\u6709\u4f20\u5165\u7684\u6570\u636e\u90fd\u8f6c\u6210json\u3002</p>","tags":["python","django","celery"]},{"location":"blog/2023/04/24/celery%E4%BC%A0%E5%8F%82%E6%97%B6%E7%9A%84%E5%AF%B9%E8%B1%A1%E8%BD%AC%E6%8D%A2/#1json","title":"1\u3001\u5bf9\u8c61\u8f6c\u6362json","text":"<p>\u56e0\u4e3a\u6211\u4f20\u9012\u7684\u662f \u5bf9\u8c61 \uff0c\u6240\u4ee5\u8981\u628a\u5bf9\u8c61\u8f6c\u6210 json\uff0c\u6240\u4ee5\u6211\u5c31\u81ea\u5b9a\u4e49\u4e86\u4e00\u4e2aJSONEncoder <pre><code>class MyEncoder(json.JSONEncoder):\n    def default(self, obj):\n        if isinstance(obj, SSH):\n            obj.__dict__['arguments']['pkey'] = None\n            return obj.__dict__\n</code></pre></p>","tags":["python","django","celery"]},{"location":"blog/2023/04/24/celery%E4%BC%A0%E5%8F%82%E6%97%B6%E7%9A%84%E5%AF%B9%E8%B1%A1%E8%BD%AC%E6%8D%A2/#2json","title":"2\u3001json\u8f6c\u6210\u5bf9\u8c61","text":"<p>\u5728\u5f02\u6b65\u4efb\u52a1\u91cc\u9762\u53c8\u5c06json\u8f6c\u6210\u5bf9\u8c61 <pre><code>@app.task(name='receive_execute_command', base=CustomTask)\ndef execute_remote_command(client: json, scripts: str):\n    \"\"\"\n    \u5f02\u6b65\u6267\u884c\u8fdc\u7a0b\u811a\u672c\n    :param client:\n    :param scripts:\n    :return:\n    \"\"\"\n    client_json_to_dict = json.loads(client)\n    client_json_to_dict['arguments']['pkey'] = SSH.get_private_key()\n\n    new_client_obj = SSH(hostname='none', password='none')\n    new_client_obj.__dict__ = client_json_to_dict\n\n    res = new_client_obj.exec_command(scripts, timeout=5)\n    return res[1].decode('utf-8')\n</code></pre></p>","tags":["python","django","celery"]},{"location":"blog/2023/04/24/celery%E4%BC%A0%E5%8F%82%E6%97%B6%E7%9A%84%E5%AF%B9%E8%B1%A1%E8%BD%AC%E6%8D%A2/#3","title":"3\u3001\u8fd9\u662f\u8c03\u7528\u5f02\u6b65","text":"<p><pre><code>        elif is_async:\n            client_to_json = json.dumps(client, cls=MyEncoder, indent=4)\n            execute_remote_command.delay(client_to_json, scripts)\n            return ['0', '\u5f02\u6b65\u6267\u884c\u4e2d\u3002'.encode('utf-8')]\n</code></pre> \u7ed3\u8bba\u5c31\u662fcelery\u7684\u5f62\u53c2\u4e0d\u80fd\u662f\u5bf9\u8c61\u3002</p>","tags":["python","django","celery"]},{"location":"blog/2023/04/24/celery%E4%BC%A0%E5%8F%82%E6%97%B6%E7%9A%84%E5%AF%B9%E8%B1%A1%E8%BD%AC%E6%8D%A2/#4__dict__-magic","title":"4\u3001\u6269\u5c55\u4e00\u4e0b__dict__ \uff08magic\u65b9\u6cd5\uff09","text":"<p>\u4e3a\u4e86\u65b9\u4fbf\u7528\u6237\u67e5\u770b\u7c7b\u4e2d\u5305\u542b\u54ea\u4e9b\u5c5e\u6027\uff0cPython \u7c7b\u63d0\u4f9b\u4e86 dict \u5c5e\u6027\u3002\u9700\u8981\u6ce8\u610f\u7684\u4e00\u70b9\u662f\uff0c\u8be5\u5c5e\u6027\u53ef\u4ee5\u7528\u7c7b\u540d\u6216\u8005\u7c7b\u7684\u5b9e\u4f8b\u5bf9\u8c61\u6765\u8c03\u7528\uff1a</p> <ul> <li> <p>\u7528\u7c7b\u540d\u76f4\u63a5\u8c03\u7528 dict\uff0c\u4f1a\u8f93\u51fa\u8be5\u7531\u7c7b\u4e2d\u6240\u6709\u7c7b\u5c5e\u6027\u7ec4\u6210\u7684\u5b57\u5178\uff1b</p> </li> <li> <p>\u800c\u4f7f\u7528\u7c7b\u7684\u5b9e\u4f8b\u5bf9\u8c61\u8c03\u7528 dict\uff0c\u4f1a\u8f93\u51fa\u7531\u7c7b\u4e2d\u6240\u6709\u5b9e\u4f8b\u5c5e\u6027\u7ec4\u6210\u7684\u5b57\u5178\u3002</p> </li> </ul> <p>\u5bf9\u4e8e\u5177\u6709\u7ee7\u627f\u5173\u7cfb\u7684\u7236\u7c7b\u548c\u5b50\u7c7b\u6765\u8bf4\uff0c\u7236\u7c7b\u6709\u81ea\u5df1\u7684 dict\uff0c\u540c\u6837\u5b50\u7c7b\u4e5f\u6709\u81ea\u5df1\u7684 dict\uff0c\u5b83\u4e0d\u4f1a\u5305\u542b\u7236\u7c7b\u7684 dict\u3002</p> <p>\u53ef\u4ee5\u53c2\u8003\uff1ahttp://c.biancheng.net/view/2374.html</p>","tags":["python","django","celery"]},{"location":"blog/2023/06/20/django%20orm%20NoneType%20object%20is%20not%20iterable/","title":"django orm 'NoneType' object is not iterable","text":"<p>django orm 'NoneType' object is not iterable</p>","tags":["django","orm"]},{"location":"blog/2023/06/20/django%20orm%20NoneType%20object%20is%20not%20iterable/#1","title":"1\u3001\u62a5\u9519\u622a\u56fe","text":"<p>\u5f53\u5c0f\u4f19\u4f34\u4eec\u9047\u5230\u8fd9\u79cd\u6c99\u96d5\u95ee\u9898\u65f6\u662f\u4e0d\u662f\u4e5f\u662f\u5f88\u70e6\u8e81? </p>","tags":["django","orm"]},{"location":"blog/2023/06/20/django%20orm%20NoneType%20object%20is%20not%20iterable/#2traceback","title":"2\u3001\u5206\u6790Traceback","text":"<p>\u53d1\u73b0\u6709\u719f\u6089\u7684\uff0c\u6211\u91cd\u5199\u4e86admin.ModelAdmin\u7684save_related\u65b9\u6cd5\uff0c\u5206\u6790\u5e94\u8be5\u662f\u518d\u591a\u5bf9\u591a\u4fdd\u5b58\u65f6\u51fa\u73b0\u4e86\u95ee\u9898\u3002 </p> <p></p>","tags":["django","orm"]},{"location":"blog/2023/06/20/django%20orm%20NoneType%20object%20is%20not%20iterable/#3scripts","title":"3\u3001\u770b\u4e0a\u53bb\u597d\u50cf\u662fscripts\u8fd9\u4e2a\u5b57\u6bb5\u5728\u4fdd\u5b58\u65f6\u51fa\u73b0\u4e86\u95ee\u9898\u3002\u7136\u540e\u53d1\u73b0\u8fd9\u4e2a\u5b57\u6bb5\u5728\u540e\u53f0\u4e5f\u505a\u4e86\u4e00\u4e2a\u8868\u5355\u9a8c\u8bc1\u3002","text":"<p>  \u5728\u6821\u9a8cscripts\u8fd9\u4e2a\u5b57\u6bb5\u65f6\uff0c\u5f53job_type==2\u65f6\u6ca1\u6709\u5bf9\u5e94\u7684\u8fd4\u56de\uff0c\u6240\u4ee5job_type==1\u6bcf\u6b21\u90fd\u6210\u529f\u4e86\uff0c2\u90fd\u662f\u5931\u8d25\u7684\u3002</p>","tags":["django","orm"]},{"location":"blog/2023/06/20/django%20orm%20NoneType%20object%20is%20not%20iterable/#4clean_-fieldname","title":"4\u3001clean_ &lt; fieldname &gt;()","text":"<p>\u65b9\u6cd5\u662f\u5728\u8868\u5355\u5b50\u7c7b\u4e0a\u8c03\u7528\u7684\u2014\u2014\u5176\u4e2d &lt; fieldname &gt; \u88ab\u66ff\u6362\u4e3a\u8868\u5355\u5b57\u6bb5\u5c5e\u6027\u7684\u540d\u79f0\u3002\u8fd9\u4e2a\u65b9\u6cd5\u505a\u4efb\u4f55\u7279\u5b9a\u5c5e\u6027\u7684\u6e05\u7406\u5de5\u4f5c\uff0c\u4e0e\u5b57\u6bb5\u7684\u7c7b\u578b\u65e0\u5173\u3002\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u4f20\u9012\u4efb\u4f55\u53c2\u6570\u3002\u4f60\u9700\u8981\u5728 self.cleaned_data \u4e2d\u67e5\u627e\u5b57\u6bb5\u7684\u503c\uff0c\u5e76\u4e14\u8bb0\u4f4f\uff0c\u6b64\u65f6\u5b83\u5c06\u662f\u4e00\u4e2a Python \u5bf9\u8c61\uff0c\u800c\u4e0d\u662f\u5728\u8868\u5355\u4e2d\u63d0\u4ea4\u7684\u539f\u59cb\u5b57\u7b26\u4e32\uff08\u5b83\u5c06\u5728 cleaned_data \u4e2d\uff0c\u56e0\u4e3a\u4e0a\u9762\u7684\u4e00\u822c\u5b57\u6bb5 clean() \u65b9\u6cd5\u5df2\u7ecf\u6e05\u7406\u4e86\u4e00\u6b21\u6570\u636e\uff09\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u60f3\u9a8c\u8bc1\u4e00\u4e2a\u53eb serialnumber \u7684 CharField \u7684\u5185\u5bb9\u662f\u552f\u4e00\u7684\uff0cclean_serialnumber() \u5c31\u53ef\u4ee5\u505a\u8fd9\u4ef6\u4e8b\u3002\u4f60\u4e0d\u9700\u8981\u4e00\u4e2a\u7279\u5b9a\u7684\u5b57\u6bb5\uff08\u5b83\u662f\u4e00\u4e2a CharField\uff09\uff0c\u4f46\u4f60\u9700\u8981\u4e00\u4e2a\u7279\u5b9a\u5b57\u6bb5\u7684\u9a8c\u8bc1\uff0c\u53ef\u80fd\u7684\u8bdd\uff0c\u6e05\u7406\uff0f\u89c4\u8303\u6570\u636e\u3002</p> <p>\u8fd9\u4e2a\u65b9\u6cd5\u7684\u8fd4\u56de\u503c\u4f1a\u66ff\u6362 cleaned_data \u4e2d\u7684\u73b0\u6709\u503c\uff0c\u6240\u4ee5\u5b83\u5fc5\u987b\u662f cleaned_data \u4e2d\u7684\u5b57\u6bb5\u503c\uff08\u5373\u4f7f\u8fd9\u4e2a\u65b9\u6cd5\u6ca1\u6709\u6539\u53d8\u5b83\uff09\u6216\u4e00\u4e2a\u65b0\u7684\u5e72\u51c0\u503c\u3002</p>","tags":["django","orm"]},{"location":"blog/2023/06/20/django%20orm%20NoneType%20object%20is%20not%20iterable/#5","title":"5\u3001\u53c2\u8003\u6587\u6863","text":"<pre><code>https://docs.djangoproject.com/zh-hans/3.2/ref/forms/validation/\n</code></pre>","tags":["django","orm"]},{"location":"blog/2023/06/09/drf%E5%A4%96%E9%94%AE%E5%BA%8F%E5%88%97%E5%8C%96/","title":"drf\u5916\u952e\u5e8f\u5217\u5316","text":"<p>drf\u5916\u952e\u5e8f\u5217\u5316</p>","tags":["django","drf"]},{"location":"blog/2023/06/09/drf%E5%A4%96%E9%94%AE%E5%BA%8F%E5%88%97%E5%8C%96/#_1","title":"\u524d\u8a00","text":"<p>\u5728Django REST Framework\uff08DRF\uff09\u4e2d\uff0c\u5916\u952e\u5b57\u6bb5\u53ef\u4ee5\u901a\u8fc7\u5e8f\u5217\u5316\u5668\u8fdb\u884c\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u3002</p>","tags":["django","drf"]},{"location":"blog/2023/06/09/drf%E5%A4%96%E9%94%AE%E5%BA%8F%E5%88%97%E5%8C%96/#1","title":"1\u3001\u6a21\u578b\u611f\u53d7\u4e00\u4e0b\uff1a","text":"<pre><code>from django.db import models\n\nclass Author(models.Model):\n    name = models.CharField(max_length=100)\n\n    def __str__(self):\n        return self.name\n\nclass Book(models.Model):\n    title = models.CharField(max_length=200)\n    author = models.ForeignKey(Author, on_delete=models.CASCADE)\n\n    def __str__(self):\n        return self.title\n</code></pre>","tags":["django","drf"]},{"location":"blog/2023/06/09/drf%E5%A4%96%E9%94%AE%E5%BA%8F%E5%88%97%E5%8C%96/#2","title":"2\u3001\u5e8f\u5217\u5316","text":"<p>\u5728\u4e0a\u9762\u7684\u793a\u4f8b\u4e2d\uff0cBook\u6a21\u578b\u6709\u4e00\u4e2a\u5916\u952e\u5b57\u6bb5\u6307\u5411Author\u6a21\u578b\u3002\u5728BookSerializer\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528source\u53c2\u6570\u6765\u6307\u5b9a\u5916\u952e\u5b57\u6bb5\u5bf9\u5e94\u7684\u5173\u8054\u6a21\u578b\u4e2d\u7684\u5b57\u6bb5\u3002\u4f8b\u5982\uff0c\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528source='author.name'\u5c06\u4f5c\u8005\u540d\u5b57\u7684\u5b57\u6bb5\u6620\u5c04\u5230author_name\u5b57\u6bb5\u3002</p> <p>\u5728AuthorSerializer\u4e2d\uff0c\u6211\u4eec\u5305\u542b\u4e86\u4e00\u4e2a\u5d4c\u5957\u7684BookSerializer\uff0c\u4ee5\u4fbf\u5e8f\u5217\u5316\u4e0e\u8be5\u4f5c\u8005\u76f8\u5173\u8054\u7684\u6240\u6709\u4e66\u7c4d\u3002 <pre><code>from rest_framework import serializers\nfrom myapp.models import Author, Book\n\nclass BookSerializer(serializers.ModelSerializer):\n    author_name = serializers.CharField(source='author.name')\n\n    class Meta:\n        model = Book\n        fields = ['id', 'title', 'author_name']\n\nclass AuthorSerializer(serializers.ModelSerializer):\n    books = BookSerializer(many=True)\n\n    class Meta:\n        model = Author\n        fields = ['id', 'name', 'books']\n</code></pre></p>","tags":["django","drf"]},{"location":"blog/2023/08/02/%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E7%BB%93%E6%9E%84%E4%BD%93/","title":"golang\u5b57\u7b26\u4e32\u8f6c\u7ed3\u6784\u4f53","text":"<p>golang\u5b57\u7b26\u4e32\u8f6c\u7ed3\u6784\u4f53</p>","tags":["golang"]},{"location":"blog/2023/08/02/%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E7%BB%93%E6%9E%84%E4%BD%93/#1","title":"1\u3001\u4e0d\u77e5\u9053\u7ed3\u6784\u4f53\u7c7b\u578b\u7684\u60c5\u51b5\u4e0b","text":"<p><pre><code>func JsonStringToMap(jsonStr string) (map[string]interface{}, error) {\n    //\u672a\u77e5\u503c\u7c7b\u578b\n    m := make(map[string]interface{})\n    err := json.Unmarshal([]byte(jsonStr), &amp;m)\n    if err != nil {\n        fmt.Printf(\"Unmarshal with error: %+v\\n\", err)\n        return nil, err\n    }\n\n    return m, nil\n}\n\n\nres := JsonStringToMap(response.ToJsonString())\nresp, ok := res[\"Response\"].(map[string]interface{})\nif ok {\n    for _, v := range resp[\"Machines\"].([]interface {}){\n        fmt.Println(v.(map[string]interface{})[\"Ip\"])\n        fmt.Println(v.(map[string]interface{})[\"Status\"])\n    }\n}\n</code></pre> \u6162\u6162\u65ad\u8a00\u62c6\u6570\u636e\uff0c\u5c5e\u5b9e\u5f88\u9ebb\u70e6\u3002</p>","tags":["golang"]},{"location":"blog/2023/08/02/%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E7%BB%93%E6%9E%84%E4%BD%93/#2","title":"2\u3001\u5728\u77e5\u9053\u7ed3\u6784\u4f53\u7c7b\u578b\u7684\u60c5\u51b5\u4e0b","text":"<p><pre><code>func JsonStringToMap_v2(jsonStr string)  {\n    //\u672a\u77e5\u503c\u7c7b\u578b\n    var dmrp cls.DescribeMachinesResponse\n\n    err := json.Unmarshal([]byte(jsonStr), &amp;dmrp)\n    if err != nil {\n        fmt.Printf(\"Unmarshal with error: %+v\\n\", err)\n    }\n\n    for _,v := range dmrp.Response.Machines {\n        fmt.Println(*v.Ip)\n        fmt.Println(*dmrp.Response.AutoUpdate)\n    }\n}\n</code></pre> \u76f8\u5bf9\u65b9\u4fbf\u591a\u4e86\u3002 \u521a\u5f00\u59cb\u627e\u4e86\u7b2c\u4e00\u79cd\u529e\u6cd5\uff0c\u611f\u89c9\u592a\u9ebb\u70e6\uff0c\u4e4b\u540e\u53d1\u73b0\u7b2c\u4e8c\u79cd\u529e\u6cd5\uff0c\u7528\u4e86\u7b2c\u4e8c\u79cd\u529e\u6cd5\u540e\u53d1\u73b0\u5728\u51fd\u6570\u7684\u8fd4\u56de\u7c7b\u578b\u91cc\u9762\u76f4\u63a5\u53ef\u4ee5\u4f7f\u7528\u672a\u8f6c\u6210json\u4e32\u4e4b\u524d\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4e0d\u719f\u6089\u7684\u4ee3\u4ef7\u5c31\u662f\u82b1\u65f6\u95f4\u6298\u817e\u3002</p>","tags":["golang"]},{"location":"blog/2023/08/02/%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E7%BB%93%E6%9E%84%E4%BD%93/#3","title":"3\u3001\u901a\u7528\u65b9\u5f0f","text":"<p>\u4e00\u4e2a\u901a\u7528\u7684\u7ed3\u6784\u4f53\uff0c\u4e0d\u7ba1\u6765\u6e90\u7684\u7c7b\u578b\uff0cData\u91cc\u9762\u5305\u542b\u7684\u662f\u5404\u79cd\u6570\u636e\u7c7b\u578b\u3002\u5f53interface\u91cc\u9762\u662f\u4e00\u4e2amap\u65f6\uff0c\u60f3\u77e5\u9053map\u4e2d\u5bf9\u5e94\u7684value\uff0c\u9700\u8981\u591a\u5c42\u65ad\u8a00\uff0c\u5148\u65ad\u51faData\uff0c\u83b7\u53d6\u5230Data\u7684\u6570\u636e\u540e\uff0c\u518d\u65adprocess_name\u548cidentify_pid\u3002</p> <pre><code>package main\n\nimport (\n    \"encoding/json\"\n    \"fmt\"\n)\n\ntype TransmittedData struct {\n    Data  interface{} `json:\"data\"`\n    Scene string      `json:\"scene\"`\n}\n\nfunc main() {\n    postData := []byte(`\n    {\n        \"data\": {\n            \"process_name\": \"serverMetricExtend\",\n            \"identify_pid\": \"ps -ef|grep serverMetricE|grep -v grep |awk '{print $2}'\"\n        },\n        \"scene\": \"process_monitor\"\n    }\n    `)\n\n    var transmittedData TransmittedData\n    err := json.Unmarshal(postData, &amp;transmittedData)\n    if err != nil {\n        fmt.Println(\"Error:\", err)\n        return\n    }\n\n    data, ok := transmittedData.Data.(map[string]interface{})\n    if !ok {\n        fmt.Println(\"Error: Data is not a map\")\n        return\n    }\n\n    processName, ok := data[\"process_name\"].(string)\n    if !ok {\n        fmt.Println(\"Error: Process Name is not a string\")\n        return\n    }\n\n    identifyPid, ok := data[\"identify_pid\"].(string)\n    if !ok {\n        fmt.Println(\"Error: Identify PID is not a string\")\n        return\n    }\n\n    fmt.Println(\"Process Name:\", processName)\n    fmt.Println(\"Identify PID:\", identifyPid)\n    fmt.Println(\"Scene:\", transmittedData.Scene)\n}\n</code></pre>","tags":["golang"]},{"location":"blog/2024/01/29/simpleui%20layer%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD/","title":"simpleui layer\u81ea\u52a8\u52a0\u8f7d","text":"<p>\u5f53\u4f60\u4f7f\u7528simpleui layer \u65f6\u80af\u5b9a\u4f1a\u9047\u5230\u66f4\u65b0\u4e86\u6570\u636e\u5e93\u6570\u636e\u540e\uff0clayer\u4e2d\u7684\u6570\u636e\u5e76\u6ca1\u6709\u81ea\u52a8\u66f4\u65b0\u7684\u60c5\u51b5\u3002</p>","tags":["simpleui","django","\u4fe1\u53f7"]},{"location":"blog/2024/01/29/simpleui%20layer%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD/#_1","title":"\u524d\u8a00","text":"<p>\u8fd9\u4e2a\u95ee\u9898\u5e94\u8be5\u4e0d\u4f1a\u6709\u5f88\u591a\u540c\u5b66\u9047\u5230\uff0c\u4f46\u662f\u5982\u679c\u9047\u5230\u4e86\u53ef\u4ee5\u53c2\u8003\u89e3\u51b3\u3002</p> <p>\u5f53\u4f60\u4f7f\u7528simpleui layer \u65f6\u80af\u5b9a\u4f1a\u9047\u5230\u66f4\u65b0\u4e86\u6570\u636e\u5e93\u6570\u636e\u540e\uff0clayer\u4e2d\u7684\u6570\u636e\u5e76\u6ca1\u6709\u81ea\u52a8\u66f4\u65b0\u7684\u60c5\u51b5\u3002\u800c\u5f53\u4f60\u66f4\u65b0\u89e3\u51b3\u5b8c\u6570\u636e\u81ea\u52a8\u66f4\u65b0\u4e4b\u540e\uff0c\u5f88\u6709\u53ef\u80fd\u4f1a\u5f15\u51fa\u53e6\u4e00\u4e2a\u95ee\u9898\uff0c\u5f53\u6a21\u578b\u7ed3\u6784\u53d1\u751f\u53d8\u66f4\u65f6\uff0c\u6070\u597d\u81ea\u52a8\u66f4\u65b0layer\u7684\u65f6\u5019\u9700\u8981\u4f9d\u8d56\u8fd9\u4e2a\u6a21\u578b\uff0c\u563f\u563f\uff0c\u90a3\u4f60\u5c31\u4f1a\u5728migrate\u7684\u65f6\u5019\u62a5\u9519\uff0c\u7c7b\u4f3c\uff1a <pre><code>django.db.utils.OperationalError: (1054, \"Unknown column 'assets_DomainList.cloud_certificate_id' in 'field list'\")\n</code></pre></p>","tags":["simpleui","django","\u4fe1\u53f7"]},{"location":"blog/2024/01/29/simpleui%20layer%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD/#1layer","title":"1\u3001\u81ea\u52a8\u66f4\u65b0layer\u6570\u636e","text":"<p>\u901a\u8fc7admin_action\u88c5\u9970\u5668\u5c06layer\u6240\u9700\u8981\u7684\u5c5e\u6027\u90fd\u8fdb\u884c\u8d4b\u503c\u3002</p>","tags":["simpleui","django","\u4fe1\u53f7"]},{"location":"blog/2024/01/29/simpleui%20layer%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD/#11layer","title":"1.1\u3001\u751f\u6210layer","text":"","tags":["simpleui","django","\u4fe1\u53f7"]},{"location":"blog/2024/01/29/simpleui%20layer%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD/#111","title":"1.1.1\u3001\u6309\u94ae","text":"<pre><code>@admin_action(short_description='\u5bfc\u5165\u57df\u540d\u5217\u8868', _type='success', icon='el-icon-s-promotion',\n                 layer=ImportDomainListLayer()())\n   def import_domain_list(self, request, queryset):\n       return JsonResponse(data={\n           'status': 'success',\n           'msg': '\u5904\u7406\u6210\u529f\uff01'\n       })\n</code></pre>","tags":["simpleui","django","\u4fe1\u53f7"]},{"location":"blog/2024/01/29/simpleui%20layer%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD/#112layer","title":"1.1.2\u3001layer\u88c5\u9970\u5668","text":"<pre><code>def admin_action(short_description=None, icon=None, _type=None, confirm=None, style=None, layer=None):\n    \"\"\"\n    \u540e\u53f0action\u5c5e\u6027\u88c5\u9970\u5668\n    :param layer:\n    :param style:\n    :param short_description:\n    :param icon:\n    :param _type:\n    :param confirm:\n    :return:\n    \"\"\"\n    def decorator(func):\n        func.short_description = short_description\n        func.icon = icon\n        func.type = _type\n        func.confirm = confirm\n        func.style = style\n        func.layer = layer\n\n        @wraps(func)\n        def wrapper(*args, **kwargs):\n            return func(*args, **kwargs)\n\n        return wrapper\n\n    return decorator\n</code></pre>","tags":["simpleui","django","\u4fe1\u53f7"]},{"location":"blog/2024/01/29/simpleui%20layer%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD/#113layer","title":"1.1.3\u3001\u5408\u6210layer\u7684\u7c7b","text":"<pre><code>class ImportDomainListLayer:\n    def __init__(self):\n        self.layer = {\n            'title': '\u5bfc\u5165\u57df\u540d\u548c\u8bb0\u5f55',\n            'tips': '\u6e05\u7a7a\u4e4b\u540e\u91cd\u65b0\u5bfc\u5165,\u4e0d\u540c\u51ed\u8bc1\u5bf9\u5e94\u4e0d\u540c\u7684\u5e73\u53f0\u3002',\n            'confirm_button': '\u786e\u8ba4\u63d0\u4ea4',\n            'cancel_button': '\u53d6\u6d88',\n            'width': '40%',\n            'labelWidth': \"80px\",\n            'params': []\n        }\n        self.dst_cloud_select = {\n            'type': 'select',\n            'key': 'dst_cloud',\n            'label': '\u76ee\u6807\u4e91\u5e73\u53f0\u51ed\u8bc1',\n            'size': 'small',\n            'options': []\n        }\n\n    def generate_layer(self):\n        self.dst_cloud_select['options'] = [{'key': cc.id, 'label': cc.name} for cc in CloudCertificate.objects.all()]\n        self.layer['params'] = [\n            self.dst_cloud_select,\n        ]\n        return self.layer\n\n    @admin_layer_load\n    def __call__(self, *args, **kwargs):\n        return self.generate_layer()\n</code></pre>","tags":["simpleui","django","\u4fe1\u53f7"]},{"location":"blog/2024/01/29/simpleui%20layer%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD/#12layer","title":"1.2\u3001\u81ea\u52a8\u66f4\u65b0layer\u6570\u636e","text":"<p>\u901a\u8fc7\u4fe1\u53f7\u5728\u4f9d\u8d56\u7684\u6a21\u578b\u6bcf\u6b21\u65b0\u589e\u6570\u636e\u540e\u81ea\u52a8\u5237\u65b0layer\u5c5e\u6027\u6570\u636e\u3002</p>","tags":["simpleui","django","\u4fe1\u53f7"]},{"location":"blog/2024/01/29/simpleui%20layer%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD/#121","title":"1.2.1\u3001\u4fe1\u53f7\u51fd\u6570","text":"<pre><code>@receiver(post_delete, sender=CloudCertificate, dispatch_uid='post_delete_CloudCertificate')\ndef del_import_domain_list_layer(sender, **kwargs):\n    logger.info(\"CloudCertificate del \u89e6\u53d1\u4fe1\u53f7\u3002\")\n    DomainListMixins.import_domain_list.layer = ImportDomainListLayer()()\n</code></pre>","tags":["simpleui","django","\u4fe1\u53f7"]},{"location":"blog/2024/01/29/simpleui%20layer%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD/#2migratelayer","title":"2\u3001\u5728migrate\u65f6layer\u4e0d\u81ea\u52a8\u52a0\u8f7d","text":"<p>\u601d\u8def\u5c31\u662f\u5728migrate\u7684\u65f6\u5019\u5ffd\u7565\u6389layer\u7684\u52a0\u8f7d\u3002</p>","tags":["simpleui","django","\u4fe1\u53f7"]},{"location":"blog/2024/01/29/simpleui%20layer%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD/#21","title":"2.1\u3001\u63a7\u5236\u4e0d\u52a0\u8f7d\u7684\u88c5\u9970\u5668","text":"<pre><code>def admin_layer_load(func):\n    \"\"\"\n    \u5728migrate\u6a21\u5f0f\u4e0b\uff0c\u4e0d\u52a0\u8f7dlayer\n    :param func:\n    :return:\n    \"\"\"\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        return 'pass' if 'migrate' in sys.argv else func(*args, **kwargs)\n    return wrapper\n</code></pre>","tags":["simpleui","django","\u4fe1\u53f7"]},{"location":"blog/2024/01/29/simpleui%20layer%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD/#22layer","title":"2.2\u3001\u5728\u8c03\u7528layer\u7684\u65f6\u5019\u52a0\u5165\u5224\u65ad","text":"<pre><code>@admin_layer_load\ndef __call__(self, *args, **kwargs):\n    return self.generate_layer()\n</code></pre>","tags":["simpleui","django","\u4fe1\u53f7"]},{"location":"blog/2024/08/05/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C/","title":"mysql\u6570\u636e\u5e93\u6743\u9650\u6821\u9a8c","text":"<p>mysql\u6570\u636e\u5e93\u6743\u9650\u6821\u9a8c</p>","tags":["golang","mysql","\u6570\u636e\u5e93\u8fc1\u79fb"]},{"location":"blog/2024/08/05/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C/#_1","title":"\u524d\u8a00","text":"<p>\u8fc1\u79fbmysql\u6570\u636e\u5e93\u540e\uff0c\u6821\u9a8c\u6743\u9650\u4e5f\u662f\u4e2a\u95ee\u9898\uff0c\u4e00\u4e2a\u5e93\u5927\u51e0\u5341\u4e2a\u8d26\u53f7\uff0c\u4e0d\u53ef\u80fd\u53bb\u4e00\u4e2a\u4e2a\u6821\u9a8c\u7684\uff0c\u6240\u4ee5\u5c31\u641e\u4e86\u4e2a\u6821\u9a8c\u7684\u5c0f\u811a\u672c\uff0c\u901a\u8fc7\u5bf9\u6bd4\u4e24\u4e2a\u5e93\u7684\u6240\u6709\u8d26\u53f7\u7684md5\u8fdb\u884c\u6bd4\u5bf9\u3002</p>","tags":["golang","mysql","\u6570\u636e\u5e93\u8fc1\u79fb"]},{"location":"blog/2024/08/05/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C/#1","title":"1\u3001\u4ee3\u7801\u5982\u4e0b","text":"\u4ee3\u7801 <pre><code>package main\n\nimport (\n\"context\"\n\"crypto/md5\"\n\"database/sql\"\n\"encoding/hex\"\n\"fmt\"\n\"log\"\n\"os\"\n\"os/signal\"\n\"strings\"\n\"time\"\n\n_ \"github.com/go-sql-driver/mysql\"\n)\n\ntype DBConfig struct {\nUser     string\nPassword string\nHost     string\nPort     string\nName     string\n}\n\ntype Database struct {\npool *sql.DB\n}\n\nfunc NewDatabase(config DBConfig) (*Database, error) {\ndsn := fmt.Sprintf(\"%s:%s@tcp(%s:%s)/%s?timeout=5s\",\n    config.User, config.Password, config.Host, config.Port, config.Name)\n\npool, err := sql.Open(\"mysql\", dsn)\nif err != nil {\n    return nil, fmt.Errorf(\"unable to use data source name: %w\", err)\n}\n\npool.SetConnMaxLifetime(0)\npool.SetMaxIdleConns(3)\npool.SetMaxOpenConns(3)\n\nreturn &amp;Database{pool: pool}, nil\n}\n\nfunc (db *Database) Close() {\ndb.pool.Close()\n}\n\nfunc (db *Database) Ping(ctx context.Context) error {\nctx, cancel := context.WithTimeout(ctx, 1*time.Second)\ndefer cancel()\nreturn db.pool.PingContext(ctx)\n}\n\nfunc (db *Database) QueryGetAllUsers(ctx context.Context) []string {\nctx, cancel := context.WithTimeout(ctx, 5*time.Second)\ndefer cancel()\n\nrows, err := db.pool.QueryContext(ctx, \"SELECT CONCAT('''', user, '''', '@', '''', host, '''') AS user_grant FROM mysql.user;\")\nif err != nil {\n    fmt.Errorf(\"unable to execute search query: %w\", err)\n}\ndefer rows.Close()\n\nvar all_users []string\nfor rows.Next() {\n    var userGrant string\n    if err := rows.Scan(&amp;userGrant); err != nil {\n    fmt.Errorf(\"error scanning row: %w\", err)\n    }\n    userGrantstr := fmt.Sprintf(\"SHOW GRANTS FOR %s;\", userGrant)\n    all_users = append(all_users, userGrantstr)\n}\n\nreturn all_users\n}\n\nfunc (db *Database) QueryGetAllUsersGrant(ctx context.Context, grantUsersSql []string) map[string][]string {\nctx, cancel := context.WithTimeout(ctx, 5*time.Second)\ndefer cancel()\n\ngrantUsersSqlmap := make(map[string][]string)\n\naddgrantUsersSqlmap := func(key string, value string) {\n    if _, exists := grantUsersSqlmap[key]; exists {\n    grantUsersSqlmap[key] = append(grantUsersSqlmap[key], value)\n    } else {\n    grantUsersSqlmap[key] = []string{value}\n    }\n}\n\nfor _, v := range grantUsersSql {\n    rows, _ := db.pool.QueryContext(ctx, v)\n    for rows.Next() {\n    var userGrant string\n    if err := rows.Scan(&amp;userGrant); err != nil {\n        fmt.Errorf(\"error scanning row: %w\", err)\n    }\n    addgrantUsersSqlmap(v, userGrant)\n    }\n}\nreturn grantUsersSqlmap\n}\n\nfunc SetupSignalHandler(stop context.CancelFunc) {\nappSignal := make(chan os.Signal, 3)\nsignal.Notify(appSignal, os.Interrupt)\n\ngo func() {\n    &lt;-appSignal\n    stop()\n}()\n}\n\nfunc contains(sql_slice []string, sql string) bool {\nfor i := 0; i &lt; len(sql_slice); i++ {\n    if sql == sql_slice[i] {\n    return true\n    }\n}\nreturn false\n}\n\nfunc calculateMD5(data []string) string {\ncombined := strings.Join(data, \",\")\nhash := md5.New()\nhash.Write([]byte(combined))\nreturn hex.EncodeToString(hash.Sum(nil))\n}\n\nfunc generateUserGrantMd5(grant_map map[string][]string) map[string]string {\ngrantUsersSqlmapMd5 := make(map[string]string)\nfor key, value := range grant_map {\n    res := calculateMD5(value)\n    grantUsersSqlmapMd5[key] = res\n}\nreturn grantUsersSqlmapMd5\n}\n\nfunc DbM(ctx context.Context, dbconf DBConfig) ([]string, map[string][]string, map[string]string) {\nnew_db_config := dbconf\ndb, err := NewDatabase(new_db_config)\nif err != nil {\n    log.Fatal(err)\n}\ndefer db.Close()\n\nif err := db.Ping(ctx); err != nil {\n    log.Fatal(err)\n}\n\ngrant_sql_slice := db.QueryGetAllUsers(ctx)\ngrant_sql_map := db.QueryGetAllUsersGrant(ctx, grant_sql_slice)\nguam := generateUserGrantMd5(grant_sql_map)\nreturn grant_sql_slice, grant_sql_map, guam\n}\n\nfunc checkDataBaseGrant(ctx context.Context) {\n// \u65b0db\ngrant_sql_slice, grant_sql_map, guam := DbM(ctx, DBConfig{\n    User:     \"xxxxxx\",\n    Password: \"xxxxxx\",\n    Host:     \"xxxxxx\",\n    Port:     \"3306\",\n    Name:     \"xxxxxx\",\n})\n// \u8001db\ngrant_sql2_slice, grant_sql2_map, guam2 := DbM(ctx, DBConfig{\n    User:     \"xxxxxx\",\n    Password: \"xxxxxx\",\n    Host:     \"xxxxxx\",\n    Port:     \"3306\",\n    Name:     \"xxxxxx\",\n})\n\n// \u8001db\u91cc\u9762\u6709\uff0c\u65b0db\u91cc\u9762\u6ca1\u6709\u7684\u8868\nfor i := 0; i &lt; len(grant_sql2_slice); i++ {\n    res := contains(grant_sql_slice, grant_sql2_slice[i])\n    if res == false {\n    fmt.Printf(\"\u5728\u8001db\uff1a%s \u4e0d\u5728\u65b0db\\n\", grant_sql2_slice[i])\n    }\n}\n\n// \u5224\u65ad\u5bf9\u5e94\u8868\u7684\u6743\u9650\u7684md5\u662f\u5426\u4e00\u6837\nfor key, _ := range guam {\n    if guam[key] != guam2[key] {\n    fmt.Printf(\"%s\u6743\u9650\u4e0d\u4e00\u81f4\\n\", key)\n    fmt.Printf(\"\u65b0db\u6743\u9650:\\n%s\\n\", grant_sql_map[key])\n    fmt.Printf(\"\u8001db\u6743\u9650:\\n%s\\n\", grant_sql2_map[key])\n    fmt.Println(\"====================================================================\")\n    }\n}\n}\n\nfunc main() {\nctx, stop := context.WithCancel(context.Background())\ndefer stop()\nSetupSignalHandler(stop)\ncheckDataBaseGrant(ctx)\n}\n</code></pre>","tags":["golang","mysql","\u6570\u636e\u5e93\u8fc1\u79fb"]},{"location":"blog/2024/08/05/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C/#2","title":"2\u3001\u4f7f\u7528\u8bf4\u660e","text":"<p>\u6709\u4e24\u4e2a\u8fd9\u4e2a\u914d\u7f6e\uff0c\u4e00\u4e2a\u65b0\u5e93\uff0c\u4e00\u4e2a\u8001\u5e93\uff0c\u522b\u7684\u65e0\u9700\u4fee\u6539\uff0c\u7136\u540e\u53ef\u4ee5\u76f4\u63a5go run \u6267\u884c\uff0cgo\u7684\u7248\u672c\u662f1.21\u3002 <pre><code>DBConfig{\n        User:     \"xxxxxx\",\n        Password: \"xxxxxx\",\n        Host:     \"xxxxxx\",\n        Port:     \"3306\",\n        Name:     \"xxxxxx\",\n    }\n</code></pre></p>","tags":["golang","mysql","\u6570\u636e\u5e93\u8fc1\u79fb"]},{"location":"blog/2023/08/08/golang%E5%AE%9A%E6%97%B6%E5%99%A8/","title":"prometheus\u7684sdk client_golang \u4f7f\u7528 \u5b9a\u65f6\u5668","text":"<p>\u4e4b\u524d\u7ebf\u4e0a\u76d1\u63a7\u7684agent\u90fd\u662f\u76f4\u63a5  time.Sleep(time.Duration(collectInterval) * time.Second) ,\u591a\u5c11\u6709\u4e9b\u8bb8\u7684low\uff0c\u6bcf\u6b21\u5f00\u59cb\u91c7\u96c6\u6570\u636e\u7684\u65f6\u95f4\u90fd\u662f\u4ece\u7a0b\u5e8f\u5f00\u59cb\u6267\u884c\u5c31\u5f00\u59cb\u91c7\u96c6\uff0c\u5f88\u663e\u7136\u8fd9\u79cd\u5077\u61d2\u7684\u65b9\u5f0f\u662f\u4e0d\u5408\u7406\u7684\u3002</p>","tags":["prometheus","monitor","golang"]},{"location":"blog/2023/08/08/golang%E5%AE%9A%E6%97%B6%E5%99%A8/#1","title":"1\u3001\u666e\u901a\u7684\u65f6\u95f4\u95f4\u9694\u793a\u4f8b","text":"<pre><code>func AbNormalLoglistener(collectInterval int)  {\n    abnormal_loglistener_Gauge := prometheus.NewGaugeVec(\n        prometheus.GaugeOpts{\n            Namespace: \"tc\",\n            Subsystem: \"serverMetricExtend\",\n            Name:      \"abnormal_loglistener_log\",\n            Help:      \"Loglistener An exception exists in the log file.\",\n        },\n        []string{\n            \"hostname\",\n            \"alert_name\",\n        },\n    )\n    prometheus.MustRegister(abnormal_loglistener_Gauge)\n\n    _t := tools.Server{}\n    sname := _t.GetServerHostName()\n\n    go func() {\n        defer func() {\n            if r := recover(); r != nil {\n                metricLog.Error(r)\n            }\n        }()\n\n        ticker := time.NewTicker(time.Duration(collectInterval) * time.Second)\n        now := time.Now()\n        nextMinute := now.Truncate(time.Duration(collectInterval) * time.Second).Add(time.Duration(collectInterval) * time.Second)\n        waitTime := nextMinute.Sub(now)\n        time.Sleep(waitTime)\n\n        for {\n            metricsBack := _t.FetchDirModTime()\n            for alert_name, status := range metricsBack{\n                abnormal_loglistener_Gauge.With(prometheus.Labels{\"hostname\": sname, \"alert_name\": alert_name}).Set(float64(status))\n            }\n\n            &lt;-ticker.C\n            nextMinute = nextMinute.Add(time.Duration(collectInterval) * time.Second)\n            waitTime = nextMinute.Sub(time.Now())\n            time.Sleep(waitTime)\n\n        }\n    }()\n}\n</code></pre>","tags":["prometheus","monitor","golang"]},{"location":"blog/2023/08/08/golang%E5%AE%9A%E6%97%B6%E5%99%A8/#2-timeticker","title":"2\u3001\u65b9\u5f0f\u4e00 time.Ticker","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc main() {\n    // \u521b\u5efa\u4e00\u4e2a\u5b9a\u65f6\u5668\uff0c\u6bcf\u9694\u4e00\u5206\u949f\u89e6\u53d1\u4e00\u6b21\n    ticker := time.NewTicker(time.Minute)\n\n    // \u83b7\u53d6\u5f53\u524d\u65f6\u95f4\n    now := time.Now()\n\n    // \u8ba1\u7b97\u4e0b\u4e00\u5206\u949f\u7684\u5f00\u59cb\u65f6\u95f4\n    nextMinute := now.Truncate(time.Minute).Add(time.Minute)\n\n    // \u8ba1\u7b97\u9700\u8981\u7b49\u5f85\u7684\u65f6\u95f4\n    waitTime := nextMinute.Sub(now)\n\n    // \u7b49\u5f85\u5230\u4e0b\u4e00\u5206\u949f\u7684\u5f00\u59cb\u65f6\u95f4\n    time.Sleep(waitTime)\n\n    // \u4f7f\u7528\u4e00\u4e2a\u65e0\u9650\u5faa\u73af\u6765\u63a7\u5236\u65b9\u6cd5\u7684\u6267\u884c\n    for {\n        // \u6267\u884c\u4f60\u7684\u65b9\u6cd5\n        fmt.Println(\"\u6267\u884c\u65b9\u6cd5\")\n\n        // \u7b49\u5f85\u5b9a\u65f6\u5668\u7684\u4e0b\u4e00\u6b21\u89e6\u53d1\u4e8b\u4ef6\n        &lt;-ticker.C\n\n        // \u8ba1\u7b97\u4e0b\u4e00\u5206\u949f\u7684\u5f00\u59cb\u65f6\u95f4\n        nextMinute = nextMinute.Add(time.Minute)\n\n        // \u8ba1\u7b97\u9700\u8981\u7b49\u5f85\u7684\u65f6\u95f4\n        waitTime = nextMinute.Sub(time.Now())\n\n        // \u7b49\u5f85\u5230\u4e0b\u4e00\u5206\u949f\u7684\u5f00\u59cb\u65f6\u95f4\n        time.Sleep(waitTime)\n    }\n}\n</code></pre>","tags":["prometheus","monitor","golang"]},{"location":"blog/2023/08/08/golang%E5%AE%9A%E6%97%B6%E5%99%A8/#3-timetimer","title":"3\u3001\u65b9\u5f0f\u4e8c time.Timer","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc main() {\n    // \u83b7\u53d6\u5f53\u524d\u65f6\u95f4\n    now := time.Now()\n\n    // \u8ba1\u7b97\u4e0b\u4e00\u5206\u949f\u7684\u5f00\u59cb\u65f6\u95f4\n    nextMinute := now.Truncate(time.Minute).Add(time.Minute)\n\n    // \u8ba1\u7b97\u9700\u8981\u7b49\u5f85\u7684\u65f6\u95f4\n    waitTime := nextMinute.Sub(now)\n\n    // \u521b\u5efa\u4e00\u4e2a\u5b9a\u65f6\u5668\uff0c\u5728\u7b49\u5f85\u65f6\u95f4\u7ed3\u675f\u540e\u6267\u884c\u4efb\u52a1\n    timer := time.NewTimer(waitTime)\n\n    // \u4f7f\u7528\u4e00\u4e2a\u65e0\u9650\u5faa\u73af\u6765\u63a7\u5236\u534f\u7a0b\u7684\u6267\u884c\n    for {\n        &lt;-timer.C // \u7b49\u5f85\u5b9a\u65f6\u5668\u7684\u89e6\u53d1\u4e8b\u4ef6\n\n        // \u6267\u884c\u4f60\u7684\u534f\u7a0b\u4efb\u52a1\n        go func() {\n            fmt.Println(\"\u6267\u884c\u534f\u7a0b\u4efb\u52a1\")\n            // \u5728\u8fd9\u91cc\u7f16\u5199\u4f60\u7684\u534f\u7a0b\u4efb\u52a1\u903b\u8f91\n        }()\n\n        // \u8ba1\u7b97\u4e0b\u4e00\u5206\u949f\u7684\u5f00\u59cb\u65f6\u95f4\n        nextMinute = nextMinute.Add(time.Minute)\n\n        // \u91cd\u65b0\u8ba1\u7b97\u9700\u8981\u7b49\u5f85\u7684\u65f6\u95f4\n        waitTime = nextMinute.Sub(time.Now())\n\n        // \u91cd\u7f6e\u5b9a\u65f6\u5668\n        timer.Reset(waitTime)\n    }\n}\n</code></pre>","tags":["prometheus","monitor","golang"]},{"location":"blog/2023/08/08/golang%E5%AE%9A%E6%97%B6%E5%99%A8/#4gpt","title":"4\u3001\u8fd9\u4e24\u79cd\u65b9\u5f0f\u7684\u533a\u522b\uff0cgpt\u7ed9\u7684\u7b54\u6848\uff0c\u8bf7\u5404\u4f4d\u81ea\u884c\u659f\u914c","text":"<ul> <li>time.NewTimer\uff1a</li> </ul> <p>time.NewTimer \u521b\u5efa\u4e00\u4e2a\u5355\u6b21\u89e6\u53d1\u7684\u5b9a\u65f6\u5668\uff0c\u5b83\u5728\u6307\u5b9a\u7684\u65f6\u95f4\u95f4\u9694\u8fc7\u540e\u89e6\u53d1\u4e00\u6b21\u3002 \u9002\u7528\u4e8e\u9700\u8981\u5728\u6307\u5b9a\u65f6\u95f4\u95f4\u9694\u540e\u6267\u884c\u4e00\u6b21\u64cd\u4f5c\u7684\u573a\u666f\u3002 \u53ef\u4ee5\u4f7f\u7528 timer.Reset \u65b9\u6cd5\u91cd\u65b0\u8bbe\u7f6e\u5b9a\u65f6\u5668\u7684\u89e6\u53d1\u65f6\u95f4\u3002</p> <ul> <li>time.NewTicker\uff1a</li> </ul> <p>time.NewTicker \u521b\u5efa\u4e00\u4e2a\u91cd\u590d\u89e6\u53d1\u7684\u5b9a\u65f6\u5668\uff0c\u5b83\u4f1a\u4ee5\u56fa\u5b9a\u7684\u65f6\u95f4\u95f4\u9694\u91cd\u590d\u89e6\u53d1\u3002 \u9002\u7528\u4e8e\u9700\u8981\u5b9a\u671f\u6267\u884c\u67d0\u4e2a\u64cd\u4f5c\u7684\u573a\u666f\uff0c\u6bd4\u5982\u6bcf\u9694\u4e00\u6bb5\u65f6\u95f4\u6267\u884c\u4e00\u6b21\u4efb\u52a1\u3002 \u6bcf\u6b21\u89e6\u53d1\u65f6\uff0ctime.Ticker \u7c7b\u578b\u7684\u503c\u4f1a\u53d1\u9001\u4e00\u4e2a\u65f6\u95f4\u5230\u5176\u5185\u90e8\u7684\u901a\u9053 C\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 &lt;-ticker.C \u6765\u7b49\u5f85\u89e6\u53d1\u4e8b\u4ef6\u3002 \u53ef\u4ee5\u4f7f\u7528 ticker.Stop \u65b9\u6cd5\u505c\u6b62\u5b9a\u65f6\u5668\u7684\u89e6\u53d1\u3002</p>","tags":["prometheus","monitor","golang"]},{"location":"blog/2023/08/08/golang%E5%AE%9A%E6%97%B6%E5%99%A8/#5","title":"5\u3001\u4e00\u4e9b\u601d\u8003","text":"<p><pre><code>m := time.Now().Truncate(time.Minute)\nfmt.Printf(\"m:%s\\n\",m )\n\ns := time.Now().Truncate(time.Duration(3600) * time.Second)\nfmt.Printf(\"s:%s\\n\",s )\n</code></pre> \u6267\u884c\u8fd4\u56de\u7ed3\u679c\uff0c\u81ea\u884c\u611f\u53d7\uff0ctime.Now().Truncate()\uff1a</p> <p>m:2023-08-08 11:56:00 +0800 CST</p> <p>s:2023-08-08 11:00:00 +0800 CST</p>","tags":["prometheus","monitor","golang"]},{"location":"blog/2023/03/21/pushGateWay%20%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/","title":"pushGateWay \u9047\u5230\u7684\u4e00\u4e9b\u95ee\u9898","text":"<p>pushGateWay \u9047\u5230\u7684\u4e00\u4e9b\u95ee\u9898</p>","tags":["python","pushGateWay"]},{"location":"blog/2023/03/21/pushGateWay%20%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/#_1","title":"\u524d\u8a00","text":"<p>\u751f\u4ea7\u9047\u5230\u7684\u4e24\u4e2a\u95ee\u9898</p> <ul> <li> <p> \u53d1\u73b0\u901a\u8fc7pgw\u63a8\u9001\u7684metric\u5728\u4e0d\u7ee7\u7eed\u63a8\u9001\u76d1\u63a7\u6570\u636e\u65f6\uff0cprometheus\u4ecd\u7136\u5728\u66f4\u65b0\u6570\u636e\u3002</p> </li> <li> <p> \u901a\u8fc7pgw\u63a8\u9001metric\u90fd\u88ab\u8986\u76d6\u4e86\u3002</p> </li> </ul>","tags":["python","pushGateWay"]},{"location":"blog/2023/03/21/pushGateWay%20%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/#1","title":"1\u3001\u95ee\u9898\u4e00\u7684\u89e3\u51b3\u65b9\u5f0f","text":"","tags":["python","pushGateWay"]},{"location":"blog/2023/03/21/pushGateWay%20%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/#11","title":"1.1\u3001\u67e5\u770b\u6587\u6863","text":"<p>\u5b98\u65b9\u6587\u6863</p> <ul> <li>When monitoring multiple instances through a single Pushgateway, the Pushgateway becomes both a single point of failure and a potential bottleneck.</li> <li>You lose Prometheus's automatic instance health monitoring via the up metric (generated on every scrape).</li> <li>The Pushgateway never forgets series pushed to it and will expose them to Prometheus forever unless those series are manually deleted via the Pushgateway's API.</li> </ul>","tags":["python","pushGateWay"]},{"location":"blog/2023/03/21/pushGateWay%20%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/#12","title":"1.2\u3001\u89e3\u51b3\u65b9\u5f0f","text":"<p>\u53ea\u80fd\u901a\u8fc7pushgateway\u7684api\u6765\u5220\u9664metric\uff0c\u901a\u8fc7prometheus\u7684api\u5220\u4e0d\u6389 \u5168\u5220\u548c\u5c40\u90e8\u5220\uff0c\u8def\u5f84\u89c4\u5219\u53c2\u8003 <pre><code>curl -X PUT http://127.0.0.1:9099/api/v1/admin/wipe    \n\ncurl -X DELETE http://127.0.0.1:9099/metrics/job/auto_wx_friend_from_pgw/process_name/5ENDU19620000906/grouping_src_instance/192.168.61.153\n</code></pre></p>","tags":["python","pushGateWay"]},{"location":"blog/2023/03/21/pushGateWay%20%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/#2","title":"2\u3001\u95ee\u9898\u4e8c\u7684\u89e3\u51b3\u65b9\u5f0f","text":"<p>\u53c2\u8003</p>","tags":["python","pushGateWay"]},{"location":"blog/2023/03/21/pushGateWay%20%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/#21","title":"2.1\u3001\u63a8\u9001\u4ee3\u7801","text":"<pre><code>from prometheus_client import CollectorRegistry, Gauge, push_to_gateway\nimport socket\n\n\nclass PushGateWayPrometheus:\n    \"\"\"\n    pushgateway\n    \"\"\"\n\n    def __init__(self):\n        self.registry = CollectorRegistry()\n        self.gateway = '192.168.60.203:9099'\n        # label \u548c value \u5bf9\u5e94\n        self.label_name = ['src_instance', 'process_name']\n        self.src_ip_label_value = socket.gethostbyname(socket.gethostname())\n        # \u65e0\u9700\u4fee\u6539\n        self.job = 'auto_wx_friend_from_pgw'\n        self.request_timeout = 5\n\n    def gauge_process_alive(self, metric_name: str, describe: str, process_name: str) -&gt; None:\n        \"\"\"\n        \u5982\u679c\u5bf9\u5e94\u503c\u8bbe\u7f6e\u4e3a1\uff0c\u5219\u8868\u793a\u5e94\u7528\u4ecd\u7136\u5b58\u6d3b\n        :param metric_name:\n        :param describe:\n        :return:\n        \"\"\"\n        g = Gauge(metric_name, describe, registry=self.registry,\n                  labelnames=self.label_name)\n        g.labels(self.src_ip_label_value, process_name).set(1)\n\n    def push(self, metric_name: str, describe: str, process_name: str) -&gt; None:\n        \"\"\"\n        \u63a8\u9001\u5bf9\u5e94\u7684\u6307\u6807\uff0c\u5982\u679c\u6709\u65b0\u7684\u53ea\u9700\u65b0\u589e\n        :param metric_name:\n        :param describe:\n        :return:\n        \"\"\"\n        self.gauge_process_alive(metric_name, describe, process_name)\n        push_to_gateway(self.gateway, job=self.job, registry=self.registry, timeout=self.request_timeout,\n                        grouping_key={\"process_name\": process_name, \"grouping_src_instance\": self.src_ip_label_value})\n\n\n# \u4e0d\u7528\u52a8\nPushGateWayPrometheus().push('job_last_success_unixtime', 'Last time a batch job successfully finished',\n                             'ce0717179055de32027e')\nPushGateWayPrometheus().push('job_last_success_unixtime', 'Last time a batch job successfully finished',\n                             '5ENDU19620000906')\nPushGateWayPrometheus().push('job_last_success_unixtime', 'Last time a batch job successfully finished',\n                             'ce071717fdf178a20c7e')\n</code></pre>","tags":["python","pushGateWay"]},{"location":"blog/2023/03/21/pushGateWay%20%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/#22grouping_keygrouping_keyjob","title":"2.2\u3001\u6307\u5b9agrouping_key\uff0c\u6839\u636egrouping_key\u4e2d\u7684\u503c\u8fdb\u884c\u5206\u7ec4\uff0c\u9ed8\u8ba4\u5c31\u662f\u6839\u636ejob\u8fdb\u884c\u5206\u7ec4","text":"<pre><code>grouping_key={\"process_name\": process_name, \"grouping_src_instance\": self.src_ip_label_value}\n</code></pre>","tags":["python","pushGateWay"]},{"location":"blog/2023/03/21/pushGateWay%20%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/#23","title":"2.3\u3001\u6b64\u65f6\u53ef\u4ee5\u770b\u770b\u4e0a\u4f20\u76d1\u63a7\u9879\u540e\u4ea7\u751f\u4e86\u591a\u5c11\u6570\u636e","text":"<p><pre><code>[root@www pushgateway-1.5.1.linux-amd64]# curl -s \"http://192.168.60.203:9099/metrics\"|grep \"auto_wx_friend_from_pgw\"\njob_last_success_unixtime{grouping_src_instance=\"192.168.61.153\",instance=\"\",job=\"auto_wx_friend_from_pgw\",process_name=\"5ENDU19620000906\",src_instance=\"192.168.61.153\"} 1\njob_last_success_unixtime{grouping_src_instance=\"192.168.61.153\",instance=\"\",job=\"auto_wx_friend_from_pgw\",process_name=\"ce0717179055de32027e\",src_instance=\"192.168.61.153\"} 1\njob_last_success_unixtime{grouping_src_instance=\"192.168.61.153\",instance=\"\",job=\"auto_wx_friend_from_pgw\",process_name=\"ce071717fdf178a20c7e\",src_instance=\"192.168.61.153\"} 1\npush_failure_time_seconds{grouping_src_instance=\"192.168.61.153\",instance=\"\",job=\"auto_wx_friend_from_pgw\",process_name=\"5ENDU19620000906\"} 0\npush_failure_time_seconds{grouping_src_instance=\"192.168.61.153\",instance=\"\",job=\"auto_wx_friend_from_pgw\",process_name=\"ce0717179055de32027e\"} 0\npush_failure_time_seconds{grouping_src_instance=\"192.168.61.153\",instance=\"\",job=\"auto_wx_friend_from_pgw\",process_name=\"ce071717fdf178a20c7e\"} 0\npush_time_seconds{grouping_src_instance=\"192.168.61.153\",instance=\"\",job=\"auto_wx_friend_from_pgw\",process_name=\"5ENDU19620000906\"} 1.6793950591862314e+09\npush_time_seconds{grouping_src_instance=\"192.168.61.153\",instance=\"\",job=\"auto_wx_friend_from_pgw\",process_name=\"ce0717179055de32027e\"} 1.6793950501798096e+09\npush_time_seconds{grouping_src_instance=\"192.168.61.153\",instance=\"\",job=\"auto_wx_friend_from_pgw\",process_name=\"ce071717fdf178a20c7e\"} 1.6793950681916375e+09\n</code></pre> \u6211\u53ea\u8981\u5224\u65ad\u5e94\u7528\u662f\u5426\u5b58\u6d3b\u5c31\u591f\u4e86\uff0c\u6240\u4ee5\u53ea\u8981push_time_seconds{}\u7684\u4e0a\u4f20\u65f6\u95f4\u8db3\u591f\u5c0f\u5c31\u884c\u3002</p>","tags":["python","pushGateWay"]},{"location":"blog/2023/09/11/python%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/","title":"python\u5355\u4f8b\u6a21\u5f0f","text":"<p>python\u5355\u4f8b\u6a21\u5f0f\u8bb0\u5f55</p>","tags":["python","\u5355\u4f8b\u6a21\u5f0f"]},{"location":"blog/2023/09/11/python%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/#1","title":"1\u3001\u5355\u4f8b\u6a21\u5f0f\u7684\u5e94\u7528\u573a\u666f","text":"<p>\u8d44\u6e90\u5171\u4eab\uff1a\u5f53\u591a\u4e2a\u5bf9\u8c61\u9700\u8981\u5171\u4eab\u540c\u4e00\u4e2a\u8d44\u6e90\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u5355\u4f8b\u6a21\u5f0f\u6765\u7ba1\u7406\u8be5\u8d44\u6e90\u7684\u8bbf\u95ee\u3002\u4f8b\u5982\uff0c\u6570\u636e\u5e93\u8fde\u63a5\u6c60\u3001\u65e5\u5fd7\u8bb0\u5f55\u5668\u7b49\u3002</p> <p>\u914d\u7f6e\u4fe1\u606f\uff1a\u5f53\u9700\u8981\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5171\u4eab\u914d\u7f6e\u4fe1\u606f\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u5355\u4f8b\u6a21\u5f0f\u6765\u4fdd\u5b58\u548c\u8bbf\u95ee\u914d\u7f6e\u5bf9\u8c61\u3002\u8fd9\u6837\u53ef\u4ee5\u786e\u4fdd\u914d\u7f6e\u4fe1\u606f\u7684\u4e00\u81f4\u6027\u548c\u5168\u5c40\u53ef\u8bbf\u95ee\u6027\u3002</p> <p>\u7f13\u5b58\u7ba1\u7406\uff1a\u5728\u9700\u8981\u7f13\u5b58\u6570\u636e\u7684\u573a\u666f\u4e2d\uff0c\u53ef\u4ee5\u4f7f\u7528\u5355\u4f8b\u6a21\u5f0f\u6765\u7ba1\u7406\u7f13\u5b58\u5bf9\u8c61\u3002\u8fd9\u6837\u53ef\u4ee5\u907f\u514d\u91cd\u590d\u521b\u5efa\u7f13\u5b58\u5bf9\u8c61\uff0c\u63d0\u9ad8\u6027\u80fd\u548c\u8d44\u6e90\u5229\u7528\u7387\u3002</p> <p>\u5bf9\u8bdd\u6846\u6216\u7a97\u53e3\u7ba1\u7406\uff1a\u5728\u56fe\u5f62\u7528\u6237\u754c\u9762\uff08GUI\uff09\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u53ef\u4ee5\u4f7f\u7528\u5355\u4f8b\u6a21\u5f0f\u6765\u7ba1\u7406\u5bf9\u8bdd\u6846\u6216\u7a97\u53e3\u5bf9\u8c61\u3002\u8fd9\u6837\u53ef\u4ee5\u786e\u4fdd\u53ea\u6709\u4e00\u4e2a\u5b9e\u4f8b\u5bf9\u8c61\u5b58\u5728\uff0c\u5e76\u4e14\u53ef\u4ee5\u65b9\u4fbf\u5730\u8fdb\u884c\u8bbf\u95ee\u548c\u63a7\u5236\u3002</p> <p>\u65e5\u5fd7\u8bb0\u5f55\uff1a\u5728\u9700\u8981\u8bb0\u5f55\u5e94\u7528\u7a0b\u5e8f\u65e5\u5fd7\u7684\u573a\u666f\u4e2d\uff0c\u53ef\u4ee5\u4f7f\u7528\u5355\u4f8b\u6a21\u5f0f\u6765\u7ba1\u7406\u65e5\u5fd7\u8bb0\u5f55\u5668\u5bf9\u8c61\u3002\u8fd9\u6837\u53ef\u4ee5\u786e\u4fdd\u53ea\u6709\u4e00\u4e2a\u65e5\u5fd7\u8bb0\u5f55\u5668\u5b9e\u4f8b\uff0c\u5e76\u4e14\u53ef\u4ee5\u5728\u6574\u4e2a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u65b9\u4fbf\u5730\u4f7f\u7528\u3002</p>","tags":["python","\u5355\u4f8b\u6a21\u5f0f"]},{"location":"blog/2023/09/11/python%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/#2","title":"2\u3001\u5f53\u4e00\u4e2a\u7c7b\u5b9a\u4e49\u88ab\u6267\u884c\u65f6\uff0c\u5c06\u53d1\u751f\u4ee5\u4e0b\u6b65\u9aa4:","text":"<p>\u89e3\u6790 MRO \u6761\u76ee \u786e\u5b9a\u9002\u5f53\u7684\u5143\u7c7b \u51c6\u5907\u7c7b\u547d\u540d\u7a7a\u95f4 \u6267\u884c\u7c7b\u4e3b\u4f53 \u521b\u5efa\u7c7b\u5bf9\u8c61 \u53c2\u8003\uff1ahttps://docs.python.org/zh-cn/3.7/reference/datamodel.html#customizing-class-creation</p>","tags":["python","\u5355\u4f8b\u6a21\u5f0f"]},{"location":"blog/2023/09/11/python%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/#3new","title":"3\u3001new()","text":"<p>\u8c03\u7528\u4ee5\u521b\u5efa\u4e00\u4e2a cls \u7c7b\u7684\u65b0\u5b9e\u4f8b\u3002</p> <p>new() \u662f\u4e00\u4e2a\u9759\u6001\u65b9\u6cd5 (\u56e0\u4e3a\u662f\u7279\u4f8b\u6240\u4ee5\u4f60\u4e0d\u9700\u8981\u663e\u5f0f\u5730\u58f0\u660e)\uff0c\u5b83\u4f1a\u5c06\u6240\u8bf7\u6c42\u5b9e\u4f8b\u6240\u5c5e\u7684\u7c7b\u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u53c2\u6570\u3002\u5176\u4f59\u7684\u53c2\u6570\u4f1a\u88ab\u4f20\u9012\u7ed9\u5bf9\u8c61\u6784\u9020\u5668\u8868\u8fbe\u5f0f (\u5bf9\u7c7b\u7684\u8c03\u7528)\u3002new() \u7684\u8fd4\u56de\u503c\u5e94\u4e3a\u65b0\u5bf9\u8c61\u5b9e\u4f8b (\u901a\u5e38\u662f cls \u7684\u5b9e\u4f8b)\u3002</p> <p>\u5982\u679c new() \u8fd4\u56de\u4e00\u4e2a cls \u7684\u5b9e\u4f8b\uff0c\u5219\u65b0\u5b9e\u4f8b\u7684 init() \u65b9\u6cd5\u4f1a\u5728\u4e4b\u540e\u88ab\u6267\u884c\uff0c\u4f8b\u5982 init(self[, ...])\uff0c\u5176\u4e2d self \u4e3a\u65b0\u5b9e\u4f8b\uff0c\u5176\u4f59\u7684\u53c2\u6570\u4e0e\u88ab\u4f20\u9012\u7ed9 new() \u7684\u76f8\u540c\u3002</p> <p>\u5982\u679c new() \u672a\u8fd4\u56de\u4e00\u4e2a cls \u7684\u5b9e\u4f8b\uff0c\u5219\u65b0\u5b9e\u4f8b\u7684 init() \u65b9\u6cd5\u5c31\u4e0d\u4f1a\u88ab\u6267\u884c\u3002</p>","tags":["python","\u5355\u4f8b\u6a21\u5f0f"]},{"location":"blog/2023/09/11/python%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/#4init","title":"4\u3001init()","text":"<p>\u5728\u5b9e\u4f8b (\u901a\u8fc7 new()) \u88ab\u521b\u5efa\u4e4b\u540e\uff0c\u8fd4\u56de\u8c03\u7528\u8005\u4e4b\u524d\u8c03\u7528\u3002\u5176\u53c2\u6570\u4e0e\u4f20\u9012\u7ed9\u7c7b\u6784\u9020\u5668\u8868\u8fbe\u5f0f\u7684\u53c2\u6570\u76f8\u540c\u3002\u4e00\u4e2a\u57fa\u7c7b\u5982\u679c\u6709 init() \u65b9\u6cd5\uff0c\u5219\u5176\u6240\u6d3e\u751f\u7684\u7c7b\u5982\u679c\u4e5f\u6709 init() \u65b9\u6cd5\uff0c\u5c31\u5fc5\u987b\u663e\u5f0f\u5730\u8c03\u7528\u5b83\u4ee5\u786e\u4fdd\u5b9e\u4f8b\u57fa\u7c7b\u90e8\u5206\u7684\u6b63\u786e\u521d\u59cb\u5316\uff1b\u4f8b\u5982: super().init([args...]).</p> <p>\u56e0\u4e3a\u5bf9\u8c61\u662f\u7531 new() \u548c init() \u534f\u4f5c\u6784\u9020\u5b8c\u6210\u7684 (\u7531 new() \u521b\u5efa\uff0c\u5e76\u7531 init() \u5b9a\u5236)\uff0c\u6240\u4ee5 init() \u8fd4\u56de\u7684\u503c\u53ea\u80fd\u662f None\uff0c\u5426\u5219\u4f1a\u5728\u8fd0\u884c\u65f6\u5f15\u53d1 TypeError\u3002</p>","tags":["python","\u5355\u4f8b\u6a21\u5f0f"]},{"location":"blog/2023/09/11/python%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/#5","title":"5\u3001\u975e\u7ebf\u7a0b\u5b89\u5168\u7684\u5355\u4f8b\u6a21\u5f0f","text":"\u975e\u7ebf\u7a0b\u5b89\u5168 <pre><code>import time\n\n\nclass Singleton:\n    _instance = None\n\n    def __new__(cls, *args, **kwargs):\n        if not cls._instance:\n            time.sleep(1)\n            cls._instance = super().__new__(cls, *args, **kwargs)\n        return cls._instance\n\n#instance1 = Singleton()\n#instance2 = Singleton()\n\n#print(instance1 is instance2)  # \u8f93\u51fa: True\n\nimport threading\ndef create_singleton():\n    instance = Singleton()\n    print(instance)\n\nthreads = []\nfor _ in range(10):\n    t = threading.Thread(target=create_singleton)\n    threads.append(t)\n    t.start()\n\nfor t in threads:\n    t.join()\n\n\n&lt;__main__.Singleton object at 0x7f8269c91f60&gt;\n&lt;__main__.Singleton object at 0x7f8269c91000&gt;\n&lt;__main__.Singleton object at 0x7f8269c90df0&gt;\n&lt;__main__.Singleton object at 0x7f8269c90be0&gt;\n&lt;__main__.Singleton object at 0x7f8269c909d0&gt;\n&lt;__main__.Singleton object at 0x7f8269c907c0&gt;\n&lt;__main__.Singleton object at 0x7f8269c905b0&gt;\n&lt;__main__.Singleton object at 0x7f8269c903a0&gt;\n&lt;__main__.Singleton object at 0x7f8269c90190&gt;\n&lt;__main__.Singleton object at 0x7f8269c91d20&gt;\n</code></pre>","tags":["python","\u5355\u4f8b\u6a21\u5f0f"]},{"location":"blog/2023/09/11/python%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/#6","title":"6\u3001\u7ebf\u7a0b\u5b89\u5168\u7684\u5355\u4f8b\u6a21\u5f0f","text":"\u7ebf\u7a0b\u5b89\u5168\u7684 <pre><code>import threading\n\nclass Singleton:\n    _instance = None\n    _lock = threading.Lock()\n\n    def __new__(cls, *args, **kwargs):\n        thread_id = threading.current_thread()\n        if not cls._instance:\n            print(\"\u6211\u518d\u7b49\u5f85\u7740\", thread_id)\n\n            with cls._lock:\n                print(\"\u6211\u8fdb\u6765\u4e86\",thread_id)\n                if not cls._instance:\n                    cls._instance = super().__new__(cls, *args, **kwargs)\n        print(\"\u6211\u76f4\u63a5\u8fd4\u56de\u4e86\", thread_id)\n        return cls._instance\n\n\ndef create_singleton():\n    instance = Singleton()\n    print(instance)\n\nthreads = []\nfor _ in range(10):\n    t = threading.Thread(target=create_singleton)\n    threads.append(t)\n    t.start()\n\nfor t in threads:\n    t.join()\n\n\n\n\u6211\u518d\u7b49\u5f85\u7740 &lt;Thread(Thread-1 (create_singleton), started 139852282197760)&gt;\n\u6211\u8fdb\u6765\u4e86 &lt;Thread(Thread-1 (create_singleton), started 139852282197760)&gt;\n\u6211\u76f4\u63a5\u8fd4\u56de\u4e86 &lt;Thread(Thread-1 (create_singleton), started 139852282197760)&gt;\n&lt;__main__.Singleton object at 0x7f31e59b90c0&gt;\n\n\n\u6211\u76f4\u63a5\u8fd4\u56de\u4e86 &lt;Thread(Thread-2 (create_singleton), started 139852282197760)&gt;\n&lt;__main__.Singleton object at 0x7f31e59b90c0&gt;\n\n\n\u6211\u76f4\u63a5\u8fd4\u56de\u4e86 &lt;Thread(Thread-3 (create_singleton), started 139852282197760)&gt;\n&lt;__main__.Singleton object at 0x7f31e59b90c0&gt;\n\n\n\u6211\u76f4\u63a5\u8fd4\u56de\u4e86 &lt;Thread(Thread-4 (create_singleton), started 139852282197760)&gt;\n&lt;__main__.Singleton object at 0x7f31e59b90c0&gt;\n\n\n\u6211\u76f4\u63a5\u8fd4\u56de\u4e86 &lt;Thread(Thread-5 (create_singleton), started 139852282197760)&gt;\n&lt;__main__.Singleton object at 0x7f31e59b90c0&gt;\n\n\n\u6211\u76f4\u63a5\u8fd4\u56de\u4e86 &lt;Thread(Thread-6 (create_singleton), started 139852282197760)&gt;\n&lt;__main__.Singleton object at 0x7f31e59b90c0&gt;\n\n\n\u6211\u76f4\u63a5\u8fd4\u56de\u4e86 &lt;Thread(Thread-7 (create_singleton), started 139852282197760)&gt;\n&lt;__main__.Singleton object at 0x7f31e59b90c0&gt;\n\n\n\u6211\u76f4\u63a5\u8fd4\u56de\u4e86 &lt;Thread(Thread-8 (create_singleton), started 139852282197760)&gt;\n&lt;__main__.Singleton object at 0x7f31e59b90c0&gt;\n\n\n\u6211\u76f4\u63a5\u8fd4\u56de\u4e86 &lt;Thread(Thread-9 (create_singleton), started 139852282197760)&gt;\n&lt;__main__.Singleton object at 0x7f31e59b90c0&gt;\n\n\n\u6211\u76f4\u63a5\u8fd4\u56de\u4e86 &lt;Thread(Thread-10 (create_singleton), started 139852282197760)&gt;\n&lt;__main__.Singleton object at 0x7f31e59b90c0&gt;\n</code></pre>","tags":["python","\u5355\u4f8b\u6a21\u5f0f"]},{"location":"blog/2023/09/11/python%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/#7","title":"7\u3001\u53c2\u8003","text":"<p>https://docs.python.org/zh-cn/3.7/library/threading.html#using-locks-conditions-and-semaphores-in-the-with-statement</p> <p>https://docs.python.org/zh-cn/3.7/library/threading.html#lock-objects</p>","tags":["python","\u5355\u4f8b\u6a21\u5f0f"]},{"location":"blog/2023/12/20/simple%20ui%20%E8%87%AA%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7%E8%8F%9C%E5%8D%95%E6%9D%83%E9%99%90/","title":"simple ui \u81ea\u5b9a\u4e49\u7528\u6237\u83dc\u5355\u6743\u9650","text":"<p>simple ui \u81ea\u5b9a\u4e49\u7528\u6237\u83dc\u5355\u6743\u9650.</p>","tags":["simple ui","django","\u81ea\u5b9a\u4e49\u6743\u9650"]},{"location":"blog/2023/12/20/simple%20ui%20%E8%87%AA%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7%E8%8F%9C%E5%8D%95%E6%9D%83%E9%99%90/#_1","title":"\u524d\u8a00","text":"<p>\u672c\u6765\u4e0d\u60f3\u6539simple ui\u7684\u83dc\u5355\u7684\uff0c\u4f46\u662f\u6709\u4e9b\u6d01\u7656\u771f\u7684\u5fcd\u4e0d\u4e86\uff0c\u5c31\u6bd4\u5982\u5c06\u7684group\u7684\u6982\u5ff5\u6539\u6210\u4e86\u81ea\u5df1\u60f3\u8c61\u4e2d\u7684role\u4e4b\u540e\uff0c\u5728\u9ed8\u8ba4\u7684simple UI\u4e2d\u81ea\u5e26\u7684group\u548crole\u4e0d\u5728\u4e00\u4e2a\u83dc\u5355\u4e0b\u9762\uff0c\u4e5f\u5c1d\u8bd5\u81ea\u5b9a\u4e49\u4e86group\uff0c\u540e\u679c\u5c31\u662f\u5f88\u591a\u65b9\u6cd5\u90fd\u9700\u8981\u81ea\u5df1\u53bb\u5b9e\u73b0\uff0c\u7206\u70b8\u3002</p> <p>\u6743\u9650\u5728\u7528\u6237\u548c\u89d2\u8272\u91cc\u9762\u8fdb\u884c\u914d\u7f6e\uff0c\u6ca1\u6709\u6743\u9650\u7684\u83dc\u5355\u548c\u6309\u94ae\u90fd\u4e0d\u4f1a\u5c55\u793a\u3002</p> <p>\u6211\u8fd9\u4e2a\u53ea\u662f\u5f88\u7b80\u5355\u7684\u6539\u6cd5\uff0c\u8981\u60f3\u66f4\u591a\u529f\u80fd\u8fd8\u662f\u8d2d\u4e70\u4ed8\u8d39\u7248\u5427\uff0c\u5144\u5f1f\u4eec\u3002</p>","tags":["simple ui","django","\u81ea\u5b9a\u4e49\u6743\u9650"]},{"location":"blog/2023/12/20/simple%20ui%20%E8%87%AA%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7%E8%8F%9C%E5%8D%95%E6%9D%83%E9%99%90/#1","title":"1\u3001\u6a21\u578b","text":"<pre><code>class MyUser(AbstractBaseUser, PermissionsMixin):\n    email = models.EmailField(verbose_name='\u90ae\u4ef6\u5730\u5740', max_length=255, unique=True)\n    phone = models.CharField('\u624b\u673a\u53f7\u7801', max_length=20, help_text='\u624b\u673a\u53f7\u7801')\n    date_of_birth = models.DateTimeField('\u521b\u5efa\u65f6\u95f4', default=timezone.now)\n    name = models.CharField('\u540d\u5b57', max_length=20)\n    is_active = models.BooleanField(default=True)\n    is_admin = models.BooleanField('\u662f\u5426\u53ef\u4ee5\u767b\u5f55\u540e\u53f0', default=False)  # \u8fd9\u4e2a\u914d\u7f6e\u51b3\u5b9a\u7528\u6237\u662f\u5426\u53ef\u4ee5\u767b\u5f55\u540e\u53f0,\u4e0d\u80fd\u6240\u6709\u6743\u9650\u90fd\u7ed9superuser\n\n    objects = MyUserManager()\n\n    USERNAME_FIELD = 'email'\n    REQUIRED_FIELDS = ['name', 'phone']\n\n    def __str__(self):\n        return self.name\n\n    @property\n    def is_staff(self):\n        return self.is_admin\n\n    class Meta:  # \u7ed9\u6a21\u578b\u589e\u52a0\u6743\u9650\n        verbose_name = \"\u7528\u6237\"\n        verbose_name_plural = \"\u7528\u6237\u4eec\"\n        permissions = [\n            (\"list_user\", \"Can change the status of tasks\"),\n            (\"close_user\", \"Can remove a task by setting its status as closed\"),\n        ]\n\n\nclass Menu(models.Model):\n    \"\"\"\n    \u83dc\u5355\n    \"\"\"\n    type_choice = (\n        ('interface', '\u63a5\u53e3'),\n        ('menu', '\u83dc\u5355')\n    )\n    name = models.CharField(max_length=30, unique=True, db_index=True, verbose_name=\"\u83dc\u5355\u540d\")\n    icon = models.CharField(max_length=50, null=True, blank=True, verbose_name=\"\u56fe\u6807\")\n    path = models.CharField(max_length=255, null=True, blank=True, verbose_name=\"\u94fe\u63a5\u5730\u5740\")\n    type = models.CharField(max_length=30, null=True, blank=True, db_index=True, choices=type_choice,\n                            verbose_name='\u7c7b\u578b')\n    is_show = models.BooleanField(default=True, db_index=True, verbose_name=\"\u662f\u5426\u663e\u793a\")\n    sort = models.IntegerField(null=True, blank=True, db_index=True, verbose_name=\"\u6392\u5e8f\u6807\u8bb0\")\n    pid = models.ForeignKey('self', null=True, blank=True, on_delete=models.SET_NULL, verbose_name=\"\u7236\u83dc\u5355\")\n\n    def __str__(self):\n        return self.name\n\n    class Meta:\n        verbose_name = '\u83dc\u5355'\n        verbose_name_plural = verbose_name\n        ordering = ['id']\n</code></pre>","tags":["simple ui","django","\u81ea\u5b9a\u4e49\u6743\u9650"]},{"location":"blog/2023/12/20/simple%20ui%20%E8%87%AA%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7%E8%8F%9C%E5%8D%95%E6%9D%83%E9%99%90/#2simple-ui","title":"2\u3001simple ui\u7684\u83dc\u5355\u914d\u7f6e","text":"<pre><code>SIMPLEUI_CONFIG = {\n    'dynamic': False,\n    'menus': [],\n}\n</code></pre>","tags":["simple ui","django","\u81ea\u5b9a\u4e49\u6743\u9650"]},{"location":"blog/2023/12/20/simple%20ui%20%E8%87%AA%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7%E8%8F%9C%E5%8D%95%E6%9D%83%E9%99%90/#3","title":"3\u3001\u5728\u4e2d\u95f4\u4ef6\u4e2d\u63a7\u5236\u83dc\u5355","text":"<pre><code>class MenuMiddleware(MiddlewareMixin):\n    \"\"\"\n    \u81ea\u5b9a\u4e49\u5de6\u8fb9\u7684\u83dc\u5355\u680f\n    \"\"\"\n\n    def process_request(self, request):\n        current_user = request.user\n        perms = current_user.get_all_permissions()\n        perms_list = set()  # /admin/app_label/model_name/, \u7528\u8fd9\u79cd\u65b9\u5f0f\u6a21\u578b\u7684\u547d\u540d\u89c4\u5219\u4e00\u5b9a\u8981\u89c4\u8303\uff0c\u5426\u5219\u5339\u914d\u5931\u8d25\n        for permission in perms:\n            app = permission.split('.')[0]\n            module = permission.split('.')[1].split('_')[1]\n            path = f'/admin/{app}/{module}/'\n            perms_list.add(path)\n\n        from user.models import Menu  # \u7528\u6237\u7684\u6743\u9650\u91cc\u9762\u6709\u6ca1\u6709\u8fd9\u4e2a\u83dc\u5355\n        menu_list = []\n        for _m in Menu.objects.filter(type__exact='menu',\n                                      is_show__exact=True).order_by('sort'):\n            inter_queryset = _m.menu_set.all().filter(is_show__exact=True).order_by('sort')\n            men_dict = {\n                'name': _m.name,\n                'icon': _m.icon,\n                'models': []\n            }\n            for inter in inter_queryset:\n                if inter.path in perms_list:\n                    men_dict['models'].append({\n                        'name': inter.name,\n                        'icon': inter.icon,\n                        'url': inter.path\n                    })\n            if len(men_dict['models']) &gt; 0:\n                menu_list.append(men_dict)\n            settings.SIMPLEUI_CONFIG['menus'] = menu_list\n        return None\n</code></pre>","tags":["simple ui","django","\u81ea\u5b9a\u4e49\u6743\u9650"]},{"location":"blog/2023/12/20/simple%20ui%20%E8%87%AA%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7%E8%8F%9C%E5%8D%95%E6%9D%83%E9%99%90/#4","title":"4\u3001 \u83dc\u5355\u7684\u7ba1\u7406","text":"","tags":["simple ui","django","\u81ea\u5b9a\u4e49\u6743\u9650"]},{"location":"blog/2023/06/11/%E5%B1%9E%E6%80%A7%E3%80%81property%E5%92%8C%E5%B1%9E%E6%80%A7%E6%8F%8F%E8%BF%B0%E7%AC%A6/","title":"\u5c5e\u6027\u3001property\u548c\u5c5e\u6027\u63cf\u8ff0\u7b26","text":"<p>\u5c5e\u6027\u3001property\u548c\u5c5e\u6027\u63cf\u8ff0\u7b26</p>","tags":["python","property"]},{"location":"blog/2023/06/11/%E5%B1%9E%E6%80%A7%E3%80%81property%E5%92%8C%E5%B1%9E%E6%80%A7%E6%8F%8F%E8%BF%B0%E7%AC%A6/#1","title":"1\u3001\u5b9e\u4f8b\u5c5e\u6027\u548c\u7c7b\u5c5e\u6027\u7684\u533a\u522b","text":"<p>\u5728 Python \u4e2d\uff0c\u7c7b\u5c5e\u6027\u662f\u5b9a\u4e49\u5728\u7c7b\u7ea7\u522b\u4e0a\u7684\u53d8\u91cf\u6216\u5e38\u91cf\uff0c\u5b83\u4eec\u662f\u6240\u6709\u8be5\u7c7b\u5b9e\u4f8b\u5171\u4eab\u7684\u503c\u3002\u800c\u5b9e\u4f8b\u5c5e\u6027\u662f\u5b9a\u4e49\u5728\u5b9e\u4f8b\u7ea7\u522b\u4e0a\u7684\u53d8\u91cf\u6216\u5e38\u91cf\uff0c\u6bcf\u4e2a\u5b9e\u4f8b\u90fd\u6709\u5176\u81ea\u5df1\u7684\u503c\u3002</p> <p>\u533a\u522b\u4e3b\u8981\u5728\u4e8e\uff1a</p> <ul> <li> <p> \u503c\u7684\u5b58\u50a8\u4f4d\u7f6e\uff1a\u7c7b\u5c5e\u6027\u5b58\u50a8\u5728\u7c7b\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\uff0c\u800c\u5b9e\u4f8b\u5c5e\u6027\u5b58\u50a8\u5728\u5b9e\u4f8b\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u3002</p> </li> <li> <p> \u8bbf\u95ee\u65b9\u5f0f\uff1a\u7c7b\u5c5e\u6027\u53ef\u4ee5\u901a\u8fc7\u7c7b\u540d\u6216\u5b9e\u4f8b\u8bbf\u95ee\uff0c\u4f46\u5b9e\u4f8b\u5c5e\u6027\u53ea\u80fd\u901a\u8fc7\u5b9e\u4f8b\u8bbf\u95ee\u3002</p> </li> <li> <p> \u7ee7\u627f\uff1a\u5b50\u7c7b\u4f1a\u7ee7\u627f\u7236\u7c7b\u7684\u7c7b\u5c5e\u6027\uff0c\u4f46\u4e0d\u4f1a\u7ee7\u627f\u7236\u7c7b\u7684\u5b9e\u4f8b\u5c5e\u6027\u3002</p> </li> </ul> <p>\u793a\u4f8b\uff1a</p> <p><pre><code>class MyClass:\n    class_attribute = 'class_value'\n\n    def __init__(self, instance_attribute):\n        self.instance_attribute = instance_attribute\n\nmy_instance_1 = MyClass('instance_value_1')\nmy_instance_2 = MyClass('instance_value_2')\n\nprint(MyClass.class_attribute)  # \u8f93\u51fa\uff1a'class_value'\nprint(my_instance_1.class_attribute)  # \u8f93\u51fa\uff1a'class_value'\nprint(my_instance_1.instance_attribute)  # \u8f93\u51fa\uff1a'instance_value_1'\nprint(my_instance_2.instance_attribute)  # \u8f93\u51fa\uff1a'instance_value_2'\n</code></pre> \u5728\u4e0a\u8ff0\u4ee3\u7801\u4e2d\uff0cclass_attribute \u662f\u4e00\u4e2a\u7c7b\u5c5e\u6027\uff0c\u88ab MyClass \u7684\u6240\u6709\u5b9e\u4f8b\u5171\u4eab\u3002\u800c instance_attribute \u5219\u662f\u4e00\u4e2a\u5b9e\u4f8b\u5c5e\u6027\uff0c\u6bcf\u4e2a\u5b9e\u4f8b\u90fd\u6709\u4e00\u4efd\u81ea\u5df1\u7684\u503c\u3002</p>","tags":["python","property"]},{"location":"blog/2023/06/11/%E5%B1%9E%E6%80%A7%E3%80%81property%E5%92%8C%E5%B1%9E%E6%80%A7%E6%8F%8F%E8%BF%B0%E7%AC%A6/#2property","title":"2\u3001property\u5e94\u7528\u573a\u666f","text":"<ul> <li> <p> \u8ba1\u7b97\u5c5e\u6027\uff1a\u6709\u65f6\u5019\u6211\u4eec\u9700\u8981\u6839\u636e\u5bf9\u8c61\u7684\u72b6\u6001\u8ba1\u7b97\u51fa\u67d0\u4e2a\u5c5e\u6027\u7684\u503c\uff0c\u8fd9\u65f6\u5019\u53ef\u4ee5\u4f7f\u7528 property \u5c06\u4e00\u4e2a\u65b9\u6cd5\u8f6c\u6362\u6210\u4e00\u4e2a\u53ea\u8bfb\u5c5e\u6027\uff0c\u4ee5\u4fbf\u5728\u8bbf\u95ee\u8fd9\u4e2a\u5c5e\u6027\u65f6\u52a8\u6001\u8ba1\u7b97\u51fa\u5176\u503c\u3002</p> </li> <li> <p> \u6570\u636e\u6821\u9a8c\uff1a\u5f53\u6211\u4eec\u60f3\u8981\u9650\u5236\u5bf9\u8c61\u7684\u67d0\u4e2a\u5c5e\u6027\u7684\u53d6\u503c\u8303\u56f4\u6216\u683c\u5f0f\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u5c5e\u6027\u7684 setter \u65b9\u6cd5\u5bf9\u8f93\u5165\u6570\u636e\u8fdb\u884c\u6821\u9a8c\uff0c\u5e76\u786e\u4fdd\u5b83\u4eec\u6ee1\u8db3\u8981\u6c42\u3002</p> </li> <li> <p> \u9632\u6b62\u610f\u5916\u4fee\u6539\uff1a\u6709\u65f6\u5019\u6211\u4eec\u5e0c\u671b\u67d0\u4e9b\u5c5e\u6027\u53ea\u80fd\u88ab\u8bfb\u53d6\uff0c\u800c\u4e0d\u80fd\u88ab\u4fee\u6539\uff0c\u53ef\u4ee5\u4f7f\u7528 property \u5c06\u5176\u8bbe\u7f6e\u4e3a\u53ea\u8bfb\u5c5e\u6027\u3002</p> </li> <li> <p> \u5c01\u88c5\u5185\u90e8\u5b9e\u73b0\u7ec6\u8282\uff1a\u5c5e\u6027\u8fd8\u53ef\u4ee5\u7528\u6765\u9690\u85cf\u5bf9\u8c61\u5185\u90e8\u7684\u5b9e\u73b0\u7ec6\u8282\uff0c\u4ece\u800c\u63d0\u9ad8\u4ee3\u7801\u7684\u5b89\u5168\u6027\u548c\u53ef\u7ef4\u62a4\u6027\u3002</p> </li> </ul>","tags":["python","property"]},{"location":"blog/2023/06/11/%E5%B1%9E%E6%80%A7%E3%80%81property%E5%92%8C%E5%B1%9E%E6%80%A7%E6%8F%8F%E8%BF%B0%E7%AC%A6/#3proprety","title":"3\u3001\u5c5e\u6027\u63cf\u8ff0\u7b26\u548cproprety\u7684\u533a\u522b","text":"<p>\u5c5e\u6027\u63cf\u8ff0\u7b26\u548cproperty\u90fd\u662fPython\u4e2d\u7528\u4e8e\u5b9a\u4e49\u7c7b\u5c5e\u6027\u7684\u673a\u5236\uff0c\u4f46\u5b83\u4eec\u7684\u5b9e\u73b0\u65b9\u5f0f\u4e0d\u540c\u3002</p> <p>\u5c5e\u6027\u63cf\u8ff0\u7b26\u662f\u4e00\u4e2a\u7c7b\uff0c\u8be5\u7c7b\u5b9a\u4e49\u4e86\u4e09\u4e2a\u65b9\u6cd5\uff1aget()\u3001set()\u548c__delete__()\u3002\u8fd9\u4e9b\u65b9\u6cd5\u5141\u8bb8\u60a8\u63a7\u5236\u5c5e\u6027\u7684\u8bbf\u95ee\u3001\u4fee\u6539\u548c\u5220\u9664\u3002\u5c5e\u6027\u63cf\u8ff0\u7b26\u53ef\u4ee5\u4e0e\u4efb\u4f55\u7c7b\u5c5e\u6027\u4e00\u8d77\u4f7f\u7528\uff0c\u5e76\u4e14\u4e00\u4e2a\u5c5e\u6027\u63cf\u8ff0\u7b26\u53ef\u4ee5\u88ab\u591a\u4e2a\u7c7b\u5c5e\u6027\u5171\u4eab\u3002\u5f53\u4e00\u4e2a\u5c5e\u6027\u63cf\u8ff0\u7b26\u88ab\u8d4b\u503c\u7ed9\u4e00\u4e2a\u7c7b\u5c5e\u6027\u65f6\uff0c\u5b83\u4f1a\u66ff\u6362\u8be5\u5c5e\u6027\u7684\u9ed8\u8ba4\u884c\u4e3a\u3002\u4f8b\u5982\uff0c\u5728\u4e00\u4e2a\u7c7b\u4e2d\u5b9a\u4e49\u4e00\u4e2a\u5c5e\u6027\u63cf\u8ff0\u7b26\u7528\u4e8e\u9650\u5236\u5c5e\u6027\u7684\u53d6\u503c\u8303\u56f4\uff1a</p> <p><pre><code>class Range:\n    def __init__(self, min_value, max_value):\n        self.min_value = min_value\n        self.max_value = max_value\n\n    def __get__(self, instance, owner):\n        return instance.__dict__[self.name]\n\n    def __set__(self, instance, value):\n        if value &lt; self.min_value or value &gt; self.max_value:\n            raise ValueError(\"Value out of range\")\n        instance.__dict__[self.name] = value\n\n    def __set_name__(self, owner, name):\n        self.name = name\n\nclass MyClass:\n    x = Range(0, 10)\n\nmy_obj = MyClass()\nmy_obj.x = 5\nprint(my_obj.x)\nmy_obj.x = 15 # Raises ValueError: Value out of range\n</code></pre> \u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u5c5e\u6027\u63cf\u8ff0\u7b26Range\u63a7\u5236\u4e86\u5c5e\u6027x\u7684\u53d6\u503c\u8303\u56f4\u3002</p> <p>\u53e6\u4e00\u65b9\u9762\uff0cproperty\u662f\u4e00\u4e2a\u5185\u7f6e\u51fd\u6570\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u79cd\u7b80\u5316\u5c5e\u6027\u8bbf\u95ee\u7684\u65b9\u5f0f\u3002\u4e0e\u5c5e\u6027\u63cf\u8ff0\u7b26\u4e0d\u540c\uff0cproperty\u4e0d\u662f\u4e00\u4e2a\u7c7b\uff0c\u800c\u662f\u4e00\u4e2a\u5305\u88c5\u5668\u51fd\u6570\uff0c\u5b83\u63a5\u53d7\u4e09\u4e2a\u53ef\u9009\u53c2\u6570\uff1afget\u3001fset\u548cfdel\u3002\u8fd9\u4e9b\u53c2\u6570\u5206\u522b\u6307\u5b9a\u83b7\u53d6\u3001\u8bbe\u7f6e\u548c\u5220\u9664\u5c5e\u6027\u65f6\u6240\u8c03\u7528\u7684\u65b9\u6cd5\u3002\u5982\u679c\u53ea\u9700\u8981\u5b9a\u4e49\u8bfb\u53d6\u5c5e\u6027\u7684\u65b9\u6cd5\uff0c\u5219\u53ef\u4ee5\u7701\u7565fset\u548cfdel\u3002\u4f8b\u5982\uff1a</p> <p><pre><code>class MyClass:\n    def __init__(self, x):\n        self._x = x\n\n    @property\n    def x(self):\n        print(\"Getting x\")\n        return self._x\n\n    @x.setter\n    def x(self, value):\n        print(\"Setting x\")\n        self._x = value\n\nmy_obj = MyClass(5)\nprint(my_obj.x) # Calls getter method\nmy_obj.x = 10 # Calls setter method\n</code></pre> \u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0cproperty\u5305\u88c5\u5668\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3ax\u7684\u5c5e\u6027\uff0c\u4f7f\u7528@property\u4fee\u9970\u5668\u6807\u8bb0getter\u65b9\u6cd5\uff0c\u4f7f\u7528@x.setter\u4fee\u9970\u5668\u6807\u8bb0setter\u65b9\u6cd5\u3002\u8fd9\u6837\u5c31\u53ef\u4ee5\u50cf\u8bbf\u95ee\u666e\u901a\u5c5e\u6027\u4e00\u6837\u6765\u8bbf\u95ee\u548c\u4fee\u6539x\u5c5e\u6027\u3002\u5f53\u8bbf\u95eex\u5c5e\u6027\u65f6\uff0c\u4f1a\u81ea\u52a8\u8c03\u7528getter\u65b9\u6cd5\uff1b\u5f53\u4fee\u6539x\u5c5e\u6027\u65f6\uff0c\u4f1a\u81ea\u52a8\u8c03\u7528setter\u65b9\u6cd5\u3002</p> <p>\u603b\u7684\u6765\u8bf4\uff0c\u5c5e\u6027\u63cf\u8ff0\u7b26\u63d0\u4f9b\u4e86\u66f4\u7075\u6d3b\u7684\u5c5e\u6027\u63a7\u5236\u673a\u5236\uff0c\u800cproperty\u5219\u63d0\u4f9b\u4e86\u66f4\u7b80\u5355\u3001\u66f4\u6613\u4e8e\u4f7f\u7528\u7684\u8bed\u6cd5\u7cd6\u3002</p>","tags":["python","property"]},{"location":"blog/2023/06/11/%E5%B1%9E%E6%80%A7%E3%80%81property%E5%92%8C%E5%B1%9E%E6%80%A7%E6%8F%8F%E8%BF%B0%E7%AC%A6/#4","title":"4\u3001\u5c5e\u6027\u63cf\u8ff0\u7b26\u7684\u89e6\u53d1","text":"<p>\u63cf\u8ff0\u7b26\u662f\u4e00\u79cd\u53ef\u4ee5\u81ea\u5b9a\u4e49\u5c5e\u6027\u8bbf\u95ee\u7684\u65b9\u5f0f\uff0c\u5b83\u80fd\u591f\u901a\u8fc7\u5c5e\u6027\u8bbf\u95ee\u6765\u62e6\u622a\u5bf9\u4e00\u4e2a\u5bf9\u8c61\u5c5e\u6027\u7684\u8bfb\u53d6\u64cd\u4f5c\u3001\u8d4b\u503c\u64cd\u4f5c\u6216\u5220\u9664\u64cd\u4f5c\uff0c\u4ece\u800c\u5b9e\u73b0\u81ea\u5b9a\u4e49\u903b\u8f91\u3002\u8981\u60f3\u8bc6\u522b\u5230\u5c5e\u6027\u8c03\u7528\uff0c\u9700\u8981\u5728\u63cf\u8ff0\u7b26\u7c7b\u4e2d\u5b9e\u73b0__get__\u3001__set__\u548c__delete__\u8fd9\u4e09\u4e2a\u65b9\u6cd5\u4e2d\u7684\u81f3\u5c11\u4e00\u4e2a\u3002</p> <p>\u5176\u4e2d\uff0cget(self, instance, owner)\u65b9\u6cd5\u4f1a\u5728\u83b7\u53d6\u5c5e\u6027\u503c\u65f6\u88ab\u8c03\u7528\uff0c\u5b83\u63a5\u6536\u4e24\u4e2a\u53c2\u6570\uff1ainstance\u8868\u793a\u5b9e\u4f8b\u5bf9\u8c61\uff0cowner\u8868\u793a\u5b9a\u4e49\u8be5\u5c5e\u6027\u7684\u7c7b\uff0c\u5982\u679c\u8be5\u5c5e\u6027\u662f\u901a\u8fc7\u7c7b\u76f4\u63a5\u8bbf\u95ee\uff0c\u90a3\u4e48instance\u4e3aNone\uff1b\u5982\u679c\u8be5\u5c5e\u6027\u662f\u901a\u8fc7\u5b9e\u4f8b\u8bbf\u95ee\uff0c\u90a3\u4e48instance\u4e3a\u5b9e\u4f8b\u672c\u8eab\u3002set(self, instance, value)\u65b9\u6cd5\u4f1a\u5728\u7ed9\u5c5e\u6027\u8d4b\u503c\u65f6\u88ab\u8c03\u7528\uff0c\u5b83\u63a5\u6536\u4e09\u4e2a\u53c2\u6570\uff1ainstance\u8868\u793a\u5b9e\u4f8b\u5bf9\u8c61\uff0cvalue\u8868\u793a\u8981\u8d4b\u7684\u503c\u3002delete(self, instance)\u65b9\u6cd5\u4f1a\u5728\u5220\u9664\u5c5e\u6027\u65f6\u88ab\u8c03\u7528\uff0c\u5b83\u63a5\u6536\u4e24\u4e2a\u53c2\u6570\uff1ainstance\u8868\u793a\u5b9e\u4f8b\u5bf9\u8c61\u3002 \u5f53\u4f7f\u7528\u63cf\u8ff0\u7b26\u65f6\uff0c \u53ea\u8981\u5c06\u5176\u4f5c\u4e3a\u4e00\u4e2a\u7c7b\u7684\u5c5e\u6027\uff0c\u90a3\u4e48\u5c31\u80fd\u591f\u5728\u8be5\u5c5e\u6027\u88ab\u8bbf\u95ee\u3001\u8d4b\u503c\u6216\u5220\u9664\u65f6\u81ea\u52a8\u89e6\u53d1\u76f8\u5e94\u7684\u65b9\u6cd5\u3002 \u4f8b\u5982\uff0c\u4e0b\u9762\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u63cf\u8ff0\u7b26\u7c7b\uff0c\u5b83\u80fd\u591f\u8bb0\u5f55\u5c5e\u6027\u8bbf\u95ee\u7684\u6b21\u6570\uff1a</p> <p><pre><code>class CountAccess:\n    def __init__(self, name):\n        self.name = name\n        self.count = 0\n\n    def __get__(self, instance, owner):\n        self.count += 1\n        return getattr(instance, self.name)\n\n    def __set__(self, instance, value):\n        self.count += 1\n        setattr(instance, self.name, value)\n\n    def __delete__(self, instance):\n        self.count += 1\n        delattr(instance, self.name)\n\nclass MyClass:\n    x = CountAccess('x')\n</code></pre> \u5f53\u901a\u8fc7\u5b9e\u4f8b\u8bbf\u95eex\u5c5e\u6027\u65f6\uff0c\u5c31\u4f1a\u81ea\u52a8\u89e6\u53d1CountAccess\u4e2d\u76f8\u5e94\u7684\u65b9\u6cd5\uff0c\u4f8b\u5982\uff1a</p> <pre><code>obj = MyClass()\nobj.x = 10  # \u89e6\u53d1 CountAccess.__set__ \u65b9\u6cd5\uff0c\u8bb0\u5f55\u8bbf\u95ee\u6b21\u6570\u5e76\u8bbe\u7f6e obj \u7684 x \u5c5e\u6027\u503c\u4e3a 10\nprint(obj.x)  # \u89e6\u53d1 CountAccess.__get__ \u65b9\u6cd5\uff0c\u8bb0\u5f55\u8bbf\u95ee\u6b21\u6570\u5e76\u83b7\u53d6 obj \u7684 x \u5c5e\u6027\u503c\ndel obj.x  # \u89e6\u53d1 CountAccess.__delete__ \u65b9\u6cd5\uff0c\u8bb0\u5f55\u8bbf\u95ee\u6b21\u6570\u5e76\u5220\u9664 obj \u7684 x \u5c5e\u6027\n</code></pre>","tags":["python","property"]},{"location":"blog/2024/06/03/%E5%BD%93%E6%88%91%E9%81%87%E5%88%B0%E4%BA%86%E7%88%AC%E8%99%AB/","title":"\u5f53\u6211\u9047\u5230\u4e86\u722c\u866b","text":"<p>\u8fd0\u7ef4\u540c\u5b66\uff0c\u7ebf\u4e0a\u673a\u5668\u600e\u4e48\u53c8\u53cc\u53d2\u53d5\u6302\u4e86\uff1f</p> <p>\u5bf9\u722c\u866b\u4e5f\u662f\u76f8\u7231\u76f8\u6740\u591a\u5e74\uff0c\u6211\u5bf9\u7ebf\u4e0a\u722c\u866b\u7684\u5e94\u5bf9\u51fa\u73b0\u7684\u51e0\u4e2a\u9636\u6bb5\uff1a</p>","tags":["\u722c\u866b","lua","openresty"]},{"location":"blog/2024/06/03/%E5%BD%93%E6%88%91%E9%81%87%E5%88%B0%E4%BA%86%E7%88%AC%E8%99%AB/#_1","title":"\u601d\u8def\uff1a","text":"","tags":["\u722c\u866b","lua","openresty"]},{"location":"blog/2024/06/03/%E5%BD%93%E6%88%91%E9%81%87%E5%88%B0%E4%BA%86%E7%88%AC%E8%99%AB/#1","title":"1\u3001\u770b\u65e5\u5fd7","text":"<p>\u5206\u6790\u65e5\u5fd7\uff0c\u627e\u51fa\u5f02\u5e38\u8bf7\u6c42\uff0c\u5c01ip\u3002</p>","tags":["\u722c\u866b","lua","openresty"]},{"location":"blog/2024/06/03/%E5%BD%93%E6%88%91%E9%81%87%E5%88%B0%E4%BA%86%E7%88%AC%E8%99%AB/#2waf","title":"2\u3001\u770bwaf","text":"<p>\u901a\u8fc7waf\uff0c\u9488\u5bf9\u67d0\u4e2auri \uff0c\u8fdb\u884c\u9650\u6d41\uff08\u5e76\u4e14\u4eba\u673a\u8bc6\u522b\uff09\uff0c\u63a7\u5236\u7684\u8fd8\u662f\u6e90ip\uff0c\u8d77\u521d\u6709\u70b9\u6210\u6548\u3002</p>","tags":["\u722c\u866b","lua","openresty"]},{"location":"blog/2024/06/03/%E5%BD%93%E6%88%91%E9%81%87%E5%88%B0%E4%BA%86%E7%88%AC%E8%99%AB/#3nginx","title":"3\u3001nginx\u9650\u5236","text":"<p>\u9047\u5230\u5927\u91cf\u5355ip\uff0c\u89e6\u53d1\u4e0d\u5230\u4eba\u673a\u8bc6\u522b\uff0c\u901a\u8fc7nginx\u81ea\u5e26\u7684limit_req_zone\u8fdb\u884curi\u9650\u5236\uff0c\u53d1\u73b0\u6709\u6548\u679c\uff0c\u4f46\u662f\u4f1a\u8bef\u6740\u5f88\u591a\u65e0\u8f9c\u3002</p> <pre><code>map $request_uri $xx_limit {\n    \"~*/xxx/\" \"/xxx/\";\n    default \"\";\n}\nlimit_req_zone $xx_limit zone=api_limit:10m rate=5r/s;\n\n\u5f53\u8bf7\u6c42\u8def\u5f84\u5305\u542b/xxx/\u65f6\uff0c\u8bbe\u7f6e$xx_limit \u4e3a/xxx/\uff0c\u9ed8\u8ba4\u503c\u4e3a\u7a7a\uff0c\u4e3a\u7a7a\u5219limit_req_zone \u4e0d\u751f\u6548\n\n\n\n\nlimit_req zone=api_limit burst=10 delay=5;\n\n\u6bcf\u79d2\u6807\u51c65\u4e2a\u8bf7\u6c42\uff0cburst\u53ef\u4ee5\u8ba9\u7a81\u53d1\u8bf7\u6c42\u523010\u4e2a\uff0cdelay\u662f\u5f53\u6709\u7a81\u53d1\u8bf7\u6c42\u65f6\u524d\u4e94\u4e2a\u76f4\u63a5\u8bf7\u6c42\uff0c\u5269\u4f59\u7684rate=5/s=200ms/\u4e2a\uff0c\u6d88\u8d391\u4e2a\uff0c\u7b49\u5f85200ms\n</code></pre>","tags":["\u722c\u866b","lua","openresty"]},{"location":"blog/2024/06/03/%E5%BD%93%E6%88%91%E9%81%87%E5%88%B0%E4%BA%86%E7%88%AC%E8%99%AB/#4openresty-lua","title":"4\u3001openresty-lua\u9650\u5236","text":"<p>\u901a\u8fc7openresty\uff0c\u5c06\u8bf7\u6c42\u76f8\u5173\u6570\u636e\u53d1\u9001\u5230\u8bf7\u6c42\u6570\u636e\u5206\u6790\u63a5\u53e3\uff0c\u5206\u6790\u4e4b\u540e\u8fd4\u56de\u7ed3\u679c\uff0c\u518d\u7531openresty\u5224\u65ad\u662f\u5426\u653e\u884c\uff0c\u5230\u76ee\u524d\u4e3a\u6b62\u7acb\u7aff\u89c1\u5f71\u3002</p> <p>\u6570\u636e\u5206\u6790\u63a5\u53e3\u5927\u6982\u5f97\u601d\u8def\u5c31\u662f\uff1a\u6b64\u65f6\u505a\u4e00\u4e9b\u9650\u5236\u5df2\u7ecf\u6ca1\u6709\u7528\u4e86\uff08\u540e\u7aef\u4ee3\u7801\u4e5f\u65e0\u6cd5\u66f4\u6539\uff09\uff0c\u53bb\u63a8\u7406\u4eba\u7684\u884c\u4e3a\uff0c\u4e00\u4e2a\u6b63\u5e38\u4eba\u8981\u8bbf\u95ee\u7f51\u7ad9\u65f6\u4f1a\u600e\u4e48\u64cd\u4f5c\uff0c\u722c\u866b\u6bd5\u7adf\u53ea\u662f\u722c\u866b\uff0c\u6ca1\u6cd5\u8ddf\u4eba\u4e00\u6837\u3002</p> <pre><code>local http = require \"resty.http\"\nlocal httpc = http.new()\nlocal json = require(\"cjson\")\n\nlocal uri = ngx.var.noparams_uri\nlocal headers=ngx.req.get_headers()\nlocal ip=headers[\"X-REAL-IP\"] or headers[\"X_FORWARDED_FOR\"] or ngx.var.remote_addr\nlocal ua=headers[\"User-Agent\"] or ''\nlocal white_ua={\"xxxx\",} -- ua \u767d\u540d\u5355\n\n\nlocal api_server=\"xxx:1234\"\nlocal topic_id = \"xxxxx\"\n\nfunction req_fast_api()\n    --return false \u662f\u5f02\u5e38\u8bf7\u6c42\uff0ctrue\u662f\u6b63\u5e38\u8bf7\u6c42\n\n    local data = {\n        TopicId = \"xxxxxxx\",\n        From = 1710086694000,\n        To = 1717151565000,\n        Query = '\"remote_addr:\\\"' .. ip .. '\\\"\"',\n        Limit = 100\n    }\n\n    local jsonStr = json.encode(data)\n\n    local resp, err = httpc:request_uri(\"http://\" .. api_server .. \"/xxx/xxx/xxxx\", {\n        method = \"POST\",\n        body = jsonStr,\n        headers = {\n            [\"Content-Type\"] = \"application/json\",\n        },\n    })\n\n    if not resp then\n        ngx.log(ngx.ERR, \"cls \u65e5\u5fd7\u63a5\u53e3\u6302\u4e86\u3002\")\n        return 500, \"true\"\n    end\n\n    return resp.status, resp.body\nend\n\n\nfunction main()\n    -- \u6821\u9a8cua\u662f\u5426\u5728\u767d\u540d\u5355\u4e2d\n    local outer_i\n    for i, v in ipairs(white_ua) do\n        if string.find(ua, v) then\n            break\n        else\n            outer_i = i\n        end\n    end\n\n    if outer_i == #white_ua then\n        -- ua\u4e0d\u5728\u767d\u540d\u5355\u4e2d\n        ngx.header[\"Server\"] = \"xxxxx/xxx\"\n        local status, body = req_fast_api()\n        ngx.log(ngx.ERR, ip .. \"\u65e5\u5fd7\u63a5\u53e3\u8fd4\u56de\uff1a\" .. body .. \",\u4e14ua\u4e0d\u5728\u767d\u540d\u5355\u4e2d\u3002\")\n        if body == \"false\" then\n            ngx.status = ngx.HTTP_BAD_REQUEST\n            ngx.say(\"xxxx\")\n            ngx.exit(ngx.HTTP_BAD_REQUEST)\n        end\n    end\nend\n\nlocal m = ngx.re.match(uri, \"^/xxxxx/.*$\", \"jo\")\n\nif m then\n    main()\nelse\n    ngx.log(ngx.ERR, \"\u975exxxx\u7684\u5ffd\u7565\" .. uri)\nend\n</code></pre>","tags":["\u722c\u866b","lua","openresty"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/","title":"\u4ece\u6545\u969c\u81ea\u6108\u7cfb\u7edf\u53d8\u6210\u8fd0\u7ef4\u7cfb\u7edf","text":"<p>\u521a\u5f00\u59cb\u521d\u8877\u662f\u505a\u4e2a\u6545\u969c\u81ea\u6108\u7684\u7cfb\u7edf\uff0c\u540e\u6765\u8fd9\u52a0\u52a0\uff0c\u90a3\u8fb9\u52a0\u52a0\u5c31\u53d8\u6210\u4e86\u8fd0\u7ef4\u7cfb\u7edf\u3002</p>","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#_1","title":"\u524d\u8a00","text":"<p>22\u5e7410\u6708\u4efd\u7684\u65f6\u5019\uff0c\u6211\u4eec\u7ebf\u4e0a\u7cfb\u7edf\u9891\u7e41\u51fa\u73b0\u6545\u969c\uff0c\u62a5\u8b66\u4e0d\u65ad\uff0c\u65f6\u4e0d\u65f6\u7684\u5c31\u9700\u8981\u4eba\u5de5\u5904\u7406\u3002</p> <ul> <li> <p>\u516c\u53f8\u5bf9\u4e8e\u8fd0\u7ef4\u65b9\u9762\u4e0d\u662f\u5f88\u91cd\u89c6\uff0c\u52a0\u4e0a\u62e5\u62b1\u963f\u91cc\u4e91\u548c\u817e\u8baf\u4e91\uff0c\u4e91\u5e73\u53f0\u53ea\u4f1a\u62a5\u8b66\uff0c\u62a5\u5b8c\u8b66\u5c31\u53ea\u80fd\u4eba\u5de5\u53bb\u5904\u7406\u95ee\u9898\uff0c\u6216\u8005\u81ea\u5df1\u5199\u4e2a\u811a\u672c\u5904\u7406\u8fd9\u4e2a\u95ee\u9898\uff0c\u5c06\u811a\u672c\u90fd\u5206\u53d1\u5230\u6bcf\u53f0\u673a\u5668\u4e0a\u53bb\u3002</p> </li> <li> <p>\u81ea\u5b9a\u4e49\u7684\u62a5\u8b66\u90fd\u662f\u5904\u7406\u7684\u7279\u5b9a\u7684\u95ee\u9898\uff0c\u4e0d\u80fd\u5f88\u597d\u7684\u7edf\u4e00\u89c4\u8303\u7ba1\u7406\uff0c\u5f88\u591a\u62a5\u8b66\u811a\u672c\u90fd\u662f\u6563\u843d\u5728\u5404\u4e2a\u673a\u5668\u4e0a\uff0c\u5f88\u591a\u65f6\u5019\u90fd\u627e\u4e0d\u5230\u811a\u672c\u4e22\u5728\u54ea\u91cc\u3002</p> </li> </ul> <p>\u4e3a\u4e86\u66f4\u597d\u7684\u7edf\u4e00\u5904\u7406\u4e91\u5e73\u53f0\u3001prometheus\u89e6\u53d1\u7684\u62a5\u8b66\uff0c\u6211\u51b3\u5b9a\u81ea\u5df1\u5f00\u53d1\u4e00\u4e2a\u6545\u969c\u81ea\u6108\u7684\u7cfb\u7edf\u3002\u4e91\u5e73\u53f0\u53ef\u4ee5\u89e6\u53d1\u4e00\u4e2a\u544a\u8b66\u56de\u8c03\uff0c\u6839\u636e\u6bcf\u4e2a\u8d44\u6e90\u7684\u4e0d\u540c\u7684\u56de\u8c03\u4f20\u9012\u53c2\u6570\u8fdb\u884c\u533a\u5206\uff0c\u4e0d\u540c\u7684\u544a\u8b66\u9879\u89e6\u53d1\u4e0d\u540c\u7684\u5904\u7406\u65b9\u5f0f\u3002</p>","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#1","title":"1\u3001\u7cfb\u7edf\u7684\u524d\u7aef","text":"","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#1simpleui-django-simpleui-captcha","title":"1\u3001simpleUi + django-simpleui-captcha","text":"<p>\u4e4b\u524d\u6709\u4e00\u4e2a\u7cfb\u7edf\u4f7f\u7528\u7684\u662fvue-admin-template\uff0c\u7528\u8d77\u6765\u786e\u5b9e\u5f88\u65b9\u4fbf\uff0c\u4f46\u662f\u4e00\u65e6\u81ea\u5df1\u589e\u52a0\u4e00\u70b9\u4e1c\u897f\u5c31\u4f1a\u5f88\u4e11\uff0c\u6240\u4ee5\u8fd9\u4e2a\u6211\u5c31\u4f7f\u7528\u7684\u662fsimpleUi + django-simpleui-captcha \u4f5c\u4e3a\u540e\u53f0\u7684\u754c\u9762\u548c\u767b\u5f55\u9a8c\u8bc1\u7801\u3002</p> \u767b\u5f55\u9996\u9875","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#2echarts","title":"2\u3001\u589e\u52a0\u4e86\u4e00\u4e9becharts\uff0c\u8fdb\u5165\u7cfb\u7edf\u5c31\u53ef\u4ee5\u770b\u5230\u6700\u8fd1\u7684\u62a5\u8b66\u60c5\u51b5\u3002","text":"\u7cfb\u7edf\u9996\u9875","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#2","title":"2\u3001\u6a21\u5757","text":"","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#1_1","title":"1\u3001\u7cfb\u7edf\u7ba1\u7406","text":"<p>\u8fd9\u4e2a\u6a21\u5757\u91cc\u9762\u4e3b\u8981\u5305\u542b\u4e86\u7528\u6237\u7684\u7ba1\u7406\u3001\u89d2\u8272\u7ba1\u7406\u3001\u83dc\u5355\u7ba1\u7406\u3001\u5b57\u5178\u7ba1\u7406\u3001\u767b\u5f55\u65e5\u5fd7\u3001\u64cd\u4f5c\u65e5\u5fd7\u3001\u544a\u8b66\u901a\u77e5\u8bb0\u5f55\u3001ip\u767d\u540d\u5355\u7b49\u3002</p>","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#1_2","title":"1\u3001\u7528\u6237\u3001\u89d2\u8272\u3001\u83dc\u5355\u4e4b\u95f4\u7684\u5173\u7cfb","text":"<ul> <li> <p>\u6211\u91cd\u5199\u4e86\u7528\u6237\u7684\u6a21\u578b\uff0c\u65b0\u589e\u4e86\u83dc\u5355\u6a21\u578b\uff0c\u6ca1\u6709\u91cd\u5199\u6743\u9650\u7684\u6a21\u578b\uff0c\u505a\u4e2a\u7b80\u5355\u7684rbac\u6211\u89c9\u5f97\u5c31\u591f\u4e86\u3002</p> </li> <li> <p>\u7528\u6237\u548c\u539f\u6765\u7684group\u90fd\u662f\u63a7\u5236\u7528\u6237\u6743\u9650\uff0c\u6211\u8fd9\u91cc\u9762\u7528\u6237\u4e00\u822c\u4e0d\u5355\u72ec\u8bbe\u7f6e\u6743\u9650\uff0c\u6240\u6709\u6743\u9650\u90fd\u662f\u5728group\u91cc\u9762\u914d\u7f6e\u7684\uff0c\u5c06group\u7406\u89e3\u4e3a\u89d2\u8272\u3002</p> </li> <li> <p>\u83dc\u5355\u662f\u5728\u4e2d\u95f4\u4ef6\u4e2d\u8fdb\u884c\u63a7\u5236\uff0c\u901a\u8fc7simpleUi\u7684\u81ea\u5b9a\u4e49\u83dc\u5355\uff0c\u63a7\u5236\u7528\u6237\u5bf9\u5e94\u6743\u9650\u5bf9\u5e94\u7684\u83dc\u5355\u3002</p> </li> </ul> \u83dc\u5355\u7ba1\u7406","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#2_1","title":"2\u3001\u5b57\u5178\u7ba1\u7406","text":"<p>\u53c2\u8003github\u4e0a\u5f88\u591a\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\uff0c\u53d1\u73b0\u5f88\u591a\u90fd\u6709\u4e2a\u5b57\u5178\u7ba1\u7406\u7cfb\u7edf\uff0c\u8d77\u521d\u6ca1\u7528\u4e0a\uff0c\u968f\u7740\u7cfb\u7edf\u7684\u4f7f\u7528\u589e\u591a\uff0c\u53d1\u73b0\u6709\u7684\u6570\u636e\u65b0\u5efa\u4e00\u5f20\u8868\u6ca1\u5fc5\u8981\uff0c\u7528\u5b57\u5178\u5374\u662f\u5f88\u65b9\u4fbf\uff0c\u5e76\u4e14\u7ba1\u7406\u548c\u4fee\u6539\u4e5f\u6bd4\u8f83\u65b9\u4fbf\u3002</p> \u5b57\u5178\u7ba1\u7406","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#2_2","title":"2\u3001\u8d44\u4ea7","text":"<p>\u5e73\u53f0\u7684\u6570\u636e\u57fa\u672c\u4e0a\u90fd\u662f\u6765\u81ea\u4e8e\u8d44\u4ea7\uff0c\u8fd9\u4e2a\u8d44\u4ea7\u76f8\u5f53\u4e8e\u4e00\u4e2a\u5c0f\u578b\u7684cmdb\uff0c\u800c\u8d44\u4ea7\u4e2d\u7684\u6570\u636e\u5219\u662f\u540c\u6b65\u4e8e\u4e91\u5e73\u53f0\u7684\u6570\u636e\u3002 \u8fd9\u4e2a\u6a21\u5757\u4e3b\u8981\u6709\u670d\u52a1\u5668\u4fe1\u606f\u3001\u670d\u52a1\u5668\u7ec4\u3001\u955c\u50cf\u3001\u4e91\u5b9e\u4f8b\u3001\u7a0b\u5e8f\u8be6\u60c5\u3001\u5b9e\u4f8b\u5e94\u7528\u7b49\u3002</p>","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#1_3","title":"1\u3001\u5b9e\u4f8b\u955c\u50cf","text":"<p>\u6839\u636e\u670d\u52a1\u5668\u4fe1\u606f\uff0c\u81ea\u52a8\u751f\u6210\u5b9e\u4f8b\u955c\u50cf\uff0c\u4fbf\u4e8e\u4e91\u5b9e\u4f8b\u5feb\u901f\u521b\u5efa\u4e91\u4e0a\u670d\u52a1\u5668\u5b9e\u4f8b\u3002</p> \u5b9e\u4f8b\u955c\u50cf","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#2_3","title":"2\u3001\u7a0b\u5e8f\u8be6\u60c5","text":"<p>\u662f\u6307\u6bcf\u53f0\u673a\u5668\u4e0a\u7684\u5e94\u7528\u7684\u914d\u7f6e\uff0c\u914d\u7f6e\u662f\u5426\u8fdb\u7a0b\u68c0\u67e5\u3001\u7aef\u53e3\u68c0\u67e5\u3001\u5f02\u5e38\u81ea\u52a8\u91cd\u542f</p> \u7a0b\u5e8f\u76d1\u63a7","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#3","title":"3\u3001\u5b9e\u4f8b\u5e94\u7528","text":"<p>\u6bcf\u4e2a\u5b9e\u4f8b\u4e0a\u7ed1\u5b9a\u7a0b\u5e8f\u8be6\u60c5\uff0c\u68c0\u67e5\u5e94\u7528\u72b6\u6001\u3002\u5305\u62ec\u901a\u8fc7\u81ea\u5b9a\u4e49\u7684agent\u4e0a\u4f20\u5e94\u7528\u7a0b\u5e8f\u7684\u76d1\u63a7\u6570\u636e\u3002</p> \u5b9e\u4f8b\u5e94\u7528","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#3_1","title":"3\u3001\u6545\u969c\u81ea\u6108","text":"<p>\u8fd9\u4e2a\u6a21\u5757\u5c31\u662f\u8fd9\u4e2a\u7cfb\u7edf\u7684\u521d\u8877\uff0c\u5c06\u4e91\u5e73\u53f0\u53d1\u51fa\u7684\u544a\u8b66\u6545\u969c\uff0c\u7ed3\u5408\u544a\u8b66\u6570\u636e\uff0c\u901a\u8fc7\u4e00\u4e2a\u7cfb\u7edf\u6765\u7edf\u4e00\u7684\u6c47\u603b\uff0c\u5904\u7406\u6545\u969c\u3002 \u8fd9\u4e2a\u6a21\u5757\u4e3b\u8981\u5305\u542b\uff0ccvm\u544a\u8b66\u3001es\u544a\u8b66\u3001prometheus\u544a\u8b66\u3001\u544a\u8b66\u5206\u6790\u3001\u63a5\u5165\u81ea\u3001\u81ea\u52a8\u5206\u6790\u4e0a\u4f20\u7ed3\u679c\u3001\u81ea\u5b9a\u4e49\u5957\u9910\u5305\u3001\u81ea\u6108\u6267\u884c\u7ed3\u679c\u7b49\u3002</p>","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#1_4","title":"1\u3001\u63a5\u5165\u81ea\u6108","text":"<p>\u76d1\u63a7\u9879\u53ef\u4ee5\u662f\u4e91\u5e73\u53f0\u7684\uff0c\u4e5f\u53ef\u4ee5\u662f\u81ea\u5b9a\u4e49\u7684\uff0c\u6267\u884c\u65b9\u5f0f\u53ef\u4ee5\u8fdc\u7a0b\u6216\u8005\u672c\u5730\uff0c\u5f02\u6b65\u6216\u8005\u540c\u6b65\u3002</p> \u63a5\u5165\u81ea\u6108","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#2_4","title":"2\u3001\u81ea\u5b9a\u4e49\u5957\u9910\u5305","text":"<p>\u81ea\u5b9a\u4e49\u5957\u9910\u5305\u5728\u63a5\u5165\u81ea\u6108\u65f6\u53ef\u4ee5\u9009\u62e9\u600e\u4e48\u5904\u7406\u8fd9\u4e2a\u544a\u8b66\u3002</p> \u63a5\u5165\u81ea\u6108","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#4cronjob","title":"4\u3001cronjob","text":"<p>\u8fd9\u4e2a\u5c31\u662f\u4f9d\u8d56\u4e8eansible\uff0c\u5c06\u670d\u52a1\u5668\u4e0a\u7684\u6240\u6709\u811a\u672c\u90fd\u7edf\u4e00\u7ba1\u7406\uff0c\u53d1\u5e03\uff0c\u67e5\u770b\u6267\u884c\u65e5\u5fd7\u3002</p> cronjob","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#5","title":"5\u3001\u65e5\u5fd7\u544a\u8b66","text":"<p>\u91cc\u9762\u5305\u542bes\u548ccls\u544a\u8b66\u65e5\u5fd7\u7684\u6355\u83b7\uff0c\u5206\u6790\u3002</p> cls\u544a\u8b66","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#6","title":"6\u3001\u6279\u91cf\u4efb\u52a1","text":"<p>\u5305\u542b\u7ebf\u4e0a\u914d\u7f6e\u6587\u4ef6\u7684\u53d1\u5e03\uff0cansible playbook\u7684\u6267\u884c\uff0c\u6587\u4ef6\u7684\u4e0a\u4f20\u7b49\u3002</p>","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#7celery","title":"7\u3001celery \u4efb\u52a1","text":"<p>\u8fd9\u4e2a\u5c31\u662f\u9700\u8981\u5b9a\u65f6\u6267\u884c\u7684\u8ba1\u7b97\u4efb\u52a1\u7684\u7ba1\u7406\u3002</p>","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#8","title":"8\u3001\u591a\u4e91\u7ba1\u7406","text":"<p>\u5305\u542b\u7ebf\u4e0a\u57df\u540d\u7b49\u7ba1\u7406\u3002</p>","tags":["django","simpleui","celery"]},{"location":"blog/2024/08/13/%E4%BB%8E%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%B3%BB%E7%BB%9F%E5%8F%98%E6%88%90%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F/#3_2","title":"3\u3001\u603b\u7ed3","text":"<p>\u6587\u6863\u4e5f\u6ca1\u5565\u597d\u5199\u7684\uff0c\u4e3b\u8981\u63d0\u4f9b\u7ed9\u6709\u8fd9\u4e2a\u9700\u6c42\u7684\u670b\u53cb\u4e00\u4e9b\u601d\u8def\uff0c\u8fd9\u4e2a\u7b97\u662f\u6211\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u7528\u7684\u6bd4\u8f83\u591a\u7684\u4e00\u4e2a\u7cfb\u7edf\u4e86\u3002</p>","tags":["django","simpleui","celery"]},{"location":"blog/2023/02/21/%E7%9B%91%E6%8E%A7win10%E7%A8%8B%E5%BA%8F/","title":"\u76d1\u63a7win10\u7a0b\u5e8f","text":"<p>Windows10\u7684\u673a\u5668\u4e0a\u542f\u52a8\u4e86\u4e24\u4e2a\u5e94\u7528\uff0c\u65f6\u4e0d\u65f6\u4f1a\u6302\u4e86\uff0c\u6240\u4ee5\u5f97\u5728win10\u4e0a\u641e\u4e2a\u5b9a\u65f6\u7a0b\u5e8f\u5b9a\u65f6\u76d1\u63a7\u4e00\u4e0b\u3002</p>","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2023/02/21/%E7%9B%91%E6%8E%A7win10%E7%A8%8B%E5%BA%8F/#1","title":"1\u3001\u5b9e\u73b0","text":"","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2023/02/21/%E7%9B%91%E6%8E%A7win10%E7%A8%8B%E5%BA%8F/#1_1","title":"1\u3001\u4ee3\u7801","text":"Golang <pre><code>package main\n\nimport (\n    \"fmt\"\n    \"github.com/shirou/gopsutil/process\"\n    \"log\"\n    \"net/http\"\n    \"os/exec\"\n    \"strings\"\n    \"time\"\n)\n\ntype Dingding struct {\n    Dingurl string\n}\n\nfunc (d Dingding) SendMsgbyText(msg string) {\n    content := `{\"msgtype\": \"text\",\n        \"text\": {\"content\": \"` + msg + `\"}\n    }`\n    req, _ := http.NewRequest(\"POST\", d.Dingurl, strings.NewReader(content))\n\n    req.Header.Set(\"Content-Type\", \"application/json; charset=utf-8\")\n\n    client := &amp;http.Client{}\n    resp, _ := client.Do(req)\n    defer resp.Body.Close()\n}\n\ntype winProcess struct {\n    name string\n    path string\n}\n\nfunc (ppp winProcess) check_process_status() (bool,int32){\n    processes, _ := process.Processes()\n    for _, p := range processes {\n        name,_ := p.Name()\n        if name == ppp.name {\n            status,_ := p.IsRunning()\n            return status, p.Pid\n        }\n    }\n    return false, int32(-1)\n\n}\n\nfunc (ppp winProcess) start_process()  {\n    sd := Dingding{\"xxxx\"}\n    sd.SendMsgbyText(ppp.name + \"  \u5e94\u7528\u542f\u52a8\u4e86!!!\")\n    cmd := exec.Command(\"cmd\", \"/c\", ppp.path)\n    err := cmd.Start()\n    if err != nil {\n        log.Fatalf(\"cmd.Run() failed with %s\\n\", err)\n    }\n\n}\n\nfunc (ppp winProcess) process_control()  {\n    if status, _ := ppp.check_process_status() ; ! status {\n        ppp.start_process()\n        fmt.Printf(\"%s \u8fdb\u7a0b\u542f\u52a8\u4e86!!!\",ppp.name)\n    }else {\n        fmt.Printf(\"%s \u7a0b\u5e8f\u6b63\u5728\u8fd0\u884c!!!\", ppp.name)\n    }\n}\n\nfunc (ppp winProcess) process_stop() {\n    c := exec.Command(\"taskkill.exe\", \"/f\", \"/im\", ppp.name)\n    err := c.Start()\n    if err != nil {\n        fmt.Println(\"\u6709\u9519\u8bef\")\n    }\n}\n\nfunc main() {\n    //\u5148\u542f\u52a8\u8f6f\u5e73\u53f0 \u518d\u542f\u52a8\u63a5\u53e3\u7a0b\u5e8f\n    abc := winProcess{\n        \"abc.exe\",\n        \"C:\\\\Users\\\\process_check\\\\abc_start.bat\",\n    }\n    abc.process_control()\n\n    time.Sleep(15 * time.Second)\n    de := winProcess{\n        \"CTItoCRMPlate.exe\",\n        \"start E:\\\\abc\\\\abc.exe\",\n    }\n    de.process_control()\n\n}\n</code></pre>","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2023/02/21/%E7%9B%91%E6%8E%A7win10%E7%A8%8B%E5%BA%8F/#2windows","title":"2\u3001windows\u6587\u4ef6\u8def\u5f84","text":"<p><pre><code>start C:\\\"Program Files\"\\abc\\abc.exe\n\npause\n</code></pre> \u7591\u95ee\uff1f\uff1f\uff1f</p> <p>\u4e3a\u5565\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u6ca1\u6709\u5355\u72ec\u7528bat\u7684\u811a\u672c\u5904\u7406\u5462\uff1f\u4e0a\u9762\u7684Program Files \u8fd9\u4e2a\u4e2d\u95f4\u6709\u7a7a\u683c\uff0c\u653e\u5728golang\u91cc\u9762\u8c03\u7528\uff0cwin10\u53ea\u8bc6\u522b\u5230\u4e86program\uff0c\u540e\u9762\u5c31\u65ad\u5f00\u4e86\u3002</p>","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2023/02/21/%E7%9B%91%E6%8E%A7win10%E7%A8%8B%E5%BA%8F/#2","title":"2\u3001\u914d\u7f6e\u5b9a\u65f6\u7a0b\u5e8f","text":"","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2023/02/21/%E7%9B%91%E6%8E%A7win10%E7%A8%8B%E5%BA%8F/#1windowscronjob","title":"1\u3001windows\u7684cronjob","text":"","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2023/02/21/%E7%9B%91%E6%8E%A7win10%E7%A8%8B%E5%BA%8F/#2_1","title":"2\u3001\u5982\u679c\u4e0d\u662f\u53ea\u5728\u7528\u6237\u767b\u5f55\u65f6\u8fd0\u884c\uff0c\u9ed8\u8ba4\u5c31\u653e\u5230\u540e\u53f0\u4e86\u3002","text":"","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2023/02/21/%E7%9B%91%E6%8E%A7win10%E7%A8%8B%E5%BA%8F/#35","title":"3\u3001\u6bcf5\u5206\u949f\u4e00\u6b21","text":"","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2023/02/21/%E7%9B%91%E6%8E%A7win10%E7%A8%8B%E5%BA%8F/#4","title":"4\u3001\u6839\u76ee\u5f55\u5f97\u9009\uff0c\u907f\u514d\u50bb\u903c\u95ee\u9898\u3002","text":"","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/","title":"istio VirtualService \u914d\u7f6e\u793a\u4f8b","text":"<p>\u521a\u5f00\u59cb\u8bd5\u8bd5\u611f\u53d7\u4e00\u4e0b\u5c31\u884c,\u540e\u9762\u770b\u770b\u5c31\u884c\u3002</p>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#1","title":"1\u3001\u57fa\u7840\u73af\u5883","text":"<pre><code>client version: 1.23.2\ncontrol plane version: 1.23.2\ndata plane version: 1.23.2 (9 proxies)\n</code></pre> <p>\u6d4b\u8bd5\u662f\u57fa\u4e8e\u6211\u81ea\u5b9a\u4e49\u7684\u4e24\u4e2a\u670d\u52a1\uff0c\u4e3a\u5565\u6ca1\u7528\u5b98\u65b9\u7684\u670d\u52a1\u5462\uff1f\u5f53\u7136\u662f\u81ea\u5df1\u5f04\u4e24\u4e2a\u65b9\u4fbf\u6d4b\u8bd5\u4fee\u6539\u3002</p> <pre><code>graph LR\n  A[\u53d1\u8d77\u8bf7\u6c42] --&gt; B[service-a-vs];\n  B --&gt; |http://service-b:8000/api/v2/users/| C[serviceb];</code></pre>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#11service-a","title":"1.1\u3001service-a","text":"<pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: service-a\n  labels:\n    app: service-a\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: service-a\n  template:\n    metadata:\n      labels:\n        app: service-a\n    spec:\n      containers:\n      - name: service-a\n        image: service-a:v7\n        ports:\n        - containerPort: 8000\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: service-a-svc\nspec:\n  selector:\n    app: service-a\n  ports:\n  - name: http\n    protocol: TCP\n    port: 8000\n    targetPort: 8000\n</code></pre>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#12service-b","title":"1.2\u3001service-b","text":"<pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: service-b\n  labels:\n    app: service-b\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: service-b\n  template:\n    metadata:\n      labels:\n        app: service-b\n    spec:\n      containers:\n      - name: service-b\n        image: service-b:v6\n        ports:\n        - containerPort: 9000\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: service-b\nspec:\n  selector:\n    app: service-b\n  ports:\n  - name: http\n    protocol: TCP\n    port: 9000\n    targetPort: 9000\n</code></pre>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#13","title":"1.3\u3001\u914d\u7f6e\u6ce8\u610f\u70b9","text":"<p>\u539f\u6587\u51fa\u5904</p> <ul> <li>hosts \u53ef\u4ee5\u662f\u5e26\u901a\u914d\u7b26\u524d\u7f00\u7684 DNS \u540d\u79f0\u6216 IP \u5730\u5740\u3002\u6839\u636e\u5e73\u53f0\u7684\u4e0d\u540c\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u77ed\u540d\u79f0\u4ee3\u66ff FQDN\uff08\u5373\u540d\u79f0\u4e2d\u6ca1\u6709\u70b9\uff09</li> <li>hosts \u5b57\u6bb5\u9002\u7528\u4e8e HTTP \u548c TCP \u670d\u52a1\u3002\u7f51\u683c\u5185\u7684\u670d\u52a1\uff08\u5373\u5728\u670d\u52a1\u6ce8\u518c\u8868\u4e2d\u627e\u5230\u7684\u670d\u52a1\uff09\u5fc5\u987b\u59cb\u7ec8\u4f7f\u7528\u5176\u5b57\u6bcd\u6570\u5b57\u540d\u79f0\u6765\u5f15\u7528\u3002\u4ec5\u5141\u8bb8\u901a\u8fc7\u7f51\u5173\u5b9a\u4e49\u7684\u670d\u52a1\u4f7f\u7528 IP \u5730\u5740\u3002</li> <li>\u8981\u63a7\u5236\u7ed1\u5b9a\u5230\u7f51\u683c\u5916\u90e8\u670d\u52a1\u7684\u6d41\u91cf\u7684\u8def\u7531\uff0c\u5fc5\u987b\u5148\u4f7f\u7528 ServiceEntry \u8d44\u6e90\u5c06\u5916\u90e8\u670d\u52a1\u6dfb\u52a0\u5230 Istio \u7684\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u4e2d\u3002\u7136\u540e\u53ef\u4ee5\u5b9a\u4e49 VirtualServices \u6765\u63a7\u5236\u7ed1\u5b9a\u5230\u8fd9\u4e9b\u5916\u90e8\u670d\u52a1\u7684\u6d41\u91cf\u3002</li> <li>\u67d0\u4e2a\u5927\u4f6c\u8bf4istio\u5bf9grpc\u652f\u6301\u4e0d\u597d\uff0c\u7ebf\u4e0a\u5f88\u591a\u8bf7\u6c42\u8fd4\u56de\u5f02\u5e38\uff0c\u5927\u4f6c\u7ed9\u7684\u89e3\u51b3\u65b9\u5f0f\u3002</li> </ul>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#2virtualservice","title":"2\u3001\u5355\u4e00VirtualService","text":"<p>\u5b98\u7f51\u4e0a\u6765\u5c31\u662fgateway\uff0c\u6211\u60f3\u80af\u5b9a\u4f1a\u6709\u4e0d\u7528gateway\u7684\u65f6\u5019\uff0c\u90a3\u5c31\u8bd5\u8bd5\u6ca1\u6709gateway\uff0c\u6ca1\u6709dr\u7684\u60c5\u51b5\u3002</p> <p>\u591a\u4e2ahost\u5171\u4eab\u89c4\u5219\uff0c\u6700\u7ec8\u8fd8\u662f\u8981\u6839\u636euri\u6216\u8005\u5176\u4ed6\u89c4\u5219\u8f6c\u53d1\u5230\u5bf9\u5e94\u7684\u670d\u52a1\u3002</p>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#21uri404","title":"2.1\u3001\u4e0d\u540c\u670d\u52a1\uff0curi404","text":"<ul> <li> <p>service-a-svc:8000</p> </li> <li> <p>service-b: 8000</p> </li> </ul> <p><pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: service-vs\nspec:\n  hosts:\n  - service-a-svc\n  - service-b\n  http:\n  - match:\n    - uri:\n        prefix: /api/v1/\n    route:\n    - destination:\n        host: service-a-svc\n        port:\n          number: 8000\n      weight: 50\n    - destination:\n        host: service-b\n        port:\n          number: 8000\n      weight: 50\n</code></pre> \u901a\u8fc7\u5982\u4e0b\u7684\u811a\u672c\u5728\u5b98\u65b9\u7684reviews-v1\u8fdb\u884c\u6d4b\u8bd5\uff0c\u6839\u636e\u4e0a\u8ff0\u914d\u7f6e\u4f1a\u5c06hosts\u4e2d\u6307\u5b9a\u7684\u4e24\u4e2a\u8fdb\u884c\u8bc6\u522b\u548c\u5e94\u7528\uff0c\u9996\u5148\u8bc6\u522bhosts\uff0c\u7136\u540e\u6839\u636e\u8def\u5f84\u8f6c\u53d1\u3002 <pre><code>kubectl exec -it pod/reviews-v1-6584ddcf65-dhzsf -- /bin/sh\n\nfor i in `seq 1 100`;do curl http://service-a-svc:8000/api/v1/users/; echo -n \"\\n\";done\n\"\"\n\u6267\u884c\u7ed3\u679c\uff1a\n{\"detail\":\"Not Found\"}\n\"\"\n\"\"\n\"\"\n\"\"\n\"\"\n{\"detail\":\"Not Found\"}\n</code></pre> </p> <p>\u7ed3\u679c\u4e0d\u4e00\u6837\u662f\u56e0\u4e3a\u6b64\u65f6service-a-svc\u548cservice-b\u4e24\u4e2adestination\u5904\u4e8e\u8d1f\u8f7d\u5747\u8861\u7684\u72b6\u6001\uff1a</p> <ul> <li>service-a-svc\u662f\u8c03\u7528service-b\u4e4b\u524d\u7684\u64cd\u4f5c\u662f\u6210\u529f\u7684\uff0c\u8c03\u7528service-b\u662f\u5931\u8d25\u7684\uff0c\u56e0\u4e3aservice-b uri 404\u3002</li> <li>service-b\u662f\u76f4\u63a5\u5931\u8d25\u7684\uff0c\u56e0\u4e3aservice-b uri 404\u3002</li> </ul>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#22uri","title":"2.2\u3001\u4e0d\u540c\u670d\u52a1\uff0c\u4e0d\u540curi","text":"<p>\u670d\u52a1a\u8c03\u7528\u670d\u52a1b</p> <ul> <li>service-a-svc:8000</li> <li> <p>service-b: 8000 <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: service-vs\nspec:\n  hosts:\n  - service-a-svc\n  - service-b\n  http:\n  - match:\n    - uri:\n        prefix: /api/v1/\n    route:\n    - destination:\n        host: service-a-svc\n        port:\n          number: 8000\n - match:\n   - uri:\n       prefix: /api/v2/\n   route:\n   - destination:\n       host: service-b\n       port:\n         number: 8000\n</code></pre> </p> </li> <li> <p>\u7b2c\u4e00\u4e2acurl\uff0c\u4ece\u6d4b\u8bd5pod\u5230service-a\uff0cservice-a\u5230service-b</p> </li> <li>\u7b2c\u4e8c\u4e2acurl\uff0c\u4ece\u6d4b\u8bd5pod\u5230service-b <pre><code>for i in `seq 1 1000`;do curl http://service-a-svc:8000/api/v1/users/; curl http://service-b:8000/api/v2/users/ddd; echo -n \"\\n\";done\n\u6267\u884c\u7ed3\u679c\uff1a\n\"{\\\"message\\\":\\\"i am service b\\\"}\"{\"message\":\"self request\"}\n\"{\\\"message\\\":\\\"i am service b\\\"}\"{\"message\":\"self request\"}\n\"{\\\"message\\\":\\\"i am service b\\\"}\"{\"message\":\"self request\"}\n\"{\\\"message\\\":\\\"i am service b\\\"}\"{\"message\":\"self request\"}\n</code></pre></li> </ul>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#23urisvc","title":"2.3\u3001\u4e0d\u540c\u670d\u52a1\uff0c\u4e0d\u540curi\uff0c\u4e0d\u540csvc\u7aef\u53e3","text":"<p>service-a \u8bf7\u6c42http://service-b:9000/api/v2/users/ \u6539\u53d8service-b\u7684\u7aef\u53e3</p> <ul> <li>service-a-svc:8000</li> <li>service-b: 9000 <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: service-vs\nspec:\n  hosts:\n  - service-a-svc\n  - service-b\n  http:\n  - match:\n    - uri:\n        prefix: /api/v1/\n    route:\n    - destination:\n        host: service-a-svc\n        port:\n          number: 8000\n  - match:\n    - uri:\n        prefix: /api/v2/\n    route:\n    - destination:\n        host: service-b\n        port:\n          number: 9000\n</code></pre></li> </ul> <p>\u6267\u884c\u5339\u914duri /api/v1/users/ \u4f1a\u8f6c\u53d1\u5230service-a-svc\u670d\u52a1\uff0c\u7136\u540e\u4eceservice-a-svc\u670d\u52a1\u518d\u53bb\u8bf7\u6c42http://service-b:9000/api/v2/users/\uff0c\u7136\u540e\u518d\u53bbvs\u4e2d\u8f6c\u53d1\u5230service-b\u670d\u52a1\u3002 <pre><code>for i in `seq 1 100`;do curl http://service-a-svc:8000/api/v1/users/; echo -n \"\\n\";done\n\u8fd4\u56de\uff1a\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n</code></pre> </p> <p>\u4ecev1\u6539\u6210\u4e86v2\uff0c\u5c31\u53d8\u6210\u76f4\u63a5\u8bf7\u6c42service-b\uff0c\u4e0d\u7ecf\u8fc7service-a-svc\u4e86\uff0c\u4eceservice-a-svc\u8fd4\u56de\u7684\u6570\u636e\u7ecf\u8fc7requests\u7684\u5904\u7406\u4e0d\u4e00\u6837\u3002</p> <p>\u8fd9\u4e2avs\u914d\u7f6e\u5224\u65ad\u901a\u8fc7hosts\u548curi\u6765\u5206\u914d\u76ee\u6807\u670d\u52a1\u3002 <pre><code>$ for i in `seq 1 100`;do curl http://service-a-svc:8000/api/v2/users/; echo -n \"\\n\";done\n{\"message\":\"i am service b\"}\n{\"message\":\"i am service b\"}\n{\"message\":\"i am service b\"}\n{\"message\":\"i am service b\"}\n{\"message\":\"i am service b\"}\n{\"message\":\"i am service b\"}\n</code></pre> </p>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#24vsvs","title":"2.4\u3001\u8c03\u7528\u670d\u52a1\u914d\u7f6evs\uff0c\u88ab\u6389\u670d\u52a1\u672a\u914d\u7f6evs","text":"<ul> <li>service-a-svc:8000</li> <li>service-b: 9000 <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: service-vs\nspec:\n  hosts:\n  - service-a-svc\n  http:\n  - match:\n    - uri:\n        prefix: /api/v1/\n    route:\n    - destination:\n        host: service-a-svc\n        port:\n          number: 8000\n</code></pre> \u4f1a\u4ece\u4ecekiali\u7684\u8c03\u7528\u94fe\u4e2d\u53d1\u73b0\uff0c\u662f\u6ca1\u7ecf\u8fc7vs\u7684\u3002 <pre><code>$ for i in `seq 1 100`;do curl http://service-a-svc:8000/api/v1/users/; echo -n \"\\n\";done\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n</code></pre></li> </ul>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#3vs","title":"3\u3001vs\u914d\u7f6e","text":"","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#31subset-hostshost","title":"3.1\u3001subset hosts\u7f3a\u5c11\u4e00\u4e2ahost\u5f15\u53d1\u7684\u95ee\u9898","text":"<p>\u4e24\u4e2a\u670d\u52a1\u7684deployment, \u533a\u522b\u5c31\u662fservice-b\u6709v2\u7684\u7248\u672c service-a-svc\u914d\u7f6e\uff1a <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: service-a\n  labels:\n    app: service-a\n    version: v1\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: service-a\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: service-a\n        version: v1\n    spec:\n      containers:\n      - name: service-a\n        image: service-a:v7\n        ports:\n        - containerPort: 8000\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: service-a-svc\n  labels:\n    app: service-a\nspec:\n  selector:\n    app: service-a\n  ports:\n  - name: http\n    protocol: TCP\n    port: 8000\n    targetPort: 8000\n</code></pre></p> <p>service-b\u914d\u7f6e\uff1a <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: service-b-v1\n  labels:\n    app: service-b\n    version: v1\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: service-b\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: service-b\n        version: v1\n    spec:\n      containers:\n      - name: service-b\n        image: service-b:v6\n        ports:\n        - containerPort: 9000\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: service-b-v2\n  labels:\n    app: service-b\n    version: v2\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: service-b\n      version: v2\n  template:\n    metadata:\n      labels:\n        app: service-b\n        version: v2\n    spec:\n      containers:\n      - name: service-b\n        image: service-b:v6\n        ports:\n        - containerPort: 9000\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: service-b\n  labels:\n    app: service-b\nspec:\n  selector:\n    app: service-b\n  ports:\n  - name: http\n    protocol: TCP\n    port: 9000\n    targetPort: 9000\n</code></pre></p> <p>vs\u7684\u914d\u7f6e <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: myservice-vs\nspec:\n  hosts:\n  - service-a-svc\n  - service-b\n  http:\n  - name: \"service-a-routes\"\n    match:\n    - uri:\n        prefix: \"/api/v1/\"\n    route:\n    - destination:\n        host: service-a-svc\n        subset: v1\n  - name: \"service-b-route\"\n    route:\n    - destination:\n        host: service-b\n        subset: v2\n\n---\napiVersion: networking.istio.io/v1\nkind: DestinationRule\nmetadata:\n  name: service-a-svc-destination\nspec:\n  host: service-a-svc\n  subsets:\n  - name: v1\n    labels:\n      version: v1\n\n---\napiVersion: networking.istio.io/v1\nkind: DestinationRule\nmetadata:\n  name: service-b-destination\nspec:\n  host: service-b\n  subsets:\n  - name: v1\n    labels:\n      version: v1\n  - name: v2\n    labels:\n      version: v2\n</code></pre> \u6267\u884c\u5982\u4e0bshell\u4e4b\u540e\uff0c\u6548\u679c\u5e94\u8be5\u662f\u8bf7\u6c42\u4eceservice-a-svc\u7684v1\u7248\u672c\uff0c\u5230service-b\u7684v2\u7248\u672c\u3002 <pre><code>for i in `seq 1 1000`;do curl http://service-a-svc:8000/api/v1/users/; echo -n \"\\n\";done\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n\"{\\\"message\\\":\\\"i am service b\\\"}\"\n</code></pre> </p>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#311vshostsservice-b","title":"3.1.1\u3001\u5c06\u4e0a\u8ff0vs\u4e2d\u7684hosts\u4e2d\u5220\u9664service-b\u4f1a\u51fa\u73b0\u4ec0\u4e48\u6548\u679c\uff1f","text":"<p>what???\u600e\u4e48\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\uff1f\uff1f\uff1f</p> <p>\u770b\u4e0a\u53bb\u4f3c\u4e4e\u7ecf\u8fc7vs\uff0c\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u6211\u7ed9vs\u8fdb\u884c\u4e86\u6545\u969c\u6ce8\u5165,\u4e24\u4e2aroute\u5206\u522b\u6ce8\u5165,service-b-route\u5e76\u6ca1\u6709\u751f\u6548\uff0cservice-a-routes\u751f\u6548\u4e86\uff0c\u6240\u4ee5\u867d\u7136kiali\u4e2d\u611f\u89c9vs\u751f\u6548\u4e86\u3002\u6240\u4ee5\u8fd8\u662f\u8d70\u7684svc\uff0csvc\u5bf9\u5e94\u4e86\u4e24\u4e2adeployment\uff0c\u53d1\u751f\u4e86\u8d1f\u8f7d\u5747\u8861\u3002 <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: myservice-vs\nspec:\n  hosts:\n  - service-a-svc\n  http:\n  - name: \"service-a-routes\"\n    match:\n    - uri:\n        prefix: \"/api/v1/\"\n    route:\n    - destination:\n        host: service-a-svc\n        subset: v1\n    fault:\n      delay:\n        percentage:\n          value: 10\n        fixedDelay: 5s\n  - name: \"service-b-route\"\n    route:\n    - destination:\n        host: service-b\n        subset: v2\n   fault:\n     delay:\n       percentage:\n         value: 10\n       fixedDelay: 5s\n</code></pre></p>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#312vshostsservice-bhttpnameservice-b-route","title":"3.1.2\u3001\u5c06\u4e0a\u8ff0vs\u4e2d\u7684hosts\u7684service-b\u5220\u9664\uff0chttp.name.service-b-route \u4e5f\u5220\u6389","text":"<p><pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: myservice-vs\nspec:\n  hosts:\n  - service-a-svc\n  http:\n  - name: \"service-a-routes\"\n    match:\n    - uri:\n        prefix: \"/api/v1/\"\n    route:\n    - destination:\n        host: service-a-svc\n        subset: v1\n</code></pre> \u8fd9\u6837\u8bbf\u95eeservice-b\u65f6\u5c31\u662f\u8d70\u7684service\uff0c\u4e0d\u7ecf\u8fc7vs\u3002 </p>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#32delegate","title":"3.2\u3001Delegate","text":"<p>\u5c06\u8bf7\u6c42\u59d4\u6258\u7ed9\u67d0\u4e2avs\u6267\u884c\u3002\u6709\u70b9\u50cf\u53cd\u5411\u4ee3\u7406\u4e2d\u7684\u670d\u52a1\u5668\u7ec4\u3002 <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: main-service\nspec:\n  hosts:\n  - \"myservice-a.com\"\n  gateways:\n  - my-service-gw\n  http:\n  - match:\n    - uri:\n        prefix: \"/api/v1/\"\n    delegate:\n       name: service-a-vs\n       namespace: default\n  - match:\n    - uri:\n        prefix: \"/api/v2/\"\n    delegate:\n        name: service-b-vs\n        namespace: default\n---\napiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: service-a-vs\nspec:\n  http:\n  - match:\n     - uri:\n        prefix: \"/api/v1/\"\n    route:\n    - destination:\n        host: service-a-svc\n---\napiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: service-b-vs\nspec:\n  http:\n  - match:\n     - uri:\n        prefix: \"/api/v2/\"\n    route:\n    - destination:\n        host: service-b\n</code></pre> <pre><code>\u4f7f\u7528gateway\u5185\u7f51\u5730\u5740\u6216\u8005\u516c\u7f51\u5730\u5740\u8bf7\u6c42\u90fd\u53ef\u4ee5\uff0c\u5185\u7f51\u5730\u5740\u9700\u8981\u914d\u7f6e\u672c\u5730host\nfor i in `seq 1 1000`;do curl http://myservice-a.com/api/v1/users/; echo -n \"\\n\";done\n\nhttp://myservice-a.com/api/v1/users/\n</code></pre> </p>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#33headers","title":"3.3\u3001\u4fee\u6539headers\u5934","text":"<p>\u53ef\u4ee5\u589e\u52a0\u6216\u8005\u5220\u9664header\u5934\u3002</p> <p>\u7ed9a\u670d\u52a1\u589e\u52a0\u4e00\u4e2a\u8fd4\u56deheader\u7684\u63a5\u53e3\u3002 <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: main-service\nspec:\n  hosts:\n  - \"myservice-a.com\"\n  gateways:\n  - my-service-gw\n  http:\n  - match:\n    - uri:\n        prefix: \"/api/v1/\"\n    route:\n    - destination:\n        host: service-a-svc\n    headers:\n      request:\n        set:\n          myservice-a: \"true\"\n  - match:\n    - uri:\n        prefix: \"/api/v2/\"\n    route:\n    - destination:\n        host: service-b\n</code></pre> <pre><code>\u8bbf\u95eehttp://myservice-a.com/api/v1/users/get_headers/\n{\n    \"host\": \"myservice-a.com\",\n    \"user-agent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36\",\n    \"accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\",\n    \"accept-encoding\": \"gzip, deflate\",\n    \"accept-language\": \"zh-CN,zh;q=0.9,en;q=0.8\",\n    \"cache-control\": \"max-age=0\",\n    \"upgrade-insecure-requests\": \"1\",\n    \"x-forwarded-for\": \"192.168.65.3\",\n    \"x-forwarded-proto\": \"http\",\n    \"x-request-id\": \"8f08441f-1ca9-9688-8ccd-dbe058180c34\",\n    \"x-envoy-attempt-count\": \"1\",\n    \"myservice-a\": \"true\",\n    \"x-envoy-internal\": \"true\",\n    \"x-forwarded-client-cert\": \"By=spiffe://cluster.local/ns/default/sa/default;Hash=347002b9c8ed65b802b993a91dc54ad26e75323828c78573636260378f7c291a;Subject=\\\"\\\";URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\"\n}\n</code></pre></p>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#34tls-tlsroute","title":"3.4\u3001tls\u8def\u7531-TLSRoute","text":"\u5b98\u65b9\u6848\u4f8b <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: bookinfo-sni\nspec:\n  hosts:\n  - \"*.bookinfo.com\"\n  gateways:\n  - mygateway\n  tls:\n  - match:\n    - port: 443\n      sniHosts:\n      - login.bookinfo.com\n    route:\n    - destination:\n        host: login.prod.svc.cluster.local\n  - match:\n    - port: 443\n      sniHosts:\n      - reviews.bookinfo.com\n    route:\n    - destination:\n        host: reviews.prod.svc.cluster.local\n</code></pre>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#35tcp-tcproute","title":"3.5\u3001tcp\u8def\u7531-TCPRoute","text":"\u5b98\u65b9\u6848\u4f8b <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: bookinfo-mongo\nspec:\n  hosts:\n  - mongo.prod.svc.cluster.local\n  tcp:\n  - match:\n    - port: 27017\n    route:\n    - destination:\n        host: mongo.backup.svc.cluster.local\n        port:\n          number: 5555\n</code></pre>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#36http-httpmatchrequest","title":"3.6\u3001http\u5339\u914d\u8bf7\u6c42-HTTPMatchRequest","text":"<p>\u6ca1\u5565\u597d\u73a9\u7684\u5c31\u4e0d\u81ea\u5df1\u6d4b\u8bd5\u4e86\u3002</p> <p>\u5185\u5bb9\u9650\u5236\u89c4\u5219\u4ec5\u5339\u914d URL \u8def\u5f84\u4ee5 /ratings/v2/ \u5f00\u5934\u4e14\u8bf7\u6c42\u5305\u542bend-user\u503c\u4e3ajason\u7684\u81ea\u5b9a\u4e49\u6807\u5934\u7684\u8bf7\u6c42\u3002</p> <ul> <li>If a root VirtualService have matched any property (path, header etc.) by regex, delegate VirtualServices should not have any other matches on the same property.</li> <li>If a delegate VirtualService have matched any property (path, header etc.) by regex, root VirtualServices should not have any other matches on the same property.</li> </ul> \u5b98\u65b9\u6848\u4f8b <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: ratings-route\nspec:\n  hosts:\n  - ratings.prod.svc.cluster.local\n  http:\n  - match:\n    - headers:\n        end-user:\n          exact: jason\n      uri:\n        prefix: \"/ratings/v2/\"\n      ignoreUriCase: true\n    route:\n    - destination:\n        host: ratings.prod.svc.cluster.local\n</code></pre>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#37httproutedestination","title":"3.7\u3001HTTPRouteDestination","text":"<p>\u6bcf\u6761\u8def\u7531\u89c4\u5219\u90fd\u4e0e\u4e00\u4e2a\u6216\u591a\u4e2a\u670d\u52a1\u7248\u672c\u76f8\u5173\u8054\uff08\u8bf7\u53c2\u9605\u6587\u6863\u5f00\u5934\u7684\u8bcd\u6c47\u8868\uff09\u3002\u4e0e\u7248\u672c\u76f8\u5173\u8054\u7684\u6743\u91cd\u51b3\u5b9a\u4e86\u5176\u63a5\u6536\u7684\u6d41\u91cf\u6bd4\u4f8b\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u89c4\u5219\u5c06\u201creviews\u201d\u670d\u52a1\u7684 25% \u6d41\u91cf\u8def\u7531\u5230\u5e26\u6709\u201cv2\u201d\u6807\u7b7e\u7684\u5b9e\u4f8b\uff0c\u5176\u4f59\u6d41\u91cf\uff08\u5373 75%\uff09\u8def\u7531\u5230\u201cv1\u201d\u3002</p> \u5b98\u65b9\u4f8b\u5b50 <p><pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: reviews-route\nspec:\n  hosts:\n  - reviews.prod.svc.cluster.local\n  http:\n  - route:\n    - destination:\n        host: reviews.prod.svc.cluster.local\n        subset: v2\n      weight: 25\n    - destination:\n        host: reviews.prod.svc.cluster.local\n        subset: v1\n      weight: 75\n</code></pre> \u4ee5\u53ca\u5173\u8054\u7684 DestinationRule</p> <pre><code>apiVersion: networking.istio.io/v1\nkind: DestinationRule\nmetadata:\n  name: reviews-destination\nspec:\n  host: reviews.prod.svc.cluster.local\n  subsets:\n  - name: v1\n    labels:\n      version: v1\n  - name: v2\n    labels:\n      version: v2\n</code></pre> <p>\u6d41\u91cf\u8fd8\u53ef\u4ee5\u5206\u6563\u5230\u4e24\u4e2a\u5b8c\u5168\u4e0d\u540c\u7684\u670d\u52a1\u4e2d\uff0c\u800c\u65e0\u9700\u5b9a\u4e49\u65b0\u7684\u5b50\u96c6\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u89c4\u5219\u5c06 25% \u7684 reviews.com \u6d41\u91cf\u8f6c\u53d1\u5230 dev.reviews.com</p> <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: reviews-route-two-domains\nspec:\n  hosts:\n  - reviews.com\n  http:\n  - route:\n    - destination:\n        host: dev.reviews.com\n      weight: 25\n    - destination:\n        host: reviews.com\n      weight: 75\n</code></pre>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#384-l4matchattributes","title":"3.8\u30014\u5c42\u5c5e\u6027\u5339\u914d-L4MatchAttributes","text":"Gpt\u7684\u6837\u4f8b <p>1\u3001\u57fa\u4e8e\u76ee\u6807\u7aef\u53e3\u7684\u6d41\u91cf\u5339\u914d <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: my-service\nspec:\n  hosts:\n    - my-service.default.svc.cluster.local\n  tcp:\n    - match:\n        - port: 8080  # \u5339\u914d TCP 8080 \u7aef\u53e3\n      route:\n        - destination:\n            host: my-service\n            port:\n              number: 8080\n    - match:\n        - port: 80  # \u5339\u914d TCP 80 \u7aef\u53e3\n      route:\n        - destination:\n            host: my-service\n            port:\n              number: 80\n</code></pre></p> <p>2\u3001\u57fa\u4e8e\u6765\u6e90\u5b50\u7f51\u7684\u6d41\u91cf\u5339\u914d <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: internal-external-split\nspec:\n  hosts:\n    - my-service.default.svc.cluster.local\n  tcp:\n    - match:\n        - sourceSubnet: \"10.0.0.0/8\"  # \u5339\u914d\u5185\u7f51\u6d41\u91cf\n      route:\n        - destination:\n            host: internal-service  # \u8def\u7531\u5230\u5185\u90e8\u670d\u52a1\n            port:\n              number: 80\n    - match:\n        - sourceSubnet: \"0.0.0.0/0\"  # \u5339\u914d\u6240\u6709\u516c\u7f51\u6d41\u91cf\n      route:\n        - destination:\n            host: external-service  # \u8def\u7531\u5230\u5916\u90e8\u670d\u52a1\n            port:\n              number: 80\n</code></pre></p> <p>3\u3001\u57fa\u4e8e\u6e90\u547d\u540d\u7a7a\u95f4\u548c\u6807\u7b7e\u7684\u6d41\u91cf\u5339\u914d \u8fd9\u79cd\u914d\u7f6e\u53ef\u4ee5\u5c06\u6d41\u91cf\u6e90\u4e0e\u547d\u540d\u7a7a\u95f4\u6216 Kubernetes \u6807\u7b7e\u7ed3\u5408\u8d77\u6765\u4f7f\u7528\uff0c\u7528\u4e8e\u8de8\u547d\u540d\u7a7a\u95f4\u7684\u6d41\u91cf\u63a7\u5236\u3002 <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: restrict-prod-access\nspec:\n  hosts:\n    - restricted-service.default.svc.cluster.local\n  tcp:\n    - match:\n        - sourceNamespace: prod  # \u4ec5\u5141\u8bb8\u6765\u81ea prod \u547d\u540d\u7a7a\u95f4\u7684\u6d41\u91cf\n      route:\n        - destination:\n            host: restricted-service\n            port:\n              number: 8080\n</code></pre></p> <p>4\u3001\u57fa\u4e8e\u7f51\u5173\u7684\u6d41\u91cf\u5339\u914d \u5982\u679c\u4f60\u6709\u591a\u4e2a\u7f51\u5173\u5e76\u5e0c\u671b\u6839\u636e\u6d41\u91cf\u8fdb\u5165\u7684\u7f51\u5173\u8fdb\u884c\u4e0d\u540c\u5904\u7406\uff0c\u53ef\u4ee5\u4f7f\u7528 gateway \u5b57\u6bb5\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: gateway-split\nspec:\n  hosts:\n    - my-service.default.svc.cluster.local\n  tcp:\n    - match:\n        - gateway: internal-gateway  # \u5185\u90e8\u7f51\u5173\u7684\u6d41\u91cf\n      route:\n        - destination:\n            host: internal-service\n            port:\n              number: 8080\n    - match:\n        - gateway: external-gateway  # \u5916\u90e8\u7f51\u5173\u7684\u6d41\u91cf\n      route:\n        - destination:\n            host: external-service\n            port:\n              number: 8080\n</code></pre>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#39tls-tlsmatchattributes","title":"3.9\u3001tls\u5339\u914d\u5c5e\u6027-TLSMatchAttributes","text":"Gpt\u793a\u4f8b <p>1\u3001\u57fa\u4e8e SNI \u7684\u6d41\u91cf\u5339\u914d SNI\uff08Server Name Indication\uff09\u662f\u5ba2\u6237\u7aef\u5728\u53d1\u8d77 TLS \u8fde\u63a5\u65f6\u53d1\u9001\u7684\u4e3b\u673a\u540d\uff0c\u7528\u4e8e\u533a\u5206\u4e0d\u540c\u7684 TLS \u670d\u52a1\u3002\u901a\u8fc7\u5339\u914d SNI\uff0c\u53ef\u4ee5\u5728\u540c\u4e00 IP \u5730\u5740\u4e0b\u8def\u7531\u5230\u4e0d\u540c\u7684\u670d\u52a1\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: tls-routing\nspec:\n  hosts:\n    - \"*\"\n  tls:\n    - match:\n        - port: 443  # \u5339\u914d HTTPS/TLS \u7aef\u53e3\n          sniHosts:\n            - \"service1.example.com\"  # \u5339\u914d SNI \u4e3a service1.example.com \u7684\u6d41\u91cf\n      route:\n        - destination:\n            host: service1\n            port:\n              number: 443\n    - match:\n        - port: 443\n          sniHosts:\n            - \"service2.example.com\"  # \u5339\u914d SNI \u4e3a service2.example.com \u7684\u6d41\u91cf\n      route:\n        - destination:\n            host: service2\n            port:\n              number: 443\n</code></pre> <p>2\u3001\u57fa\u4e8e\u6765\u6e90\u5b50\u7f51\u7684 TLS \u6d41\u91cf\u5339\u914d \u53ef\u4ee5\u4f7f\u7528 sourceSubnet \u6765\u533a\u5206\u6765\u81ea\u4e0d\u540c\u6765\u6e90\u7684 TLS \u6d41\u91cf\u3002\u6bd4\u5982\uff0c\u4f60\u53ef\u80fd\u5e0c\u671b\u5185\u7f51\u7684 TLS \u6d41\u91cf\u8d70\u4e0d\u540c\u7684\u8def\u7531\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: tls-internal-external\nspec:\n  hosts:\n    - \"*\"\n  tls:\n    - match:\n        - port: 443\n          sourceSubnet: \"10.0.0.0/8\"  # \u5339\u914d\u6765\u81ea\u5185\u7f51\u7684 TLS \u6d41\u91cf\n      route:\n        - destination:\n            host: internal-tls-service\n            port:\n              number: 443\n    - match:\n        - port: 443\n          sourceSubnet: \"0.0.0.0/0\"  # \u5339\u914d\u6765\u81ea\u516c\u7f51\u7684 TLS \u6d41\u91cf\n      route:\n        - destination:\n            host: external-tls-service\n            port:\n              number: 443\n</code></pre> <p>3\u3001\u57fa\u4e8e\u7279\u5b9a\u547d\u540d\u7a7a\u95f4\u548c\u6807\u7b7e\u7684 TLS \u6d41\u91cf\u5339\u914d \u53ef\u4ee5\u6839\u636e Kubernetes \u547d\u540d\u7a7a\u95f4\u6216\u6807\u7b7e\u6765\u5339\u914d TLS \u6d41\u91cf\u6e90\uff0c\u4ece\u800c\u7075\u6d3b\u63a7\u5236\u8de8\u547d\u540d\u7a7a\u95f4\u7684 TLS \u6d41\u91cf\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: restrict-tls-prod\nspec:\n  hosts:\n    - restricted-tls-service.default.svc.cluster.local\n  tls:\n    - match:\n        - sourceNamespace: prod  # \u4ec5\u5141\u8bb8\u6765\u81ea prod \u547d\u540d\u7a7a\u95f4\u7684 TLS \u6d41\u91cf\n      route:\n        - destination:\n            host: restricted-tls-service\n            port:\n              number: 443\n</code></pre> <p>4\u3001\u57fa\u4e8e\u591a\u4e2a\u6761\u4ef6\u7ec4\u5408\u7684 TLS \u6d41\u91cf\u5339\u914d <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: complex-tls-routing\nspec:\n  hosts:\n    - \"*\"\n  tls:\n    - match:\n        - port: 443\n          sniHosts:\n            - \"internal.example.com\"\n          sourceSubnet: \"10.0.0.0/8\"  # \u4ec5\u5339\u914d\u6765\u81ea\u5185\u7f51\u4e14 SNI \u4e3a internal.example.com \u7684 TLS \u6d41\u91cf\n      route:\n        - destination:\n            host: internal-service\n            port:\n              number: 443\n    - match:\n        - port: 443\n          sniHosts:\n            - \"external.example.com\"\n          sourceSubnet: \"0.0.0.0/0\"  # \u5339\u914d\u6765\u81ea\u516c\u7f51\u4e14 SNI \u4e3a external.example.com \u7684 TLS \u6d41\u91cf\n      route:\n        - destination:\n            host: external-service\n            port:\n              number: 443\n</code></pre></p>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#310http-httpredirect","title":"3.10\u3001http\u91cd\u5b9a\u5411-HTTPRedirect","text":"<p>HTTPRedirect \u53ef\u7528\u4e8e\u5411\u8c03\u7528\u8005\u53d1\u9001 301 \u91cd\u5b9a\u5411\u54cd\u5e94\uff0c\u5176\u4e2d\u54cd\u5e94\u4e2d\u7684 Authority/Host \u548c URI \u53ef\u4ee5\u4e0e\u6307\u5b9a\u503c\u4ea4\u6362\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u89c4\u5219\u5c06 ratings \u670d\u52a1\u4e0a\u7684 /v1/getProductRatings API \u8bf7\u6c42\u91cd\u5b9a\u5411\u5230 bookratings \u670d\u52a1\u63d0\u4f9b\u7684 /v1/bookRatings\u3002</p> <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: ratings-route\nspec:\n  hosts:\n  - ratings.prod.svc.cluster.local\n  http:\n  - match:\n    - uri:\n        exact: /v1/getProductRatings\n    redirect:\n      uri: /v1/bookRatings\n      authority: newratings.default.svc.cluster.local\n  ...\n</code></pre>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#311http-httpdirectresponse","title":"3.11\u3001http\u76f4\u63a5\u54cd\u5e94-HTTPDirectResponse","text":"<p>HTTPDirectResponse \u53ef\u7528\u4e8e\u5411\u5ba2\u6237\u7aef\u53d1\u9001\u56fa\u5b9a\u54cd\u5e94\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u89c4\u5219\u5411 /v1/getProductRatings API \u8bf7\u6c42\u8fd4\u56de\u5e26\u6709\u6b63\u6587\u7684\u56fa\u5b9a 503 \u72b6\u6001\u3002</p> <p><pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: ratings-route\nspec:\n  hosts:\n  - ratings.prod.svc.cluster.local\n  http:\n  - match:\n    - uri:\n        exact: /v1/getProductRatings\n    directResponse:\n      status: 503\n      body:\n        string: \"unknown error\"\n  ...\n</code></pre> \u8fd8\u53ef\u4ee5\u6307\u5b9a\u4e8c\u8fdb\u5236\u54cd\u5e94\u4e3b\u4f53\u3002\u8fd9\u5bf9\u4e8e\u975e\u57fa\u4e8e\u6587\u672c\u7684\u534f\u8bae\uff08\u4f8b\u5982 gRPC\uff09\u975e\u5e38\u6709\u7528\u3002</p> <p><pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: ratings-route\nspec:\n  hosts:\n  - ratings.prod.svc.cluster.local\n  http:\n  - match:\n    - uri:\n        exact: /v1/getProductRatings\n    directResponse:\n      status: 503\n      body:\n        bytes: \"dW5rbm93biBlcnJvcg==\" # \"unknown error\" in base64\n  ...\n</code></pre> \u5728 HTTPRoute \u548c direct_response \u4e2d\u6dfb\u52a0\u6807\u5934\u662f\u4e00\u79cd\u5f88\u597d\u7684\u505a\u6cd5\uff0c\u4f8b\u5982\u6307\u5b9a\u8fd4\u56de\u7684 Content-Type\u3002</p> <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: ratings-route\nspec:\n  hosts:\n  - ratings.prod.svc.cluster.local\n  http:\n  - match:\n    - uri:\n        exact: /v1/getProductRatings\n    directResponse:\n      status: 503\n      body:\n        string: \"{\\\"error\\\": \\\"unknown error\\\"}\"\n    headers:\n      response:\n        set:\n          content-type: \"text/plain\"\n  ...\n</code></pre>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#312http-httprewrite","title":"3.12\u3001HTTP\u91cd\u5199-HTTPRewrite","text":"<p>HTTPRewrite \u53ef\u7528\u4e8e\u5728\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u76ee\u6807\u4e4b\u524d\u91cd\u5199 HTTP \u8bf7\u6c42\u7684\u7279\u5b9a\u90e8\u5206\u3002\u91cd\u5199\u539f\u8bed\u53ea\u80fd\u4e0e HTTPRouteDestination \u4e00\u8d77\u4f7f\u7528\u3002\u4ee5\u4e0b\u793a\u4f8b\u6f14\u793a\u4e86\u5982\u4f55\u5728\u8fdb\u884c\u5b9e\u9645 API \u8c03\u7528\u4e4b\u524d\u5c06 API \u8c03\u7528\u7684 URL \u524d\u7f00 (/ratings) \u91cd\u5199\u4e3a ratings \u670d\u52a1\u3002</p> <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: ratings-route\nspec:\n  hosts:\n  - ratings.prod.svc.cluster.local\n  http:\n  - match:\n    - uri:\n        prefix: /ratings\n    rewrite:\n      uri: /v1/bookRatings\n    route:\n    - destination:\n        host: ratings.prod.svc.cluster.local\n        subset: v1\n</code></pre>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#313httprewrite-vs-httpredirect","title":"3.13\u3001HTTPRewrite vs HTTPRedirect","text":"<p>HTTPRewrite \u7528\u4e8e\u4fee\u6539\u8bf7\u6c42\u4e2d\u7684\u8def\u5f84\u6216\u4e3b\u673a\u5934\u4fe1\u606f\uff0c\u5728 Istio \u4e2d\u7528\u4e8e\u5c06\u8bf7\u6c42\u91cd\u5199\u4e3a\u4e0d\u540c\u7684\u8def\u5f84\u6216\u4e3b\u673a\u5730\u5740\uff0c\u800c\u4e0d\u4f1a\u6539\u53d8\u8bf7\u6c42\u7684\u72b6\u6001\u7801\u3002\u5ba2\u6237\u7aef\u5e76\u4e0d\u4f1a\u5bdf\u89c9\u5230\u8bf7\u6c42\u8def\u5f84\u88ab\u4fee\u6539\uff0c\u6574\u4e2a\u8fc7\u7a0b\u5bf9\u5ba2\u6237\u7aef\u662f\u900f\u660e\u7684\u3002</p> <p>HTTPRedirect \u7528\u4e8e\u53d1\u9001 HTTP \u91cd\u5b9a\u5411\u54cd\u5e94\u7ed9\u5ba2\u6237\u7aef\uff0c\u5e76\u8ba9\u5ba2\u6237\u7aef\u81ea\u5df1\u53bb\u8bbf\u95ee\u65b0\u7684 URL\u3002\u901a\u5e38\u7528\u4e8e\u5c06\u5ba2\u6237\u7aef\u8bf7\u6c42\u91cd\u5b9a\u5411\u5230\u53e6\u4e00\u4e2a URL \u6216\u8fdb\u884c\u534f\u8bae\u5207\u6362\uff08\u5982 HTTP \u8f6c HTTPS\uff09\u3002\u91cd\u5b9a\u5411\u64cd\u4f5c\u4f1a\u8fd4\u56de 3xx \u72b6\u6001\u7801\uff08\u5982 301 Moved Permanently \u6216 302 Found\uff09\uff0c\u544a\u8bc9\u5ba2\u6237\u7aef URL \u53d1\u751f\u4e86\u53d8\u5316\u3002</p> \u529f\u80fd HTTPRewrite HTTPRedirect \u4f5c\u7528 \u4fee\u6539\u8bf7\u6c42\u8def\u5f84\u6216\u4e3b\u673a\uff0c\u670d\u52a1\u5668\u7aef\u900f\u660e\u5904\u7406 \u8fd4\u56de 3xx \u54cd\u5e94\uff0c\u5ba2\u6237\u7aef\u91cd\u65b0\u8bf7\u6c42 \u5ba2\u6237\u7aef\u53ef\u89c1\u6027 \u5bf9\u5ba2\u6237\u7aef\u4e0d\u53ef\u89c1\uff08\u5ba2\u6237\u7aef\u611f\u77e5\u4e0d\u5230\u8def\u5f84\u7684\u53d8\u5316\uff09 \u5ba2\u6237\u7aef\u53ef\u89c1\uff08\u5ba2\u6237\u7aef\u6536\u5230\u91cd\u5b9a\u5411\u5e76\u91cd\u65b0\u8bf7\u6c42\uff09 \u72b6\u6001\u7801 \u4e0d\u66f4\u6539\u72b6\u6001\u7801\uff0c\u7ee7\u7eed\u5904\u7406\u8bf7\u6c42 \u8fd4\u56de 3xx \u72b6\u6001\u7801\uff08\u5982 301\u3001302\uff09 \u4f7f\u7528\u573a\u666f \u5185\u90e8\u8def\u5f84\u6216\u4e3b\u673a\u7684\u8c03\u6574\u3001\u9690\u85cf\u590d\u6742\u6027 \u534f\u8bae\u5207\u6362\u3001\u8def\u5f84\u8fc1\u79fb\u3001\u6c38\u4e45\u91cd\u5b9a\u5411","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#314regexrewrite","title":"3.14\u3001RegexRewrite","text":"<p>\u57fa\u4e8e\u6b63\u5219\u8868\u8fbe\u5f0f\u5bf9 HTTP \u8bf7\u6c42\u7684 URI \u8fdb\u884c\u4fee\u6539\u7684\u529f\u80fd\u3002\u5b83\u5141\u8bb8\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\u8bf7\u6c42\u7684 URI\uff0c\u7136\u540e\u901a\u8fc7\u66ff\u6362\u7684\u65b9\u5f0f\u5bf9\u5339\u914d\u7684\u90e8\u5206\u8fdb\u884c\u91cd\u5199\u3002</p> Gpt\u793a\u4f8b <p>1\u3001\u7b80\u5355\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u91cd\u5199 \u5047\u8bbe\u4f60\u6709\u4e00\u4e2a\u8bf7\u6c42\u8def\u5f84 /foo/123/bar\uff0c\u4f60\u5e0c\u671b\u5c06\u5176\u91cd\u5199\u4e3a /baz/123/bar\u3002\u8fd9\u91cc\u7684 123 \u53ef\u4ee5\u662f\u4efb\u4f55\u6570\u5b57\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: regex-rewrite-example\nspec:\n  hosts:\n    - my-app.com\n  http:\n    - match:\n        - uri:\n            regex: \"^/foo/([0-9]+)/bar$\"  # \u5339\u914d\u8def\u5f84 /foo/\u6570\u5b57/bar\n      route:\n        - destination:\n            host: my-service\n            port:\n              number: 8080\n      rewrite:\n        regex:\n          pattern: \"^/foo/([0-9]+)/bar$\"  # \u5339\u914d /foo/\u6570\u5b57/bar\n          substitution: \"/baz/$1/bar\"  # \u91cd\u5199\u4e3a /baz/\u6570\u5b57/bar\uff0c$1 \u4ee3\u8868\u7b2c\u4e00\u4e2a\u6355\u83b7\u7ec4\n</code></pre> <p>2\u3001\u590d\u6742\u7684\u91cd\u5199 \u5047\u8bbe\u4f60\u5e0c\u671b\u5c06\u8bf7\u6c42\u8def\u5f84 /api/v1/product/abc123/details \u91cd\u5199\u4e3a /products/abc123/info\uff0c\u5373\u5c06\u8def\u5f84\u4e2d\u7684 /api/v1/product/ \u91cd\u5199\u4e3a /products/\uff0c\u5e76\u4fdd\u7559 abc123 \u7684\u90e8\u5206\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: complex-regex-rewrite\nspec:\n  hosts:\n    - my-app.com\n  http:\n    - match:\n        - uri:\n            regex: \"^/api/v1/product/([a-zA-Z0-9]+)/details$\"\n      route:\n        - destination:\n            host: product-service\n            port:\n              number: 8080\n      rewrite:\n        regex:\n          pattern: \"^/api/v1/product/([a-zA-Z0-9]+)/details$\"\n          substitution: \"/products/$1/info\"  # \u5c06 /api/v1/product/abc123/details \u91cd\u5199\u4e3a /products/abc123/info\n</code></pre> <p>3\u3001\u6b63\u5219\u8868\u8fbe\u5f0f\u91cd\u5199\u5e76\u91cd\u5b9a\u5411\u5230 HTTPS \u6709\u65f6\u4f60\u5e0c\u671b\u4e0d\u4ec5\u4fee\u6539\u8def\u5f84\uff0c\u8fd8\u5e0c\u671b\u5c06\u8bf7\u6c42\u91cd\u5b9a\u5411\u5230 HTTPS\u3002\u6bd4\u5982\uff0c\u91cd\u5199 /blog/2024/10/20/title \u4e3a /article/2024/10/20/title\uff0c\u5e76\u5207\u6362\u5230 HTTPS\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: redirect-and-rewrite\nspec:\n  hosts:\n    - my-app.com\n  http:\n    - match:\n        - uri:\n            regex: \"^/blog/([0-9]{4})/([0-9]{2})/([0-9]{2})/.*$\"  # \u5339\u914d /blog/yyyy/mm/dd/title\n      redirect:\n        uri: \"/article/$1/$2/$3\"  # \u91cd\u5199\u4e3a /article/yyyy/mm/dd\n        scheme: \"https\"  # \u5c06\u8bf7\u6c42\u91cd\u5b9a\u5411\u5230 HTTPS\n</code></pre>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#315stringmatch","title":"3.15\u3001StringMatch","text":"<p>StringMatch \u63d0\u4f9b\u4e86\u4e09\u79cd\u5339\u914d\u65b9\u5f0f\uff1a</p> <ul> <li>exact: \u7cbe\u786e\u5339\u914d\uff0c\u8981\u6c42\u5b57\u7b26\u4e32\u5b8c\u5168\u76f8\u7b49\u3002</li> <li>prefix: \u524d\u7f00\u5339\u914d\uff0c\u8981\u6c42\u5b57\u7b26\u4e32\u4ee5\u6307\u5b9a\u524d\u7f00\u5f00\u5934\u3002</li> <li>regex: \u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\uff0c\u57fa\u4e8e\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\u5b57\u7b26\u4e32\u3002</li> </ul> Gpt\u793a\u4f8b <p>1\u3001\u7cbe\u786e\u5339\u914d <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: product-service\nspec:\n  hosts:\n    - my-product-service.com\n  http:\n    - match:\n        - uri:\n            exact: \"/products/detail\"  # \u7cbe\u786e\u5339\u914d\u8def\u5f84 /products/detail\n      route:\n        - destination:\n            host: product-service\n            port:\n              number: 8080\n</code></pre></p>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#316http-httpretry","title":"3.16\u3001http\u91cd\u8bd5-HTTPRetry","text":"<p>\u63cf\u8ff0 HTTP \u8bf7\u6c42\u5931\u8d25\u65f6\u4f7f\u7528\u7684\u91cd\u8bd5\u7b56\u7565\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u89c4\u5219\u5c06\u8c03\u7528 ratings:v1 \u670d\u52a1\u65f6\u7684\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u8bbe\u7f6e\u4e3a 3\uff0c\u6bcf\u6b21\u91cd\u8bd5\u7684\u8d85\u65f6\u65f6\u95f4\u4e3a 2 \u79d2\u3002\u5982\u679c\u51fa\u73b0\u8fde\u63a5\u5931\u8d25\u3001refused_stream \u6216\u4e0a\u6e38\u670d\u52a1\u5668\u54cd\u5e94\u670d\u52a1\u4e0d\u53ef\u7528 (503)\uff0c\u5219\u4f1a\u5c1d\u8bd5\u91cd\u8bd5\u3002</p> <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: ratings-route\nspec:\n  hosts:\n  - ratings.prod.svc.cluster.local\n  http:\n  - route:\n    - destination:\n        host: ratings.prod.svc.cluster.local\n        subset: v1\n    retries:\n      attempts: 3\n      perTryTimeout: 2s\n      retryOn: gateway-error,connect-failure,refused-stream\n</code></pre>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#317-corspolicy","title":"3.17\u3001\u8de8\u57df-CorsPolicy","text":"<p>\u793a\u4f8b <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: ratings-route\nspec:\n  hosts:\n  - ratings.prod.svc.cluster.local\n  http:\n  - route:\n    - destination:\n        host: ratings.prod.svc.cluster.local\n        subset: v1\n    corsPolicy:\n      allowOrigins:\n      - exact: https://example.com\n      allowMethods:\n      - POST\n      - GET\n      allowCredentials: false\n      allowHeaders:\n      - X-Foo-Bar\n      maxAge: \"24h\"\n</code></pre></p>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#318http-httpfaultinjection","title":"3.18\u3001http\u6545\u969c\u6ce8\u5165-HTTPFaultInjection","text":"\u5b98\u7f51\u793a\u4f8b <p>1\u3001\u5ef6\u8fdf\u89c4\u8303\u7528\u4e8e\u5c06\u5ef6\u8fdf\u6ce8\u5165\u8bf7\u6c42\u8f6c\u53d1\u8def\u5f84\u3002\u4ee5\u4e0b\u793a\u4f8b\u5c06\u4ece\u6240\u6709\u5e26\u6709\u6807\u7b7e env: prod \u7684 pod \u5411\u201creviews\u201d\u670d\u52a1\u7684\u201cv1\u201d\u7248\u672c\u53d1\u51fa\u7684\u6bcf 1000 \u4e2a\u8bf7\u6c42\u4e2d\uff0c\u6709 1 \u4e2a\u8bf7\u6c42\u4f1a\u5ef6\u8fdf 5 \u79d2 <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: reviews-route\nspec:\n  hosts:\n  - reviews.prod.svc.cluster.local\n  http:\n  - match:\n    - sourceLabels:\n        env: prod\n    route:\n    - destination:\n        host: reviews.prod.svc.cluster.local\n        subset: v1\n    fault:\n      delay:\n        percentage:\n          value: 0.1\n        fixedDelay: 5s\n</code></pre></p> <p>2\u3001\u4e2d\u6b62\u89c4\u8303\u7528\u4e8e\u63d0\u524d\u4e2d\u6b62\u5177\u6709\u9884\u5148\u6307\u5b9a\u7684\u9519\u8bef\u4ee3\u7801\u7684\u8bf7\u6c42\u3002\u4ee5\u4e0b\u793a\u4f8b\u5c06\u5bf9\u201c\u8bc4\u7ea7\u201d\u670d\u52a1\u201cv1\u201d\u7684\u6bcf 1000 \u4e2a\u8bf7\u6c42\u4e2d\u7684 1 \u4e2a\u8fd4\u56de HTTP 400 \u9519\u8bef\u4ee3\u7801\u3002</p> <pre><code>apiVersion: networking.istio.io/v1\nkind: VirtualService\nmetadata:\n  name: ratings-route\nspec:\n  hosts:\n  - ratings.prod.svc.cluster.local\n  http:\n  - route:\n    - destination:\n        host: ratings.prod.svc.cluster.local\n        subset: v1\n    fault:\n      abort:\n        percentage:\n          value: 0.1\n        httpStatus: 400\n</code></pre>","tags":["istio","k8s"]},{"location":"blog/2024/10/15/istio-virtualservice-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/#319http-httpmirrorpolicy","title":"3.19\u3001HTTP\u955c\u50cf\u7b56\u7565-HTTPMirrorPolicy","text":"<p>HTTPMirrorPolicy \u53ef\u7528\u4e8e\u6307\u5b9a\u9664\u539f\u59cb\u76ee\u6807\u4e4b\u5916\u7684\u955c\u50cf HTTP \u6d41\u91cf\u7684\u76ee\u6807\u3002\u955c\u50cf\u6d41\u91cf\u662f\u5c3d\u6700\u5927\u52aa\u529b\u7684\uff0c\u5176\u4e2d sidecar/\u7f51\u5173\u4e0d\u4f1a\u7b49\u5f85\u955c\u50cf\u76ee\u6807\u54cd\u5e94\u5c31\u8fd4\u56de\u539f\u59cb\u76ee\u6807\u7684\u54cd\u5e94\u3002\u5c06\u4e3a\u955c\u50cf\u76ee\u6807\u751f\u6210\u7edf\u8ba1\u4fe1\u606f\u3002</p> Gpt\u793a\u4f8b <p>1\u3001\u955c\u50cf\u8bf7\u6c42\u5230\u53e6\u4e00\u4e2a\u670d\u52a1 <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: my-virtualservice\nspec:\n  hosts:\n    - primary-service.default.svc.cluster.local\n  http:\n    - route:\n        - destination:\n            host: primary-service.default.svc.cluster.local\n            port:\n              number: 80\n      mirror:\n        host: mirror-service.default.svc.cluster.local\n        port:\n          number: 8080\n      mirrorPercentage:\n        value: 100  # \u5c06 100% \u7684\u8bf7\u6c42\u955c\u50cf\u5230 mirror-service\n</code></pre></p> <p>2\u3001\u90e8\u5206\u8bf7\u6c42\u955c\u50cf <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: partial-mirror\nspec:\n  hosts:\n    - primary-service.default.svc.cluster.local\n  http:\n    - route:\n        - destination:\n            host: primary-service.default.svc.cluster.local\n            port:\n              number: 80\n      mirror:\n        host: mirror-service.default.svc.cluster.local\n        port:\n          number: 8080\n      mirrorPercentage:\n        value: 50  # \u53ea\u955c\u50cf 50% \u7684\u8bf7\u6c42\n</code></pre> 3\u3001\u955c\u50cf\u5230\u4e0d\u540c\u7684\u5b50\u96c6 <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: mirror-to-subset\nspec:\n  hosts:\n    - primary-service.default.svc.cluster.local\n  http:\n    - route:\n        - destination:\n            host: primary-service.default.svc.cluster.local\n            subset: v1\n            port:\n              number: 80\n      mirror:\n        host: primary-service.default.svc.cluster.local\n        subset: v2  # \u5c06\u8bf7\u6c42\u955c\u50cf\u5230 v2 \u5b50\u96c6\n        port:\n          number: 80\n      mirrorPercentage:\n        value: 100\n</code></pre></p>","tags":["istio","k8s"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/","title":"k8s1.30.2\u5806\u53e0\u96c6\u7fa4\u90e8\u7f72","text":"<p>k8s1.30.2\u5806\u53e0\u96c6\u7fa4\u5b89\u88c5\u5b89\u88c5\u3002</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1","title":"1\u3001\u51c6\u5907\u4e09\u53f0\u63a7\u5236\u5e73\u9762\u673a\u5668","text":"<p>\u4e24\u53f0\u673a\u5668\u4e0a\u9010\u6b65\u5b89\u88c5haproxy\u548ckeepalived</p> <ul> <li>\u5b98\u65b9\u7684\u9ad8\u53ef\u7528\u65b9\u6848</li> <li>debian11</li> </ul>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#2","title":"2\u3001\u9ad8\u53ef\u7528\u914d\u7f6e","text":"","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1haproxy-2810","title":"1\u3001haproxy-2.8.10","text":"","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1centos","title":"1\u3001centos\u5b89\u88c5","text":"<p>\u5b89\u88c5\u6587\u6863 <pre><code>\u57fa\u7840\u4f9d\u8d56\nyum install gcc gcc-c++ pcre-devel openssl-devel systemd-devel -y\n\n\n$ make clean\n$ make -j $(nproc) TARGET=linux-glibc \\\n            USE_OPENSSL=1 USE_LUA=1 USE_PCRE=1 USE_SYSTEMD=1\n$ sudo make install\n\n\n\u4e0d\u7528lua\u53ef\u4ee5\u4e0d\u52a0lua\u7684\u53c2\u6570\n</code></pre></p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#2_1","title":"2\u3001\u5b98\u65b9\u914d\u7f6e\u6587\u4ef6","text":"\u5b98\u65b9\u914d\u7f6e\u6587\u4ef6 <pre><code># /etc/haproxy/haproxy.cfg\n#---------------------------------------------------------------------\n# Global settings\n#---------------------------------------------------------------------\nglobal\n    log stdout format raw local0\n    daemon\n\n#---------------------------------------------------------------------\n# common defaults that all the 'listen' and 'backend' sections will\n# use if not designated in their block\n#---------------------------------------------------------------------\ndefaults\n    mode                    http\n    log                     global\n    option                  httplog\n    option                  dontlognull\n    option http-server-close\n    option forwardfor       except 127.0.0.0/8\n    option                  redispatch\n    retries                 1\n    timeout http-request    10s\n    timeout queue           20s\n    timeout connect         5s\n    timeout client          35s\n    timeout server          35s\n    timeout http-keep-alive 10s\n    timeout check           10s\n\n#---------------------------------------------------------------------\n# apiserver frontend which proxys to the control plane nodes\n#---------------------------------------------------------------------\nfrontend apiserver\n    bind *:9443\n    mode tcp\n    option tcplog\n    default_backend apiserverbackend\n\n#---------------------------------------------------------------------\n# round robin balancing for apiserver\n#---------------------------------------------------------------------\nbackend apiserverbackend\n    option httpchk\n\n    http-check connect ssl\n    http-check send meth GET uri /healthz\n    http-check expect status 200\n\n    mode tcp\n    balance     roundrobin\n\n    server k8s-m-1 192.168.47.158:6443 check verify none\n    server k8s-m-2 192.168.47.153:6443 check verify none\n    server k8s-m-3 192.168.47.154:6443 check verify none\n</code></pre> <p>\u542f\u52a8haproxy -f /etc/haproxy/haproxy.cfg</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#3debian","title":"3\u3001debian\u5b89\u88c5","text":"Debian\u5b89\u88c5 <pre><code>apt install -y linux-kbuild-5.10 make libsystemd-dev curl\n\ncurl -L -R -O https://www.lua.org/ftp/lua-5.4.7.tar.gz\ntar zxf lua-5.4.7.tar.gz\ncd lua-5.4.7\nmake all test\nmake linux install\n\n\u6700\u540e\u5f00\u59cb\u4e0a\u9762centos\u7684\u6d41\u7a0b\nmake -j $(nproc) TARGET=linux-glibc   USE_OPENSSL=1 USE_LUA=1 USE_PCRE=1 USE_SYSTEMD=1\n</code></pre>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1keepalived-224","title":"1\u3001keepalived-2.2.4","text":"","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1centos_1","title":"1\u3001centos\u5b89\u88c5","text":"<p>centos\u5b89\u88c5 <pre><code>yum install curl gcc openssl-devel libnl3-devel net-snmp-devel -y\n\n./configure\nmake\nmake install\n\n\u53ef\u4ee5\u53c2\u8003INSTALL\u6587\u4ef6\n</code></pre></p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#2master","title":"2\u3001master\u914d\u7f6e","text":"Master\u914d\u7f6e <pre><code>! /etc/keepalived/keepalived.conf\n! Configuration File for keepalived\nglobal_defs {\n    router_id LVS_DEVEL\n}\nvrrp_script check_apiserver {\n  script \"/etc/keepalived/check_apiserver.sh\"\n  interval 3\n  weight -2\n  fall 10\n  rise 2\n}\n\nvrrp_instance VI_1 {\n    state MASTER\n    interface ens33\n    virtual_router_id 66\n    priority 101\n    authentication {\n        auth_type PASS\n        auth_pass 42\n    }\n    virtual_ipaddress {\n        192.168.47.180\n    }\n    track_script {\n        check_apiserver\n    }\n}\n</code></pre>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#3backup","title":"3\u3001backup\u914d\u7f6e","text":"Backup\u914d\u7f6e <pre><code>! /etc/keepalived/keepalived.conf\n! Configuration File for keepalived\nglobal_defs {\n    router_id LVS_DEVEL\n}\nvrrp_script check_apiserver {\n  script \"/etc/keepalived/check_apiserver.sh\"\n  interval 3\n  weight -2\n  fall 10\n  rise 2\n}\n\nvrrp_instance VI_1 {\n    state BACKUP\n    interface ens33\n    virtual_router_id 66\n    priority 100\n    authentication {\n        auth_type PASS\n        auth_pass 42\n    }\n    virtual_ipaddress {\n        192.168.47.180\n    }\n    track_script {\n        check_apiserver\n    }\n}\n</code></pre>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#4apiserver","title":"4\u3001\u68c0\u67e5apiserver\u7684\u63a5\u53e3","text":"<pre><code>check_apiserver.sh\n```shell\n#!/bin/sh\n\nerrorExit() {\n    echo \"*** $*\" 1&gt;&amp;2\n    exit 1\n}\n\ncurl -sfk --max-time 2 https://localhost:9443/healthz -o /dev/null || errorExit \"Error GET https://localhost:9443/healthz\"\n</code></pre> <p>\u542f\u52a8keepalived -f /etc/keepalived/keepalived.conf</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#5debian","title":"5\u3001debian\u5b89\u88c5","text":"<pre><code>apt-get install build-essential libssl-dev libnl-3-dev libnl-genl-3-dev libnfnetlink-dev pkg-config\n\n\n\u7136\u540e\u5f00\u59cb\u4e0a\u9762\u7684\u6d41\u7a0b\n</code></pre> <p>\u865a\u62dfIP\u4f1a\u51fa\u73b0\u5728master\u7684\u673a\u5668\u4e0a\uff0c180\u5c31\u662f\u865a\u62df\u7684IP\uff0c\u4e8c\u5c42\u7f51\u7edc\u662f\u6839\u636emac\u5730\u5740\u901a\u4fe1\u3002 </p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#3kubeadm1302","title":"3\u3001kubeadm1.30.2","text":"","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1_1","title":"1\u3001\u73af\u5883\u51c6\u5907","text":"","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1-ipv4","title":"1\u3001\u542f\u7528 IPv4 \u6570\u636e\u5305\u8f6c\u53d1","text":"<pre><code># \u8bbe\u7f6e\u6240\u9700\u7684 sysctl \u53c2\u6570\uff0c\u53c2\u6570\u5728\u91cd\u65b0\u542f\u52a8\u540e\u4fdd\u6301\u4e0d\u53d8\ncat &lt;&lt;EOF | tee /etc/sysctl.d/k8s.conf\nnet.ipv4.ip_forward = 1\nEOF\n\n# \u5e94\u7528 sysctl \u53c2\u6570\u800c\u4e0d\u91cd\u65b0\u542f\u52a8\nsudo sysctl --system\n</code></pre>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#2containerdrunccni","title":"2\u3001\u5b89\u88c5containerd\u3001runc\u3001cni","text":"<p>crontainerd\u589e\u52a0\u4ee3\u7406 <pre><code>vim /usr/local/lib/systemd/system/containerd.service\n[Service]\nEnvironment=\"HTTP_PROXY=http://192.168.61.198:7890\"\nEnvironment=\"HTTPS_PROXY=http://192.168.61.198:7890\"\nEnvironment=\"NO_PROXY=localhost\"\n\nsystemctl daemon-reload\nsystemctl restart containerd\n</code></pre></p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#3crontainerd-cgroup","title":"3\u3001\u914d\u7f6ecrontainerd cgroup\u9a71\u52a8","text":"<p>\u914d\u7f6ecrontainerd cgroup\u9a71\u52a8 <pre><code>containerd config default &gt; /etc/containerd/config.toml\n\nsystemctl restart containerd\n</code></pre></p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#2kubeadm","title":"2\u3001kubeadm\u51c6\u5907","text":"","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1_2","title":"1\u3001\u51c6\u5907\u5de5\u4f5c","text":"<p>\u53c2\u8003 swap\u7684\u5173\u95ed \u5bbf\u4e3b\u673adns\u6700\u597d\u67e5\u770b\u4e00\u4e0b\uff0c\u5426\u5219\u90e8\u7f72\u5b8c\u53ef\u80fd\u57df\u540d\u4e0d\u901a\u3002</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#2-kubeadmkubelet-kubectl","title":"2\u3001\u5b89\u88c5 kubeadm\u3001kubelet \u548c kubectl","text":"<p>\u53c2\u8003 <pre><code>export HTTP_PROXY=http://192.168.61.198:7890\nexport HTTPS_PROXY=http://192.168.61.198:7890\n\nyum \u5b89\u88c5\u7684\u65f6\u5019\u53ef\u80fd\u4f1a\u5931\u8d25\uff0c\u6ca1\u6709\u4ee3\u7406\u771f\u7684\u4e0d\u592a\u65b9\u4fbf\n</code></pre> \u4f60\u9700\u8981\u786e\u4fdd\u5bb9\u5668\u8fd0\u884c\u65f6\u548c kubelet \u6240\u4f7f\u7528\u7684\u662f\u76f8\u540c\u7684 cgroup \u9a71\u52a8\uff0c\u5426\u5219 kubelet \u8fdb\u7a0b\u4f1a\u5931\u8d25\u3002\u51fa\u5904</p> <p>\u867d\u7136kubeadm \u9ed8\u8ba4\u4f7f\u7528 systemd\uff0c\u4f46\u662f\u8fd8\u662f\u68c0\u67e5kubelet\u662f\u4e0d\u662f\u90fd\u662fsystemd \u5728\u6587\u4ef6 /var/lib/kubelet/config.yaml \u67e5\u770b cgroupDriver: systemd</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#3","title":"3\u3001\u5806\u53e0\u9ad8\u53ef\u7528","text":"<p>\u53c2\u8003\uff0c\u521d\u59cb\u5316\u63a7\u5236\u5e73\u9762\uff0c\u53e6\u5916\u4e24\u53f0\u673a\u5668\u9700\u8981\u52a0\u5165\u63a7\u5236\u5e73\u9762</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1_3","title":"1\u3001\u62c9\u53d6\u6240\u6709\u955c\u50cf","text":"<pre><code>kubeadm config images pull\n</code></pre>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#2_2","title":"2\u3001\u4e24\u79cd\u521d\u59cb\u5316\u65b9\u5f0f","text":"","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1_4","title":"1\u3001\u547d\u4ee4\u884c\u521d\u59cb\u5316","text":"<pre><code>kubeadm init --control-plane-endpoint 192.168.47.180:9443   --upload-certs --service-cidr=10.96.0.0/12   --pod-network-cidr=10.244.0.0/16\n</code></pre> <p>\u521d\u59cb\u5316\u4e4b\u540e\u53d1\u73b0\u6709\u7684pod\u7684ip\u5e76\u6ca1\u6709\u51fa\u73b0\u5728pod cidr\u4e2d\uff0c\u662f\u56e0\u4e3a\u9700\u8981hostNetwork <pre><code>[root@k8s-m-1 ~]# kubectl get pod -A -o wide\nNAMESPACE     NAME                              READY   STATUS    RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES\nkube-system   coredns-7db6d8ff4d-8crsr          1/1     Running   0          21m   10.244.0.15      k8s-m-1   &lt;none&gt;           &lt;none&gt;\nkube-system   coredns-7db6d8ff4d-g58zq          1/1     Running   0          21m   10.244.0.14      k8s-m-1   &lt;none&gt;           &lt;none&gt;\nkube-system   etcd-k8s-m-1                      1/1     Running   1          21m   192.168.47.158   k8s-m-1   &lt;none&gt;           &lt;none&gt;\nkube-system   etcd-k8s-m-2                      1/1     Running   1          20m   192.168.47.153   k8s-m-2   &lt;none&gt;           &lt;none&gt;\nkube-system   etcd-k8s-m-3                      1/1     Running   0          20m   192.168.47.154   k8s-m-3   &lt;none&gt;           &lt;none&gt;\nkube-system   kube-apiserver-k8s-m-1            1/1     Running   1          21m   192.168.47.158   k8s-m-1   &lt;none&gt;           &lt;none&gt;\nkube-system   kube-apiserver-k8s-m-2            1/1     Running   1          20m   192.168.47.153   k8s-m-2   &lt;none&gt;           &lt;none&gt;\nkube-system   kube-apiserver-k8s-m-3            1/1     Running   1          20m   192.168.47.154   k8s-m-3   &lt;none&gt;           &lt;none&gt;\nkube-system   kube-controller-manager-k8s-m-1   1/1     Running   1          21m   192.168.47.158   k8s-m-1   &lt;none&gt;           &lt;none&gt;\nkube-system   kube-controller-manager-k8s-m-2   1/1     Running   1          20m   192.168.47.153   k8s-m-2   &lt;none&gt;           &lt;none&gt;\nkube-system   kube-controller-manager-k8s-m-3   1/1     Running   1          20m   192.168.47.154   k8s-m-3   &lt;none&gt;           &lt;none&gt;\nkube-system   kube-proxy-c4h56                  1/1     Running   0          20m   192.168.47.153   k8s-m-2   &lt;none&gt;           &lt;none&gt;\nkube-system   kube-proxy-q9wbn                  1/1     Running   0          20m   192.168.47.154   k8s-m-3   &lt;none&gt;           &lt;none&gt;\nkube-system   kube-proxy-qsrkf                  1/1     Running   0          20m   192.168.47.155   k8s-w-1   &lt;none&gt;           &lt;none&gt;\nkube-system   kube-proxy-swqmx                  1/1     Running   0          21m   192.168.47.158   k8s-m-1   &lt;none&gt;           &lt;none&gt;\nkube-system   kube-scheduler-k8s-m-1            1/1     Running   1          21m   192.168.47.158   k8s-m-1   &lt;none&gt;           &lt;none&gt;\nkube-system   kube-scheduler-k8s-m-2            1/1     Running   1          20m   192.168.47.153   k8s-m-2   &lt;none&gt;           &lt;none&gt;\nkube-system   kube-scheduler-k8s-m-3            1/1     Running   1          20m   192.168.47.154   k8s-m-3   &lt;none&gt;           &lt;none&gt;\n\n\n\n[root@k8s-m-1 ~]# kubectl get pod etcd-k8s-m-1 -n kube-system -o yaml|grep hostNetwork\n  hostNetwork: true\n</code></pre></p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#2_3","title":"2\u3001\u914d\u7f6e\u6587\u4ef6\u7684\u521d\u59cb\u5316","text":"<p>1) ipvs \u76f8\u5173\u521d\u59cb\u5316 \u914d\u7f6e\u6587\u4ef6\u7684\u521d\u59cb\u5316\u53ef\u4ee5\u589e\u52a0\u529f\u80fd\uff1aipvs\u3001kubelet systemd\u7b49</p> <ul> <li>\u5982\u679c\u9700\u8981\u53d8\u6210ipvs\uff0c rr\u3001wrr\u3001sh\u90fd\u662f\u7b97\u6cd5 <pre><code>yum install ipset ipvsadmin -y\n\n\u91cd\u542f\u5931\u6548\nmodprobe ip_vs\nmodprobe ip_vs_rr\nmodprobe ip_vs_wrr\nmodprobe ip_vs_sh\nmodprobe nf_conntrack_ipv4  \u9ad8\u7248\u672c\u5185\u6838 nf_conntrack\n\n\n\u91cd\u542f\u8fd8\u5728\ncat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF\n#!/bin/bash\nmodprobe  ip_vs\nmodprobe  ip_vs_rr\nmodprobe  ip_vs_wrr\nmodprobe  ip_vs_sh\nmodprobe  nf_conntrack\nEOF\nchmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vs\n</code></pre> <pre><code>apiVersion: kubeadm.k8s.io/v1beta3\nbootstrapTokens:\n- groups:\n  - system:bootstrappers:kubeadm:default-node-token\n  token: abcdef.0123456789abcdef\n  ttl: 24h0m0s\n  usages:\n  - signing\n  - authentication\nkind: InitConfiguration\nlocalAPIEndpoint:\n  advertiseAddress: 192.168.47.158\n  bindPort: 6443\nnodeRegistration:\n  criSocket: unix:///var/run/containerd/containerd.sock\n  imagePullPolicy: IfNotPresent\n  name: k8s-m-1\n  taints: null\n---\napiServer:\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta3\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns: {}\netcd:\n  local:\n    dataDir: /var/lib/etcd\nimageRepository: registry.k8s.io\nkind: ClusterConfiguration\nkubernetesVersion: 1.30.0\nnetworking:\n  dnsDomain: cluster.local\n  serviceSubnet: 10.96.0.0/12\n  podSubnet: 10.244.0.0/16\nscheduler: {}\ncontrolPlaneEndpoint: \"192.168.47.180:9443\"\n---\nkind: KubeletConfiguration\napiVersion: kubelet.config.k8s.io/v1beta1\ncgroupDriver: systemd\n---\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nkind: KubeProxyConfiguration\nmode: \"ipvs\"\n</code></pre> <pre><code>kubeadm init --config init.yml --upload-certs\n</code></pre> 2) \u6ca1\u6709kubu-proxy\u7684\u521d\u59cb\u5316\uff0ccilium v1.30 <pre><code>apiVersion: kubeadm.k8s.io/v1beta3\nbootstrapTokens:\n- groups:\n  - system:bootstrappers:kubeadm:default-node-token\n  token: abcdef.0123456789abcdef\n  ttl: 24h0m0s\n  usages:\n  - signing\n  - authentication\nkind: InitConfiguration\nlocalAPIEndpoint:\n  advertiseAddress: 192.168.47.158\n  bindPort: 6443\nnodeRegistration:\n  criSocket: unix:///var/run/containerd/containerd.sock\n  imagePullPolicy: IfNotPresent\n  name: k8s-m-1\n  taints: null\n---\napiServer:\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta3\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns: {}\netcd:\n  local:\n    dataDir: /var/lib/etcd\nimageRepository: registry.k8s.io\nkind: ClusterConfiguration\nkubernetesVersion: 1.30.0\nnetworking:\n  dnsDomain: cluster.local\n  serviceSubnet: 10.96.0.0/12\nscheduler: {}\ncontrolPlaneEndpoint: \"192.168.47.180:9443\"\n---\nkind: KubeletConfiguration\napiVersion: kubelet.config.k8s.io/v1beta1\ncgroupDriver: systemd\n</code></pre> v1.29 <pre><code>apiVersion: kubeadm.k8s.io/v1beta3\nbootstrapTokens:\n- groups:\n  - system:bootstrappers:kubeadm:default-node-token\n  token: abcdef.0123456789abcdef\n  ttl: 24h0m0s\n  usages:\n  - signing\n  - authentication\nkind: InitConfiguration\nlocalAPIEndpoint:\n  advertiseAddress: 192.168.47.158\n  bindPort: 6443\nnodeRegistration:\n  criSocket: unix:///var/run/containerd/containerd.sock\n  imagePullPolicy: IfNotPresent\n  name: k8s-m-1\n  taints: null\n---\napiServer:\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta3\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns: {}\netcd:\n  local:\n    dataDir: /var/lib/etcd\nimageRepository: registry.k8s.io\nkind: ClusterConfiguration\nkubernetesVersion: 1.29.0\nnetworking:\n  dnsDomain: cluster.local\n  serviceSubnet: 10.96.0.0/12\nscheduler: {}\ncontrolPlaneEndpoint: \"192.168.47.180:9443\"\n---\nkind: KubeletConfiguration\napiVersion: kubelet.config.k8s.io/v1beta1\ncgroupDriver: systemd\n</code></pre> <pre><code>kubeadm init --config init.yml --upload-certs --skip-phases=addon/kube-proxy\n</code></pre></li> </ul>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#3_1","title":"3\u3001\u521d\u59cb\u5316\u5931\u8d25\uff0c\u6e05\u7406\u73af\u5883","text":"<p>\u67e5\u770b <pre><code>kubeadm reset\niptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X\nipvsadm -C\n</code></pre> \u53c2\u8003</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#4","title":"4\u3001\u521d\u59cb\u5316\u4e4b\u540e\u7684\u6821\u9a8c","text":"<p>\u6821\u9a8cipvs\u6821\u9a8c <pre><code>[root@k8s-m-1 ~]# kubectl logs -n kube-system `kubectl get pods -n kube-system -l k8s-app=kube-proxy -o name|head -1` |grep ipvs\nI0701 10:23:03.745006       1 server_linux.go:233] \"Using ipvs Proxier\"\n</code></pre> kubelet system\u9a8c\u8bc1 <pre><code>[root@k8s-m-1 ~]# kubectl get cm kubelet-config -n kube-system -o yaml|grep cgroupDriver\n    cgroupDriver: systemd\n</code></pre></p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#4_1","title":"4\u3001\u6269\u5c55\u7684\u5b89\u88c5","text":"","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1_5","title":"1\u3001\u7f51\u7edc\u63d2\u4ef6\u7684\u9009\u62e9","text":"<p>\u53c2\u8003</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1cilium","title":"1\u3001cilium","text":"","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1cli","title":"1\u3001\u5b89\u88c5cli","text":"<p>\u5b89\u88c5cli</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#2cilium","title":"2\u3001\u5b89\u88c5cilium","text":"<p>\u5b89\u88c5cilium</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#3_2","title":"3\u3001\u9a8c\u8bc1\u5b89\u88c5","text":"<p>pod\u53ea\u4f1a\u5728worker\u4e0a\u8fd0\u884c\uff0c\u9700\u8981\u914d\u7f6eworker, \u6700\u5c11\u9700\u8981\u4e24\u4e2aworker\uff0c\u8981\u4e0d\u7136\u4f1a\u4e00\u76f4pending\u3002</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#4hubble-ui","title":"4\u3001\u8bbf\u95eehubble ui","text":"<pre><code>kubectl port-forward --address 0.0.0.0 service/hubble-ui 80:80 -n kube-system\n</code></pre>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#5helm","title":"5\u3001\u901a\u8fc7helm\u5b89\u88c5","text":"Helm\u5b89\u88c5 <pre><code>helm repo add cilium https://helm.cilium.io/\n\nhelm install cilium cilium/cilium --version 1.15.6 \\\n  --namespace kube-system \\\n  --set k8sServiceHost=192.168.47.180 \\\n  --set k8sServicePort=9443 \\\n  --set hubble.relay.enabled=true \\\n  --set hubble.ui.enabled=true\n\n\nhelm install cilium cilium/cilium --version 1.15.6 \\\n  --namespace kube-system \\\n  --set k8sServiceHost=192.168.47.180  \\\n  --set k8sServicePort=9443 \\\n  --set hubble.relay.enabled=true \\\n  --set hubble.ui.enabled=true \\\n  --set kubeProxyReplacement=\"true\" \\   #\u5b98\u65b9\u8fd9\u4e2a\u7248\u672c\u7684\u5e2e\u52a9\u6587\u6863\u91cc\u6ca1\u6709\u8fd9\u4e2a\u914d\u7f6e\uff0c\u53ef\u4ee5\u5ffd\u7565\n\n  --set routingMode=native \\            #\u672c\u5730\u8def\u7531\u6a21\u5f0f\n  --set autoDirectNodeRoutes=true \\\n  --set ipv4NativeRoutingCIDR=10.244.0.0/16 \\\n\n  --set ipam.mode=\"cluster-pool\" \\      #pod ip\u6c60\n  --set ipam.operator.clusterPoolIPv4PodCIDRList=\"10.244.0.0/16\" \\\n  --set ipam.operator.clusterPoolIPv4MaskSize=24 \\\n\n  --set bpf.masquerade=true \\       #\u57fa\u4e8ebpf\u7684ip\u4f2a\u88c5\uff0c\u9ed8\u8ba4\u662fiptables\n  --set ipMasqAgent.enabled=true\n\n\u4fee\u6539pod cidr\u7684\u65f6\u5019\uff0c\u9700\u8981\u5c06\u5df2\u6709\u7684cni\u7684\u63d2\u4ef6\u7684\u914d\u7f6e\u6e05\u7a7a\uff0c\u7f51\u5361\u914d\u7f6e\u4e5f\u8981\u6e05\u7a7a\u3002\n\n\n\nhelm install cilium cilium/cilium --version 1.15.6 \\\n  --namespace kube-system \\\n  --set k8sServiceHost=192.168.47.149  \\\n  --set k8sServicePort=6443 \\\n  --set hubble.relay.enabled=true \\\n  --set hubble.ui.enabled=true \\\n  --set kubeProxyReplacement=true \\\n  --set routingMode=native \\\n  --set autoDirectNodeRoutes=true \\\n  --set ipv4NativeRoutingCIDR=10.244.0.0/16 \\\n  --set ipam.mode=\"cluster-pool\" \\\n  --set ipam.operator.clusterPoolIPv4PodCIDRList=\"10.244.0.0/16\" \\\n  --set ipam.operator.clusterPoolIPv4MaskSize=24 \\\n  --set bpf.masquerade=true \\\n  --set ipMasqAgent.enabled=true \\\n  --set ipMasqAgent.config.nonMasqueradeCIDRs='{10.0.0.0/8,172.16.0.0/12,192.168.0.0/16}' \\\n  --set ipMasqAgent.config.masqLinkLocal=false \\\n  --set loadBalancer.mode=hybrid \\\n  --set loadBalancer.serviceTopology=true \\\n  --set bandwidthManager.enabled=true \\\n  --set bandwidthManager.bbr=true \\\n  --set devices=ens33\n\n  pod\u7f51\u7edc\u4e4b\u95f4\uff0c\u5185\u7f51\u4e4b\u95f4\u7684\u6570\u636e\u901a\u4fe1\u4e0d\u9700\u8981ip\u4f2a\u88c5\u3002\n</code></pre> <p>Kubernetes\u63d2\u4ef6\u4e4bip-masq-agent-\u817e\u8baf\u4e91\u5f00\u53d1\u8005\u793e\u533a-\u817e\u8baf\u4e91</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#6nodeciliumioagent-not-ready","title":"6\u3001node.cilium.io/agent-not-ready","text":"<p>node.cilium.io/agent-not-ready \u662fcilium\u81ea\u52a8\u7ed9\u8282\u70b9\u52a0\u7684\u6c61\u70b9\uff0c\u9632\u6b62cilium\u5728\u63a5\u7ba1\u8282\u70b9cni\u4e4b\u524d\u5df2\u7ecf\u6709pod\u90e8\u7f72\u5728\u76ee\u6807\u8282\u70b9\u4e0a\u3002 <pre><code>kubectl get nodes -o json | jq '.items[] | {name: .metadata.name, taints: .spec.taints}'\n</code></pre> \u672a\u5f00\u59cb\u5b89\u88c5\u63d2\u4ef6</p> \u672a\u5f00\u59cb\u5b89\u88c5\u63d2\u4ef6 <pre><code>{\n  \"name\": \"k8s-m-1\",\n  \"taints\": [\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node-role.kubernetes.io/control-plane\"\n    },\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.kubernetes.io/not-ready\"\n    }\n  ]\n}\n{\n  \"name\": \"k8s-m-2\",\n  \"taints\": [\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node-role.kubernetes.io/control-plane\"\n    },\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.kubernetes.io/not-ready\"\n    }\n  ]\n}\n{\n  \"name\": \"k8s-m-3\",\n  \"taints\": [\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node-role.kubernetes.io/control-plane\"\n    },\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.kubernetes.io/not-ready\"\n    }\n  ]\n}\n{\n  \"name\": \"k8s-w-1\",\n  \"taints\": [\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.kubernetes.io/not-ready\"\n    }\n  ]\n}\n{\n  \"name\": \"k8s-w-2\",\n  \"taints\": [\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.kubernetes.io/not-ready\"\n    }\n  ]\n}\n</code></pre> <p>\u5b89\u88c5\u63d2\u4ef6\u8fc7\u7a0b\u4e2d</p> \u5b89\u88c5\u63d2\u4ef6\u8fc7\u7a0b\u4e2d <pre><code>{\n  \"name\": \"k8s-m-1\",\n  \"taints\": [\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node-role.kubernetes.io/control-plane\"\n    },\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.kubernetes.io/not-ready\"\n    },\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.cilium.io/agent-not-ready\"\n    }\n  ]\n}\n{\n  \"name\": \"k8s-m-2\",\n  \"taints\": [\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node-role.kubernetes.io/control-plane\"\n    },\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.kubernetes.io/not-ready\"\n    },\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.cilium.io/agent-not-ready\"\n    }\n  ]\n}\n{\n  \"name\": \"k8s-m-3\",\n  \"taints\": [\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node-role.kubernetes.io/control-plane\"\n    },\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.kubernetes.io/not-ready\"\n    },\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.cilium.io/agent-not-ready\"\n    }\n  ]\n}\n{\n  \"name\": \"k8s-w-1\",\n  \"taints\": [\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.kubernetes.io/not-ready\"\n    },\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.cilium.io/agent-not-ready\"\n    }\n  ]\n}\n{\n  \"name\": \"k8s-w-2\",\n  \"taints\": [\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.kubernetes.io/not-ready\"\n    },\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node.cilium.io/agent-not-ready\"\n    }\n  ]\n}\n</code></pre>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#7ciliumpod","title":"7\u3001\u5220\u9664\u672a\u88abcilium\u7ba1\u7406\u7684pod","text":"<pre><code>kubectl get pods --all-namespaces -o custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,HOSTNETWORK:.spec.hostNetwork --no-headers=true | grep '&lt;none&gt;' | awk '{print \"-n \"$1\" \"$2}' | xargs -L 1 -r kubectl delete pod\n</code></pre>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#8","title":"8\u3001\u9a8c\u8bc1\u5b89\u88c5","text":"<p>Kubernetes Without kube-proxy \u2014 Cilium 1.15.6 documentation</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1bpf","title":"1\u3001bpf\u4f2a\u88c5\u547d\u4ee4","text":"<pre><code>root@k8s-m:~# kubectl -n kube-system exec ds/cilium -- cilium-dbg bpf ipmasq list\nDefaulted container \"cilium-agent\" out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)\nIP PREFIX/ADDRESS   \n10.0.0.0/8               \n169.254.0.0/16           \n172.16.0.0/12            \n192.168.0.0/16   \n</code></pre>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#9helm","title":"9\u3001helm\u5b89\u88c5\u7684\u4e00\u4e9b\u53c2\u6570\u7684\u4f18\u7f3a\u70b9","text":"<pre><code>Maglev \u4e00\u81f4\u6027\u54c8\u5e0c\uff0c\u542f\u7528 Maglev \u6563\u5217\u4ee5\u5b9e\u73b0\u670d\u52a1\u8d1f\u8f7d\u5e73\u8861\uff0c\u542f\u7528 Maglev \u5c06\u4f7f\u6bcf\u4e2a Cilium \u7ba1\u7406\u8282\u70b9\u7684\u5185\u5b58\u6d88\u8017\u6bd4\u9ed8\u8ba4\u8bbe\u7f6e\u66f4\u9ad8\n--set loadBalancer.algorithm=maglev\nhttps://docs.cilium.io/en/stable/network/kubernetes/kubeproxy-free/#maglev-consistent-hashing\n\nDSR\n\u7531\u4e8e\u7279\u5b9a\u4e8e Cilium \u7684 IP \u9009\u9879\u53ef\u80fd\u4f1a\u88ab\u5e95\u5c42\u7f51\u7edc\u7ed3\u6784\u4e22\u5f03\uff0c\u56e0\u6b64 DSR \u6a21\u5f0f\u53ef\u80fd\u65e0\u6cd5\u5728\u67d0\u4e9b\u516c\u5171\u4e91\u63d0\u4f9b\u5546\u73af\u5883\u4e2d\u5de5\u4f5c\u3002\n--set loadBalancer.mode=dsr \\ \n--set loadBalancer.dsrDispatch=opt\nhttps://docs.cilium.io/en/stable/network/kubernetes/kubeproxy-free/#direct-server-return-dsr\n\u6709\u5173\u5206\u6790\uff1a\nhttps://bbs.huaweicloud.com/blogs/417889\n\nGeneve\n\u9002\u7528\u4e8e\u672c\u5730\u8def\u7531\u6a21\u5f0f\n--set tunnelProtocol=geneve \\ \n--set loadBalancer.mode=dsr \\ \n--set loadBalancer.dsrDispatch=geneve \\ \nhttps://docs.cilium.io/en/stable/network/kubernetes/kubeproxy-free/#direct-server-return-dsr-with-geneve\n\n\n\u6df7\u5408 DSR \u548c SNAT \u6a21\u5f0f\uff08\u6700\u597d\u7684\uff09\nCilium \u8fd8\u652f\u6301\u6df7\u5408 DSR \u548c SNAT \u6a21\u5f0f\uff0c\u5373\u5bf9 TCP \u8fde\u63a5\u6267\u884c DSR\uff0c\u5bf9 UDP \u8fde\u63a5\u6267\u884c SNAT\u3002\n--set loadBalancer.mode=hybrid \\ \nhttps://docs.cilium.io/en/stable/network/kubernetes/kubeproxy-free/#hybrid-dsr-and-snat-mode\n\n\nPod \u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u5957\u63a5\u5b57\u8d1f\u8f7d\u5747\u8861\u5668\u7ed5\u8fc7\n\u5982\u679c\u8981\u4f7f\u7528Istio sidecar\u7b49\u64cd\u4f5c\u53ef\u80fd\u9700\u8981\u5f00\u542f\n--set socketLB.hostNamespaceOnly=true\nhttps://docs.cilium.io/en/stable/network/kubernetes/kubeproxy-free/#socket-loadbalancer-bypass-in-pod-namespace\n\n\n\nLoadBalancer \u548c NodePort XDP \u52a0\u901f\n\u672c\u5730\u90e8\u7f72\u7684\u73af\u5883\u53ef\u80fd\u4e0d\u884c\uff0c\u4e91\u4e0a\u53ef\u80fd\u652f\u6301\n--set loadBalancer.acceleration=native \\ \n\u81ea\u68c0\u662f\u5426\u5f00\u542f\u52a0\u901f\nkubectl -n kube-system exec ds/cilium -- cilium-dbg status --verbose | grep XDP\n\n\nBandwidth Manager\nBandwidth Manager requires a v5.1.x or more recent Linux kernel.\ncentos7.9,kernel 6.9.7-1.el7.elrepo.x86_64, cilium 1.15.6 \u5b89\u88c5\u4e4b\u540e\u6821\u9a8c\u672a\u751f\u6548\uff0c\u53ef\u80fd\u662f\u56e0\u4e3a\u662f\u865a\u62df\u673a\u7684\u539f\u56e0\uff0c\u65e0\u6cd5\u8bc6\u522b\u5230\u7f51\u5361\n$ kubectl -n kube-system exec ds/cilium -- cilium-dbg status | grep BandwidthManager\nBandwidthManager:       EDT with BPF [BBR] [eth0]\n</code></pre>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#10","title":"10\u3001\u53ef\u80fd\u51fa\u73b0\u7684\u95ee\u9898","text":"","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1bandwidth-manager","title":"1\u3001Bandwidth Manager\u672a\u751f\u6548","text":"<pre><code>kubectl logs pod/cilium-nxzls -n kube-system|grep -i bandwidth\nDefaulted container \"cilium-agent\" out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)\ntime=\"2024-07-10T10:08:47Z\" level=info msg=\"  --enable-bandwidth-manager='true'\" subsys=daemon\ntime=\"2024-07-10T10:08:48Z\" level=warning msg=\"BPF bandwidth manager could not detect host devices. Disabling the feature.\" subsys=bandwidth-manager\ntime=\"2024-07-10T10:08:48Z\" level=info msg=\"Start hook executed\" duration=\"624.35\u00b5s\" function=\"*bandwidth.manager.Start\" subsys=hive\n\n\n\u8fd9\u4e2a\u95ee\u9898\u5b98\u7f51\u6587\u6863\u4e2d\u6734\u5b9e\u65e0\u534e\u7684\u89e3\u51b3\u529e\u6cd5\u5c31\u662f\n  --set devices=ens33\nroot@k8s-m:~# kubectl -n kube-system exec ds/cilium -- cilium-dbg status | grep BandwidthManager\nDefaulted container \"cilium-agent\" out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)\nBandwidthManager:        EDT with BPF [BBR] [ens33]\n</code></pre>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#2-valid-cgroup-base-path-found-socket-load-balancing-tracing-with-hubble-will-not-work","title":"2\u3001 valid cgroup base path found: socket load-balancing tracing with Hubble will not work","text":"<p>\u53c2\u8003\u5b98\u65b9\u6587\u6863 \u539f\u56e0\u662f\u6ca1\u6709\u4f7f\u7528cgroup v2 \u5173\u4e8e cgroup v2</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#11istio","title":"11\u3001\u4e0eistio\u96c6\u6210","text":"<pre><code>  --set socketLB.hostNamespaceOnly=true \\\n  --set cni-exclusive=false\n</code></pre>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#5","title":"5\u3001\u5de5\u5177\u7684\u5b89\u88c5","text":"","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1helm","title":"1\u3001helm\u5b89\u88c5","text":"<p>\u53c2\u8003</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#2dashboard","title":"2\u3001dashboard","text":"","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#1_6","title":"1\u3001\u521b\u5efa\u7528\u6237","text":"<p>\u521b\u5efa\u7528\u6237</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#2web","title":"2\u3001\u8bbf\u95eeweb","text":"<pre><code>kubectl -n kubernetes-dashboard port-forward  --address 0.0.0.0 svc/kubernetes-dashboard-kong-proxy 8443:443\n</code></pre>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#3ingress","title":"3\u3001\u914d\u7f6eingress \u8bbf\u95ee","text":"<p>ingress\u914d\u7f6edashboard</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#4token","title":"4\u3001\u83b7\u53d6token","text":"<pre><code>kubectl get secret admin-user -n kubernetes-dashboard -o jsonpath={\".data.token\"} | base64 -d\n</code></pre>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2024/07/31/k8s1.30.2%E5%A0%86%E5%8F%A0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/#3metrics-server","title":"3\u3001metrics-server","text":"<p>metrics-server \u9700\u8981\u53d6\u6d88tls\u6821\u9a8c --kubelet-insecure-tls</p>","tags":["k8s","kubeadm","\u5806\u53e0\u96c6\u7fa4","cilium","haproxy"]},{"location":"blog/2023/10/24/k8s%20kubeadm%E6%89%A9%E5%AE%B9%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E8%8A%82%E7%82%B9/","title":"k8s kubeadm\u6269\u5bb9\u6307\u5b9a\u7248\u672c\u8282\u70b9","text":"<p>k8s kubeadm\u6269\u5bb9\u6307\u5b9a\u7248\u672c\u8282\u70b9.</p>","tags":["k8s","kubeadm","\u6269\u5bb9\u8282\u70b9"]},{"location":"blog/2023/10/24/k8s%20kubeadm%E6%89%A9%E5%AE%B9%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E8%8A%82%E7%82%B9/#_1","title":"\u524d\u8a00","text":"<p>\u6bcf\u6b21\u90fd\u8981\u641c\u600e\u4e48\u6269\u5bb9\uff0c\u7d22\u6027\u5c31\u81ea\u5df1\u8bb0\u5f55\u4e0b\u6765\u3002</p>","tags":["k8s","kubeadm","\u6269\u5bb9\u8282\u70b9"]},{"location":"blog/2023/10/24/k8s%20kubeadm%E6%89%A9%E5%AE%B9%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E8%8A%82%E7%82%B9/#1","title":"1\u3001\u65b0\u589e\u673a\u5668","text":"","tags":["k8s","kubeadm","\u6269\u5bb9\u8282\u70b9"]},{"location":"blog/2023/10/24/k8s%20kubeadm%E6%89%A9%E5%AE%B9%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E8%8A%82%E7%82%B9/#2etchosts","title":"2\u3001\u540c\u6b65/etc/hosts\u6587\u4ef6","text":"","tags":["k8s","kubeadm","\u6269\u5bb9\u8282\u70b9"]},{"location":"blog/2023/10/24/k8s%20kubeadm%E6%89%A9%E5%AE%B9%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E8%8A%82%E7%82%B9/#3","title":"3\u3001\u5173\u95ed\u65b0\u673a\u5668\u9632\u706b\u5899","text":"<pre><code>systemctl stop firewalld\nsystemctl disable firewalld\n</code></pre>","tags":["k8s","kubeadm","\u6269\u5bb9\u8282\u70b9"]},{"location":"blog/2023/10/24/k8s%20kubeadm%E6%89%A9%E5%AE%B9%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E8%8A%82%E7%82%B9/#4repo","title":"4\u3001\u65b0\u673a\u5668\u589e\u52a0repo\u6587\u4ef6","text":"<pre><code>cat kubernetes.repo\n\n[kubernetes]\nname=Kubernetes Repo\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\ngpgcheck=0\ngpg=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg\nenable=1\n</code></pre>","tags":["k8s","kubeadm","\u6269\u5bb9\u8282\u70b9"]},{"location":"blog/2023/10/24/k8s%20kubeadm%E6%89%A9%E5%AE%B9%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E8%8A%82%E7%82%B9/#5swap","title":"5\u3001\u5173\u95edswap","text":"<pre><code>swapoff -a\n\n/etc/fstab\n</code></pre>","tags":["k8s","kubeadm","\u6269\u5bb9\u8282\u70b9"]},{"location":"blog/2023/10/24/k8s%20kubeadm%E6%89%A9%E5%AE%B9%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E8%8A%82%E7%82%B9/#6","title":"6\u3001\u67e5\u770b\u53ef\u4ee5\u5b89\u88c5\u7684\u7248\u672c\uff0c\u5e76\u5b89\u88c5","text":"<pre><code>yum list kubeadm --showduplicates\nyum list kubectl --showduplicates\nyum list kubelet --showduplicates\n\n\nyum install kubectl-1.18.0-0\nyum install kubelet-1.18.0-0\nyum install kubeadm-1.18.0-0\n</code></pre>","tags":["k8s","kubeadm","\u6269\u5bb9\u8282\u70b9"]},{"location":"blog/2023/10/24/k8s%20kubeadm%E6%89%A9%E5%AE%B9%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E8%8A%82%E7%82%B9/#7","title":"7\u3001\u751f\u6210\u65b0\u673a\u5668\u7684\u52a0\u5165\u547d\u4ee4","text":"<pre><code>\u65b9\u5f0f\u4e00\uff1a\n[root@k8s-master01 ~]# kubeadm token create\nW1024 11:10:21.218806   11133 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]\nmy8t6c.9ey5l99fymaec6jf\n\n[root@k8s-master01 ~]# openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'\nf4c750ab5e1c14eea6f2cf4fbb42ae7f4873e0a1fb22adca39dc9eaa78ae1b38\n\n\n\u65b9\u5f0f\u4e8c\uff1a\nkubeadm token create --print-join-command\nkubeadm join --token my8t6c.9ey5l99fymaec6jf 192.168.60.195:6443 --discovery-token-ca-cert-hash sha256:f4c750ab5e1c14eea6f2cf4fbb42ae7f4873e0a1fb22adca39dc9eaa78ae1b38\n</code></pre>","tags":["k8s","kubeadm","\u6269\u5bb9\u8282\u70b9"]},{"location":"blog/2023/10/24/k8s%20kubeadm%E6%89%A9%E5%AE%B9%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E8%8A%82%E7%82%B9/#8","title":"8\u3001\u95ee\u9898\u6765\u4e86","text":"<p>1\uff09\u56e0\u4e3a\u957f\u65f6\u95f4\u6ca1\u6709\u7ba1\u7406\u8fd9\u5957\u96c6\u7fa4\uff0c\u5bfc\u81f4\u5728join\u7684\u8fc7\u7a0b\u4e2d\u62a5\u9519\uff0cThe cluster-info ConfigMap does not yet contain a JWS signature for token ID \"f5evrb\", will try again\uff0c\u8fd9\u4e2a\u62a5\u9519\u662f\u5728join\u7684\u53c2\u6570\u52a0\u4e0a\u4e86--v=2\u770b\u51fa\u6765\u7684\u3002</p> <p>2\uff09\u7136\u540e\u770bapi-server\u7684\u62a5\u9519\u4e4b\u540e\u53d1\u73b0\u62a5\u9519\uff0cUnable to authenticate the request due to an error: x509: certificate has expired or is not yet valid\uff0c\u56e0\u4e3a\u96c6\u7fa4\u7684\u8bc1\u4e66\u8fc7\u671f\u4e86\uff0c\u6240\u4ee5\u901a\u8fc7kubeadm alpha certs renew all \u4e4b\u540e\u53d1\u73b0\u63a7\u5236\u5e73\u9762\u7684\u7ec4\u4ef6\u90fd\u542f\u52a8\u4e86\uff0c\u5c31\u6ca1\u6709\u53bb\u7ba1\u4ed6\uff0c\u4f46\u662f\u8fd9\u662f\u6709\u95ee\u9898\u7684\uff0c\u968f\u540e\u91cd\u542f\u89e3\u51b3\u3002  <pre><code>docker ps | grep -E 'k8s_kube-apiserver|k8s_kube-controller-manager|k8s_kube-scheduler|k8s_etcd_etcd' | awk -F ' ' '{print $1}' | xargs docker restart\nsystemctl restart kubelet\n</code></pre></p>","tags":["k8s","kubeadm","\u6269\u5bb9\u8282\u70b9"]},{"location":"blog/2023/10/24/k8s%20kubeadm%E6%89%A9%E5%AE%B9%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E8%8A%82%E7%82%B9/#9notready","title":"9\u3001\u8282\u70b9\u52a0\u5165\u96c6\u7fa4\u540e\uff0c\u8282\u70b9\u72b6\u6001\u4e00\u76f4\u662fNotReady","text":"<p><pre><code>kubectl get nodes\nk8s-node01     NotReady   &lt;none&gt;   3m36s   v1.18.0\n\nkubectl describe node k8s-node01\nruntime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized\n</code></pre> \u6700\u540e\u770bkubelet\u7684\u62a5\u9519\u627e\u4e0d\u5230flannel\u7684\u63d2\u4ef6\uff0c\u7136\u540e\u53bb\u8001\u673a\u5668\u4e0a\u4e0b\u8f7d\u4e0a\u4f20\uff0c\u6700\u540e\u8282\u70b9\u6b63\u5e38\u3002</p> <pre><code>journalctl -fu kubelet \n\nOct 23 23:46:51 k8s-node01 kubelet[5447]: : [failed to find plugin \"flannel\" in path [/opt/cni/bin]]\nOct 23 23:46:51 k8s-node01 kubelet[5447]: W1023 23:46:51.095117    5447 cni.go:237] Unable to update cni config: no valid networks found in /etc/cni/net.d\n</code></pre>","tags":["k8s","kubeadm","\u6269\u5bb9\u8282\u70b9"]},{"location":"blog/2024/02/21/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E7%90%86%E8%A7%A3/","title":"\u5bb9\u5668\u7f51\u7edc\u7406\u89e3","text":"<p>\u5bb9\u5668\u7f51\u7edc\u7406\u89e3\u3002</p> <p>\u5bb9\u5668\u4e2d\u7684\u5e94\u7528\u751f\u6210\u7f51\u7edc\u8bf7\u6c42 -&gt; veth-container -&gt; veth-host -&gt; \u7f51\u7edc\u6865\u63a5\uff08\u5982docker0\uff09-&gt; \u5bbf\u4e3b\u673a\u8def\u7531 -&gt; iptables -&gt;\u7269\u7406\u7f51\u5361 -&gt; \u5916\u90e8\u7f51\u7edc</p>","tags":["docker","iptables"]},{"location":"blog/2024/02/21/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E7%90%86%E8%A7%A3/#1veth-container-veth-host","title":"1\u3001veth-container -&gt; veth-host","text":"<p>Docker \u6216 Kubernetes \u521b\u5efa\u4e00\u5bf9\u865a\u62df\u7f51\u5361\uff08veth pair\uff09\uff0c\u4e00\u7aef\u653e\u5728\u5bbf\u4e3b\u673a\u4e0a\uff08\u79f0\u4f5cveth-host\uff09\uff0c\u53e6\u4e00\u7aef\u653e\u5728\u5bb9\u5668\u4e2d\uff08\u79f0\u4f5cveth-container\uff09\u3002 \u5bbf\u4e3b\u673a\u4e0a\u7684\u90a3\u7aef\u865a\u62df\u7f51\u5361\u88ab\u8fde\u63a5\u5230\u4e00\u4e2a\u7f51\u7edc\u6865\u63a5\uff08\u5982 Docker \u9ed8\u8ba4\u7684docker0\u6865\uff09\uff0c\u8fd9\u4e2a\u6865\u63a5\u5141\u8bb8\u7f51\u7edc\u5305\u5728\u5404\u4e2a\u5bb9\u5668\u4ee5\u53ca\u5bbf\u4e3b\u673a\u4e4b\u95f4\u8f6c\u53d1\u3002</p> <p>\u8fd9\u79cd\u673a\u5236\u7684\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ol> <li> <p>\u5f53Docker\u5bb9\u5668\u542f\u52a8\u65f6\uff0cDocker\u670d\u52a1\u4f1a\u521b\u5efa\u4e00\u5bf9<code>veth</code>\u63a5\u53e3\u3002\u5047\u8bbe\u5bf9\u4e8e\u7279\u5b9a\u7684\u5bb9\u5668\u521b\u5efa\u7684<code>veth</code>\u63a5\u53e3\u88ab\u79f0\u4e3a<code>vethXXX</code>\u548c<code>vethYYY</code>\u3002</p> </li> <li> <p><code>vethXXX</code>\u8fd9\u4e00\u7aef\u88ab\u653e\u5165\u5bb9\u5668\u7684\u7f51\u7edc\u547d\u540d\u7a7a\u95f4\uff0c\u5e76\u901a\u5e38\u88ab\u547d\u540d\u4e3a<code>eth0</code>\uff0c\u8fd9\u6837\u5bb9\u5668\u5185\u90e8\u7684\u8fdb\u7a0b\u5c31\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u63a5\u53e3\u53d1\u9001\u548c\u63a5\u6536\u7f51\u7edc\u6570\u636e\u3002\u800c<code>vethYYY</code>\u8fd9\u7aef\u7559\u5728\u5bbf\u4e3b\u673a\u7684\u5168\u5c40\u7f51\u7edc\u547d\u540d\u7a7a\u95f4\u4e2d\u3002</p> </li> <li> <p><code>vethYYY</code>\u8fd9\u7aef\u63a5\u53e3\u5c06\u88ab\u8fde\u63a5\u5230Docker\u7684\u865a\u62df\u7f51\u6865\u4e0a\uff0c\u4f8b\u5982\u9ed8\u8ba4\u7684\u7f51\u6865<code>docker0</code>\u3002\u8fd9\u4e2a\u865a\u62df\u7f51\u6865\u5141\u8bb8\u5bb9\u5668\u4e4b\u95f4\u5728\u76f8\u540c\u5bbf\u4e3b\u673a\u4e0a\u76f8\u4e92\u901a\u4fe1\uff0c\u540c\u65f6\u4e5f\u5141\u8bb8\u5bb9\u5668\u4e0e\u5bbf\u4e3b\u673a\u4e4b\u95f4\u7684\u901a\u4fe1\u3002</p> </li> </ol> <p></p> <pre><code>[root@jenkins-master ~]# docker inspect -f '{{.State.Pid}}' nginx-dd\n29044\n[root@jenkins-master ~]# nsenter -t 29044 -n ip addr\n</code></pre>","tags":["docker","iptables"]},{"location":"blog/2024/02/21/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E7%90%86%E8%A7%A3/#2veth-host-docker0","title":"2\u3001veth-host -&gt; \u7f51\u7edc\u6865\u63a5\uff08\u5982docker0\uff09","text":"<p>  veth pair \u5728\u5bbf\u4e3b\u673a\u4e0a\u7684\u63a5\u53e3\u52a0\u5165\u7f51\u6865\u4e2d\u3002</p>","tags":["docker","iptables"]},{"location":"blog/2024/02/21/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E7%90%86%E8%A7%A3/#3docker0-","title":"3\u3001\u7f51\u7edc\u6865\u63a5\uff08\u5982docker0\uff09-&gt; \u5bbf\u4e3b\u673a\u8def\u7531","text":"<p>\u5728 CentOS \u7cfb\u7edf\u4e2d\uff0c\u7f51\u6865 (<code>bridge</code>) \u662f\u4e00\u4e2a\u5de5\u4f5c\u5728 OSI \u6a21\u578b\u7684\u7b2c\u4e8c\u5c42\uff08\u6570\u636e\u94fe\u8def\u5c42\uff09\u7684\u8bbe\u5907\uff0c\u5b83\u8d1f\u8d23\u8fde\u63a5\u4e24\u4e2a\u6216\u591a\u4e2a\u7f51\u7edc\u6bb5\uff0c\u4f7f\u5b83\u4eec\u8868\u73b0\u5f97\u50cf\u662f\u540c\u4e00\u7f51\u7edc\u3002\u5b83\u901a\u8fc7 MAC \u5730\u5740\u6765\u8f6c\u53d1\u6d41\u91cf\uff1b\u7136\u800c\uff0c\u5f53\u6211\u4eec\u5728\u7f51\u6865\u4e0a\u914d\u7f6e\u4e86\u4e00\u4e2a IP \u5730\u5740\u65f6\uff0c\u8fd9\u4e2a\u7f51\u6865\u4e5f\u53ef\u4ee5\u53c2\u4e0e\u7b2c\u4e09\u5c42\uff08\u7f51\u7edc\u5c42\uff09\u7684\u64cd\u4f5c\uff0c\u6bd4\u5982\u8def\u7531\u51b3\u7b56\u3002</p> <p>\u8fd9\u79cd\u914d\u7f6e\u5141\u8bb8\u7f51\u6865\u8bbe\u5907\u53c2\u4e0e\u5230\u64cd\u4f5c\u7cfb\u7edf\u7684 IP \u8def\u7531\u51b3\u7b56\u4e2d\u3002\u4e00\u65e6\u4e00\u4e2a\u7f51\u6865\u914d\u7f6e\u4e86 IP \u5730\u5740\uff0c\u5c31\u8ddf\u5176\u4ed6\u4efb\u4f55\u7f51\u7edc\u63a5\u53e3\u4e00\u6837\uff0c\u5b83\u4f1a\u51fa\u73b0\u5728\u64cd\u4f5c\u7cfb\u7edf\u7684\u8def\u7531\u8868\u4e2d\u3002\u8def\u7531\u8868\u51b3\u5b9a\u4e86 IP \u6570\u636e\u5305\u5982\u4f55\u4ece\u4e00\u4e2a\u63a5\u53e3\uff08\u53ef\u4ee5\u662f\u7269\u7406\u63a5\u53e3\uff0c\u4e5f\u53ef\u4ee5\u662f\u903b\u8f91\u63a5\u53e3\u5982\u7f51\u6865\uff09\u88ab\u8def\u7531\u5230\u53e6\u4e00\u4e2a\u63a5\u53e3\u3002</p> <p>\u7f51\u6865\u4e0a\u914d\u7f6e\u7684 IP \u5730\u5740\u4f7f\u5f97\u7f51\u6865\u53ef\u4ee5\uff1a</p> <ul> <li>\u63a5\u6536\u53d1\u5f80\u5176 IP \u5730\u5740\u7684\u6d41\u91cf\u3002</li> <li>\u53d1\u9001\u6570\u636e\u5305\u5230\u7f51\u7edc\u4e0a\uff0c\u8fd9\u4e9b\u6570\u636e\u5305\u4f1a\u7ecf\u8def\u7531\u8868\u4e2d\u5b9a\u4e49\u7684\u4e0b\u4e00\u8df3\u8def\u7531\u8d70\u5411\u76ee\u7684\u5730\u3002</li> <li>\u4f5c\u4e3a\u7f51\u6865\u4e0a\u5176\u4ed6\u8bbe\u5907\u7684\u7f51\u5173\u3002</li> </ul> <p>\u901a\u5e38\uff0c\u5f53\u4e00\u4e2a\u6865\u63a5\u7f51\u7edc\u4e2d\u7684\u8bbe\u5907\u8981\u53d1\u9001\u4e00\u4e2a\u6570\u636e\u5305\u5230\u53e6\u4e00\u4e2a\u7f51\u7edc\u6bb5\uff08\u53ef\u80fd\u662f\u901a\u8fc7\u4e92\u8054\u7f51\uff09\u65f6\uff0c\u6570\u636e\u5305\u4f1a\u9001\u5230\u7f51\u6865\u8bbe\u5907\uff0c\u4ece\u90a3\u91cc\u6839\u636e CentOS \u7684\u8def\u7531\u8868\u51b3\u7b56\u6765\u786e\u5b9a\u4e0b\u4e00\u6b65\u884c\u52a8\u3002\u5982\u679c\u8def\u7531\u8868\u4e2d\u6709\u5339\u914d\u8be5\u76ee\u7684\u5730\u7684\u8def\u7531\uff0c\u6570\u636e\u5305\u5c06\u6839\u636e\u8fd9\u4e2a\u8def\u7531\u8fdb\u884c\u8f6c\u53d1\u3002</p> <p>\u8fd9\u662f\u4e00\u4e2a\u7b80\u5316\u7684\u4f8b\u5b50\uff1a</p> <ol> <li>\u8bbe\u5907A\uff08\u8fde\u63a5\u5230\u7f51\u6865 br0 \u7f51\u7edc\uff09\u53d1\u9001\u6570\u636e\u5305\u5230\u8bbe\u5907B\uff08\u4e92\u8054\u7f51\u4e0a\u7684\u67d0\u4e2aIP\u5730\u5740\uff09\u3002</li> <li>\u6570\u636e\u5305\u9996\u5148\u5230\u8fbe\u7f51\u6865 br0\u3002</li> <li>\u5982\u679c br0 \u6709\u4e00\u4e2a IP \u5730\u5740\uff0c\u5b83\u4f1a\u68c0\u67e5\u5b83\u7684\u8def\u7531\u8868\u6765\u51b3\u5b9a\u5982\u4f55\u5904\u7406\u8fd9\u4e2a\u6570\u636e\u5305\u3002</li> <li>\u5982\u679c\u8def\u7531\u8868\u6307\u793a\u5b83\u5e94\u8be5\u901a\u8fc7\u67d0\u4e2a\u7269\u7406\u63a5\u53e3\u53d1\u9001\uff08\u6bd4\u5982 eth0\uff09\uff0c\u5b83\u4f1a\u5c06\u6570\u636e\u5305\u53d1\u5230\u8fd9\u4e2a\u63a5\u53e3\uff0c\u8be5\u63a5\u53e3\u518d\u628a\u6570\u636e\u5305\u9001\u5230\u5916\u90e8\u7f51\u7edc\u3002</li> </ol> <p>\u6240\u4ee5\u5373\u4fbf\u7f51\u6865\u662f\u7b2c\u4e8c\u5c42\u8bbe\u5907\uff0c\u4e00\u65e6\u914d\u7f6e\u4e86 IP \u5730\u5740\uff0c\u5b83\u5c31\u80fd\u591f\u5229\u7528\u64cd\u4f5c\u7cfb\u7edf\u7684\u8def\u7531\u8868\u8fdb\u884c\u7b2c\u4e09\u5c42\u7684\u8def\u7531\u3002\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u5728\u4e00\u4e9b\u8bbe\u7f6e\u4e2d\uff0c\u7f51\u6865\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u4e2a\u865a\u62df\u673a\u6216\u5bb9\u5668\u73af\u5883\u4e2d\u7684\u9ed8\u8ba4\u7f51\u5173\u3002</p> <p></p>","tags":["docker","iptables"]},{"location":"blog/2024/02/21/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E7%90%86%E8%A7%A3/#4-iptables","title":"4\u3001\u5bbf\u4e3b\u673a\u8def\u7531 -&gt; iptables","text":"<p>\u8def\u7531\u8868\u8d1f\u8d23\u51b3\u5b9a\u672c\u5730\u751f\u6210\u7684\u7f51\u7edc\u6570\u636e\u5305\u8be5\u5982\u4f55\u5728\u5bbf\u4e3b\u673a\u7684\u4e0d\u540c\u7f51\u7edc\u63a5\u53e3\u4e4b\u95f4\u8f6c\u53d1\uff0c\u662f\u5426\u8981\u8f6c\u53d1\u5230\u7269\u7406\u7f51\u5361\uff0c\u6216\u8005\u662f\u7559\u5728\u672c\u5730\u5904\u7406\u3002 iptables\u8d1f\u8d23\u5bf9\u7ecf\u8fc7\u5bbf\u4e3b\u673a\u7684\u6570\u636e\u5305\u8fdb\u884c\u68c0\u67e5\uff0c\u57fa\u4e8e\u4e00\u7cfb\u5217\u7684\u89c4\u5219\u8fdb\u884c\u4fee\u6539\uff08\u6bd4\u5982NAT\uff09\uff0c\u6216\u8005\u51b3\u5b9a\u662f\u5426\u5141\u8bb8\u7279\u5b9a\u7684\u6570\u636e\u6d41\u901a\u8fc7\u3002</p> <p></p> Filter\u8868 <pre><code>*filter\n:INPUT ACCEPT [244972180:39059491022]\n:FORWARD DROP [0:0]\n:OUTPUT ACCEPT [439290180:389638265797]\n:DOCKER - [0:0]\n:DOCKER-ISOLATION-STAGE-1 - [0:0]\n:DOCKER-ISOLATION-STAGE-2 - [0:0]\n:DOCKER-USER - [0:0]\n-A FORWARD -j DOCKER-USER\n-A FORWARD -j DOCKER-ISOLATION-STAGE-1\n-A FORWARD -o br-40d652e0aac8 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\n-A FORWARD -o br-40d652e0aac8 -j DOCKER\n-A FORWARD -i br-40d652e0aac8 ! -o br-40d652e0aac8 -j ACCEPT\n-A FORWARD -i br-40d652e0aac8 -o br-40d652e0aac8 -j ACCEPT\n-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\n-A FORWARD -o docker0 -j DOCKER\n-A FORWARD -i docker0 ! -o docker0 -j ACCEPT\n-A FORWARD -i docker0 -o docker0 -j ACCEPT\n-A DOCKER -d 172.18.0.2/32 ! -i br-40d652e0aac8 -o br-40d652e0aac8 -p tcp -m tcp --dport 80 -j ACCEPT\n-A DOCKER-ISOLATION-STAGE-1 -i br-40d652e0aac8 ! -o br-40d652e0aac8 -j DOCKER-ISOLATION-STAGE-2\n-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2\n-A DOCKER-ISOLATION-STAGE-1 -j RETURN\n-A DOCKER-ISOLATION-STAGE-2 -o br-40d652e0aac8 -j DROP\n-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP\n-A DOCKER-ISOLATION-STAGE-2 -j RETURN\n-A DOCKER-USER -j RETURN\nCOMMIT\n# Completed on Tue Feb 20 15:06:32 2024\n</code></pre> <p></p> Nat\u8868 <pre><code># Generated by iptables-save v1.4.21 on Tue Feb 20 15:06:32 2024\n*nat\n:PREROUTING ACCEPT [6782554:235185454]\n:INPUT ACCEPT [6770892:234485508]\n:OUTPUT ACCEPT [10758364:662367917]\n:POSTROUTING ACCEPT [10792762:664241249]\n:DOCKER - [0:0]\n-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER\n-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER\n-A POSTROUTING -s 172.18.0.0/16 ! -o br-40d652e0aac8 -j MASQUERADE\n-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE\n-A POSTROUTING -s 172.18.0.2/32 -d 172.18.0.2/32 -p tcp -m tcp --dport 80 -j MASQUERADE\n-A DOCKER -i br-40d652e0aac8 -j RETURN\n-A DOCKER -i docker0 -j RETURN\n-A DOCKER ! -i br-40d652e0aac8 -p tcp -m tcp --dport 80 -j DNAT --to-destination 172.18.0.2:80\nCOMMIT\n# Completed on Tue Feb 20 15:06:32 2024\n# Generated by iptables-save v1.4.21 on Tue Feb 20 15:06:32 2024\n</code></pre> <p>\u8fd9\u4e9b\u89c4\u5219\u4f3c\u4e4e\u914d\u7f6e\u81ea Docker \u4ee5\u7ba1\u7406\u5bb9\u5668\u7684\u7f51\u7edc\u901a\u4fe1\u3002\u4e0b\u9762\u6211\u5c06\u4e00\u4e00\u89e3\u91ca\u5b83\u4eec\u7684\u542b\u4e49\uff1a</p> <ol> <li><code>-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER</code></li> <li> <p>\u8fd9\u6761\u89c4\u5219\u6dfb\u52a0\u5230 <code>PREROUTING</code> \u94fe\uff0c\u5b83\u5339\u914d\u6240\u6709\u76ee\u6807\u7c7b\u578b\u4e3a <code>LOCAL</code> \u7684\u6570\u636e\u5305\uff0c\u5e76\u5c06\u5b83\u4eec\u8df3\u8f6c\u5230\u4e00\u4e2a\u540d\u4e3a <code>DOCKER</code> \u7684\u81ea\u5b9a\u4e49\u94fe\uff08\u8fd9\u662f Docker \u4f7f\u7528\u7684\uff09\u3002</p> </li> <li> <p><code>-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER</code></p> </li> <li> <p>\u8fd9\u6761\u89c4\u5219\u6dfb\u52a0\u5230 <code>OUTPUT</code> \u94fe\uff0c\u5b83\u8868\u793a\u5982\u679c\u8f93\u51fa\u6570\u636e\u5305\u7684\u76ee\u7684\u5730\u5740\u4e0d\u662f\u672c\u5730\u56de\u73af\u5730\u5740\uff08localhost\uff0c\u4e5f\u5c31\u662f127.0.0.0/8\u4e4b\u5916\uff09\uff0c\u5e76\u4e14\u76ee\u7684\u7c7b\u578b\u4e3a <code>LOCAL</code>\uff0c\u4e5f\u5c06\u5b83\u4eec\u8df3\u8f6c\u5230 <code>DOCKER</code> \u94fe\u3002</p> </li> <li> <p><code>-A POSTROUTING -s 172.18.0.0/16 ! -o br-40d652e0aac8 -j MASQUERADE</code></p> </li> <li> <p>\u8fd9\u6761\u89c4\u5219\u6dfb\u52a0\u5230 <code>POSTROUTING</code> \u94fe\uff0c\u5b83\u4f1a\u5bf9\u6e90\u5730\u5740\u4e3a <code>172.18.0.0/16</code> \u7684\u6570\u636e\u5305\uff0c\u5e76\u4e14\u4e0d\u662f\u4ece\u63a5\u53e3 <code>br-40d652e0aac8</code> \u51fa\u53bb\u7684\uff0c\u6267\u884c <code>MASQUERADE</code> \u52a8\u4f5c\u3002<code>MASQUERADE</code> \u7c7b\u4f3c\u4e8eSNAT\uff0c\u4f46\u6e90IP\u4f1a\u6839\u636e\u51fa\u53e3\u63a5\u53e3\u7684IP\u52a8\u6001\u53d8\u5316\uff0c\u5e38\u7528\u4e8e\u52a8\u6001IP\u573a\u666f\uff0c\u5982\u62e8\u53f7\u8fde\u63a5\u4e92\u8054\u7f51\u3002Docker \u4f7f\u7528\u8fd9\u4e2a\u6765\u5141\u8bb8\u5bb9\u5668\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u3002</p> </li> <li> <p><code>-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE</code></p> </li> <li> <p>\u4e0e\u7b2c3\u70b9\u7c7b\u4f3c\uff0c\u8fd9\u4e2a\u89c4\u5219\u5e94\u7528\u4e8e\u6e90\u5730\u5740\u4e3a <code>172.17.0.0/16</code> \u7684\u6570\u636e\u5305\uff0c\u4e0d\u662f\u4ece\u63a5\u53e3 <code>docker0</code> \u51fa\u53bb\u7684\u3002</p> </li> <li> <p><code>-A POSTROUTING -s 172.18.0.2/32 -d 172.18.0.2/32 -p tcp -m tcp --dport 80 -j MASQUERADE</code></p> </li> <li> <p>\u8be5\u89c4\u5219\u9488\u5bf9\u4ece\u5355\u4e2aIP <code>172.18.0.2</code> \u53d1\u51fa\u3001\u76ee\u7684\u5730\u4e5f\u662f\u6b64IP\u3001\u4ee5\u53ca\u76ee\u7684\u7aef\u53e3\u4e3a80\u7684TCP\u6570\u636e\u5305\uff0c\u505a<code>MASQUERADE</code>\u5904\u7406\u3002\u8fd9\u901a\u5e38\u7528\u4e8e\u5904\u7406\u5bb9\u5668\u4e0e\u81ea\u5df1\u53d1\u8d77\u8ddf\u81ea\u5df1\u7684\u8fde\u63a5\u3002</p> </li> <li> <p><code>-A DOCKER -i br-40d652e0aac8 -j RETURN</code></p> </li> <li> <p>\u5bf9\u4e8e\u901a\u8fc7 <code>br-40d652e0aac8</code> \u63a5\u53e3\u8fdb\u5165\u7684\u6570\u636e\u5305\uff0c\u8fd9\u6761\u89c4\u5219\u5728 <code>DOCKER</code> \u94fe\u4e2d\u76f4\u63a5\u8fd4\u56de\uff0c\u5373\u4e0d\u505a\u7279\u6b8a\u5904\u7406\u3002</p> </li> <li> <p><code>-A DOCKER -i docker0 -j RETURN</code></p> </li> <li> <p>\u7c7b\u4f3c\u4e0a\u4e00\u6761\u89c4\u5219\uff0c\u901a\u8fc7 <code>docker0</code> \u7f51\u6865\u63a5\u53e3\u8fdb\u5165\u7684\u6570\u636e\u5305\u4e0d\u505a\u5904\u7406\uff0c\u76f4\u63a5\u8fd4\u56de\u3002</p> </li> <li> <p><code>-A DOCKER ! -i br-40d652e0aac8 -p tcp -m tcp --dport 80 -j DNAT --to-destination 172.18.0.2:80</code></p> </li> <li>\u8be5\u89c4\u5219\u5bf9\u975e\u4ece <code>br-40d652e0aac8</code> \u63a5\u53e3\u8fdb\u5165\u3001\u76ee\u7684\u7aef\u53e3\u4e3a80\u7684TCP\u6570\u636e\u5305\uff0c\u6267\u884cDNAT\u52a8\u4f5c\uff0c\u4fee\u6539\u76ee\u7684\u5730\u5740\u4e3a <code>172.18.0.2:80</code>\u3002\u8fd9\u901a\u5e38\u662f\u5728\u505a\u7aef\u53e3\u8f6c\u53d1\uff0c\u5c06\u5230\u8fbe\u5bbf\u4e3b\u673a\u67d0\u7aef\u53e3\u7684\u6570\u636e\u5305\u8f6c\u53d1\u5230\u7279\u5b9a\u5bb9\u5668\u7684\u7aef\u53e3\u3002</li> </ol> <p>\u4ee5\u4e0a\u89c4\u5219\u96c6\u662f Docker \u5728\u5bbf\u4e3b\u673a\u4e0a\u914d\u7f6e\u7684\u4e00\u90e8\u5206\uff0c\u4ee5\u5b9e\u73b0\u5bb9\u5668\u4e4b\u95f4\u4ee5\u53ca\u5bb9\u5668\u4e0e\u5916\u90e8\u7f51\u7edc\u4e4b\u95f4\u7684\u6d41\u7545\u901a\u4fe1\u3002\u901a\u8fc7\u8fd9\u4e9b\u89c4\u5219\u53ef\u4ee5\u770b\u51fa Docker \u4f7f\u7528 <code>iptables</code> \u7684\u5b9a\u5236\u94fe\u6765\u5904\u7406\u5bb9\u5668\u7f51\u7edc\u7684\u590d\u6742\u6027\uff0c\u800c\u53ef\u8bc6\u522b\u6027\u5219\u7531 Docker \u672c\u8eab\u7ef4\u62a4\u3002</p>","tags":["docker","iptables"]},{"location":"blog/2024/02/21/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E7%90%86%E8%A7%A3/#forward","title":"FORWARD \u89c4\u5219\uff1a","text":"<ol> <li> <p><code>-A FORWARD -j DOCKER-USER</code>\uff1a   \u5c06\u6240\u6709 FORWARD \u94fe\u7684\u6d41\u91cf\u5b9a\u5411\u5230\u540d\u4e3a DOCKER-USER \u7684\u81ea\u5b9a\u4e49\u94fe\u3002\u8fd9\u6837\u505a\u662f\u4e3a\u4e86\u7ed9\u7528\u6237\u63d0\u4f9b\u5728\u81ea\u5b9a\u4e49\u94fe\u4e2d\u63d2\u5165\u4ed6\u4eec\u81ea\u5df1\u7684 FORWARD \u89c4\u5219\u7684\u673a\u4f1a\uff0c\u4e0d\u901a\u8fc7 Docker \u81ea\u52a8\u751f\u6210\u7684\u89c4\u5219\u3002</p> </li> <li> <p><code>-A FORWARD -j DOCKER-ISOLATION-STAGE-1</code>\uff1a   \u6b64\u89c4\u5219\u628a\u6d41\u91cf\u9001\u5230\u9694\u79bb\u9636\u6bb5\u94fe\u3002Docker \u4f7f\u7528\u8fd9\u4e9b\u89c4\u5219\u6765\u963b\u6b62\u4e0d\u540c\u7f51\u7edc\u7684\u5bb9\u5668\u4e4b\u95f4\u7684\u76f4\u63a5\u901a\u4fe1\uff0c\u5b9e\u65bd\u7f51\u7edc\u9694\u79bb\u3002</p> </li> <li> <p><code>-A FORWARD -o br-40d652e0aac8 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</code>\uff1a   \u6b64\u89c4\u5219\u5141\u8bb8\u4e0e\u5df2\u7ecf\u5efa\u7acb\u6216\u76f8\u5173\u8054\u7684\u8fde\u63a5\u53d1\u51fa\u7684\u6d41\u91cf\u901a\u8fc7 Docker \u7f51\u6865 <code>br-40d652e0aac8</code>\u3002</p> </li> <li> <p><code>-A FORWARD -o br-40d652e0aac8 -j DOCKER</code>\uff1a   \u5bf9\u4e8e\u53d1\u51fa\u7684\u6d41\u91cf\uff0c\u5982\u679c\u5b83\u662f\u4ece\u7f51\u6865 <code>br-40d652e0aac8</code> \u4f20\u51fa\u7684\uff0c\u5c31\u8df3\u8f6c\u5230 DOCKER \u94fe\u3002</p> </li> <li> <p><code>-A FORWARD -i br-40d652e0aac8 ! -o br-40d652e0aac8 -j ACCEPT</code>\uff1a   \u8fd9\u6761\u89c4\u5219\u5141\u8bb8\u6240\u6709\u8fdb\u5165\u7f51\u6865 <code>br-40d652e0aac8</code> \u4e14\u4e0d\u662f\u4ece\u8be5\u7f51\u6865\u4f20\u51fa\u7684\u6d41\u91cf\u3002</p> </li> <li> <p><code>-A FORWARD -i br-40d652e0aac8 -o br-40d652e0aac8 -j ACCEPT</code>\uff1a   \u5141\u8bb8\u6240\u6709\u4ece\u7f51\u6865 <code>br-40d652e0aac8</code> \u8fdb\u6765\u540c\u65f6\u4e5f\u4ece\u540c\u4e00\u7f51\u6865\u51fa\u53bb\u7684\u6d41\u91cf\u3002\u8fd9\u6837\u7684\u6d41\u91cf\u53d1\u751f\u5728\u540c\u4e00 Docker \u7f51\u6865\u5185\u90e8\u7684\u4e0d\u540c\u5bb9\u5668\u4e4b\u95f4\u3002</p> </li> </ol>","tags":["docker","iptables"]},{"location":"blog/2024/02/21/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E7%90%86%E8%A7%A3/#docker","title":"DOCKER \u94fe\uff1a","text":"<ol> <li><code>-A DOCKER -d 172.18.0.2/32 ! -i br-40d652e0aac8 -o br-40d652e0aac8 -p tcp -m tcp --dport 80 -j ACCEPT</code>\uff1a   \u6b64\u89c4\u5219\u5141\u8bb8\u4efb\u4f55\u4e0d\u662f\u6765\u81ea\u7f51\u6865 <code>br-40d652e0aac8</code> \u7684\u6d41\u91cf\u5230\u8fbe IP \u4e3a 172.18.0.2 \u7684\u8bbe\u5907\uff08\u5bb9\u5668\uff09\u4e0a\u7684 TCP \u7aef\u53e3 80\u3002</li> </ol>","tags":["docker","iptables"]},{"location":"blog/2024/02/21/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E7%90%86%E8%A7%A3/#docker-isolation-stage","title":"DOCKER-ISOLATION-STAGE \u94fe\uff1a","text":"<ol> <li> <p><code>-A DOCKER-ISOLATION-STAGE-1 -i br-40d652e0aac8 ! -o br-40d652e0aac8 -j DOCKER-ISOLATION-STAGE-2</code>\uff1a   \u5982\u679c\u6d41\u91cf\u662f\u4ece\u7f51\u6865 <code>br-40d652e0aac8</code> \u8fdb\u6765\u4e14\u4e0d\u662f\u4f20\u51fa\u540c\u4e00\u7f51\u6865\u7684\uff0c\u5219\u5b9a\u5411\u5230\u9694\u79bb\u9636\u6bb5 2\u3002</p> </li> <li> <p><code>-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2</code>\uff1a   \u5bf9\u4e8e\u8fdb\u5165\u9ed8\u8ba4\u7684 Docker \u7f51\u6865 <code>docker0</code> \u800c\u4e14\u4e0d\u662f\u79bb\u5f00\u5b83\u7684\u6d41\u91cf\uff0c\u8df3\u8f6c\u5230\u9694\u79bb\u9636\u6bb5 2\u3002</p> </li> <li> <p><code>-A DOCKER-ISOLATION-STAGE-1 -j RETURN</code>\uff1a     \u6240\u6709\u4e0d\u7b26\u5408\u9694\u79bb\u89c4\u5219\u7684\u6d41\u91cf\u7ed3\u675f\u9694\u79bb\u9636\u6bb5 1 \u5e76\u8fd4\u56de\u5230 FORWARD \u3002</p> </li> <li> <p><code>-A DOCKER-ISOLATION-STAGE-2 -o br-40d652e0aac8 -j DROP</code>\uff1a     \u4e22\u5f03\u6240\u6709\u4f20\u51fa\u7f51\u6865 <code>br-40d652e0aac8</code> \u7684\u6d41\u91cf\uff0c\u4ee5\u786e\u4fdd\u7f51\u7edc\u9694\u79bb\u3002</p> </li> <li> <p><code>-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP</code>\uff1a     \u4e22\u5f03\u6240\u6709\u4f20\u51fa\u7f51\u6865 <code>docker0</code> \u7684\u6d41\u91cf\uff0c\u540c\u6837\u4e3a\u4e86\u7f51\u7edc\u9694</p> </li> </ol>","tags":["docker","iptables"]},{"location":"blog/2024/09/29/%E4%BB%8E%E5%B9%B2%E4%BA%866%E5%B9%B4%E7%9A%84%E5%85%AC%E5%8F%B8%E6%AF%95%E4%B8%9A/","title":"\u4ece\u5e72\u4e866\u5e74\u7684\u516c\u53f8\u6bd5\u4e1a","text":"<p>\u662f\u7684\uff0c\u6ca1\u9519\uff0c\u6211\u4ece\u5e72\u4e866\u5e74\u7684\u516c\u53f8\u6bd5\u4e1a\u4e86\uff0c\u54c8\u54c8\u54c8\u3002</p> <p>\u8bb0\u5f972017\u5e74\u4e00\u4e2a\u4eba\u80cc\u7740\u53cc\u80a9\u5305\u4ece\u5357\u4eac\u6765\u5230\u4e86\u4e0a\u6d77\uff0c\u6ca1\u6709\u544a\u8bc9\u5bb6\u4eba\u548c\u670b\u53cb\uff0c\u6253\u7b97\u627e\u4e2a\u5b9e\u4e60\u5de5\u4f5c\uff0c\u540e\u6765\u4e5f\u627e\u5230\u4e86\u67d0\u4e2a\u5927\u5382\u7684\u5b9e\u4e60\u5c97\u4f4d\uff0c\u4e34\u8fd1\u5927\u5b66\u6bd5\u4e1a\u7684\u65f6\u5019\uff0c\u5317\u4eac\u603b\u90e8\u65b0\u589e\u4e00\u4e2a\u9886\u5bfc\uff0c\u6211\u7684\u76f4\u5c5e\u9886\u5bfc\u548c\u8001\u540c\u4e8b\u7eb7\u7eb7\u4e3b\u52a8\u79bb\u804c\uff0c\u6211\u90a3\u4f1a\u548c\u53e6\u4e00\u4e2a\u5b9e\u4e60\u7684\u540c\u4e8b\u4e5f\u7eb7\u7eb7\u4e3b\u52a8\u79bb\u804c\uff0c\u65b0\u9886\u5bfc\u529d\u8bf4\u8ba9\u6211\u4eec\u7559\u4e0b\uff0c\u6211\u4eec\u6b7b\u6d3b\u90fd\u4e0d\u7559\u4e0b\uff0c\u53ef\u80fd\u662f\u5e74\u8f7b\u6c14\u76db\u52a0\u4e0a\u8001\u9886\u5bfc\u5bf9\u6211\u4eec\u786e\u5b9e\u4e0d\u9519\uff0c\u7136\u540e\u5c31\u8d70\u4e86\u3002</p> <p>2018\u5e74\u627e\u5230\u4e86\u6211\u73b0\u5728\u7684\u516c\u53f8\uff0c\u4ece\u6bd5\u4e1a\u4e00\u76f4\u5e72\u5230\u73b0\u5728\u3002\u521a\u51fa\u5165\u804c\u7684\u51e0\u5e74\uff0c\u516c\u53f8\u53d1\u5c55\u7684\u662f\u84b8\u84b8\u65e5\u4e0a\uff0c\u6bcf\u5929\u529e\u516c\u5ba4\u90fd\u662f\u70ed\u70ed\u95f9\u95f9\uff0c\u5145\u65a5\u7740\u540c\u4e8b\u5173\u4e8e\u5de5\u4f5c\u95ee\u9898\u7684\u63a2\u8ba8\u3002\u52302020\u5e74\u7684\u65f6\u5019\uff0c\u6211\u4e5f\u901a\u8fc7\u81ea\u5df1\u7684\u52aa\u529b\u62ff\u5230\u4e86\u516c\u53f8\u7684\u671f\u6743\uff0c\u5de5\u8d44\u4e5f\u662f\u6bd4\u8d77\u521d\u5165\u804c\u6da8\u4e86\u5f88\u591a\u3002</p> <p>\u4f46\u662f\u4ece\u65b0\u51a0\u5f00\u59cb\u4e4b\u540e\uff0c\u516c\u53f8\u5c31\u6bcf\u51b5\u6108\u4e0b\uff0c\u8eab\u8fb9\u7684\u5c0f\u4f19\u4f34\u4e5f\u662f\u8d70\u4e86\u4e00\u6ce2\u53c8\u4e00\u6ce2\uff0c\u800c\u6211\u56e0\u4e3a\u516c\u53f8\u53ea\u6709\u4e00\u679a\u8fd0\u7ef4\uff0c\u6240\u4ee5\u6211\u4e00\u76f4\u575a\u5b88\u5c97\u4f4d\u3002\u4eca\u5e74\u662f\u5de5\u4f5c\u7684\u7b2c7\u5e74\uff0c\u7ec8\u4e8e\u6211\u4e5f\u79bb\u5f00\u4e86\u8fd9\u4e2a\u6211\u60f3\u5e72\u5230\u9000\u4f11\u7684\u516c\u53f8\uff0c\u534f\u5546\u79bb\u804c\u6d41\u7a0b\u4e5f\u662f\u6bd4\u8f83\u987a\u7545\u7684\u3002</p> <p>\u5165\u804c\u7684\u8fd9\u4e48\u591a\u5e74\u4e5f\u5e72\u4e86\u4e0d\u5c11\u4e8b\u60c5\uff0c\u521a\u5165\u804c\u7684\u65f6\u5019\uff0c\u7ebf\u4e0a\u5404\u79cd\u95ee\u9898\uff0c\u5e94\u7528\u7ecf\u5e38\u5d29\uff0c\u5f88\u591a\u4e8b\u60c5\u9700\u8981\u81ea\u52a8\u5316\uff0c\u8d44\u6e90\u7684\u5229\u7528\u7387\u4f4e\uff0c\u5230\u540e\u6765\u7edf\u4e00\u7684\u76d1\u63a7\uff0c\u6545\u969c\u81ea\u6108\u5904\u7406\uff0c\u5f00\u53d1\u73af\u5883\u7684\u5347\u7ea7\uff0c\u65e5\u5fd7\u5e73\u53f0\u7684\u5efa\u8bbe\uff0c\u914d\u7f6e\u6587\u4ef6\u7684\u53d1\u5e03\uff0ck8s\u7684\u4e0a\u7ebf\uff0c\u8fd0\u7ef4\u5e73\u53f0\u7684\u5efa\u8bbe\u7b49\u7b49\uff0c\u516c\u53f8\u89c4\u6a21\u5c0f\uff0c\u63a8\u52a8\u4e00\u4ef6\u4e8b\u60c5\u4e00\u822c\u90fd\u6bd4\u8f83\u5feb\uff0c\u52a0\u4e0a\u9886\u5bfc\u7684\u652f\u6301\uff0c\u6240\u4ee5\u7a7a\u4f59\u7684\u65f6\u95f4\u5c31\u4e0d\u65ad\u7684\u5b66\u4e60\u5e76\u5e94\u7528\u3002</p> <p>\u81ea\u5df1\u4e5f\u662f\u572823\u5e74\u7684\u65f6\u5019\u5b8c\u6210\u4e86\u4eba\u751f\u5927\u4e8b\uff0c\u4eca\u5e74\u5e74\u5e95\u5982\u679c\u9884\u4ea7\u671f\u6b63\u786e\u7684\u8bdd\u5e94\u8be5\u4e5f\u4f1a\u6709\u65b0\u751f\u547d\u7684\u8bde\u751f\u3002\u6b63\u597d\u8d81\u7740\u8fd9\u4e2a\u65f6\u95f4\u597d\u597d\u7684\u966a\u7740\u8001\u5a46\u5f85\u4ea7\uff0c\u4e00\u8fb9\u4e5f\u662f\u603b\u7ed3\u8fd9\u4e48\u591a\u5e74\u7684\u5de5\u4f5c\u7ecf\u9a8c\uff0c\u5b66\u70b9\u65b0\u4e1c\u897f\uff0c\u8003\u8651\u4e00\u4e0b\u672a\u6765\u7684\u53d1\u5c55\u8def\u7ebf\uff0c\u4e00\u5207\u90fd\u662f\u6700\u597d\u7684\u5b89\u6392\u3002</p> <p></p>","tags":["\u7ecf\u5386"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/","title":"prometheus \u76d1\u63a7windows","text":"<p>\u901a\u8fc7ansible \u6279\u91cf\u64cd\u4f5cwindows\u673a\u5668\uff0c\u90e8\u7f72windows_exporter-0.21.0-amd64.exe</p> <ul> <li> <p>ansible\u6279\u91cf\u64cd\u4f5cwindows</p> </li> <li> <p>windows_exporter\u76d1\u63a7windows\u8fdb\u7a0b</p> </li> <li> <p>prometheus\u76d1\u63a7windows_exporter</p> </li> </ul>","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#1","title":"1\u3001\u9700\u8981\u68c0\u67e5\u7684","text":"<p>\u901a\u8fc7ansible\u6279\u91cf\u64cd\u4f5cwindows\u673a\u5668\u3002</p>","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#1_1","title":"1\u3001\u767b\u5f55\u540d","text":"<p>ansible\u767b\u5f55\u7528\u6237\u540d\u5fc5\u987b\u4e0e\u7cfb\u7edf\u7ec4\u8bb0\u5f55\u7684\u6210\u5458\u540d\u4e00\u81f4\uff0c\u8981\u4e0d\u7136\u4f1a\u4e00\u76f4\u62a5\u9519\uff0c\"ntlm: the specified credentials were rejected by the server\" </p>","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#2","title":"2\u3001\u68c0\u67e5\u7f51\u7edc\u72b6\u6001\u662f\u5426\u662f\u4e13\u6709\u7f51\u7edc","text":"","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#3windowspowershell","title":"3\u3001\u5728\u88ab\u63a7windows\u7535\u8111\u4e2d\uff0c\u901a\u8fc7\u7ba1\u7406\u5458\u65b9\u5f0f\u6253\u5f00powershell\uff0c\u6267\u884c\u5982\u4e0b","text":"<pre><code>winrm quickconfig\nwinrm set winrm/config/service/auth '@{Basic=\"true\"}'\nwinrm set winrm/config/service '@{AllowUnencrypted=\"true\"}'\n</code></pre>","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#4linux","title":"4\u3001\u63a7\u5236\u7aef\u5728linux\u673a\u5668\u4e0a\uff0c\u5b89\u88c5\u5982\u4e0b","text":"<pre><code>pip install pywinrm&gt;=0.2.2\n</code></pre>","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#2ansible","title":"2\u3001ansible\u914d\u7f6e","text":"","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#1ansible-host","title":"1\u3001ansible host\u53ef\u4ee5\u5982\u4e0b","text":"<pre><code>[wind]\nmy_server ansible_host=192.168.61.153 ansible_ssh_user=\"aaa\\bbb\" \nansible_ssh_pass=\"xxx\"\n\n[wind:vars]\nansible_ssh_port=5985\nansible_connection=\"winrm\"\nansible_winrm_server_cert_validation=ignore \nansible_winrm_transport=ntlm\n</code></pre>","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#2_1","title":"2\u3001\u6d4b\u8bd5\u4e00\u4e0b","text":"<pre><code>[root@www ~]# ansible -i /etc/ansible/myhost wind -m win_ping\nmy_server | SUCCESS =&gt; {\n    \"changed\": false, \n    \"ping\": \"pong\"\n}\n</code></pre>","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#3","title":"3\u3001\u5f00\u59cb\u6279\u91cf\u64cd\u4f5c","text":"<pre><code>---\n- hosts: wind\n  gather_facts: no\n  tasks:\n    - name: create directory\n      win_file: \n        path: D:\\ops_control\n        state: directory\n    - name: copy pkg\n      win_copy:\n        src: \"{{item}}\"\n        dest: D:\\ops_control\\\n        force: yes\n      with_items:\n        - /etc/ansible/pkg/windows_exporter-0.21.0-amd64.exe\n        - /etc/ansible/pkg/wind_exporter.exe\n        - /etc/ansible/config/config.yml\n        - /etc/ansible/pkg/start_win_exporter.bat\n\n\n#\u521b\u5efa\u76ee\u5f55\nansible -i /etc/ansible/myhost wind -m win_file -a \"path=D:\\ops_control state=directory\"\n\n\u590d\u5236\nansible -i /etc/ansible/myhost wind -m win_copy -a \"src=/etc/ansible/pkg/windows_exporter-0.21.0-amd64.exe dest=D:\\ops_control\\ force=yes\"\nansible -i /etc/ansible/myhost wind -m win_copy -a \"src=/etc/ansible/config/config.yml dest=D:\\ops_control\\ force=yes\"\nansible -i /etc/ansible/myhost wind -m win_copy -a \"src=/etc/ansible/pkg/start_win_exporter.bat dest=D:\\ops_control\\ force=yes\"\n\n\u6267\u884c\nansible -i /etc/ansible/myhost wind -m win_command -a \"chdir=D:\\ops_control  .\\start_win_exporter.bat\"\n\n\n\u91cd\u542f\nansible -i /etc/ansible/myhost wind -m raw -a \"taskkill /F /IM windows_exporter-0.21.0-amd64.exe /T\"\n</code></pre>","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#3windows_exporter","title":"3\u3001windows_exporter","text":"","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#1_2","title":"1\u3001\u914d\u7f6e","text":"<p>windows_exporter\u7684config.yml\u914d\u7f6e\u6587\u4ef6\u793a\u4f8b\uff0c\u76d1\u63a7\u6307\u5b9a\u8fdb\u7a0b\u7684\u72b6\u6001\uff0c\u6211\u4e0a\u4f20\u7684\u4e00\u4e2adashboard\uff0c\u4e5f\u662f\u53c2\u8003\u522b\u7684\u5927\u4f6c\u7684\uff0c\u6709\u9700\u8981\u7684\u53ef\u4ee5\u81ea\u53d6\uff1ahttps://grafana.com/grafana/dashboards/18236-1-windows-exporter-for-prometheus-dashboard-cn-v20201012/</p> <pre><code>---\n# Note this is not an exhaustive list of all configuration values\ncollectors:\n  enabled: cpu,cs,logical_disk,net,os,process,system,textfile\ncollector:\n  process: \n    whitelist: \"QQ.*\"\n#  service:\n#    services-where: Name='windows_exporter'\n#  scheduled_task:\n#    blacklist: /Microsoft/.+\nlog:\n  level: warn\nscrape:\n  timeout-margin: 0.5\ntelemetry:\n  addr: \":9182\"\n  path: /metrics\n  max-requests: 5\n</code></pre>","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#2bat","title":"2\u3001bat\u811a\u672c\u542f\u52a8","text":"<p><pre><code>start D:\\ops_control\\windows_exporter-0.21.0-amd64.exe --config.file=D:\\ops_control\\config.yml\n</code></pre>  exporter\u5730\u5740\uff1ahttps://github.com/prometheus-community/windows_exporter</p>","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#3_1","title":"3\u3001\u76d1\u63a7\u68c0\u67e5\u4e0e\u542f\u52a8","text":"<p>\u53c2\u8003</p>","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#4prometheus","title":"4\u3001prometheus\u7684\u76d1\u63a7","text":"","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#1prometheus","title":"1\u3001prometheus\u914d\u7f6e","text":"Prometheus\u914d\u7f6e <pre><code># my global config\nglobal:\nscrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.\nevaluation_interval: 1m # Evaluate rules every 15 seconds. The default is every 1 minute.\n# scrape_timeout is set to the global default (10s).\n\n# Alertmanager configuration\nalerting:\nalertmanagers:\n    - static_configs:\n        - targets:\n        - localhost:9093\n\n# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.\nrule_files:\n- \"/opt/soft/alertmanager-0.25.0.linux-amd64/local_rules.yml\"\n# - \"/opt/soft/alertmanager-0.25.0.linux-amd64/hoststatus_rules.yml\"\n# - \"first_rules.yml\"\n# - \"second_rules.yml\"\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n# The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.\n#- job_name: \"prometheus\"\n\n    # metrics_path defaults to '/metrics'\n    # scheme defaults to 'http'.\n\n    #static_configs:\n    #  - targets: [\"localhost:9090\"]\n#- job_name: 'redis'\n#  static_configs:\n#  - targets: ['192.168.60.174:9121']\n#    labels:\n#      ecs: redis\n#  metrics_path: /scrape\n#  relabel_configs:\n#    - source_labels: [__address__]\n#      target_label: __param_target\n#    - source_labels: [__param_target]\n#      target_label: instance\n- job_name: \"windows_prometheus\"\n    static_configs:\n    - targets: [\"192.168.61.153:9182\",\"192.168.62.238:9182\"]\n</code></pre>","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#2alertmanager","title":"2\u3001alertmanager\u7684\u914d\u7f6e","text":"Alertmanager\u914d\u7f6e <pre><code>alertmanager.yml\n\nglobal:\nresolve_timeout: 5m\nsmtp_smarthost: 'smtp.163.com:25'\nsmtp_from: 'xxx@163.com'\nsmtp_auth_username: 'xxx@163.com'\nsmtp_auth_password: 'xxx'\nsmtp_require_tls: false\n\ntemplates:\n- 'notify.tmpl'\n\nroute:\ngroup_by: ['alertname']\ngroup_wait: 10s\ngroup_interval: 10s\nrepeat_interval: 5m\nreceiver: 'default-receiver'\nroutes:\n    - receiver: 'ops'\n    match:\n        severity: 'error'\n    group_wait: 10s\nreceivers: \n- name: 'default-receiver'\nemail_configs:\n- to: 'xxx@dingtalk.com'\n    html: '{{ template \"notify.html\" . }}'\n    headers: { Subject: \"\u6765\u81eaprometheus_60.203_\u62a5\u8b66\u90ae\u4ef6\"}\n    send_resolved: true\n- name: 'ops'\nemail_configs:\n- to: 'xxx@qq.com'\n    html: '{{ template \"notify.html\" . }}'\n    headers: { Subject: \"\u6765\u81eaprometheus_60.203_\u62a5\u8b66\u90ae\u4ef6\"}\n    send_resolved: true\n\ninhibit_rules:\n- source_match:\n    severity: 'critical'\n    target_match:\n    severity: 'warning'\n    equal: ['alertname', 'dev', 'instance']\n</code></pre> Local_rules <p>local_rules.yml <pre><code>groups:\n- name: local_rules\nrules:\n\n# Alert for any instance that is unreachable for &gt;5 minutes.\n- alert: InstanceDown\n    expr: up{job=\"windows_prometheus\"} == 0\n    for: 2m\n    labels:\n    severity: error\n    annotations:\n    summary: \"Instance {{ $labels.instance }} down\"\n    description: \"{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes, current value: {{ $value }}\"\n\n\n- alert: processThreadsTooMany\n    expr: windows_process_threads{} &gt; 0\n    for: 10m\n    annotations:\n    summary: \"Threads too many {{ $labels.instance }} {{  $labels.process }}\"\n    description: \"{{ $labels.instance }} {{  $labels.process }}  (current value: {{ $value }})\"\n</code></pre></p> Notify <p>notify.tmpl <pre><code>{{ define \"notify.html\" }}\n\n{{- if gt (len .Alerts.Firing) 0 -}}{{ range .Alerts }}\n\n@\u5f02\u5e38\u8b66\u544a &lt;br&gt;\n\n\u5b9e\u4f8b: {{ .Labels.instance }} &lt;br&gt;\n\n\u4fe1\u606f: {{ .Annotations.summary }} &lt;br&gt;\n\n\u8be6\u60c5: {{ .Annotations.description }} &lt;br&gt;\n\n\u5f00\u59cb\u65f6\u95f4: {{ (.StartsAt.Add 28800e9).Format \"2006-01-02 15:04:05\" }} &lt;br&gt;&lt;br&gt;\n\n{{ end }}{{ end -}}\n\n{{- if gt (len .Alerts.Resolved) 0 -}}{{ range .Alerts }}\n\n@\u5f02\u5e38\u6062\u590d &lt;br&gt;\n\n\u5b9e\u4f8b: {{ .Labels.instance }} &lt;br&gt;\n\n\u4fe1\u606f: {{ .Annotations.summary }} &lt;br&gt;\n\n\u5f00\u59cb\u65f6\u95f4: {{ (.StartsAt.Add 28800e9).Format \"2006-01-02 15:04:05\" }} &lt;br&gt;\n\n\u6062\u590d\u65f6\u95f4: {{ (.EndsAt.Add 28800e9).Format \"2006-01-02 15:04:05\" }} &lt;br&gt;\n\n{{ end }}{{ end -}}\n\n{{- end }}\n</code></pre></p>","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#3prometheus","title":"3\u3001\u91cd\u542fprometheus","text":"<pre><code>curl -X POST http://127.0.0.1:9093/-/reload\ncurl -X POST http://127.0.0.1:9091/-/reload\n</code></pre>","tags":["prometheus","windows"]},{"location":"blog/2023/03/09/%E7%9B%91%E6%8E%A7windows/#4","title":"4\u3001\u53c2\u8003\u94fe\u63a5","text":"<pre><code>https://blog.csdn.net/W1124824402/article/details/128408171\nhttps://ost.51cto.com/posts/14124\n\nhttps://github.com/prometheus/alertmanager/blob/main/template/default.tmpl\n\nhttps://prometheus.io/docs/alerting/latest/notification_examples/\n</code></pre>","tags":["prometheus","windows"]},{"location":"blog/2023/03/17/%E6%97%A0%E9%BB%98%E8%AE%A4%E5%80%BC%E7%9B%91%E6%8E%A7%E9%A1%B9/","title":"prometheus \u65e0\u9ed8\u8ba4\u503c\u76d1\u63a7\u9879\u548calertmanager \u544a\u8b66\u6291\u5236","text":"<p>prometheus \u65e0\u9ed8\u8ba4\u503c\u76d1\u63a7\u9879\u548calertmanager \u544a\u8b66\u6291\u5236.</p>","tags":["prometheus","alertmanager"]},{"location":"blog/2023/03/17/%E6%97%A0%E9%BB%98%E8%AE%A4%E5%80%BC%E7%9B%91%E6%8E%A7%E9%A1%B9/#1","title":"1\u3001\u914d\u7f6e\u6587\u4ef6\u793a\u4f8b","text":"<p>\u8d77\u521d\u81ea\u5df1\u8bbe\u5b9a\u7684\u914d\u7f6e\u662f\u4e24\u4e2a\u5355\u7eaf\u7684static_configs\uff0c\u7528\u81ea\u5e26\u7684labels\u8fdb\u884c\u5411\u91cf\u5339\u914d\u3002</p> Prometheus <pre><code>global:\nscrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.\nevaluation_interval: 1m # Evaluate rules every 15 seconds. The default is every 1 minute.\n# scrape_timeout is set to the global default (10s).\n\nalerting:\nalertmanagers:\n    - static_configs:\n        - targets:\n        - localhost:9093\n\n# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.\nrule_files:\n- \"/opt/soft/alertmanager-0.25.0.linux-amd64/local_rules.yml\"\n\nscrape_configs:\n- job_name: \"pushGateway\"\n\n    static_configs:\n    - targets: [\"localhost:9099\"]\n    #relabel_configs:\n    #  - source_labels: [srcIp]\n    #    separator: ':'\n    #    regex: '(.*)'\n    #    replacement: '${1}'\n    #    target_label: instance\n\n- job_name: \"windows_prometheus\"\n    static_configs:\n    - targets: \n        - 192.168.61.153:9182\n        - 192.168.62.238:9182\n        - 192.168.62.157:9182\n        - 192.168.62.17:9182\n        - 192.168.66.175:9182\n        - 192.168.62.54:9182\n        - 192.168.62.94:9182\n        - 192.168.62.87:9182\n        - 192.168.62.52:9182\n        - 192.168.62.224:9182\n        - 192.168.62.222:9182\n        - 192.168.62.185:9182\n        - 192.168.62.71:9182\n        - 192.168.62.110:9182\n        - 192.168.62.88:9182\n        - 192.168.62.28:9182\n        - 192.168.62.175:9182\n        - 192.168.62.247:9182\n    relabel_configs:\n    - source_labels: [__address__]\n        separator: ':'\n        regex: '(.*):(.*)'\n        replacement: '${1}'\n        target_label: src_instance\n</code></pre>","tags":["prometheus","alertmanager"]},{"location":"blog/2023/03/17/%E6%97%A0%E9%BB%98%E8%AE%A4%E5%80%BC%E7%9B%91%E6%8E%A7%E9%A1%B9/#2pushgateway","title":"2\u3001pushGateWay\u65e0\u9ed8\u8ba4\u503c","text":"<p>pushGateWay \u7684\u6570\u636e\u5c42\u9762, pushgateway \u7684\u6570\u636e\u6765\u6e90\u662f\u63a8\u9001\u5230pgw\uff0c\u7136\u540eprometheus \u518d\u53bb\u62c9\u53d6pgw\u5bf9\u5e94\u7684metric\u3002\u6240\u4ee5pgw\u8ddfexporter\u5c31\u6709\u4e2a\u533a\u522b\uff0cpgw\u6ca1\u6709\u9ed8\u8ba4\u503c\u3002 </p> <p>\u90a3\u4e48\u5728\u5f53\u4e0a\u56fe\u4e2d short-lived jobs\u6ca1\u6709\u5411pgw\u63a8\u9001\u6570\u636e\u65f6\uff0cpgw\u4e0d\u77e5\u9053\u662f\u5426\u5b58\u5728\u8be5\u76d1\u63a7\u5411\u91cf\u3002\u6240\u4ee5\u6b64\u65f6\u5bf9\u5e94\u76d1\u63a7\u9879\u7528\u6765\u5224\u65ad\u5e94\u7528\u7684\u5b58\u6d3b\u72b6\u6001\u5c31\u591a\u5c11\u6709\u4e9b\u9ebb\u70e6\u3002</p>","tags":["prometheus","alertmanager"]},{"location":"blog/2023/03/17/%E6%97%A0%E9%BB%98%E8%AE%A4%E5%80%BC%E7%9B%91%E6%8E%A7%E9%A1%B9/#3","title":"3\u3001\u544a\u8b66\u89c4\u5219\u793a\u4f8b","text":"\u544a\u8b66\u89c4\u5219 <pre><code>groups:\n- name: local_rules\nrules:\n\n- alert: InstanceDown\n    expr: up{job=\"windows_prometheus\"} == 0\n    for: 2m\n    labels:\n    severity: error\n    annotations:\n    summary: \"Instance {{ $labels.instance }} down\"\n    description: \"{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes, current value: {{ $value }}\"\n\n\n- alert: auto_wx_friend\n    expr: (job_last_success_unixtime{exported_job=\"auto_wx_friend_from_pgw\"} or (up{job=\"windows_prometheus\"} * 0)) == 0\n    for: 2m\n    labels:\n    severity: error\n    annotations:\n    summary: \"auto_wx_friend down {{ $labels.src_instance }} {{  $labels.job }}\"\n    description: \"{{ $labels.src_instance }} {{  $labels.job }}  (current value: {{ $value }})\"\n</code></pre>","tags":["prometheus","alertmanager"]},{"location":"blog/2023/03/17/%E6%97%A0%E9%BB%98%E8%AE%A4%E5%80%BC%E7%9B%91%E6%8E%A7%E9%A1%B9/#4pgw","title":"4\u3001\u76d1\u63a7\u6570\u636e\u63a8\u9001\u81f3pgw\u7684\u811a\u672c","text":"<p>\u544a\u8b66\u89c4\u5219\u4e2d\uff0cInstanceDown\u662fexporter\u7684\uff0cauto_wx_friend\u662fpgw\u7684\u3002\u800c\u5728prometheus\u4e2d\u7684src_instance\u662f\u4e3a\u4e86\u5c1d\u8bd5\u5411\u91cf\u5339\u914d\uff0c\u6240\u4ee5\u5f97\u6709\u76f8\u540clabels\u3002</p> \u811a\u672c <pre><code>from prometheus_client import CollectorRegistry, Gauge, push_to_gateway\nimport socket\n\n\nclass PushGateWayPrometheus:\n    \"\"\"\n    pushgateway\n    \"\"\"\n\n    def __init__(self):\n        self.registry = CollectorRegistry()\n        self.gateway = '192.168.60.203:9099'\n        # label \u548c value \u5bf9\u5e94\n        self.label_name = ['src_instance', ]\n        self.src_ip_label_value = socket.gethostbyname(socket.gethostname())\n        # \u65e0\u9700\u4fee\u6539\n        self.job = 'auto_wx_friend_from_pgw'\n\n    def gauge_process_alive(self, metric_name: str, describe: str) -&gt; None:\n        \"\"\"\n        \u5982\u679c\u5bf9\u5e94\u503c\u8bbe\u7f6e\u4e3a1\uff0c\u5219\u8868\u793a\u5e94\u7528\u4ecd\u7136\u5b58\u6d3b\n        :param metric_name: \n        :param describe: \n        :return: \n        \"\"\"\n        g = Gauge(metric_name, describe, registry=self.registry,\n                labelnames=self.label_name)\n        g.labels(self.src_ip_label_value).set(1)\n\n    def push(self, metric_name: str, describe: str) -&gt; None:\n        \"\"\"\n        \u63a8\u9001\u5bf9\u5e94\u7684\u6307\u6807\uff0c\u5982\u679c\u6709\u65b0\u7684\u53ea\u9700\u65b0\u589e\n        :param metric_name: \n        :param describe: \n        :return: \n        \"\"\"\n        self.gauge_process_alive(metric_name, describe)\n        push_to_gateway(self.gateway, job=self.job, registry=self.registry)\n\n\nPushGateWayPrometheus().push('job_last_success_unixtime', 'Last time a batch job successfully finished')\n</code></pre>","tags":["prometheus","alertmanager"]},{"location":"blog/2023/03/17/%E6%97%A0%E9%BB%98%E8%AE%A4%E5%80%BC%E7%9B%91%E6%8E%A7%E9%A1%B9/#5alertmanager","title":"5\u3001alertmanager \u544a\u8b66\u6291\u5236","text":"<pre><code>inhibit_rules:\n  - source_match:\n      severity: 'critical'\n    target_match:\n      severity: 'warning'\n    equal: ['alertname', 'instance']\n\n\n# \u6291\u5236\u5668\u914d\u7f6e\ninhibit_rules: # \u6291\u5236\u89c4\u5219\n  - source_match: # \u6e90\u6807\u7b7e\u8b66\u62a5\u89e6\u53d1\u65f6\u6291\u5236\u542b\u6709\u76ee\u6807\u6807\u7b7e\u7684\u8b66\u62a5\uff0c\u5728\u5f53\u524d\u8b66\u62a5\u5339\u914d status: 'High'\n      status: 'High'  \n    target_match:\n      status: 'Warning' # \n    equal: ['alertname','operations', 'instance'] # \u786e\u4fdd\u8fd9\u4e2a\u914d\u7f6e\u4e0b\u7684\u6807\u7b7e\u5185\u5bb9\u76f8\u540c\u624d\u4f1a\u6291\u5236\uff0c\u4e5f\u5c31\u662f\u8bf4\u8b66\u62a5\u4e2d\u5fc5\u987b\u6709\u8fd9\u4e09\u4e2a\u6807\u7b7e\u503c\u624d\u4f1a\u88ab\u6291\u5236\u3002\n</code></pre>","tags":["prometheus","alertmanager"]},{"location":"blog/2023/07/04/See%20pam_nologin%288%29/","title":"System is booting up. See pam_nologin(8)","text":"<p>System is booting up. See pam_nologin(8).</p> <p>\u51fa\u73b0\u7684\u60c5\u51b5\u5343\u5947\u767e\u602a\uff0c\u6b64\u6587\u6863\u4ec5\u63d0\u4f9b\u89e3\u51b3\u95ee\u9898\u7684\u4e00\u4e2a\u601d\u8def\u3002</p>"},{"location":"blog/2023/07/04/See%20pam_nologin%288%29/#_1","title":"\u524d\u8a00","text":"<p>System is booting up. See pam_nologin(8) \uff1f \u8fd9\u662f\u4ec0\u4e48\u9524\u5b50\u95ee\u9898\uff1f\uff0c\u5feb\u4e0b\u73ed\u7684\u65f6\u5019\u9694\u58c1\u8001\u738b\u627e\u6211\u8bf4\u4ed6\u767b\u5f55\u4e0d\u4e0a\u7ebf\u4e0a\u673a\u5668\u4e86\uff0c\u6211\u8bd5\u4e86\u4e00\u4e0broot\u7528\u6237\u53ef\u4ee5\uff0c\u7136\u540e\u666e\u901a\u7528\u6237\u4e0d\u884c\uff0c\u7136\u540e\u6211\u5c31\u8ba9\u4ed6\u5148\u4e34\u65f6\u7528root\u7528\u4e00\u4e0b\uff0c\u6211\u5148\u67e5\u67e5\u95ee\u9898\u3002</p> <p>\u5b8c\u6574\u62a5\u9519\u662f\u8fd9\u4e2a\u6837\u5b50\u7684 <pre><code>[root@xxx~]# ssh xxx@10.10.1.1\nSystem is booting up. See pam_nologin(8)\nAuthentication failed.\n</code></pre> \u5173\u4e8e\u8fd9\u4e2a\u670d\u52a1\u5668\u57fa\u7840\u7684\u65e5\u5fd7\u4e5f\u90fd\u67e5\u4e86\uff0c\u6ca1\u6709\u4ec0\u4e48\u5f02\u5e38\u4e4b\u5904\u3002\u767e\u5ea6\u6216\u8c37\u6b4c\u7684\u90fd\u662f\u6ca1\u5173\u7cfb\u7684\u7ed3\u679c\uff0c\u6211\u4e5f\u6ca1\u6709\u968f\u4fbf\u8bd5\uff0c\u7ebf\u4e0a\u673a\u5668\u8c28\u614e\u64cd\u4f5c\u3002</p>"},{"location":"blog/2023/07/04/See%20pam_nologin%288%29/#1","title":"1\u3001\u67e5\u627e\u95ee\u9898","text":""},{"location":"blog/2023/07/04/See%20pam_nologin%288%29/#11","title":"1.1\u3001\u4e00\u4e2a\u601d\u8def","text":"<p>\u6458\u6284\u81eachatgpt\u7684\u4e00\u4e2a\u65e0\u7528\u7684\u7b54\u6848\uff0c\u4f46\u662f\u7ed9\u6211\u63d0\u4f9b\u4e86\u4e00\u4e2a\u601d\u8def\u3002</p> <pre><code>pam_nologin(8)\u662f\u4e00\u4e2a\u7528\u4e8eLinux\u7cfb\u7edf\u7684PAM\uff08Pluggable Authentication Modules\uff09\u6a21\u5757\uff0c\u5b83\u5141\u8bb8\u7ba1\u7406\u5458\u5728\u7cfb\u7edf\u7ef4\u62a4\u671f\u95f4\u963b\u6b62\u7528\u6237\u767b\u5f55\u3002\u5f53\u7cfb\u7edf\u542f\u52a8\u65f6\uff0cPAM\u4f1a\u68c0\u67e5\u662f\u5426\u5b58\u5728/etc/nologin\u6587\u4ef6\uff0c\u5982\u679c\u8be5\u6587\u4ef6\u5b58\u5728\u4e14\u4e0d\u4e3a\u7a7a\uff0c\u5219PAM\u5c06\u62d2\u7edd\u6240\u6709\u975e\u7279\u6743\u7528\u6237\u7684\u767b\u5f55\u8bf7\u6c42\uff0c\u5e76\u663e\u793a\u5176\u4e2d\u6307\u5b9a\u7684\u6d88\u606f\u3002\n\n\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c/etc/nologin\u6587\u4ef6\u53ea\u6709\u5728\u7cfb\u7edf\u91cd\u542f\u671f\u95f4\u624d\u88ab\u521b\u5efa\uff0c\u5e76\u5728\u7cfb\u7edf\u91cd\u542f\u540e\u81ea\u52a8\u5220\u9664\u3002\u56e0\u6b64\uff0c\u5982\u679c\u4f60\u770b\u5230\u4e86\u7c7b\u4f3c\"See pam_nologin(8)\"\u7684\u6d88\u606f\uff0c\u4f46\u7cfb\u7edf\u6ca1\u6709\u91cd\u542f\uff0c\u90a3\u53ef\u80fd\u662f\u7531\u4e8e\u67d0\u4e9b\u539f\u56e0\u5bfc\u81f4/etc/nologin\u6587\u4ef6\u672a\u80fd\u6b63\u786e\u5730\u5220\u9664\u3002\n\n\u4f60\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u6b65\u9aa4\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff1a\n\n\u4ee5root\u8eab\u4efd\u767b\u5f55\u5230\u7cfb\u7edf\u3002\n\u68c0\u67e5/etc/nologin\u6587\u4ef6\u662f\u5426\u5b58\u5728\uff1als -l /etc/nologin\n\u5982\u679c\u5b58\u5728\uff0c\u8bf7\u5220\u9664\u8be5\u6587\u4ef6\uff1arm /etc/nologin\n\u6267\u884c\u4e0a\u8ff0\u6b65\u9aa4\u540e\uff0c\u518d\u6b21\u5c1d\u8bd5\u767b\u5f55\u5e94\u8be5\u5c31\u4e0d\u4f1a\u51fa\u73b0\"See pam_nologin(8)\"\u7684\u6d88\u606f\u4e86\u3002\n</code></pre>"},{"location":"blog/2023/07/04/See%20pam_nologin%288%29/#12","title":"1.2\u3001\u7ee7\u7eed\u5206\u6790","text":"<p>\u6743\u9650\u5565\u7684\u6211\u90fd\u6ca1\u6709\u52a8\u8fc7\uff0cvisudo\u6587\u4ef6\u4e5f\u6ca1\u6709\u5f02\u5e38\uff0c\u7136\u540e\u6211\u5c31\u5168\u5c40\u627enologin\u6587\u4ef6\uff0c\u641e\u4e0d\u597d\u6709\u4ec0\u4e48\u9690\u85cf\u7684nologin\u3002 <pre><code>[root@xxx run]# find / -name nologin -type f\n/usr/sbin/nologin\n/run/nologin\n</code></pre> \u8fd9\u4e2a/run/nologin\u662f\u54ea\u4e2a\u7599\u7629\u6765\u7684\uff0c\u7136\u540e\u53d1\u73b0\u770b\u4e86\u4e00\u4e0b\u6587\u4ef6\u7684\u5185\u5bb9\u3002</p> <p><pre><code>[root@xxx run]# cat /run/nologin\nSystem is booting up. See pam_nologin(8)[root@xxx run]# \n</code></pre> \u6211\u9760\uff0c\u8fd9\u4e0d\u5c31\u662f\u62a5\u9519\u7684\u8f93\u51fa\u3002</p> <p>\u5220\u9664\u8fd9\u4e2a /run/nologin \u8fd9\u4e2a\u6587\u4ef6\u662f\u5426\u6709\u4ec0\u4e48\u5371\u5bb3\uff1f\u4e0d\u5220\u6211\u5f97\u666e\u901a\u7528\u6237\u90fd\u767b\u5f55\u4e0d\u4e86\u4e86\uff0c\u968f\u5373\u6211\u5c31\u5220\u4e86\u8fd9\u4e2a\u6587\u4ef6\uff08\u4e3a\u5565\u4f1a\u60f3\u5220\u9664\u8fd9\u4e2a\u6587\u4ef6\uff0c\u56e0\u4e3a\u4e0a\u9762\u7684/etc/nologin\u4e5f\u662f\u53ef\u4ee5\u5220\u9664\u7684\uff0c\u5e76\u4e14\u8003\u8651\u4e86\u5220\u9664\u53ef\u80fd\u4f1a\u6709\u7684\u5f71\u54cd\uff09\uff0c\u7136\u540e\u6d4b\u8bd5\u666e\u901a\u7528\u6237\u53ef\u4ee5\u767b\u5f55\u4e86\u3002</p> <ul> <li> \u975e\u7279\u6743\u7528\u6237\u80fd\u591f\u767b\u5f55\uff1a/run/nologin \u6587\u4ef6\u7684\u5b58\u5728\u4f1a\u963b\u6b62\u975e\u7279\u6743\u7528\u6237\u767b\u5f55\u7cfb\u7edf\u3002\u5982\u679c\u4f60\u5220\u9664\u4e86\u8be5\u6587\u4ef6\uff0c\u90a3\u4e48\u975e\u7279\u6743\u7528\u6237\u5c06\u80fd\u591f\u767b\u5f55\u7cfb\u7edf\u3002</li> <li> \u5b89\u5168\u6027\u964d\u4f4e\uff1a/run/nologin \u6587\u4ef6\u7684\u76ee\u7684\u662f\u5728\u7cfb\u7edf\u7ef4\u62a4\u671f\u95f4\u9632\u6b62\u975e\u7279\u6743\u7528\u6237\u767b\u5f55\uff0c\u4ee5\u786e\u4fdd\u7cfb\u7edf\u5b89\u5168\u3002\u5982\u679c\u4f60\u5220\u9664\u4e86\u8be5\u6587\u4ef6\uff0c\u7cfb\u7edf\u53ef\u80fd\u4f1a\u66f4\u5bb9\u6613\u53d7\u5230\u672a\u7ecf\u6388\u6743\u7684\u8bbf\u95ee\u3002</li> </ul>"},{"location":"blog/2023/07/04/See%20pam_nologin%288%29/#2","title":"2\u3001\u4e3a\u5565\u4f1a\u51fa\u73b0\u8fd9\u4e2a\u95ee\u9898","text":"<ul> <li> <p> \u6211\u770b\u8fd9\u4e2a\u6587\u4ef6\u7684\u521b\u5efa\u65f6\u95f4\u662f\u57285\u670830\u53f7\uff0c\u7136\u540e\u6211\u60f3\u52305\u670830\u65e5\u6211\u5e72\u4e86\u4e00\u4ef6\u4e8b\u60c5\uff0c\u6211\u6539\u4e86 /usr/lib/tmpfiles.d/tmp.conf \uff0c\u6709\u4e2a\u6240\u8c13\u7684\u67b6\u6784\u5e08\u5728\u7ebf\u4e0a\u53d1\u5e03\u4e86\u4e00\u4e2a\u5e94\u7528\uff0c\u5c06pid\u653e\u5728\u4e86/tmp \u4e0b\u9762\uff0c\u7136\u540e\u8ddf\u6211\u8bf4\u7ebf\u4e0a\u5e94\u7528\u53d1\u5e03\u5931\u8d25\u4e86\uff0c\u4e0d\u6210\u529f\u3002\u6211\u4e00\u67e5\u53d1\u73b0pid\u8fdb\u7a0b\u6587\u4ef6\u7684\u5185\u5bb9\u6539\u4e86\uff0cpid\u5bf9\u4e0d\u4e0a\uff0c\u6700\u540e\u67e5\u51fa\u6765\u662f\u56e0\u4e3a/tmp \u81ea\u52a8\u6e05\u4e86pid\u6587\u4ef6\u3002\u7136\u540e\u6211\u5c31\u60f3\u5ffd\u7565\u6389\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\u3002</p> </li> <li> <p> \u4f46\u662f\u6539\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u8fd8\u9700\u8981\u91cd\u542f systemd-tmpfiles-setup.service\uff0c\u7ed3\u679c\u53d1\u73b0\u8fd9\u4e2a\u670d\u52a1\u4e0d\u7ed9\u91cd\u542f\uff0c\u8fd8\u5f97\u53bb\u4fee\u6539/usr/lib/systemd/system/systemd-tmpfiles-setup.service \u7684RefuseManualStop=yes\uff0c\u4e00\u987f\u64cd\u4f5c\u540e\u5c31\u597d\u4e86\uff0c/tmp\u4e0b\u9762\u6392\u9664\u7684\u6587\u4ef6\u5230\u73b0\u5728\u90fd\u6ca1\u6709\u5220\u9664\u3002\u76f4\u81f3\u6628\u665a\u90fd\u6ca1\u6709\u4ec0\u4e48\u95ee\u9898\u3002</p> </li> <li> <p> \u6700\u540e\u786e\u5b9a\u5c31\u662f\u7531 \u91cd\u542f systemd-tmpfiles-setup.service\u5bfc\u81f4\u7684\u3002</p> </li> </ul>"},{"location":"blog/2023/07/04/See%20pam_nologin%288%29/#_2","title":"\u603b\u7ed3","text":"<p>\u5728Systemd\u4e2d\uff0csystemd-tmpfiles-setup.service\u662f\u8d1f\u8d23\u5728\u7cfb\u7edf\u5f15\u5bfc\u8fc7\u7a0b\u4e2d\u521b\u5efa\u4e34\u65f6\u6587\u4ef6\u548c\u76ee\u5f55\u7684\u670d\u52a1\u3002\u800c\u521b\u5efa/run/nologin\u6587\u4ef6\u7684\u76ee\u7684\u662f\u4e3a\u4e86\u9632\u6b62\u7528\u6237\u767b\u5f55\u7cfb\u7edf\u3002</p> <p>\u5f53\u7cfb\u7edf\u5904\u4e8e\u7ef4\u62a4\u6a21\u5f0f\u6216\u9700\u8981\u7981\u6b62\u7528\u6237\u767b\u5f55\u65f6\uff0c\u7ba1\u7406\u5458\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a/run/nologin\u7684\u6587\u4ef6\u3002\u5982\u679c\u8be5\u6587\u4ef6\u5b58\u5728\uff0c\u7528\u6237\u8bd5\u56fe\u767b\u5f55\u7cfb\u7edf\u65f6\u5c06\u6536\u5230\u4e00\u4e2a\u62d2\u7edd\u767b\u5f55\u7684\u6d88\u606f\uff0c\u5e76\u4e14\u767b\u5f55\u8bf7\u6c42\u4f1a\u88ab\u62d2\u7edd\u3002</p> <p>\u91cd\u542fsystemd-tmpfiles-setup.service\u670d\u52a1\u53ef\u80fd\u4f1a\u91cd\u65b0\u751f\u6210\u4e34\u65f6\u6587\u4ef6\u548c\u76ee\u5f55\uff0c\u5e76\u4e14\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u4e5f\u4f1a\u91cd\u65b0\u521b\u5efa/run/nologin\u6587\u4ef6\u3002\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u786e\u4fdd\u5728\u7cfb\u7edf\u5f15\u5bfc\u671f\u95f4\u59cb\u7ec8\u5b58\u5728\u8fd9\u4e2a\u963b\u6b62\u7528\u6237\u767b\u5f55\u7684\u6807\u5fd7\u6587\u4ef6\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u5bf9/run/nologin\u6587\u4ef6\u7684\u5177\u4f53\u4f7f\u7528\u53ef\u80fd\u56e0\u64cd\u4f5c\u7cfb\u7edf\u7248\u672c\u548c\u914d\u7f6e\u800c\u6709\u6240\u4e0d\u540c\u3002</p>"},{"location":"blog/2023/07/04/See%20pam_nologin%288%29/#_3","title":"\u53c2\u8003","text":"<p>\u53ef\u4ee5\u53c2\u8003\uff0c\u522b\u4eba\u9047\u5230\u7c7b\u4f3c\u7684\u95ee\u9898\uff0c\u4f46\u662f\u4e0d\u591a\uff1a</p> <p>https://bbs.archlinux.org/viewtopic.php?id=155281  https://bugzilla.redhat.com/show_bug.cgi?id=1507501</p>"},{"location":"blog/2024/01/16/crontab%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/","title":"crontab\u73af\u5883\u53d8\u91cf","text":"<p>crontab\u73af\u5883\u53d8\u91cf.</p>","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2024/01/16/crontab%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/#1fstab","title":"1\u3001\u5927\u81f4\u529f\u80fd\u5c31\u662f\u627e\u51fa\u672a\u5728fstab\u4e2d\u6302\u8f7d\u7684\u78c1\u76d8\uff0c\u5e76\u53d1\u9001\u5230\u4e91\u5e73\u53f0\u544a\u8b66\u3002","text":"<pre><code>#!/bin/bash\nsource /etc/profile\n\nremote_address=\"http://1.1.1.1:6666\"\nuser=xxxx\npass=xxxx\n\nexcept_block=(\"/dev/sr0\" \"/dev/cdrom\" \"/dev/dvd\")\n\nblkid_output=$(blkid -s UUID)\nall_block=()\n\n\ncheck_useless() {\n  target=$1\n  found=0\n  for item in \"${except_block[@]}\"; do\n      if [ \"$item\" == \"$target\" ]; then\n          found=1\n          break\n      fi\n  done\n  echo $found\n}\n\ncheck_block_in_fstab(){\n  uuid=$1\n  device=$2\n  uuid_wc=`grep $uuid /etc/fstab |wc -l`\n  device_wc=`grep $device /etc/fstab|wc -l`\n  appear_counts=$(($uuid_wc + $device_wc))\n  echo $appear_counts\n\n}\n\nmain(){\n   while IFS= read -r line; do\n     uuid=$(echo \"$line\" | awk '{print $2}' | cut -d \"=\" -f2 | sed 's/\"//g')\n     device=$(echo \"$line\" | awk '{print $1}' | sed 's/://g')\n\n     found=`check_useless $device`\n     if [ $found -eq 0 ];then\n        check_res=`check_block_in_fstab $uuid $device`\n        if [ $check_res -ne 1 ];then\n            JWT_TOKEN=`curl -s -X POST -d \"email=${user}&amp;password=${pass}\" \"${remote_address}/jwt/api-token-path/\"|awk -F '[:\"]' '{print $8}'`\n\n            curl \"${remote_address}/receive/ReceiveCustomAlarm/\" \\\n               -X POST \\\n               -H \"Content-Type: application/json\" \\\n               -H \"Authorization: Bearer $JWT_TOKEN\" \\\n               -d \"{\n                     \\\"subject\\\": \\\"\u6709\u78c1\u76d8\u672a\u5728fstab\u4e2d\\\",\n                     \\\"ip\\\": \\\"`hostname -I | cut -d' ' -f1`\\\",\n                     \\\"hostname\\\": \\\"`hostname`\\\",\n                     \\\"source\\\": \\\"\u670d\u52a1\u5668\\\",\n                     \\\"alarm_template_id\\\": 1, \n                     \\\"alarm_content\\\": {\n                       \\\"title\\\": \\\"\u6709\u78c1\u76d8\u672a\u5728fstab\u4e2d\\\",\n                       \\\"msg\\\": \\\"${uuid}-${device}\\\"\n                     }\n                   }\" \n        fi\n     fi\n   done &lt;&lt;&lt; \"$blkid_output\"\n}\n</code></pre>","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2024/01/16/crontab%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/#2","title":"2\u3001\u672c\u8eab\u8fd9\u4e2a\u4e1c\u897f\u6ca1\u5565\u6709\u8da3\u7684\uff0c\u4f46\u662f\u53d1\u73b0\u73af\u5883\u53d8\u91cf\u4e0d\u4e00\u6837\uff0c\u6bcf\u6b21\u90fd\u80fd\u5728\u73af\u5883\u53d8\u91cf\u4e0a\u51fa\u95ee\u9898\uff0c\u4f46\u662f\u6bcf\u6b21\u89e3\u51b3\u7684\u65b9\u5f0f\u4e5f\u4e0d\u4e00\u6837\uff0c\u6211\u5c31\u8bb0\u5f55\u4e00\u4e0b\u8fd9\u6b21\u7684\u5904\u7406\u65b9\u5f0f\uff0c\u4f9b\u5c0f\u4f19\u4f34\u7684\u89e3\u5fe7\u3002","text":"","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2024/01/16/crontab%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/#21blkid","title":"2.1\u3001\u56e0\u4e3a\u811a\u672c\u7528\u5230\u4e86blkid\u8fd9\u4e2a\u547d\u4ee4","text":"<pre><code>blkid: /usr/sbin/blkid /usr/share/man/man8/blkid.8.gz\n</code></pre>","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2024/01/16/crontab%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/#22crontab","title":"2.2\u3001\u6211\u770bcrontab\u6587\u4ef6\u7684\u5185\u5bb9\uff0c\u4ee5\u4e3a\u4e0d\u4f1a\u6709\u4ec0\u4e48\u95ee\u9898\uff0c\u6bd5\u7adf\u624b\u52a8\u6267\u884c\u6ca1\u6709\u95ee\u9898","text":"<pre><code>cat /etc/crontab \nSHELL=/bin/bash\nPATH=/sbin:/bin:/usr/sbin:/usr/bin\nMAILTO=root\n\n# For details see man 4 crontabs\n\n# Example of job definition:\n# .---------------- minute (0 - 59)\n# |  .------------- hour (0 - 23)\n# |  |  .---------- day of month (1 - 31)\n# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...\n# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat\n# |  |  |  |  |\n# *  *  *  *  * user-name  command to be executed\n</code></pre>","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2024/01/16/crontab%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/#23crontabcrontab","title":"2.3\u3001\u7136\u540e\u653e\u5230crontab\u4e4b\u540e\uff0c\u53d1\u73b0\u547d\u4ee4\u6ca1\u6709\u6267\u884c\uff0c\u5728crontab\u4e2d\u7684\u73af\u5883\u53d8\u91cf\u662f","text":"<pre><code>/usr/bin:/bin\n</code></pre>","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2024/01/16/crontab%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/#24","title":"2.4\u3001\u6240\u4ee5\u9700\u8981\u7684\u547d\u4ee4\u4e0d\u5728\u73af\u5883\u53d8\u91cf\u4e2d\uff0c\u89e3\u51b3\u65b9\u5f0f","text":"","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2024/01/16/crontab%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/#241","title":"2.4.1\u3001\u4f7f\u7528\u5168\u8def\u5f84","text":"","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2024/01/16/crontab%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/#242etcprofileetcprofile","title":"2.4.2\u3001\u5f15\u5165/etc/profile\uff0c\u52a0\u8f7d/etc/profile \u6587\u4ef6\u4e2d\u7684\u73af\u5883\u53d8\u91cf","text":"","tags":["crontab","\u73af\u5883\u53d8\u91cf"]},{"location":"blog/2023/02/23/supervisor%E5%90%AF%E5%8A%A8%E4%BA%A7%E7%94%9F%E5%A4%9A%E4%B8%AA%E8%BF%9B%E7%A8%8B/","title":"supervisor\u542f\u52a8\u4ea7\u751f\u591a\u4e2a\u8fdb\u7a0b","text":"<p>\u7fcc\u65e5\u7ebf\u4e0aes\u9891\u7e41\u62a5\u8b66\uff0c\u8bf4\u67d0\u4e00\u65f6\u95f4\u6bb5\u8bf7\u6c42\u6570\u91cf\u4e0e\u524d\u51e0\u65e5\u76f8\u6bd4\u6709\u4e0a\u5347\uff0c\u9042\u53bb\u670d\u52a1\u5668\u4e0a\u67e5\u770b\u8bf7\u6c42\uff0c\u53d1\u73b0\u5e76\u6ca1\u6709\u4ec0\u4e48\u7279\u522b\u5927\u7684\u91cf\uff0c\u7136\u540e\u5bf9\u6bd4\u5165\u53e3\u7f51\u5173\u7684\u8bf7\u6c42\u65e5\u5fd7\uff0c\u4e00\u4e2areques id \u51fa\u73b0\u4e863\u6b21\uff0c\u5982\u6b64\u6709\u8da3\u7684\u4e8b\u60c5\u5fc5\u63a2\u67e5\u4e00\u756a\u3002</p> <p>\u53d1\u73b0\u4e00\u53f0\u673a\u5668\u4e0a\u7684filebeat\u542f\u52a8\u4e863\u4e2a\u8fdb\u7a0b\u3002\u3002\u3002\u5bfc\u81f4\u4e00\u6761\u65e5\u5fd7\u4e0a\u4f20\u4e863\u6b21\u3002filebeat\u662f\u901a\u8fc7supervisor\u6765\u8fdb\u884c\u7ba1\u7406\uff0c\u7406\u8bba\u4e0a\u4e0d\u4f1a\u6709\u95ee\u9898\u3002</p>","tags":["filebeat","supervisor"]},{"location":"blog/2023/02/23/supervisor%E5%90%AF%E5%8A%A8%E4%BA%A7%E7%94%9F%E5%A4%9A%E4%B8%AA%E8%BF%9B%E7%A8%8B/#1","title":"1\u3001\u6709\u95ee\u9898\u7684\u914d\u7f6e","text":"<p>\u901a\u8fc7supervisor\u4f5c\u4e3a\u5b88\u62a4\u8fdb\u7a0b\u63a7\u5236filebeat <pre><code>filebeat.ini\n[program:filebeatstart]\ncommand=sh /etc/supervisord.d/startfilebeat.sh\nprocess_name=filebeatstart\nredirect_stderr=true\nstdout_logfile=/tmp/filebeatstart.log\nstdout_logfile_maxbytes=50MB\nstdout_logfile_backups=3\nautorestart=true\nstartsecs=3\nstartretries=3\n\nstartfilebeat.sh\n#!/bin/bash\n/opt/soft/filebeat-7.5.1-linux-x86_64/filebeat -c /opt/soft/filebeat-7.5.1-linux-x86_64/filebeat.yml\n</code></pre> \u4e0a\u9762\u7684supervisor\u914d\u7f6e\u66f4\u65b0\u4e4b\u540e\uff0c\u6ca1\u6709\u5c06\u539f\u5148\u7684\u8fdb\u7a0b\u6740\u6389\u7684\uff0c\u6240\u4ee5\u4f1a\u5bfc\u81f4\u8fdb\u7a0b\u4e0d\u65ad\u589e\u52a0\u3002 \u8fd9\u4e2a\u5730\u65b9\u6ca1\u6709\u8fc7\u591a\u6d4b\u8bd5\uff0c\u611f\u5174\u8da3\u7684\u53ef\u4ee5\u591a\u8bd5\u8bd5\u3002</p> <p>startfilebeat.sh\u4f5c\u4e3a\u7236\u8fdb\u7a0b\u5e76\u6ca1\u6709\u6740\u6b7b\u5b9e\u9645\u7684\u8fdb\u7a0b\u3002</p>","tags":["filebeat","supervisor"]},{"location":"blog/2023/02/23/supervisor%E5%90%AF%E5%8A%A8%E4%BA%A7%E7%94%9F%E5%A4%9A%E4%B8%AA%E8%BF%9B%E7%A8%8B/#2","title":"2\u3001\u6b63\u786e\u7684\u914d\u7f6e","text":"<pre><code>filebeat.ini\n[program:filebeatstart]\ncommand=/opt/soft/filebeat-7.5.1-linux-x86_64/filebeat -c /opt/soft/filebeat-7.5.1-linux-x86_64/filebeat.yml\nprocess_name=filebeatstart\nredirect_stderr=true\nstdout_logfile=/tmp/filebeatstart.log\nstdout_logfile_maxbytes=50MB\nstdout_logfile_backups=3\nautorestart=true\nstartsecs=3\nstartretries=3\n</code></pre>","tags":["filebeat","supervisor"]},{"location":"blog/2023/02/23/supervisor%E5%90%AF%E5%8A%A8%E4%BA%A7%E7%94%9F%E5%A4%9A%E4%B8%AA%E8%BF%9B%E7%A8%8B/#3","title":"3\u3001\u7ea0\u9519\u64cd\u4f5c","text":"<pre><code>#\u5148\u505csupervisor\uff0c\u8981\u4e0d\u7136\u5e72\u6389\u8fd8\u4f1a\u542f\u52a8\nansible web_server -m shell -a \"supervisorctl stop filebeatstart\"\n\n#\u5e72\u6389\u6240\u6709\u591a\u4f59\u7684filebeat\u8fdb\u7a0b\nansible web_server -m shell -a \"ps -ef|grep filebeat|grep -v grep|awk '{print \\$2}'|xargs -i kill -9 {}\"\n\n#\u66f4\u65b0\u914d\u7f6e\nansible web_server -m shell -a \"supervisorctl update\"\n\n#\u542f\u52a8\nansible web_server -m shell -a \"supervisorctl start filebeatstart\"\n</code></pre>","tags":["filebeat","supervisor"]},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/","title":"\u6d41\u7545\u7684python","text":"<p>\u770b\u4e66\u65f6\u89c9\u5f97\u9700\u8981\u7684\u5c31\u8bb0\u5f55\u4e86\u4e0b\u6765\u3002</p>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#1","title":"1\u3001\u6570\u636e\u6a21\u578b","text":""},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#11","title":"1.1\u3001\u5c55\u793a\u9b54\u672f\u65b9\u6cd5","text":"<pre><code>1\u3001\u672c\u4f8b\u529f\u80fd\uff1a\u901a\u8fc7\u4f8b\u5b50\u5c55\u793a__getitem__\u548c__len__\u4e24\u4e2a\u7279\u6b8a\u65b9\u6cd5\u3002\n\n\n2\u3001\u672c\u4f8b\u4ee3\u7801\nimport collections\n\nCard = collections.namedtuple('Card', ['rank', 'suit'])\n\nclass FrenchDeck:\n    ranks = [str(n) for n in range(2, 11)] + list('JQKA')\n    suits = 'spades diamonds clubs hearts'.split()\n\n    def __init__(self):\n        self._cards = [Card(rank, suit) for suit in self.suits\n                       for rank in self.ranks]\n\n    def __len__(self):\n        return len(self._cards)\n\n    def __getitem__(self, position):\n        return self._cards[position]\n\n\n\n\n3\u3001\u672c\u4f8b\u6269\u5c55\nnamedtupele \u7528\u4e8e\u6784\u5efa\u53ea\u6709\u5c11\u6570\u5c5e\u6027\u4f46\u662f\u6ca1\u6709\u65b9\u6cd5\u7684\u5bf9\u8c61\uff0c\u6bd4\u5982\u6570\u636e\u5e93\u6761\u76ee\n\nPython\u5143\u7ec4\u7684\u5347\u7ea7\u7248\u672c -- namedtuple(\u5177\u540d\u5143\u7ec4)\n\u56e0\u4e3a\u5143\u7ec4\u7684\u5c40\u9650\u6027\uff1a\u4e0d\u80fd\u4e3a\u5143\u7ec4\u5185\u90e8\u7684\u6570\u636e\u8fdb\u884c\u547d\u540d\uff0c\u6240\u4ee5\u5f80\u5f80\u6211\u4eec\u5e76\u4e0d\u77e5\u9053\u4e00\u4e2a\u5143\u7ec4\u6240\u8981\u8868\u8fbe\u7684\u610f\u4e49\uff0c\u6240\u4ee5\u5728\u8fd9\u91cc\u5f15\u5165\u4e86 collections.namedtuple \u8fd9\u4e2a\u5de5\u5382\u51fd\u6570\uff0c\u6765\u6784\u9020\u4e00\u4e2a\u5e26\u5b57\u6bb5\u540d\u7684\u5143\u7ec4\u3002\u5177\u540d\u5143\u7ec4\u7684\u5b9e\u4f8b\u548c\u666e\u901a\u5143\u7ec4\u6d88\u8017\u7684\u5185\u5b58\u4e00\u6837\u591a\uff0c\u56e0\u4e3a\u5b57\u6bb5\u540d\u90fd\u88ab\u5b58\u5728\u5bf9\u5e94\u7684\u7c7b\u91cc\u9762\u3002\u8fd9\u4e2a\u7c7b\u8ddf\u666e\u901a\u7684\u5bf9\u8c61\u5b9e\u4f8b\u6bd4\u8d77\u6765\u4e5f\u8981\u5c0f\u4e00\u4e9b\uff0c\u56e0\u4e3a Python \u4e0d\u4f1a\u7528 __dict__ \u6765\u5b58\u653e\u8fd9\u4e9b\u5b9e\u4f8b\u7684\u5c5e\u6027\u3002\n\nnamedtuple \u5bf9\u8c61\u7684\u5b9a\u4e49\u5982\u4ee5\u4e0b\u683c\u5f0f\uff1a\ncollections.namedtuple(typename, field_names, verbose=False, rename=False) \n\n\n\n4\u3001\u53c2\u8003\nhttps://www.runoob.com/note/25726\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#12","title":"1.2\u3001\u7b80\u5355\u4e8c\u7ef4\u5411\u91cf","text":"<pre><code>1\u3001\u672c\u4f8b\u529f\u80fd\n  \u4e00\u4e2a\u7b80\u5355\u7684\u4e8c\u7ef4\u5411\u91cf\u7684\u7c7b\n\n2\u3001\u4ee3\u7801  \nfrom math import hypot\n\nclass Vector:\n\n    def __init__(self, x=0, y=0):\n        self.x = x\n        self.y = y\n\n    def __repr__(self):\n        return 'Vector(%r, %r)' % (self.x, self.y)\n\n    def __abs__(self):\n        return hypot(self.x, self.y)\n\n    def __bool__(self):\n        return bool(abs(self))\n\n    def __add__(self, other):\n        x = self.x + other.x\n        y = self.y + other.y\n        return Vector(x, y)\n\n    def __mul__(self, scalar):\n        return Vector(self.x * scalar, self.y * scalar)\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#2","title":"2\u3001\u6570\u636e\u7ed3\u6784","text":""},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#21","title":"2.1\u3001\u5185\u7f6e\u5e8f\u5217\u7c7b\u578b","text":"<pre><code>\u5bb9\u5668\u5e8f\u5217\n    list\u3001 tuple \u548ccollections.deque \u8fd9\u4e9b\u5e8f\u5217\u5b58\u653e\u4e0d\u540c\u7c7b\u578b\u7684\u6570\u636e\n\u6241\u5e73\u5e8f\u5217\n    str\u3001bytes\u3001bytearry\u3001memoryview \u548carray.array \u8fd9\u7c7b\u5e8f\u5217\u53ea\u80fd\u5bb9\u7eb3\u4e00\u79cd\u7c7b\u578b\n\n\u53ef\u53d8\u5e8f\u5217\n    list bytearray array.array collections.deque \u548c memoryview\n\n\u4e0d\u53ef\u53d8\u5e8f\u5217\n    tuple  str   bytes\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#22","title":"2.2\u3001\u5217\u8868\u63a8\u5bfc\u548c\u751f\u6210\u5668\u8868\u8fbe\u5f0f","text":"<pre><code>1\u3001\u5217\u8868\u63a8\u5bfc\u662f\u6784\u5efa\u5217\u8868\u7684\u5feb\u6377\u65b9\u5f0f\uff0c\u800c\u751f\u6210\u5668\u8868\u8fbe\u5f0f\u5219\u53ef\u4ee5\u7528\u6765\u521b\u5efa\u5176\u4ed6\u4efb\u4f55\u7c7b\u578b\u7684\u5e8f\u5217\n\n2\u3001\u867d\u7136\u4e5f\u53ef\u4ee5\u7528\u5217\u8868\u63a8\u5bfc\u6765\u521d\u59cb\u5316\u5143\u7ec4\u3001\u6570\u7ec4\u6216\u5176\u4ed6\u5e8f\u5217\u7c7b\u578b\uff0c\u4f46\u662f\u751f\u6210\u5668\u8868\u8fbe\u5f0f\u662f\u66f4\u597d\u7684\u9009\u62e9\u3002\u8fd9\u662f\u56e0\u4e3a\u751f\u6210\u5668\u8868\u8fbe\u5f0f\u80cc\u540e\u9075\u5b88\u4e86\u8fed\u4ee3\u5668\u534f\u8bae\uff0c\u53ef\u4ee5\u9010\u4e2a\u4ea7\u51fa\u5143\u7d20\uff0c\u800c\u4e0d\u662f\u5148\u5efa\u7acb\u4e00\u4e2a\u5b8c\u6574\u7684\u5217\u8868\uff0c\u7136\u540e\u518d\u628a\u8fd9\u4e2a\u5217\u8868\u4f20\u9012\u5230\u67d0\u4e2a\u6784\u9020\u51fd\u6570\u91cc\u9762\u3002\n\n3\u3001\u751f\u6210\u5668\u8868\u8fbe\u5f0f\u7684\u8bed\u6cd5\u8ddf\u63a8\u5bfc\u5f0f\u5dee\u4e0d\u591a\uff0c\u53ea\u4e0d\u8fc7\u628a\u65b9\u62ec\u53f7\u6362\u6210\u5706\u62ec\u53f7\u800c\u5df2\u3002\n\n\n4\u3001\u6bd4\u8f83\u4ee3\u7801\nimport timeit\n\nTIMES = 10000\n\nSETUP = \"\"\"\nsymbols = '$\u00a2\u00a3\u00a5\u20ac\u00a4'\ndef non_ascii(c):\n    return c &gt; 127\n\"\"\"\n\ndef clock(label, cmd):\n    res = timeit.repeat(cmd, setup=SETUP, number=TIMES)\n    print(label, *('{:.3f}'.format(x) for x in res))\n\nclock('listcomp        :', '[ord(s) for s in symbols if ord(s) &gt; 127]')\nclock('listcomp + func :', '[ord(s) for s in symbols if non_ascii(ord(s))]')\nclock('filter + lambda :', 'list(filter(lambda c: c &gt; 127, map(ord, symbols)))')\nclock('filter + func   :', 'list(filter(non_ascii, map(ord, symbols)))')\n\n\n5\u3001\u6269\u5c55\ntimeit\n\u6d4b\u91cf\u5c0f\u4ee3\u7801\u7247\u6bb5\u7684\u6267\u884c\u65f6\u95f4\nhttps://docs.python.org/zh-cn/3/library/timeit.html\n\n\n6\u3001\u7528\u751f\u6210\u5668\u8868\u8fbe\u5f0f\u521d\u59cb\u5316\u5143\u7ec4\u548c\u6570\u7ec4\nsymbols = '$\u00a2\u00a3\u00a5\u20ac\u00a4'\ntuple(ord(symbol) for symbol in symbols)\n(36, 162, 163, 165, 8364, 164)\n\n(ord(symbol) for symbol in symbols)\n&lt;generator object &lt;genexpr&gt; at 0x7fe8bb4d4570&gt;\n\narray.array('I', (ord(symbol) for symbol in symbols))\n\n1\uff09\u5982\u679c\u751f\u6210\u5668\u8868\u8fbe\u5f0f\u662f\u4e00\u4e2a\u51fd\u6570\u8c03\u7528\u8fc7\u7a0b\u4e2d\u552f\u4e00\u53c2\u6570\uff0c\u90a3\u4e48\u4e0d\u9700\u8981\u989d\u5916\u518d\u7528\u62ec\u53f7\u628a\u5b83\u56f4\u8d77\u6765\n2\uff09array\u7684\u6784\u9020\u65b9\u6cd5\u9700\u8981\u4e24\u4e2a\u53c2\u6570\uff0c\u56e0\u6b64\u62ec\u53f7\u662f\u5fc5\u987b\u7684\uff0carray\u6784\u9020\u65b9\u6cd5\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u5236\u5b9a\u4e86\u6570\u7ec4\u4e2d\u6570\u5b57\u7684\u5b58\u50a8\u65b9\u5f0f\u3002\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#23","title":"2.3\u3001\u5143\u7ec4\u548c\u8bb0\u5f55","text":"<pre><code>\u5143\u7ec4\u5176\u5b9e\u662f\u5bf9\u6570\u636e\u7684\u8bb0\u5f55\uff1a\u5143\u7ec4\u4e2d\u6bcf\u4e2a\u5143\u7d20\u90fd\u5b58\u653e\u4e86\u8bb0\u5f55\u4e2d\u7684\u4e00\u4e2a\u5b57\u6bb5\u7684\u6570\u636e\uff0c\u5916\u52a0\u8fd9\u4e2a\u5b57\u6bb5\u7684\u4f4d\u7f6e\u3002\u6b63\u662f\u8fd9\u4e2a\u4f4d\u7f6e\u4fe1\u606f\u7ed9\u6570\u636e\u8d4b\u4e88\u4e86\u610f\u4e49\u3002\n\n\u5982\u679c\u53ea\u662f\u628a\u5143\u7ec4\u7406\u89e3\u6210\u4e0d\u53ef\u53d8\u7684\u5217\u8868\uff0c\u90a3\u5b83\u6240\u5305\u542b\u7684\u5143\u7d20\u7684\u603b\u6570\u548c\u4ed6\u4eec\u7684\u4f4d\u7f6e\u4f3c\u4e4e\u5c31\u53d8\u5f97\u53ef\u6709\u53ef\u65e0\u4e86\u3002\n\n\n2.3.3\u5d4c\u5957\u5143\u7ec4\u62c6\u5305\n\n\u4ee3\u7801\nmetro_areas = [\n    ('Tokyo', 'JP', 36.933, (35.689722, 139.691667)),   # &lt;1&gt;\n    ('Delhi NCR', 'IN', 21.935, (28.613889, 77.208889)),\n    ('Mexico City', 'MX', 20.142, (19.433333, -99.133333)),\n    ('New York-Newark', 'US', 20.104, (40.808611, -74.020386)),\n    ('Sao Paulo', 'BR', 19.649, (-23.547778, -46.635833)),\n]\n\nprint('{:15} | {:^9} | {:^9}'.format('', 'lat.', 'long.'))\nfmt = '{:15} | {:9.4f} | {:9.4f}'\nfor name, cc, pop, (latitude, longitude) in metro_areas:  # &lt;2&gt;\n    if longitude &lt;= 0:  # &lt;3&gt;\n        print(fmt.format(name, latitude, longitude))\n\n\n2.3.4 \u5177\u540d\u5143\u7ec4\ncollections.namedtuple\u662f\u4e00\u4e2a\u5de5\u5382\u51fd\u6570\uff0c\u5b83\u53ef\u4ee5\u7528\u6765\u6784\u5efa\u4e00\u4e2a\u5e26\u5b57\u6bb5\u540d\u7684\u5143\u7ec4\u548c\u4e00\u4e2a\u6709\u540d\u5b57\u7684\u7c7b\u3002\n\n\u7528namedtuple\u6784\u5efa\u7684\u7c7b\u7684\u793a\u4f8b\u6240\u6d88\u8017\u7684\u5185\u5b58\u8ddf\u5143\u7ec4\u662f\u4e00\u6837\u7684\uff0c\u56e0\u4e3a\u5b57\u6bb5\u540d\u90fd\u88ab\u5b58\u5728\u5bf9\u5e94\u7684\u7c7b\u91cc\u9762\u3002\u8fd9\u4e2a\u5b9e\u4f8b\u8ddf\u666e\u901a\u7684\u5bf9\u8c61\u5b9e\u4f8b\u6bd4\u4f1a\u5c0f\u4e00\u70b9\uff0c\u56e0\u4e3apython\u4e0d\u4f1a\u7528__dict__\u6765\u5b58\u653e\u8fd9\u4e9b\u5b9e\u4f8b\u7684\u5c5e\u6027\u3002\n\n\u4ee3\u7801\u53ef\u4ee5\u53c2\u80031.1\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#24","title":"2.4\u3001\u5207\u7247","text":"<pre><code>\u5207\u7247\n\nlist tuple \u5b57\u7b26\u4e32\u8fd9\u7c7b\u5e8f\u5217\u7c7b\u578b\u90fd\u652f\u6301\u5207\u7247\n\n\u8bd5\u70bc\nl = [10,20,30,40,50,60]\n\nl[:3]\n[10, 20, 30]\nl[3:]\n[40, 50, 60]\n\n2.4.2 \u5bf9\u8c61\u5207\u7247\n\ns='bicycle'\ns[::3]\n'bye'\ns[::1]\n'bicycle'\ns[::-1]\n'elcycib'\n\n\n2.4.4 \u7ed9\u5207\u7247\u8d4b\u503c\nl=list(range(10))\nl\n[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]\nl[2:5]\n[2, 3, 4]\nl[2:5]=[20,30]\nl\n[0, 1, 20, 30, 5, 6, 7, 8, 9]\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#25","title":"2.5\u3001\u5e8f\u5217","text":"<pre><code>\u5e8f\u5217\n\n\n2.5 \u5bf9\u5e8f\u5217\u4f7f\u7528*\u548c+\nl=[1,2,3]\nl*5\n[1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3]\n\n*\u548c+\u90fd\u9075\u5faa\u8fd9\u4e2a\u89c4\u5f8b\uff0c\u4e0d\u4fee\u6539\u539f\u6709\u7684\u64cd\u4f5c\u5bf9\u8c61\uff0c\u800c\u662f\u6784\u5efa\u4e00\u4e2a\u5168\u65b0\u7684\u5e8f\u5217\n\n\n2.6 \u5e8f\u5217\u7684\u589e\u91cf\u8d4b\u503c\n\u589e\u91cf\u8d4b\u503c\u8fd0\u7b97\u7b26+=\u548c*=\u7684\u8868\u73b0\u53d6\u51b3\u4e8e\u4ed6\u4eec\u7684\u7b2c\u4e00\u4e2a\u64cd\u4f5c\u5bf9\u8c61\n\n+= \u80cc\u540e\u7684\u7279\u6b8a\u65b9\u6cd5\u662f__iadd__\uff08\u5c31\u5730\u52a0\u6cd5\uff09\uff0c\u540c\u65f6\u5bf9\u53ef\u53d8\u5e8f\u5217\uff08list bytearray array.array\uff09\u6765\u8bf4\uff0c\u5c31\u4f1a\u5c31\u5730\u6539\u52a8\uff0c\u5c31\u50cf\u8c03\u7528\u4e86a.extend(b)\u3002\n\u4f46\u662f\u5982\u679c\u6ca1\u6709\u5b9e\u73b0__iadd__\uff0c a+=b\u8fd9\u4e2a\u8868\u8fbe\u5f0f\u5c31\u4f1a\u53d8\u6210a=a+b\u3002\n\n\n2.7 list.sort \u548c\u5185\u7f6e\u7684\u51fd\u6570sorted\nlist.sort\u65b9\u6cd5\u4f1a\u5c31\u5730\u6392\u5e8f\u5217\u8868\uff0c\u4e00\u822c\u5c31\u5730\u6392\u5e8f\u7684\u8fd4\u56de\u7684\u5c31\u662fnone\n\nsorted \u4f1a\u65b0\u5efa\u4e00\u4e2a\u5217\u8868\u4f5c\u4e3a\u8fd4\u56de\u503c\uff0c\u53ef\u4ee5\u63a5\u53d7\u4efb\u4f55\u5f62\u5f0f\u7684\u53ef\u8fed\u4ee3\u5bf9\u8c61\u4f5c\u4e3a\u53c2\u6570\uff0c\u751a\u81f3\u5305\u62ec\u4e0d\u53ef\u53d8\u5e8f\u5217\u6216\u751f\u6210\u5668\u3002\n\n\n\n2.8 \u7528bisect\u6765\u7ba1\u7406\u5df2\u6392\u5e8f\u7684\u961f\u5217\nbisect\u6a21\u5757\u5305\u542b\u4e24\u4e2a\u4e3b\u8981\u51fd\u6570\uff0cbisect\u548cinsort\uff0c\u4e24\u4e2a\u51fd\u6570\u90fd\u901a\u8fc7\u4e8c\u5206\u67e5\u627e\u7b97\u6cd5\u67e5\u627e\u548c\u63d2\u5165\u51fd\u6570\n\n\n\u4ee3\u7801\u53c2\u8003\nimport bisect\nimport random\n\nSIZE = 7\n\nrandom.seed(1729)\n\nmy_list = []\nfor i in range(SIZE):\n    new_item = random.randrange(SIZE*2)\n    bisect.insort(my_list, new_item)\n    print('%2d -&gt;' % new_item, my_list)\n\n\n=======================================================================\n# BEGIN BISECT_DEMO\nimport bisect\nimport sys\n\nHAYSTACK = [1, 4, 5, 6, 8, 12, 15, 20, 21, 23, 23, 26, 29, 30]\nNEEDLES = [0, 1, 2, 5, 8, 10, 22, 23, 29, 30, 31]\n\nROW_FMT = '{0:2d} @ {1:2d}    {2}{0:&lt;2d}'\n\ndef demo(bisect_fn):\n    for needle in reversed(NEEDLES):\n        position = bisect_fn(HAYSTACK, needle)  # &lt;1&gt;\n        offset = position * '  |'  # &lt;2&gt;\n        print(ROW_FMT.format(needle, position, offset))  # &lt;3&gt;\n\nif __name__ == '__main__':\n\n    if sys.argv[-1] == 'left':    # &lt;4&gt;\n        bisect_fn = bisect.bisect_left\n    else:\n        bisect_fn = bisect.bisect\n\n    print('DEMO:', bisect_fn.__name__)  # &lt;5&gt;\n    print('haystack -&gt;', ' '.join('%2d' % n for n in HAYSTACK))\n    demo(bisect_fn)\n\n# END BISECT_DEMO\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#26","title":"2.6\u3001\u5f53\u5217\u8868\u4e0d\u662f\u9996\u9009\u65f6","text":"<pre><code>\u5f53\u5217\u8868\u4e0d\u662f\u9996\u9009\u65f6\n\n2.9.1 \u6570\u7ec4\n\u5982\u679c\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u53ea\u5305\u542b\u6570\u7ec4\u7684\u5217\u8868\uff0c\u90a3\u4e48array.array\u6bd4list\u66f4\u9ad8\u6548\n\n\n2.9.2 \u5185\u5b58\u89c6\u56fe\nmemoryview\u662f\u4e00\u4e2a\u5185\u7f6e\u7c7b\uff0c\u8ba9\u7528\u6237\u4e0d\u590d\u5236\u5185\u5bb9\u7684\u60c5\u51b5\u4e0b\u64cd\u4f5c\u540c\u4e00\u4e2a\u6570\u7ec4\u7684\u4e0d\u540c\u5207\u7247\u3002\u8fd9\u4e2a\u529f\u80fd\u5728\u5904\u7406\u5927\u578b\u6570\u636e\u96c6\u5408\u7684\u65f6\u5019\u975e\u5e38\u91cd\u8981\u3002\n\n2.9.3 numpy\u548cscipy\n\n2.9.4 \u53cc\u5411\u961f\u5217\u548c\u5176\u4ed6\u5f62\u5f0f\u7684\u961f\u5217\nfrom collections import deque\ndeque(range(10), maxlen=10)\ndeque([0, 1, 2, 3, 4, 5, 6, 7, 8, 9], maxlen=10)\ndq = deque(range(10), maxlen=10)\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#3","title":"3\u3001\u5b57\u5178\u548c\u96c6\u5408","text":""},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#31","title":"3.1\u3001\u6563\u5217\u7684\u5b9a\u4e49","text":"<pre><code>\u6563\u5217\u7684\u5b9a\u4e49\n\n1\u3001\u5b98\u7f51\u6563\u5217\u7684\u5b9a\u4e49\uff1ahttps://docs.python.org/3/glossary.html#term-hashable\n\u5982\u679c\u4e00\u4e2a\u5bf9\u8c61\u5177\u6709\u5728\u5176\u751f\u547d\u5468\u671f\u5185\u6c38\u4e0d\u6539\u53d8\u7684\u54c8\u5e0c\u503c\uff08\u5b83\u9700\u8981\u4e00\u4e2a\u65b9\u6cd5\uff09\uff0c\u5e76\u4e14\u53ef\u4ee5\u4e0e\u5176\u4ed6\u5bf9\u8c61\u8fdb\u884c\u6bd4\u8f83\uff08\u5b83\u9700\u8981\u4e00\u4e2a\u65b9\u6cd5\uff09\uff0c\u5219\u8be5\u5bf9\u8c61\u662f\u53ef\u54c8\u5e0c\u7684\u3002\u6bd4\u8f83\u76f8\u7b49\u7684\u53ef\u6563\u5217\u5bf9\u8c61\u5fc5\u987b\u5177\u6709\u76f8\u540c\u7684\u6563\u5217\u503c\u3002__hash__()__eq__()\n\n\u53ef\u54c8\u5e0c\u6027\u4f7f\u5bf9\u8c61\u53ef\u7528\u4f5c\u5b57\u5178\u952e\u548c\u96c6\u5408\u6210\u5458\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u6570\u636e\u7ed3\u6784\u5728\u5185\u90e8\u4f7f\u7528\u54c8\u5e0c\u503c\u3002\n\nPython \u7684\u5927\u90e8\u5206\u4e0d\u53ef\u53d8\u5185\u7f6e\u5bf9\u8c61\u90fd\u662f\u53ef\u6563\u5217\u7684\uff1b\u53ef\u53d8\u5bb9\u5668\uff08\u4f8b\u5982\u5217\u8868\u6216\u5b57\u5178\uff09\u4e0d\u662f\uff1b\u4e0d\u53ef\u53d8\u5bb9\u5668\uff08\u4f8b\u5982\u5143\u7ec4\u548c\u51bb\u7ed3\u96c6\uff09\u53ea\u6709\u5728\u5176\u5143\u7d20\u53ef\u54c8\u5e0c\u65f6\u624d\u53ef\u54c8\u5e0c\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4f5c\u4e3a\u7528\u6237\u5b9a\u4e49\u7c7b\u5b9e\u4f8b\u7684\u5bf9\u8c61\u662f\u53ef\u6563\u5217\u7684\u3002\u5b83\u4eec\u90fd\u6bd4\u8f83\u4e0d\u76f8\u7b49\uff08\u9664\u4e86\u5b83\u4eec\u81ea\u5df1\uff09\uff0c\u5b83\u4eec\u7684\u54c8\u5e0c\u503c\u6765\u81ea\u5b83\u4eec\u7684id().\n\n\n2\u3001\u4f5c\u8005\u7684\u5b9a\u4e49\n\u539f\u5b50\u4e0d\u53ef\u53d8\u6570\u636e\u7c7b\u578b\uff08str\uff0cbytes\u548c\u6570\u503c\u7c7b\u578b\uff09\u90fd\u662f\u53ef\u6563\u5217\u7c7b\u578b\uff0cfrozenset \u4e5f\u662f\u53ef\u6563\u5217\u7684\u3002\u5143\u7ec4\u53ea\u6709\u5f53\u5305\u542b\u7684\u6240\u6709\u5143\u7d20\u90fd\u662f\u53ef\u6563\u5217\u7684\u60c5\u51b5\u4e0b\uff0c\u4ed6\u624d\u662f\u6563\u5217\u7684\u3002\n\u5982\u679c\u5143\u7ec4\u91cc\u9762\u7684\u5143\u7d20\u662f\u5176\u4ed6\u53ef\u53d8\u7c7b\u578b\u7684\u5f15\u7528\u5c31\u4e0d\u662f\u6563\u5217\u7684\u3002\n\n3\u3001\u5b57\u5178\u63a8\u5bfc\u5f0f\n{a:b for a,b in ab}\n\n4\u3001\u5e38\u89c1\u7684\u6620\u5c04\u65b9\u6cd5\ndict defaultdict OrderedDict\uff0c\u540e\u9762\u4e24\u4e2a\u6570\u636e\u7c7b\u578b\u662fdict\u7684\u53d8\u79cd\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#32setdefault","title":"3.2\u3001\u7528setdefault\u5904\u7406\u627e\u4e0d\u5230\u7684\u952e","text":"<pre><code>\u7528setdefault\u5904\u7406\u627e\u4e0d\u5230\u7684\u952e\n\n\n1\u3001\u6548\u7387\u8f83\u4f4e\u7684\u5904\u7406\u65b9\u5f0f\uff0c\u901a\u8fc7\u5728get\u4e0d\u5230\u7684\u503c\u65f6\u8bbe\u7f6e\u9ed8\u8ba4\u503c\n\u7a0b\u5e8f\u529f\u80fd\uff1a\u4ece\u7d22\u5f15\u4e2d\u83b7\u53d6\u5355\u8bcd\u51fa\u73b0\u7684\u9891\u7387\u4fe1\u606f\uff0c\u5e76\u628a\u5b83\u4eec\u5199\u8fdb\u5bf9\u5e94\u7684\u5217\u8868\u91cc\n\n# adapted from Alex Martelli's example in \"Re-learning Python\"\n# http://www.aleax.it/Python/accu04_Relearn_Python_alex.pdf\n# (slide 41) Ex: lines-by-word file index\n\n# BEGIN INDEX0\n\"\"\"Build an index mapping word -&gt; list of occurrences\"\"\"\n\nimport sys\nimport re\n\nWORD_RE = re.compile('\\w+')\n\nindex = {}\nwith open(sys.argv[1], encoding='utf-8') as fp:\n    for line_no, line in enumerate(fp, 1):\n        for match in WORD_RE.finditer(line):\n            word = match.group()\n            column_no = match.start()+1\n            location = (line_no, column_no)\n            # this is ugly; coded like this to make a point\n            occurrences = index.get(word, [])  # &lt;1&gt;\n            occurrences.append(location)       # &lt;2&gt;\n            index[word] = occurrences          # &lt;3&gt;\n\n# print in alphabetical order\nfor word in sorted(index, key=str.upper):  # &lt;4&gt;\n    print(word, index[word])\n# END INDEX0\n\n2\u3001\u7528setdefault\n# adapted from Alex Martelli's example in \"Re-learning Python\"\n# http://www.aleax.it/Python/accu04_Relearn_Python_alex.pdf\n# (slide 41) Ex: lines-by-word file index\n\n# BEGIN INDEX\n\"\"\"Build an index mapping word -&gt; list of occurrences\"\"\"\n\nimport sys\nimport re\n\nWORD_RE = re.compile('\\w+')\n\nindex = {}\nwith open(sys.argv[1], encoding='utf-8') as fp:\n    for line_no, line in enumerate(fp, 1):\n        for match in WORD_RE.finditer(line):\n            word = match.group()\n            column_no = match.start()+1\n            location = (line_no, column_no)\n            index.setdefault(word, []).append(location)  # &lt;1&gt;\n\n# print in alphabetical order\nfor word in sorted(index, key=str.upper):\n    print(word, index[word])\n# END INDEX\n\n\n3\u3001\u6269\u5c55\nenumerate() \u51fd\u6570\u7528\u4e8e\u5c06\u4e00\u4e2a\u53ef\u904d\u5386\u7684\u6570\u636e\u5bf9\u8c61(\u5982\u5217\u8868\u3001\u5143\u7ec4\u6216\u5b57\u7b26\u4e32)\u7ec4\u5408\u4e3a\u4e00\u4e2a\u7d22\u5f15\u5e8f\u5217\uff0c\u540c\u65f6\u5217\u51fa\u6570\u636e\u548c\u6570\u636e\u4e0b\u6807\uff0c\u4e00\u822c\u7528\u5728 for \u5faa\u73af\u5f53\u4e2d\u3002\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#33","title":"3.3\u3001\u7ed9\u5b57\u5178\u4e2d\u7684\u952e\u8d4b\u4e88\u9ed8\u8ba4\u503c","text":"<pre><code>\u7ed9\u5b57\u5178\u4e2d\u7684\u952e\u8d4b\u4e88\u9ed8\u8ba4\u503c\n1\uff09\u901a\u8fc7defaultdict\u8fd9\u4e2a\u7c7b\u578b\u800c\u4e0d\u662f\u666e\u901a\u7684dict\n    \u5229\u7528defaultdict\u5b9e\u4f8b\u800c\u4e0d\u662fsetdefault\u65b9\u6cd5\n    index = collections.defaultdict(list)\n2\uff09\u81ea\u5df1\u5b9a\u4e49\u4e00\u4e2adict\u7684\u5b50\u7c7b\uff0c\u7136\u540e\u5728\u5b50\u7c7b\u4e2d\u5b9e\u73b0__missing__\u65b9\u6cd5\u3002\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#4-","title":"4\u3001--","text":""},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#5","title":"5\u3001\u4e00\u7b49\u51fd\u6570","text":""},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#51","title":"5.1\u3001\u51fd\u6570\u7684\u4ecb\u7ecd","text":"<pre><code>\u5728python\u4e2d\uff0c\u6240\u6709\u51fd\u6570\u90fd\u662f\u4e00\u7b49\u5bf9\u8c61\n\n\u63a5\u53d7\u51fd\u6570\u4e3a\u53c2\u6570\uff0c\u6216\u8005\u628a\u51fd\u6570\u4f5c\u4e3a\u7ed3\u679c\u8fd4\u56de\u7684\u51fd\u6570\u662f\u9ad8\u9636\u51fd\u6570\n\u6700\u4e3a\u4eba\u719f\u77e5\u7684\u9ad8\u9636\u51fd\u6570\u6709map\uff0cfilter\uff0creduce\u548capply\uff08python3\u4e2d\u4ee5\u79fb\u9664\uff09\n\n\nmap\u3001filter\u548creduce\u7684\u73b0\u4ee3\u66ff\u4ee3\u54c1\n\u5217\u8868\u63a8\u5bfc\u5f0f\u548c\u751f\u6210\u5668\u8868\u8fbe\u5f0f\u5177\u6709map\u548cfilter\u4e24\u4e2a\u51fd\u6570\u7684\u529f\u80fd\u3002\n\n\n\u533f\u540d\u51fd\u6570\nlambda\u5173\u952e\u5b57\u5728python\u8868\u8fbe\u5f0f\u5185\u521b\u5efa\u533f\u540d\u51fd\u6570\n\n\u53ef\u8c03\u7528\u5bf9\u8c61\n\u7528\u6237\u5b9a\u4e49\u7684\u51fd\u6570\n    \u7528def\u8bed\u53e5\u6216lambda\u8868\u8fbe\u5f0f\u521b\u5efa\n\u5185\u7f6e\u51fd\u6570\n    \u4f7f\u7528c\u5b9e\u73b0\u7684\u51fd\u6570\uff0c\u5982\u679clen\u6216time.strftime\n\u5185\u7f6e\u65b9\u6cd5\n    \u4f7f\u7528c\u5b9e\u73b0\u7684\u65b9\u6cd5\uff0c\u5982dict.get\n\u65b9\u6cd5\n    \u5728\u7c7b\u7684\u5b9a\u4e49\u4f53\u4e2d\u5b9a\u4e49\u7684\u51fd\u6570\n\u7c7b\n\n\u7c7b\u7684\u5b9e\u4f8b\n    \u5982\u679c\u7c7b\u5b9a\u4e49\u4e86__call__\u65b9\u6cd5\uff0c\u90a3\u4e48\u5b83\u7684\u5b9e\u4f8b\u53ef\u4ee5\u4f5c\u4e3a\u51fd\u6570\u8c03\u7528\n\u751f\u6210\u5668\u51fd\u6570\n    \u4f7f\u7528\u7387yield\u5173\u952e\u5b57\u7684\u51fd\u6570\u6216\u65b9\u6cd5\u3002\u8fd4\u56de\u7684\u662f\u751f\u6210\u5668\u5bf9\u8c61\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#52","title":"5.2\u3001\u7528\u6237\u81ea\u5b9a\u4e49\u7684\u53ef\u8c03\u7528\u7684\u7c7b\u578b","text":"<pre><code>\u7528\u6237\u81ea\u5b9a\u4e49\u7684\u53ef\u8c03\u7528\u7684\u7c7b\u578b\n\n\"\"\"\n# BEGIN BINGO_DEMO\n&gt;&gt;&gt; bingo = BingoCage(range(3))\n&gt;&gt;&gt; bingo.pick()\n1\n&gt;&gt;&gt; bingo()\n0\n&gt;&gt;&gt; callable(bingo)\nTrue\n# END BINGO_DEMO\n\"\"\"\n\n# BEGIN BINGO\n\nimport random\n\nclass BingoCage:\n\n    def __init__(self, items):\n        self._items = list(items)  # &lt;1&gt;\n        random.shuffle(self._items)  # &lt;2&gt;\n\n    def pick(self):  # &lt;3&gt;\n        try:\n            return self._items.pop()\n        except IndexError:\n            raise LookupError('pick from empty BingoCage')  # &lt;4&gt;\n\n    def __call__(self):  # &lt;5&gt;\n        return self.pick()\n\n# END BINGO\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#53","title":"5.3\u3001\u51fd\u6570\u6ce8\u89e3","text":"<pre><code>\u51fd\u6570\u6ce8\u89e3\n \"\"\"\n    &gt;&gt;&gt; clip('banana ', 6)\n    'banana'\n    &gt;&gt;&gt; clip('banana ', 7)\n    'banana'\n    &gt;&gt;&gt; clip('banana ', 5)\n    'banana'\n    &gt;&gt;&gt; clip('banana split', 6)\n    'banana'\n    &gt;&gt;&gt; clip('banana split', 7)\n    'banana'\n    &gt;&gt;&gt; clip('banana split', 10)\n    'banana'\n    &gt;&gt;&gt; clip('banana split', 11)\n    'banana'\n    &gt;&gt;&gt; clip('banana split', 12)\n    'banana split'\n\"\"\"\n\n# BEGIN CLIP_ANNOT\n\ndef clip(text:str, max_len:'int &gt; 0'=80) -&gt; str:  # &lt;1&gt;\n    \"\"\"Return text clipped at the last space before or after max_len\n    \"\"\"\n    end = None\n    if len(text) &gt; max_len:\n        space_before = text.rfind(' ', 0, max_len)\n        if space_before &gt;= 0:\n            end = space_before\n        else:\n            space_after = text.rfind(' ', max_len)\n            if space_after &gt;= 0:\n                end = space_after\n    if end is None:  # no spaces were found\n        end = len(text)\n    return text[:end].rstrip()\n\n# END CLIP_ANNOT\n\n\u6709\u6ce8\u89e3\u7684\u51fd\u6570\u58f0\u660e\n\u51fd\u6570\u58f0\u660e\u4e2d\u7684\u5404\u4e2a\u53c2\u6570\u53ef\u4ee5\u5728\uff1a\u4e4b\u540e\u589e\u52a0\u6ce8\u89e3\u8868\u8fbe\u5f0f\n\u6ce8\u89e3\u4e2d\u6700\u5e38\u7528\u7684\u7c7b\u578b\u662f\u7c7b\uff08str\u6216int\uff09\u548c\u5b57\u7b26\u4e32\uff08\u2018int &gt; 0\u2019\uff09\n\u6ce8\u89e3\u4e0d\u4f1a\u505a\u4efb\u4f55\u5904\u7406\uff0c\u53ea\u662f\u5b58\u50a8\u5728\u51fd\u6570\u7684__annotations__\u5c5e\u6027\uff08\u5b57\u5178\u4e2d\uff09\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#54","title":"5.4\u3001\u652f\u6301\u51fd\u6570\u5f0f\u7f16\u7a0b\u7684\u5305","text":"<pre><code>\u652f\u6301\u51fd\u6570\u5f0f\u7f16\u7a0b\u7684\u5305\n\npython\u7684\u76ee\u6807\u4e0d\u662f\u53d8\u6210\u51fd\u6570\u5f0f\u7f16\u7a0b\u8bed\u8a00\uff0c\u4f46\u662f\u5f97\u76ca\u4e8eoperator\u548cfunctools\u7b49\u5305\u7684\u652f\u6301\uff0c\u51fd\u6570\u5f0f\u7f16\u7a0b\u4e5f\u662f\u4fe1\u624b\u62c8\u6765\n\nopertaor\u6a21\u5757\n\nfrom tunctools import reduce\nfrom operator import mul\ndef fact(n):\n    return reduce(mul, range(1, n+1))\n\nfunctools.partial\u51bb\u7ed3\u53c2\u6570\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#6","title":"6\u3001\u88c5\u9970\u5668\u548c\u95ed\u5305","text":""},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#61","title":"6.1\u3001\u88c5\u9970\u5668\u57fa\u7840","text":"<p>\u88c5\u9970\u5668\u662f\u53ef\u8c03\u7528\u7684\u5bf9\u8c61\uff0c\u5176\u53c2\u6570\u662f\u53e6\u4e00\u4e2a\u51fd\u6570\u3002 nonlocal</p>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#62","title":"6.2\u3001\u5bfc\u5165\u65f6\u548c\u8fd0\u884c\u65f6","text":"<pre><code># BEGIN REGISTRATION\n\nregistry = []  # &lt;1&gt;\n\ndef register(func):  # &lt;2&gt;\n    print('running register(%s)' % func)  # &lt;3&gt;\n    registry.append(func)  # &lt;4&gt;\n    return func  # &lt;5&gt;\n\n@register  # &lt;6&gt;\ndef f1():\n    print('running f1()')\n\n@register\ndef f2():\n    print('running f2()')\n\ndef f3():  # &lt;7&gt;\n    print('running f3()')\n\ndef main():  # &lt;8&gt;\n    print('running main()')\n    print('registry -&gt;', registry)\n    f1()\n    f2()\n    f3()\n\nif __name__=='__main__':\n    main()  # &lt;9&gt;\n\n# END REGISTRATION\n\n\n\u51fd\u6570\u88c5\u9970\u5668\u5728\u5bfc\u5165\u6a21\u5757\u65f6\u7acb\u5373\u6267\u884c\uff0c\u800c\u88ab\u88c5\u9970\u7684\u51fd\u6570\u53ea\u5728\u660e\u786e\u8c03\u7528\u65f6\u8fd0\u884c\u3002\u5bfc\u5165\u65f6\u548c\u8fd0\u884c\u65f6\u662f\u6709\u533a\u522b\u7684\u3002\u53ef\u4ee5\u6267\u884c\u4e00\u4e0b\u8bd5\u8bd5\u3002\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#7","title":"7\u3001\u5bf9\u8c61\u5f15\u7528\u3001\u53ef\u53d8\u6027\u548c\u5783\u573e\u56de\u6536","text":"<pre><code>\u6807\u8bc6\u3001\u76f8\u7b49\u6027\u548c\u522b\u540d\n\nabc=123\nkk=abc\nkk is abc\nOut[1]: True\n\n\n\nid(abc)\nOut[2]: 4543210432\n\nid(kk)\nOut[3]: 4543210432\n\n\u4e0a\u9762ABC\uff0ckk\u6307\u4ee3\u540c\u4e00\u4e2a\u5bf9\u8c61\n\n\n\u5728==\u548cis\u4e4b\u95f4\u9009\u62e9\n==\u6bd4\u8f83\u7684\u4e24\u4e2a\u5bf9\u8c61\u7684\u503c\nis\u6bd4\u8f83\u7684\u662f\u5bf9\u8c61\u7684\u6807\u8bc6\n\n\u6700\u5e38\u4f7f\u7528is\u68c0\u67e5\u53d8\u91cf\u7ed1\u5b9a\u503c\u662f\u4e0d\u662fNone\nx is None\nx is not None\nis\u8fd0\u7b97\u7b26\u6bd4==\u5feb\n\n\n\u5143\u7ec4\u7684\u76f8\u5bf9\u4e0d\u53ef\u53d8\u6027\n\u5143\u7ec4\u4e0d\u53ef\u53d8\u6027\u5176\u5b9e\u662f\u6307tuple\u6570\u636e\u7ed3\u6784\u7684\u7269\u7406\u5185\u5bb9\uff08\u5373\u4fdd\u5b58\u7684\u5f15\u7528\uff09\u4e0d\u53ef\u53d8\uff0c\u4e0e\u5f15\u7528\u7684\u5bf9\u8c61\u65e0\u5173\u3002\u5143\u7956\u4e2d\u4e0d\u53ef\u53d8\u7684\u662f\u5143\u7d20\u7684\u6807\u8bc6\u3002\n\n\n\u9ed8\u8ba4\u505a\u6d45\u590d\u5236\n\u590d\u5236\u4e86\u6700\u5916\u5c42\u5bb9\u5668\uff0c\u526f\u672c\u4e2d\u7684\u5143\u7d20\u662f\u6e90\u5bb9\u5668\u4e2d\u5143\u7d20\u7684\u5f15\u7528\n\n\u6df1\u590d\u5236\n\u526f\u672c\u4e0d\u5171\u4eab\u5185\u90e8\u5bf9\u8c61\u7684\u5f15\u7528\n\ndel\u548c\u5783\u573e\u56de\u6536\ndel\u8bed\u53e5\u5220\u9664\u540d\u79f0\u800c\u4e0d\u662f\u5bf9\u8c61\u3002del\u547d\u4ee4\u53ef\u80fd\u4f1a\u5bfc\u81f4\u5bf9\u8c61\u88ab\u5f53\u505a\u5783\u573e\u56de\u6536\uff0c\u4f46\u662f\u4ec5\u5f53\u5220\u9664\u7684\u53d8\u91cf\u4fdd\u5b58\u7684\u662f\u5bf9\u8c61\u7684\u6700\u540e\u4e00\u4e2a\u5f15\u7528\u3002\n\u5728cpython\u4e2d\uff0c\u5783\u573e\u56de\u6536\u7684\u4e3b\u8981\u7b97\u6cd5\u662f\u5f15\u7528\u8ba1\u6570\uff0c\u5f53\u5f15\u7528\u8ba1\u6570\u5f520\uff0c\u5bf9\u8c61\u7acb\u5373\u88ab\u9500\u6bc1\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#14","title":"14\u3001\u8fed\u4ee3\u5668\u548c\u751f\u6210\u5668","text":""},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#141","title":"14.1\u3001\u4ec0\u4e48\u662f\u8fed\u4ee3\u5668","text":"<pre><code>\u6240\u6709\u7684\u751f\u6210\u5668\u90fd\u662f\u8fed\u4ee3\u5668\n\u8fed\u4ee3\u5668\u7531\u4e8e\u4ece\u96c6\u5408\u4e2d\u53d6\u51fa\u5143\u7d20\uff0c\u751f\u6210\u5668\u7528\u4e8e\u51ed\u7a7a\u751f\u6210\u5143\u7d20\u3002\n\n\u5982\u679c\u5bf9\u8c61\u5b9e\u73b0\u4e86\u80fd\u8fd4\u56de__iter__\u65b9\u6cd5\uff0c\u90a3\u4e48\u5bf9\u8c61\u5c31\u662f\u53ef\u8fed\u4ee3\u7684\uff0c\u5e8f\u5217\u90fd\u662f\u53ef\u4ee5\u8fed\u4ee3\u7684\u3002\n\u5b9e\u73b0\u4e86__getitem__\u65b9\u6cd5\uff0c\u800c\u4e14\u5176\u53c2\u6570\u662f\u4ece\u96f6\u5f00\u59cb\u7684\u7d22\u5f15\uff0c\u8fd9\u79cd\u5bf9\u8c61\u4e5f\u53ef\u4ee5\u8fed\u4ee3\u3002\n\npython\u4ece\u53ef\u8fed\u4ee3\u7684\u5bf9\u8c61\u4e2d\u83b7\u53d6\u8fed\u4ee3\u5668\n\n\n\"\"\"\nSentence: iterate over words using the Iterator Pattern, take #1\n\nWARNING: the Iterator Pattern is much simpler in idiomatic Python;\nsee: sentence_gen*.py.\n\"\"\"\n\n# BEGIN SENTENCE_ITER\nimport re\nimport reprlib\n\nRE_WORD = re.compile('\\w+')\n\n\nclass Sentence:\n\n    def __init__(self, text):\n        self.text = text\n        self.words = RE_WORD.findall(text)\n\n    def __repr__(self):\n        return 'Sentence(%s)' % reprlib.repr(self.text)\n\n    def __iter__(self):  # &lt;1&gt;\n        return SentenceIterator(self.words)  # &lt;2&gt;\n\n\nclass SentenceIterator:\n\n    def __init__(self, words):\n        self.words = words  # &lt;3&gt;\n        self.index = 0  # &lt;4&gt;\n\n    def __next__(self):\n        try:\n            word = self.words[self.index]  # &lt;5&gt;\n        except IndexError:\n            raise StopIteration()  # &lt;6&gt;\n        self.index += 1  # &lt;7&gt;\n        return word  # &lt;8&gt;\n\n    def __iter__(self):  # &lt;9&gt;\n        return self\n# END SENTENCE_ITER\n\ndef main():\n    import sys\n    import warnings\n    try:\n        filename = sys.argv[1]\n        word_number = int(sys.argv[2])\n    except (IndexError, ValueError):\n        print('Usage: %s &lt;file-name&gt; &lt;word-number&gt;' % sys.argv[0])\n        sys.exit(1)\n    with open(filename, 'rt', encoding='utf-8') as text_file:\n        s = Sentence(text_file.read())\n    for n, word in enumerate(s, 1):\n        if n == word_number:\n            print(word)\n            break\n    else:\n        warnings.warn('last word is #%d, \"%s\"' % (n, word))\n\nif __name__ == '__main__':\n    main()\n\n\n\u8fed\u4ee3\u5668\u5e94\u8be5\u5b9e\u73b0__next__\u548c__iter__\u4e24\u4e2a\u65b9\u6cd5\n\n\n\n\u53ef\u8fed\u4ee3\u7684\u5bf9\u8c61\u6709\u4e2a__iter__\u65b9\u6cd5\uff0c\u6bcf\u6b21\u90fd\u5b9e\u4f8b\u5316\u4e00\u4e2a\u65b0\u7684\u8fed\u4ee3\u5668\uff1b\n\u8fed\u4ee3\u5668\u8981\u5b9e\u73b0__next__\u65b9\u6cd5\uff0c\u8fd4\u56de\u5355\u4e2a\u5143\u7d20\uff0c\u6b64\u5916\u8fd8\u8981\u5b9e\u73b0__iter__\u65b9\u6cd5\uff0c\u8fd4\u56de\u8fed\u4ee3\u5668\u672c\u8eab.\n\n\u8fed\u4ee3\u5668\u53ef\u4ee5\u8fed\u4ee3\uff0c\u4f46\u662f\u53ef\u8fed\u4ee3\u7684\u5bf9\u8c61\u4e0d\u662f\u8fed\u4ee3\u5668\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#142","title":"14.2\u3001\u751f\u6210\u5668","text":"<pre><code>\u53ea\u8981python\u51fd\u6570\u7684\u5b9a\u4e49\u4f53\u4e2d\u6709yield\u5173\u952e\u5b57\uff0c\u8be5\u51fd\u6570\u5c31\u662f\u751f\u6210\u5668\u51fd\u6570\n\n\"\"\"\nSentence: iterate over words using a generator function\n\"\"\"\n\nimport re\nimport reprlib\n\nRE_WORD = re.compile('\\w+')\n\n\nclass Sentence:\n\n    def __init__(self, text):\n        self.text = text\n        self.words = RE_WORD.findall(text)\n\n    def __repr__(self):\n        return 'Sentence(%s)' % reprlib.repr(self.text)\n\n    def __iter__(self):\n        for word in self.words:  # &lt;1&gt;\n            yield word  # &lt;2&gt;\n        return  # &lt;3&gt;\n\n# done! &lt;4&gt;\n\n\n\u4f7f\u7528itertools\u6a21\u5757\u751f\u6210\u7b49\u5dee\u6570\u5217\ngen=itertools.takewhile(lambda n:n&lt;3, itertools.count(1, .5))\n\nitertools.count\u4f1a\u628a\u5185\u5b58\u5e72\u7206\n\n\n\n\u6807\u51c6\u5e93\u4e2d\u7684\u751f\u6210\u5668\u51fd\u6570\n\u5185\u7f6e\u7684\u548citertools \u548cfunctools\u4e2d\u7684\n\npyhon3.3\u51fa\u73b0\u7684\u65b0\u8bed\u6cd5,yield from\n\n\n\u53ef\u8fed\u4ee3\u7684\u89c4\u7ea6\u51fd\u6570\uff0c\u8fd4\u56de\u5355\u4e2a\u7ed3\u679c\nall\nany\nmax\nmin\nreduce\nsum\n\niter\u51fd\u6570\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#15else","title":"15\u3001\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u548celse","text":""},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#151","title":"15.1\u3001\u4ecb\u7ecd","text":"<pre><code>\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u5bf9\u8c61\u5b58\u5728\u7684\u76ee\u7684\u662f\u7ba1\u7406with\u8bed\u53e5\uff0c\u5c31\u50cf\u8fed\u4ee3\u5668\u7684\u5b58\u5728\u662f\u4e3a\u4e86\u7ba1\u7406for\u8bed\u53e5\u4e00\u6837\n\n\nfinally \u5b50\u53e5\u7684\u4ee3\u7801\u901a\u5e38\u7528\u4e8e\u91ca\u653e\u91cd\u8981\u7684\u8d44\u6e90\uff0c\u6216\u8005\u8fd8\u539f\u4e34\u65f6\u53d8\u66f4\u7684\u72b6\u6001\u3002witch\u8bed\u53e5\u76ee\u7684\u5c31\u662f\u7b80\u5316try/finally\u6a21\u5f0f\n\n\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u534f\u8bae\u5305\u542b__enter__\u548c__exit__\u4e24\u4e2a\u65b9\u6cd5\u3002with\u8bed\u53e5\u5f00\u59cb\u8fd0\u884c\u65f6\uff0c\u4f1a\u5728\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u5bf9\u8c61\u4e0a\u8c03\u7528__enter__\u65b9\u6cd5\u3002with\u8bed\u53e5\u8fd0\u884c\u7ed3\u675f\u540e\uff0c\n\u4f1a\u5728\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u5bf9\u8c61\u4e0a\u8c03\u7528__exit__\u65b9\u6cd5\u3002\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#152","title":"15.2\u3001\u901a\u8fc7\u7c7b\u5b9e\u73b0\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668","text":"<pre><code>\"\"\"\nA \"mirroring\" ``stdout`` context.\n\nWhile active, the context manager reverses text output to\n``stdout``::\n\n# BEGIN MIRROR_DEMO_1\n\n    &gt;&gt;&gt; from mirror import LookingGlass\n    &gt;&gt;&gt; with LookingGlass() as what:  # &lt;1&gt;\n    ...      print('Alice, Kitty and Snowdrop')  # &lt;2&gt;\n    ...      print(what)\n    ...\n    pordwonS dna yttiK ,ecilA  # &lt;3&gt;\n    YKCOWREBBAJ\n    &gt;&gt;&gt; what  # &lt;4&gt;\n    'JABBERWOCKY'\n    &gt;&gt;&gt; print('Back to normal.')  # &lt;5&gt;\n    Back to normal.\n\n# END MIRROR_DEMO_1\n\n\nThis exposes the context manager operation::\n\n# BEGIN MIRROR_DEMO_2\n\n    &gt;&gt;&gt; from mirror import LookingGlass\n    &gt;&gt;&gt; manager = LookingGlass()  # &lt;1&gt;\n    &gt;&gt;&gt; manager\n    &lt;mirror.LookingGlass object at 0x2a578ac&gt;\n    &gt;&gt;&gt; monster = manager.__enter__()  # &lt;2&gt;\n    &gt;&gt;&gt; monster == 'JABBERWOCKY'  # &lt;3&gt;\n    eurT\n    &gt;&gt;&gt; monster\n    'YKCOWREBBAJ'\n    &gt;&gt;&gt; manager\n    &gt;ca875a2x0 ta tcejbo ssalGgnikooL.rorrim&lt;\n    &gt;&gt;&gt; manager.__exit__(None, None, None)  # &lt;4&gt;\n    &gt;&gt;&gt; monster\n    'JABBERWOCKY'\n\n# END MIRROR_DEMO_2\n\nThe context manager can handle and \"swallow\" exceptions.\n\n# BEGIN MIRROR_DEMO_3\n\n    &gt;&gt;&gt; from mirror import LookingGlass\n    &gt;&gt;&gt; with LookingGlass():\n    ...      print('Humpty Dumpty')\n    ...      x = 1/0  # &lt;1&gt;\n    ...      print('END')  # &lt;2&gt;\n    ...\n    ytpmuD ytpmuH\n    Please DO NOT divide by zero!\n    &gt;&gt;&gt; with LookingGlass():\n    ...      print('Humpty Dumpty')\n    ...      x = no_such_name  # &lt;1&gt;\n    ...      print('END')  # &lt;2&gt;\n    ...\n    Traceback (most recent call last):\n      ...\n    NameError: name 'no_such_name' is not defined\n\n# END MIRROR_DEMO_3\n\n\"\"\"\n\n\n# BEGIN MIRROR_EX\nclass LookingGlass:\n\n    def __enter__(self):  # &lt;1&gt;\n        import sys\n        self.original_write = sys.stdout.write  # &lt;2&gt;\n        sys.stdout.write = self.reverse_write  # &lt;3&gt;\n        return 'JABBERWOCKY'  # &lt;4&gt;\n\n    def reverse_write(self, text):  # &lt;5&gt;\n        self.original_write(text[::-1])\n\n    def __exit__(self, exc_type, exc_value, traceback):  # &lt;6&gt;\n        import sys  # &lt;7&gt;\n        sys.stdout.write = self.original_write  # &lt;8&gt;\n        if exc_type is ZeroDivisionError:  # &lt;9&gt;\n            print('Please DO NOT divide by zero!')\n            return True  # &lt;10&gt;\n        # &lt;11&gt;\n\n\n# END MIRROR_EX\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#153","title":"15.3\u3001\u901a\u8fc7\u751f\u6210\u5668\u5b9e\u73b0\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668","text":"<pre><code>contextlib\u6a21\u5757\u4e2d\u7684\u5b9e\u7528\u5de5\u5177\nclosing\nsuppress\n@contextmanager\nContextDecorator\nExitStack\n\n\u4f7f\u7528@contextmanager\uff0c\u4e0d\u7528\u7f16\u5199\u5b8c\u6574\u7684\u7c7b\uff0c\u53ea\u9700\u8981\u5b9e\u73b0\u4e00\u4e2a\u5e26\u6709yield\u8bed\u53e5\u7684\u751f\u6210\u5668\uff0c\u751f\u6210\u60f3\u8ba9__enter__\u65b9\u6cd5\u8fd4\u56de\u7684\u503c\uff0cyield\u8bed\u53e5\u4e4b\u524d\u7684\uff08enter\uff09\uff0c\u4e4b\u540e\u7684\uff08exit\uff09\n\n\n\"\"\"\nA \"mirroring\" ``stdout`` context manager.\n\nWhile active, the context manager reverses text output to\n``stdout``::\n\n# BEGIN MIRROR_GEN_DEMO_1\n\n    &gt;&gt;&gt; from mirror_gen import looking_glass\n    &gt;&gt;&gt; with looking_glass() as what:  # &lt;1&gt;\n    ...      print('Alice, Kitty and Snowdrop')\n    ...      print(what)\n    ...\n    pordwonS dna yttiK ,ecilA\n    YKCOWREBBAJ\n    &gt;&gt;&gt; what\n    'JABBERWOCKY'\n\n# END MIRROR_GEN_DEMO_1\n\n\nThis exposes the context manager operation::\n\n# BEGIN MIRROR_GEN_DEMO_2\n\n    &gt;&gt;&gt; from mirror_gen import looking_glass\n    &gt;&gt;&gt; manager = looking_glass()  # &lt;1&gt;\n    &gt;&gt;&gt; manager  # doctest: +ELLIPSIS\n    &lt;contextlib._GeneratorContextManager object at 0x...&gt;\n    &gt;&gt;&gt; monster = manager.__enter__()  # &lt;2&gt;\n    &gt;&gt;&gt; monster == 'JABBERWOCKY'  # &lt;3&gt;\n    eurT\n    &gt;&gt;&gt; monster\n    'YKCOWREBBAJ'\n    &gt;&gt;&gt; manager  # doctest: +ELLIPSIS\n    &gt;...x0 ta tcejbo reganaMtxetnoCrotareneG_.biltxetnoc&lt;\n    &gt;&gt;&gt; manager.__exit__(None, None, None)  # &lt;4&gt;\n    &gt;&gt;&gt; monster\n    'JABBERWOCKY'\n\n# END MIRROR_GEN_DEMO_2\n\n\"\"\"\n\n\n# BEGIN MIRROR_GEN_EX\n\nimport contextlib\n\n\n@contextlib.contextmanager  # &lt;1&gt;\ndef looking_glass():\n    import sys\n    original_write = sys.stdout.write  # &lt;2&gt;\n\n    def reverse_write(text):  # &lt;3&gt;\n        original_write(text[::-1])\n\n    sys.stdout.write = reverse_write  # &lt;4&gt;\n    yield 'JABBERWOCKY'  # &lt;5&gt;\n    sys.stdout.write = original_write  # &lt;6&gt;\n\n\n# END MIRROR_GEN_EX\n\n\n\n\u57fa\u4e8e\u751f\u6210\u5668\u7684\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\uff0c\u800c\u4e14\u5b9e\u73b0\u4e86\u5f02\u5e38\u5904\u7406\n\"\"\"\nA \"mirroring\" ``stdout`` context manager.\n\nWhile active, the context manager reverses text output to\n``stdout``::\n\n# BEGIN MIRROR_GEN_DEMO_1\n\n    &gt;&gt;&gt; from mirror_gen import looking_glass\n    &gt;&gt;&gt; with looking_glass() as what:  # &lt;1&gt;\n    ...      print('Alice, Kitty and Snowdrop')\n    ...      print(what)\n    ...\n    pordwonS dna yttiK ,ecilA\n    YKCOWREBBAJ\n    &gt;&gt;&gt; what\n    'JABBERWOCKY'\n\n# END MIRROR_GEN_DEMO_1\n\n\nThis exposes the context manager operation::\n\n# BEGIN MIRROR_GEN_DEMO_2\n\n    &gt;&gt;&gt; from mirror_gen import looking_glass\n    &gt;&gt;&gt; manager = looking_glass()  # &lt;1&gt;\n    &gt;&gt;&gt; manager  # doctest: +ELLIPSIS\n    &lt;contextlib._GeneratorContextManager object at 0x...&gt;\n    &gt;&gt;&gt; monster = manager.__enter__()  # &lt;2&gt;\n    &gt;&gt;&gt; monster == 'JABBERWOCKY'  # &lt;3&gt;\n    eurT\n    &gt;&gt;&gt; monster\n    'YKCOWREBBAJ'\n    &gt;&gt;&gt; manager  # doctest: +ELLIPSIS\n    &gt;...x0 ta tcejbo reganaMtxetnoCrotareneG_.biltxetnoc&lt;\n    &gt;&gt;&gt; manager.__exit__(None, None, None)  # &lt;4&gt;\n    &gt;&gt;&gt; monster\n    'JABBERWOCKY'\n\n# END MIRROR_GEN_DEMO_2\n\nThe context manager can handle and \"swallow\" exceptions.\nThe following test does not pass under doctest (a\nZeroDivisionError is reported by doctest) but passes\nif executed by hand in the Python 3 console (the exception\nis handled by the context manager):\n\n# BEGIN MIRROR_GEN_DEMO_3\n\n    &gt;&gt;&gt; from mirror_gen import looking_glass\n    &gt;&gt;&gt; with looking_glass():\n    ...      print('Humpty Dumpty')\n    ...      x = 1/0  # &lt;1&gt;\n    ...      print('END')  # &lt;2&gt;\n    ...\n    ytpmuD ytpmuH\n    Please DO NOT divide by zero!\n\n# END MIRROR_GEN_DEMO_3\n\n    &gt;&gt;&gt; with looking_glass():\n    ...      print('Humpty Dumpty')\n    ...      x = no_such_name  # &lt;1&gt;\n    ...      print('END')  # &lt;2&gt;\n    ...\n    Traceback (most recent call last):\n      ...\n    NameError: name 'no_such_name' is not defined\n\n\n\n\"\"\"\n\n\n# BEGIN MIRROR_GEN_EXC\n\nimport contextlib\n\n\n@contextlib.contextmanager\ndef looking_glass():\n    import sys\n    original_write = sys.stdout.write\n\n    def reverse_write(text):\n        original_write(text[::-1])\n\n    sys.stdout.write = reverse_write\n    msg = ''  # &lt;1&gt;\n    try:\n        yield 'JABBERWOCKY'\n    except ZeroDivisionError:  # &lt;2&gt;\n        msg = 'Please DO NOT divide by zero!'\n    finally:\n        sys.stdout.write = original_write  # &lt;3&gt;\n        if msg:\n            print(msg)  # &lt;4&gt;\n\n\n# END MIRROR_GEN_EXC\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#16-","title":"16\u3001\u534f\u7a0b-\u8001\u7248\u672c","text":""},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#1614","title":"16.1\u3001\u534f\u7a0b\u76844\u4e2a\u72b6\u6001","text":"<pre><code>\u534f\u7a0b\u76844\u4e2a\u72b6\u6001\n\n\u5f53\u524d\u72b6\u6001\u53ef\u4ee5\u7528inspect.getgeneratorstate()\n\nGEN_CREATED = 'GEN_CREATED' \u7b49\u5f85\u5f00\u59cb\u6267\u884c\nGEN_RUNNING = 'GEN_RUNNING' \u89e3\u91ca\u5668\u6b63\u5728\u6267\u884c\nGEN_SUSPENDED = 'GEN_SUSPENDED' \u5728yield\u8868\u8fbe\u5f0f\u5904\u6682\u505c\nGEN_CLOSED = 'GEN_CLOSED'   \u6267\u884c\u7ed3\u675f\n\n\n\"\"\"\nA coroutine to compute a running average\n\n# BEGIN CORO_AVERAGER_TEST\n    &gt;&gt;&gt; coro_avg = averager()  # &lt;1&gt;\n    &gt;&gt;&gt; next(coro_avg)  # &lt;2&gt;\n    &gt;&gt;&gt; coro_avg.send(10)  # &lt;3&gt;\n    10.0\n    &gt;&gt;&gt; coro_avg.send(30)\n    20.0\n    &gt;&gt;&gt; coro_avg.send(5)\n    15.0\n\n# END CORO_AVERAGER_TEST\n\n\"\"\"\n\n# BEGIN CORO_AVERAGER\ndef averager():\n    total = 0.0\n    count = 0\n    average = None\n    while True:  # &lt;1&gt;\n        term = yield average  # &lt;2&gt;\n        total += term\n        count += 1\n        average = total/count\n# END CORO_AVERAGER\n\n\n\n\u9884\u6fc0\u534f\u7a0b\u88c5\u9970\u5668\uff0c\u8c03\u7528send\u4e4b\u524d\uff0c\u4e00\u5b9a\u8981\u5148\u8c03\u7528next()\u3002\u4e3a\u4e86\u7b80\u5316\u534f\u7a0b\u7684\u65b9\u6cd5\uff0c\u6709\u65f6\u4f1a\u4f7f\u7528\u4e00\u4e2a\u9884\u6fc0\u88c5\u9970\u5668\u3002\n# BEGIN CORO_DECO\nfrom functools import wraps\n\ndef coroutine(func):\n    \"\"\"Decorator: primes `func` by advancing to first `yield`\"\"\"\n    @wraps(func)\n    def primer(*args,**kwargs):  # &lt;1&gt;\n        gen = func(*args,**kwargs)  # &lt;2&gt;\n        next(gen)  # &lt;3&gt;\n        return gen  # &lt;4&gt;\n    return primer\n# END CORO_DECO\n\n\n\u9884\u6fc0\u4e4b\u540e\u7684\n\n# BEGIN DECORATED_AVERAGER\n\"\"\"\nA coroutine to compute a running average\n\n    &gt;&gt;&gt; coro_avg = averager()  # &lt;1&gt;\n    &gt;&gt;&gt; from inspect import getgeneratorstate\n    &gt;&gt;&gt; getgeneratorstate(coro_avg)  # &lt;2&gt;\n    'GEN_SUSPENDED'\n    &gt;&gt;&gt; coro_avg.send(10)  # &lt;3&gt;\n    10.0\n    &gt;&gt;&gt; coro_avg.send(30)\n    20.0\n    &gt;&gt;&gt; coro_avg.send(5)\n    15.0\n\n\"\"\"\n\nfrom coroutil import coroutine  # &lt;4&gt;\n\n@coroutine  # &lt;5&gt;\ndef averager():  # &lt;6&gt;\n    total = 0.0\n    count = 0\n    average = None\n    while True:\n        term = yield average\n        total += term\n        count += 1\n        average = total/count\n# END DECORATED_AVERAGER\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#162","title":"16.2\u3001\u7ec8\u6b62\u534f\u7a0b\u548c\u5f02\u5e38\u5904\u7406","text":"<p>\u5728\u534f\u7a0b\u5185\u90e8\u6ca1\u6709\u5904\u7406\u5f02\u5e38\uff0c\u534f\u7a0b\u4f1a\u7ec8\u6b62\u3002\u5982\u679c\u8bd5\u56fe\u91cd\u65b0\u6fc0\u6d3b\u534f\u7a0b\uff0c\u4f1a\u629b\u51fastopIteration\u7684\u5f02\u5e38 \u7ec8\u6b62\u534f\u7a0b\u7684\u4e00\u79cd\u65b9\u5f0f\uff1a\u53d1\u9001\u67d0\u4e2a\u54e8\u7b26\u503c\u3002\u5185\u7f6e\u7684None\u548cEllipsis\u7b49\u5e38\u91cf\u7ecf\u5e38\u7528\u4f5c\u54e8\u7b26\u503c</p>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#163yield-from","title":"16.3\u3001yield from","text":"<pre><code>\u53ef\u4ee5\u7528\u4e8e\u7b80\u5316for\u5faa\u73af\u4e2d\u7684yield\u8868\u8fbe\u5f0f\u3002\n\ndef gen():\n    yield from 'ab'\n    yield from range(1,2)\n\nlist(gen())\n\n\nyield from x \u8868\u8fbe\u5f0f\u5bf9x\u5bf9\u8c61\u6240\u505a\u7684\u7b2c\u4e00\u4ef6\u4e8b\u662f\uff0c\u8c03\u7528iter(x),\u4ece\u4e2d\u83b7\u53d6\u8fed\u4ee3\u5668\u3002x\u53ef\u4ee5\u662f\u4efb\u4f55\u53ef\u8fed\u4ee3\u7684\u5bf9\u8c61\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#17future","title":"17\u3001future\u5904\u7406\u5e76\u53d1","text":""},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#171","title":"17.1\u3001\u591a\u7ebf\u7a0b\u548c\u591a\u8fdb\u7a0b","text":"<pre><code>\u5728io\u5bc6\u96c6\u578b\u5e94\u7528\u4e2d\uff0c\u5982\u679c\u4ee3\u7801\u5199\u7684\u6b63\u786e\uff0c\u4f7f\u7528\u7ebf\u7a0b\u6216\u8005asyncio\u541e\u5410\u91cf\u90fd\u4f1a\u6bd4\u4f9d\u5e8f\u6267\u884c\u7684\u4ee3\u7801\u9ad8\u5f88\u591a\n\n\nconcurrent.futures\nfuture\u5c01\u88c5\u5f85\u5b8c\u6210\u7684\u64cd\u4f5c\uff0c\u53ef\u4ee5\u653e\u5165\u961f\u5217\uff0c\u5b8c\u6210\u7684\u72b6\u6001\u53ef\u4ee5\u67e5\u8be2\uff0c\u5f97\u5230\u7ed3\u679c\u540e\u53ef\u4ee5\u83b7\u53d6\u7ed3\u679c\u3002result()\u4f1a\u963b\u585e\u8c03\u7528\u65b9\u6240\u5728\u7684\u7ebf\u7a0b\uff0c\u77e5\u9053\u6709\u7ed3\u679c\u53ef\u8fd4\u56de\u3002\u53ef\u4ee5\n\u589e\u52a0timeout\u53c2\u6570\uff0casyncio.Future.result\u4e0d\u652f\u6301\u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4\n\n\"\"\"Download flags of top 20 countries by population\n\nThreadPoolExecutor version 2, with ``as_completed``.\n\nSample run::\n\n    $ python3 flags_threadpool.py\n    BD retrieved.\n    EG retrieved.\n    CN retrieved.\n    ...\n    PH retrieved.\n    US retrieved.\n    IR retrieved.\n    20 flags downloaded in 0.93s\n\n\"\"\"\nfrom concurrent import futures\n\nfrom flags import save_flag, get_flag, show, main\n\nMAX_WORKERS = 20\n\n\ndef download_one(cc):\n    image = get_flag(cc)\n    show(cc)\n    save_flag(image, cc.lower() + '.gif')\n    return cc\n\n\n# BEGIN FLAGS_THREADPOOL_AS_COMPLETED\ndef download_many(cc_list):\n    cc_list = cc_list[:5]  # &lt;1&gt;\n    with futures.ThreadPoolExecutor(max_workers=3) as executor:  # &lt;2&gt;\n        to_do = []\n        for cc in sorted(cc_list):  # &lt;3&gt;\n            future = executor.submit(download_one, cc)  # &lt;4&gt;\n            to_do.append(future)  # &lt;5&gt;\n            msg = 'Scheduled for {}: {}'\n            print(msg.format(cc, future))  # &lt;6&gt;\n\n        results = []\n        for future in futures.as_completed(to_do):  # &lt;7&gt;\n            res = future.result()  # &lt;8&gt;\n            msg = '{} result: {!r}'\n            print(msg.format(future, res)) # &lt;9&gt;\n            results.append(res)\n\n    return len(results)\n# END FLAGS_THREADPOOL_AS_COMPLETED\n\nif __name__ == '__main__':\n    main(download_many)\n\nexecutor.submit\u65b9\u6cd5\u6392\u5b9a\u53ef\u8c03\u7528\u5bf9\u8c61\u7684\u6267\u884c\u65f6\u95f4\uff0c\u7136\u540e\u8fd4\u56de\u4e00\u4e2afuture\nto_do\u5b58\u50a8\u5404\u4e2afuture\uff0c\u540e\u9762\u4f20\u9012\u7ed9as_completed,as_completed\u51fd\u6570\u5728future\u8fd0\u884c\u7ed3\u675f\u540e\u4ea7\u51fafuture\u3002\n\n\n\u963b\u585e\u578bio\u548cGIL\n\u4e25\u683c\u6765\u8bf4\uff0c\u6211\u4eec\u76ee\u524d\u6d4b\u8bd5\u7684\u5e76\u53d1\u811a\u672c\u90fd\u4e0d\u80fd\u5e76\u884c\u4e0b\u8f7d\u3002\u4f7f\u7528concurrent.futures\u5b9e\u73b0\u7684\u90a3\u4e24\u4e2a\u5b9e\u4f8b\u53d7GIL\u7684\u9650\u5236\u3002\ncpython\u89e3\u91ca\u5668\u672c\u8eab\u5c31\u4e0d\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\uff0c\u6240\u4ee5\u6709GIL\uff0c\u4e00\u6b21\u53ea\u5141\u8bb8\u4f7f\u7528\u4e00\u4e2a\u7ebf\u7a0b\u6267\u884cpython\u5b57\u8282\u7801\u3002\u4e00\u4e2apython\u7ecf\u5e38\u901a\u5e38\u4e0d\u80fd\u540c\u65f6\u4f7f\u7528\u591a\u4e2acpu\u6838\u5fc3\u3002\n\n\u6807\u51c6\u5e93\u4e2d\u6240\u6709\u6267\u884c\u963b\u585e\u578bio\u64cd\u4f5c\u7684\u51fd\u6570\uff0c\u5728\u7b49\u5f85\u64cd\u4f5c\u7cfb\u7edf\u8fd4\u56de\u7ed3\u679c\u65f6\u90fd\u4f1a\u91ca\u653eGIL\u3002\u8fd9\u610f\u5473\u7740python\u53ef\u4ee5\u5728\u8fd9\u4e2a\u5c42\u6b21\u4e0a\u4f7f\u7528\u591a\u7ebf\u7a0b\u3002\u4e00\u4e2apython\u7ebf\u7a0b\u5728\u7b49\u5f85\u7f51\u7edc\n\u54cd\u5e94\u65f6\uff0c\u963b\u585e\u578bio\u51fd\u6570\u4f1a\u91ca\u653eGIL\uff0c\u518d\u8fd0\u884c\u4e00\u4e2a\u7ebf\u7a0b\u3002\n\n\n\n\u901a\u8fc7ProcessPoolExecutor\u53ef\u4ee5\u505acpu\u5bc6\u96c6\u578b\u5904\u7406\uff0c\u53ef\u4ee5\u7ed5\u5f00GIL\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#18asyncio","title":"18\u3001asyncio","text":""},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#181","title":"18.1\u3001\u4ece\u5c5e\u7ebf\u7a0b","text":"<pre><code>1\u3001\u4ece\u5c5e\u7ebf\u7a0b\u7684\u6982\u5ff5\n\u5728Python\u4e2d\uff0c\u4ece\u5c5e\u7ebf\u7a0b\u4e5f\u79f0\u4e3a\u5b88\u62a4\u7ebf\u7a0b\uff08daemonthread\uff09\u3002\u4e0e\u666e\u901a\u7ebf\u7a0b\u4e0d\u540c\uff0c\u4ece\u5c5e\u7ebf\u7a0b\u4f1a\u5728\u4e3b\u7ebf\u7a0b\u7ed3\u675f\u65f6\u81ea\u52a8\u9000\u51fa\uff0c\u5e76\u4e14\u4ece\u5c5e\u7ebf\u7a0b\u65e0\u6cd5\u963b\u6b62\u7a0b\u5e8f\u7684\u9000\u51fa\u3002\u4ece\u5c5e\u7ebf\u7a0b\u901a\u5e38\u7528\u4e8e\u6267\u884c\u4e00\u4e9b\u540e\u53f0\u4efb\u52a1\n\nimport threading\nimport time\n\ndef worker():\n    \"\"\"\u7ebf\u7a0b\u6267\u884c\u7684\u4efb\u52a1\"\"\"\n    while True:\n        print('Worker')\n        time.sleep(1)\n\n# \u521b\u5efa\u7ebf\u7a0b\nt = threading.Thread(target=worker)\n# \u5c06\u7ebf\u7a0b\u8bbe\u7f6e\u4e3a\u4ece\u5c5e\u7ebf\u7a0b\nt.setDaemon(True)\n# \u542f\u52a8\u7ebf\u7a0b\nt.start()\n\n# \u4e3b\u7ebf\u7a0b\u4f11\u77205\u79d2\u949f\ntime.sleep(5)\nprint('Main thread exiting')\n\n\n\u8fd9\u4e2a\u4f8b\u5b50\u521b\u5efa\u4e86\u4e00\u4e2a\u540d\u4e3at\u7684\u7ebf\u7a0b\uff0c\u5e76\u5c06\u5176\u8bbe\u7f6e\u4e3a\u4ece\u5c5e\u7ebf\u7a0b\u3002\u7136\u540e\uff0c\u4e3b\u7ebf\u7a0b\u4f11\u77205\u79d2\u949f\u540e\u9000\u51fa\u3002\u7531\u4e8et\u662f\u4ece\u5c5e\u7ebf\u7a0b\uff0c\u6240\u4ee5\u5373\u4f7ft\u5728\u540e\u53f0\u6267\u884c\uff0c\u7a0b\u5e8f\u4e5f\u4f1a\u5728\u4e3b\u7ebf\u7a0b\u9000\u51fa\u65f6\u7ed3\u675f\u3002\n\n\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4ece\u5c5e\u7ebf\u7a0b\u901a\u5e38\u4e0d\u80fd\u8bbf\u95ee\u5171\u4eab\u8d44\u6e90\uff0c\u56e0\u4e3a\u5b83\u4eec\u53ef\u80fd\u5728\u4e3b\u7ebf\u7a0b\u9000\u51fa\u4e4b\u524d\u5c31\u88ab\u5f3a\u5236\u7ed3\u675f\u3002\u5982\u679c\u9700\u8981\u5728\u4ece\u5c5e\u7ebf\u7a0b\u4e2d\u4f7f\u7528\u5171\u4eab\u8d44\u6e90\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u7ebf\u7a0b\u540c\u6b65\u673a\u5236\u6765\u4fdd\u8bc1\u6570\u636e\u7684\u6b63\u786e\u6027\u3002\n\n\n\u4e0a\u8ff0\u4ece\u5c5e\u7ebf\u7a0b\u7684\u6982\u5ff5\u4ecechatGpt\u4e2d\u67e5\u8be2\u5f97\u6765\n\n\n\nhttps://blog.csdn.net/weixin_47831992/article/details/127387175\n\n\u5728\u4e0d\u8bbe\u7f6e\u5b88\u62a4\u7ebf\u7a0b\u6216\u8005\u4ece\u5c5e\u7ebf\u7a0b\u7684\u60c5\u51b5\u4e0b\u53ef\u4ee5\u8bbe\u7f6e\u7ebf\u7a0b\u540c\u6b65\uff0c\u8ba9\u4e3b\u7ebf\u7a0b\u963b\u585e\u3002\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#182","title":"18.2\u3001\u7ebf\u7a0b\u548c\u534f\u7a0b\u7684\u5bf9\u6bd4","text":"<pre><code>\u901a\u8fc7threading\u5b9e\u73b0\u7ebf\u7a0b\u548c\u901a\u8fc7asyncio\u5b9e\u73b0\u534f\u7a0b\n\nasyncio.task\u5bf9\u8c61\u662f\u7528\u4e8e\u9a71\u52a8\u534f\u7a0b\uff0cthread\u5bf9\u8c61\u7528\u4e8e\u8c03\u7528\u53ef\u8c03\u7528\u7684\u5bf9\u8c61\n\n\n\u7ebf\u7a0b\uff1a\n    \u56e0\u4e3a\u8c03\u5ea6\u7a0b\u5e8f\u4efb\u4f55\u65f6\u5019\u90fd\u80fd\u4e2d\u65ad\u7ebf\u7a0b\u3002\u5fc5\u987b\u8bb0\u4f4f\u4fdd\u7559\u9501\uff0c\u53bb\u4fdd\u62a4\u7a0b\u5e8f\u4e2d\u7684\u91cd\u8981\u90e8\u5206\uff0c\u9632\u6b62\u591a\u6b65\u64cd\u4f5c\u5728\u6267\u884c\u7684\u8fc7\u7a0b\u4e2d\u4e2d\u65ad\uff0c\u9632\u6b62\u6570\u636e\u5904\u4e8e\u65e0\u6548\u72b6\u6001\u3002\n\u534f\u7a0b:\n    \u800c\u534f\u7a0b\u9ed8\u8ba4\u4f1a\u505a\u597d\u5168\u65b9\u4f4d\u4fdd\u62a4\uff0c\u4ee5\u9632\u6b62\u4e2d\u65ad\u3002\n    \u5bf9\u4e8e\u534f\u7a0b\u6765\u8bf4\uff0c\u65e0\u9700\u4fdd\u7559\u9501\uff0c\u5728\u591a\u4e2a\u7ebf\u7a0b\u4e4b\u95f4\u540c\u6b65\u64cd\u4f5c\uff0c\u534f\u7a0b\u81ea\u8eab\u5c31\u4f1a\u540c\u6b65\uff0c\u56e0\u4e3a\u5728\u4efb\u610f\u65f6\u523b\u53ea\u6709\u4e00\u4e2a\u534f\u7a0b\u8fd0\u884c\u3002\n    \u60f3\u8981\u4ea4\u51fa\u63a7\u5236\u6743\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528yield\u6216\u8005yield from\u628a\u63a7\u5236\u6743\u4ea4\u7ed9\u8c03\u5ea6\u7a0b\u5e8f\u3002\uff08\u65b0\u7248\u672c\u7684\u5e94\u8be5\u4e0d\u662f\u901a\u8fc7\u8fd9\u4e24\u4e2a\u65b9\u5f0f\u6765\u4ea4\u51fa\u63a7\u5236\u6743\uff09\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#183","title":"18.3\u3001\u534f\u7a0b\u5e38\u7528\u7684\u4e00\u4e9b\u65b9\u6cd5","text":"<pre><code>asyncio.Future \n\u5728 Python 3.7 \u4e2d\uff0casyncio.Future \u662f\u534f\u7a0b\u4e2d\u5f02\u6b65\u64cd\u4f5c\u7684\u7ed3\u679c\u5bb9\u5668\u3002\u5b83\u5141\u8bb8\u60a8\u4ee5\u975e\u963b\u585e\u65b9\u5f0f\u7b49\u5f85\u5f02\u6b65\u64cd\u4f5c\u7684\u5b8c\u6210\uff0c\u5e76\u4f7f\u7528\u5b83\u4eec\u7684\u7ed3\u679c\u3002\n\nimport asyncio\n\nasync def my_coroutine():\n    # \u521b\u5efa\u4e00\u4e2a future \u5bf9\u8c61\n    future = asyncio.Future()\n\n    # \u8ba9\u53e6\u5916\u4e00\u4e2a\u4efb\u52a1\u57285\u79d2\u540e\u8bbe\u7f6efuture\u7684\u7ed3\u679c\n    async def set_result():\n        await asyncio.sleep(5)\n        future.set_result('Future is done!')\n\n    asyncio.create_task(set_result())\n\n    # \u4f7f\u7528await\u7b49\u5f85 future \u5b8c\u6210\n    result = await future\n    print(result)\n\n# \u8fd0\u884c\u534f\u7a0b\nasyncio.run(my_coroutine())\n\n\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\uff0c\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a asyncio.Future \u5bf9\u8c61 future\uff0c\u5e76\u4f7f\u7528\u53e6\u4e00\u4e2a\u534f\u7a0b set_result() \u6765\u8bbe\u7f6e\u5176\u7ed3\u679c\u3002\u7136\u540e\uff0c\u6211\u4eec\u4f7f\u7528 await \u7b49\u5f85 future \u5bf9\u8c61\u7684\u5b8c\u6210\uff0c\u5e76\u6253\u5370\u51fa\u7ed3\u679c\u3002\u6ce8\u610f\uff0cset_result() \u534f\u7a0b\u5728\u540e\u53f0\u8fdb\u884c\uff0c\u4e0d\u4f1a\u963b\u585e\u5f53\u524d\u7684\u534f\u7a0b\u3002\n\n\u5f53\u60a8\u9700\u8981\u5728\u534f\u7a0b\u4e2d\u6267\u884c I/O \u64cd\u4f5c\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528 asyncio.Future \u5bf9\u8c61\u6765\u4ee3\u66ff\u56de\u8c03\u51fd\u6570\u6216\u7ebf\u7a0b\u3002\u6b64\u5916\uff0casyncio.Future \u4e5f\u53ef\u7528\u4e8e\u5b9e\u73b0\u534f\u7a0b\u4e4b\u95f4\u7684\u901a\u4fe1\u3002\n\n\nasyncio.as_completed==================================================================\n\nasyncio.as_completed \u662f\u4e00\u4e2a\u5f02\u6b65\u534f\u7a0b\u51fd\u6570\uff0c\u7528\u4e8e\u8fed\u4ee3\u4e00\u7ec4\u534f\u7a0b\u5bf9\u8c61\uff0c\u5e76\u5728\u5b83\u4eec\u5b8c\u6210\u540e\u8fd4\u56de\u4e00\u4e2a\u8fed\u4ee3\u5668\u3002\u5b83\u4f1a\u6309\u7167\u4efb\u52a1\u5b8c\u6210\u7684\u987a\u5e8f\u751f\u6210 Future \u5bf9\u8c61\u3002\n\nimport asyncio\n\nasync def coro1():\n    await asyncio.sleep(1)\n    return \"coro1\"\n\nasync def coro2():\n    await asyncio.sleep(2)\n    return \"coro2\"\n\nasync def main():\n    tasks = [coro1(), coro2()]\n    for task in asyncio.as_completed(tasks):\n        result = await task\n        print(result)\n\nasyncio.run(main())\n\n\n\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e24\u4e2a\u534f\u7a0b\u51fd\u6570 coro1 \u548c coro2\uff0c\u5b83\u4eec\u5206\u522b\u4f11\u7720 1 \u79d2\u548c 2 \u79d2\uff0c\u5e76\u8fd4\u56de\u5b57\u7b26\u4e32 \"coro1\" \u548c \"coro2\"\u3002\n\n\u5728 main() \u51fd\u6570\u4e2d\uff0c\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u4efb\u52a1\u5217\u8868 tasks\uff0c\u5176\u4e2d\u5305\u542b\u8fd9\u4e24\u4e2a\u534f\u7a0b\u51fd\u6570\u3002\u7136\u540e\uff0c\u6211\u4eec\u4f7f\u7528 asyncio.as_completed \u8fed\u4ee3\u8fd9\u4e9b\u4efb\u52a1\uff0c\u5e76\u7b49\u5f85\u6bcf\u4e2a\u4efb\u52a1\u5b8c\u6210\u540e\u6253\u5370\u7ed3\u679c\u3002\n\n\u7531\u4e8e coro1 \u5b8c\u6210\u65f6\u95f4\u8f83\u77ed\uff0c\u6240\u4ee5\u5b83\u7684\u7ed3\u679c\u5148\u88ab\u6253\u5370\uff0c\u7136\u540e\u662f coro2 \u7684\u7ed3\u679c\u3002\n\n\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0casyncio.as_completed \u8fd4\u56de\u7684\u662f\u4e00\u4e2a\u8fed\u4ee3\u5668\uff0c\u5b83\u4f1a\u5728\u6240\u6709\u534f\u7a0b\u5b8c\u6210\u4e4b\u524d\u4e00\u76f4\u963b\u585e\u3002\u5982\u679c\u60a8\u60f3\u540c\u65f6\u8fd0\u884c\u591a\u4e2a\u534f\u7a0b\uff0c\u53ef\u4ee5\u4f7f\u7528 asyncio.gather \u51fd\u6570\u3002\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#19","title":"19\u3001\u52a8\u6001\u5c5e\u6027\u548c\u7279\u6027","text":""},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#191","title":"19.1\u3001\u52a8\u6001\u5c5e\u6027\u7684\u4e00\u4e9b\u6982\u5ff5","text":"<pre><code>\u5728python\u4e2d\uff0c\u6570\u636e\u7684\u5c5e\u6027\u548c\u5904\u7406\u6570\u636e\u7684\u65b9\u6cd5\u7edf\u79f0\u5c5e\u6027\uff08attribute\uff09\uff0c\u9664\u4e86\u8fd9\u4e8c\u8005\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u521b\u5efa\u7279\u6027\uff08property\uff09\uff0c\u5728\u4e0d\u6539\u53d8\u7c7b\u63a5\u53e3\u7684\u524d\u63d0\u4e0b\uff0c\u4f7f\u7528\u5b58\u53d6\u65b9\u6cd5\uff08\u5373\u8bfb\u503c\u65b9\u6cd5\u548c\u8bbe\u503c\u65b9\u6cd5\uff09\n\n\n__getattr__\u65b9\u6cd5\uff0c\u4ec5\u5f53\u65e0\u6cd5\u4f7f\u7528\u5e38\u89c4\u65b9\u5f0f\u83b7\u53d6\u5c5e\u6027\uff08\u5373\u5728\u5b9e\u4f8b\u3001\u7c7b\u6216\u8d85\u7c7b\u4e2d\u627e\u4e0d\u5230\u6307\u5b9a\u7684\u5c5e\u6027\uff09\uff0c\u89e3\u91ca\u5668\u624d\u4f1a\u8c03\u7528\u7279\u6b8a\u7684__getattr__\u65b9\u6cd5\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#192","title":"19.2\u3001\u52a8\u6001\u5c5e\u6027\u7684\u5b9e\u73b0","text":"<pre><code>from collections import abc\nfrom urllib.request import urlopen\nimport warnings\nimport os\nimport json\n\n\nURL = 'http://www.oreilly.com/pub/sc/osconfeed'\nJSON = 'osconfeed.json'\n\n\ndef load():\n    if not os.path.exists(JSON):\n        msg = 'downloading {} to {}'.format(URL, JSON)\n        warnings.warn(msg)  # &lt;1&gt;\n        with urlopen(URL) as remote, open(JSON, 'wb') as local:  # &lt;2&gt;\n            local.write(remote.read())\n\n    with open(JSON) as fp:\n        return json.load(fp)  # &lt;3&gt;\n\n\nclass FrozenJSON:\n    \"\"\"A read-only fa\u00e7ade for navigating a JSON-like object\n       using attribute notation\n    \"\"\"\n\n    def __init__(self, mapping):\n        self.__data = dict(mapping)  # &lt;1&gt;\n        print(\"\\n\")\n\n        # print(self.__data)\n\n    def __getattr__(self, name):  # &lt;2&gt;\n        print(f'\\n{name}\\n')\n        # if name == 'Schedule':\n        #     return 'you Schedule'\n        if hasattr(self.__data, name):\n            return getattr(self.__data, name)  # &lt;3&gt;\n        else:\n            return FrozenJSON.build(self.__data[name])  # &lt;4&gt;\n\n    @classmethod\n    def build(cls, obj):  # &lt;5&gt;\n        if isinstance(obj, abc.Mapping):  # &lt;6&gt;\n            print(\"\u6211\u73b0\u5728\u662f\u4e2a\u5b57\u5178\")\n            print(obj)\n            return cls(obj)\n        elif isinstance(obj, abc.MutableSequence):  # &lt;7&gt;\n            print(\"\u6211\u73b0\u5728\u53ea\u662f\u4e2a\u5e8f\u5217\")\n            print(obj)\n            return [cls.build(item) for item in obj]\n        else:  # &lt;8&gt;\n            return obj\n\nraw_feed = load()\nfeed = FrozenJSON(raw_feed)\nprint(\"\u521d\u59cb\u5316\u5462\")\n\nprint(feed.Schedule.speakers[0].keys())\n# print(feed.Schedule.__dict__)\n# print(feed.Schedule)\n\n\n\u5b57\u5178\u6837\u4f8b\uff1a\n{ \"Schedule\":\n  { \"conferences\": [{\"serial\": 115 }],\n    \"events\": [\n      { \"serial\": 34505,\n        \"name\": \"Why Schools Don\u00b4t Use Open Source to Teach Programming\",\n        \"event_type\": \"40-minute conference session\",\n        \"time_start\": \"2014-07-23 11:30:00\",\n        \"time_stop\": \"2014-07-23 12:10:00\",\n        \"venue_serial\": 1462,\n        \"description\": \"Aside from the fact that high school programming...\",\n        \"website_url\": \"http://oscon.com/oscon2014/public/schedule/detail/34505\",\n        \"speakers\": [157509],\n        \"categories\": [\"Education\"] }\n    ],\n    \"speakers\": [\n      { \"serial\": 157509,\n        \"name\": \"Robert Lefkowitz\",\n        \"photo\": null,\n        \"url\": \"http://sharewave.com/\",\n        \"position\": \"CTO\",\n        \"affiliation\": \"Sharewave\",\n        \"twitter\": \"sharewaveteam\",\n        \"bio\": \"Robert \u00b4r0ml\u00b4 Lefkowitz is the CTO at Sharewave, a startup...\" }\n    ],\n    \"venues\": [\n      { \"serial\": 1462,\n        \"name\": \"F151\",\n        \"category\": \"Conference Venues\" }\n    ]\n  }\n}\n\n\n\u8f93\u51fa\uff1a\n\u521d\u59cb\u5316\u5462\n\nSchedule\n\n\u6211\u73b0\u5728\u662f\u4e2a\u5b57\u5178\n{'conferences': [{'serial': 115}], 'events': [{'serial': 34505, 'name': 'Why Schools Don\u00b4t Use Open Source to Teach Programming', 'event_type': '40-minute conference session', 'time_start': '2014-07-23 11:30:00', 'time_stop': '2014-07-23 12:10:00', 'venue_serial': 1462, 'description': 'Aside from the fact that high school programming...', 'website_url': 'http://oscon.com/oscon2014/public/schedule/detail/34505', 'speakers': [157509], 'categories': ['Education']}], 'speakers': [{'serial': 157509, 'name': 'Robert Lefkowitz', 'photo': None, 'url': 'http://sharewave.com/', 'position': 'CTO', 'affiliation': 'Sharewave', 'twitter': 'sharewaveteam', 'bio': 'Robert \u00b4r0ml\u00b4 Lefkowitz is the CTO at Sharewave, a startup...'}], 'venues': [{'serial': 1462, 'name': 'F151', 'category': 'Conference Venues'}]}\n\n\n\nspeakers\n\n\u6211\u73b0\u5728\u53ea\u662f\u4e2a\u5e8f\u5217\n[{'serial': 157509, 'name': 'Robert Lefkowitz', 'photo': None, 'url': 'http://sharewave.com/', 'position': 'CTO', 'affiliation': 'Sharewave', 'twitter': 'sharewaveteam', 'bio': 'Robert \u00b4r0ml\u00b4 Lefkowitz is the CTO at Sharewave, a startup...'}]\n\u6211\u73b0\u5728\u662f\u4e2a\u5b57\u5178\n{'serial': 157509, 'name': 'Robert Lefkowitz', 'photo': None, 'url': 'http://sharewave.com/', 'position': 'CTO', 'affiliation': 'Sharewave', 'twitter': 'sharewaveteam', 'bio': 'Robert \u00b4r0ml\u00b4 Lefkowitz is the CTO at Sharewave, a startup...'}\n\n\n\nkeys\n\ndict_keys(['serial', 'name', 'photo', 'url', 'position', 'affiliation', 'twitter', 'bio'])\n\n\n\n\n\n1\u3001\u4e00\u4e9b\u6280\u672f\u70b9\u5206\u6790\n1\uff09isinstance(obj, abc.Mapping) \u5224\u65ad\u662f\u5426\u662f\u5b57\u5178\n    isinstance(obj, abc.MutableSequence) \u5224\u65ad\u662f\u5426\u662f\u5217\u8868\n2\uff09return cls(obj)\n    \u6b64\u5904\u54a8\u8be2\u4e86\u4e00\u4e0bgpt\uff1a\n    \u8bf7\u95ee\u60a8\u6240\u8bf4\u7684\u201c\u7c7b\u52a0\u53c2\u6570\u201d\u662f\u6307\u7c7b\u7684\u5b9e\u4f8b\u5316\u65f6\u9700\u8981\u4f20\u5165\u4e00\u4e9b\u53c2\u6570\u5417\uff1f\u5982\u679c\u662f\u8fd9\u6837\u7684\u8bdd\uff0c\u53ef\u4ee5\u5728\u7c7b\u7684\u5b9a\u4e49\u4e2d\u4f7f\u7528\u6784\u9020\u51fd\u6570\uff08\u4e5f\u79f0\u4e3a\u521d\u59cb\u5316\u65b9\u6cd5\uff09\u6765\u63a5\u6536\u8fd9\u4e9b\u53c2\u6570\u3002Python\u4e2d\u7684\u6784\u9020\u51fd\u6570\u662f__init__\uff0c\u5b83\u4f1a\u5728\u521b\u5efa\u5bf9\u8c61\u65f6\u81ea\u52a8\u8c03\u7528\u3002\u4ee5\u4e0b\u662f\u4e00\u4e2a\u793a\u4f8b\u4ee3\u7801\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u7c7b\u548c\u6784\u9020\u51fd\u6570\uff1a\n\n    class Person:\n    def __init__(self, name, age):\n        self.name = name\n        self.age = age\n\n    person1 = Person(\"Alice\", 25)\n    print(person1.name) # \u8f93\u51fa \"Alice\"\n    print(person1.age) # \u8f93\u51fa 25\n\n3\uff09return [cls.build(item) for item in obj]\n    \u5bf9\u5217\u8868\u91cc\u9762\u7684\u5b57\u5178\u8fdb\u884c\n4)\u7c7b\u65b9\u6cd5build\u628a\u5d4c\u5957\u7ed3\u6784\u8f6c\u6362\u6210\u5b9e\u4f8b\u6216\u8005\u5b9e\u4f8b\u5217\u8868\n5\uff09\u53ef\u80fd\u4f1a\u51fa\u73b0\u5173\u952e\u5b57\u5f53\u505akey\u7684\u60c5\u51b5\uff0c\u4ee5\u9632\u4e07\u4e00\u62a5\u9519\u53ef\u4ee5\u6293\u4f4f\u5f02\u5e38\u6216\u8005\u5bf9\u5f02\u5e38\u7684\u53ef\u4ee5\u505a\u4e00\u4e9b\u8bc6\u522b\u7684\u4e8b\u60c5\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#193__new__","title":"19.3\u3001\u4f7f\u7528__new__\u65b9\u6cd5\u4ee5\u7075\u6d3b\u7684\u65b9\u5f0f\u521b\u5efa\u5bf9\u8c61","text":"<pre><code>__new__\u662f\u6784\u5efa\u5b9e\u4f8b\u7684\u7279\u6b8a\u65b9\u6cd5\uff0c\u8fd9\u662f\u4e2a\u7c7b\u65b9\u6cd5\uff08\u4f7f\u7528\u7279\u6b8a\u65b9\u5f0f\u5904\u7406\uff0c\u4e0d\u9700\u8981@classmethod\uff09\uff0c\u5fc5\u987b\u8fd4\u56de\u4e00\u4e2a\u5b9e\u4f8b\u3002\n\u8fd4\u56de\u7684\u5b9e\u4f8b\u4f1a\u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u53c2\u6570\uff08\u5373self\uff09\u4f20\u7ed9__init__\u65b9\u6cd5\u3002\n\u56e0\u4e3a\u8c03\u7528__init__\u65b9\u6cd5\u65f6\u8981\u4f20\u5165\u5b9e\u4f8b\uff0c\u800c\u4e14\u7981\u6b62\u8fd4\u56de\u4efb\u4f55\u503c\uff0c\u6240\u4ee5__init__\u65b9\u6cd5\u5176\u5b9e\u662f\u201c\u521d\u59cb\u5316\u65b9\u6cd5\u201d\u3002\u771f\u6b63\u7684\u6784\u9020\u65b9\u6cd5\u662f__new__\u3002\n\u6211\u4eec\u51e0\u4e4e\u4e0d\u9700\u8981\u81ea\u5df1\u7f16\u5199__new__\u65b9\u6cd5\uff0c\u56e0\u4e3a\u4eceobject\u7c7b\u7ee7\u627f\u7684\u5b9e\u73b0\u5df2\u7ecf\u8db3\u591f\u4e86\u3002\n\n\n\"\"\"\nexplore2.py: Script to explore the OSCON schedule feed\n\n    &gt;&gt;&gt; from osconfeed import load\n    &gt;&gt;&gt; raw_feed = load()\n    &gt;&gt;&gt; feed = FrozenJSON(raw_feed)\n    &gt;&gt;&gt; len(feed.Schedule.speakers)\n    357\n    &gt;&gt;&gt; sorted(feed.Schedule.keys())\n    ['conferences', 'events', 'speakers', 'venues']\n    &gt;&gt;&gt; feed.Schedule.speakers[-1].name\n    'Carina C. Zona'\n    &gt;&gt;&gt; talk = feed.Schedule.events[40]\n    &gt;&gt;&gt; talk.name\n    'There *Will* Be Bugs'\n    &gt;&gt;&gt; talk.speakers\n    [3471, 5199]\n    &gt;&gt;&gt; talk.flavor\n    Traceback (most recent call last):\n      ...\n    KeyError: 'flavor'\n\n\"\"\"\naaa={ \"Schedule\":\n  { \"conferences\": [{\"serial\": 115 }],\n    \"events\": [\n      { \"serial\": 34505,\n        \"name\": \"Why Schools Don\u00b4t Use Open Source to Teach Programming\",\n        \"event_type\": \"40-minute conference session\",\n        \"time_start\": \"2014-07-23 11:30:00\",\n        \"time_stop\": \"2014-07-23 12:10:00\",\n        \"venue_serial\": 1462,\n        \"description\": \"Aside from the fact that high school programming...\",\n        \"website_url\": \"http://oscon.com/oscon2014/public/schedule/detail/34505\",\n        \"speakers\": [157509],\n        \"categories\": [\"Education\"] }\n    ],\n    \"speakers\": [\n      { \"serial\": 157509,\n        \"name\": \"Robert Lefkowitz\",\n        \"photo\": '',\n        \"url\": \"http://sharewave.com/\",\n        \"position\": \"CTO\",\n        \"affiliation\": \"Sharewave\",\n        \"twitter\": \"sharewaveteam\",\n        \"bio\": \"Robert \u00b4r0ml\u00b4 Lefkowitz is the CTO at Sharewave, a startup...\" },\n    { \"serial\": 6666,\n            \"name\": \"dsfa\",\n            \"photo\": '',\n            \"url\": \"http://adfa.com/\",\n            \"position\": \"ff\",\n            \"affiliation\": \"ffff\",\n            \"twitter\": \"ffff\",\n            \"bio\": \"Robert \u00b4r0ml\u00b4 Lefkowitz is the CTO at Sharewave, a startup...\" }\n    ],\n    \"venues\": [\n      { \"serial\": 1462,\n        \"name\": \"F151\",\n        \"category\": \"Conference Venues\" }\n    ]\n  }\n}\n\n# BEGIN EXPLORE2\nfrom collections import abc\nfrom keyword import iskeyword\n\n\nclass FrozenJSON(object):\n    \"\"\"A read-only fa\u00e7ade for navigating a JSON-like object\n       using attribute notation\n    \"\"\"\n\n    def __new__(cls, arg):  # &lt;1&gt;\n        # print(f'\u521d\u59cb\u5316arg\\t{arg}')\n        if isinstance(arg, abc.Mapping):\n            return super().__new__(cls)  # &lt;2&gt;\n        elif isinstance(arg, abc.MutableSequence):  # &lt;3&gt;\n            # print(\"\u662f\u5e8f\u5217\\n\")\n            # print([cls(item) for item in arg])\n            # for item in arg:\n            #     print(item)\n                # print(cls(item))\n                # print(\"\\n\")\n            return [cls(item) for item in arg]\n        else:\n            return arg\n\n    def __init__(self, mapping):\n        print(f'\u6211\u662finit{mapping}')\n        # print(f'init\u7684\u64cd\u4f5c{mapping}')\n        self.__data = {}\n        for key, value in mapping.items():\n            if iskeyword(key):\n                key += '_'\n            self.__data[key] = value\n\n    def __getattr__(self, name):\n        if hasattr(self.__data, name):\n            # print(f'\\n{name}\\n')\n            # print(self.__data)\n            # print(self.__data[name])\n            # print(\"\\n\\n\")\n            return getattr(self.__data, name)\n        else:\n            # print(f'\\n{name}\\n')\n            # print(self.__data)\n            # print(self.__data[name])\n            # print(\"\\n\\n\")\n            return FrozenJSON(self.__data[name])  # &lt;4&gt;\n# END EXPLORE2\n\n\nfeed = FrozenJSON(aaa)\nprint(\"\u5df2\u7ecf\u521d\u59cb\u5316\u4e86\")\nprint(feed.Schedule.speakers[-1].name)\n\n\n\n\n\u9700\u8981\u601d\u8003\u7684\u95ee\u9898\uff1a\nsuper().__new__(cls) \u548c [cls(item) for item in arg] \u8fd9\u4e24\u5904\u7684\u533a\u522b\n\n\n\u6211\u81ea\u5df1\u6d4b\u8bd5\u4e86\u4e00\u4e0b\uff0ccls(arg1)\u4f1a\u9677\u5165__new__\u4e2d\u7684\u65e0\u9650\u5faa\u73af\uff0c\u7c7b\u4f3c\u4e8e\u8fed\u4ee3\u5668\uff0c\u4e0a\u6587\u4e2d\u5217\u8868\u91cc\u9762\u7684\u6570\u636e\u8fdb\u884c\u62c6\u5206\uff0c\u5c06\u5217\u8868\u4e2d\u7684\u5b57\u5178\u518d\u7ee7\u7eed\u5faa\u73af\uff0c\u5982\u679c\u662f\u5b57\u5178\u5c31\u8fd4\u56de\u5b9e\u4f8b\nclass MyClass:\n    def __new__(cls, arg1):\n        print(f'new\u4e2d{arg1}')\n        if arg1 == 'foo':\n            return arg1\n        else:\n            print(\"\u6211\u60f3\u51fa\u53bb\")\n            return cls(arg1)\n\n    def __init__(self, arg1):\n        self.arg1 = arg1\n\nmy_obj = MyClass(\"foo12\")\nprint(my_obj)  # \u8f93\u51fa: foo\n</code></pre>"},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#20","title":"20\u3001\u5c5e\u6027\u63cf\u8ff0\u7b26","text":""},{"location":"note/%E6%B5%81%E7%95%85%E7%9A%84python%E7%AC%94%E8%AE%B0/#201","title":"20.1\u3001\u6982\u5ff5","text":"<p>\u63cf\u8ff0\u7b26\u662f\u5bf9\u591a\u4e2a\u5c5e\u6027\u8fd0\u7528\u76f8\u540c\u7684\u5b58\u53d6\u903b\u8f91\u7684\u4e00\u79cd\u65b9\u5f0f\uff0c\u4f8b\u5982django\uff0corm\uff0csql alchemy\u7b49orm\u4e2d\u7684\u5b57\u6bb5\u7c7b\u578b\u90fd\u662f\u63cf\u8ff0\u7b26\uff0c\u628a\u6570\u636e\u5e93\u8bb0\u5f55\u4e2d\u5b57\u6bb5\u91cc\u7684\u6570\u636e\u4e0epython \u5bf9\u8c61\u7684\u5c5e\u6027\u5bf9\u5e94\u8d77\u6765\u3002</p> <p>\u63cf\u8ff0\u7b26\u662f\u5b9e\u73b0\u4e86\u7279\u5b9a\u534f\u8bae\u7c7b\u578b\u7684\u7c7b\uff0c\u8fd9\u4e2a\u534f\u8bae\u5305\u62ec\u4e86__get__, __set__\u548c__delete__\u65b9\u6cd5</p> <p>\u63cf\u8ff0\u7b26\u5b9e\u4f8b\uff1a\u9a8c\u8bc1\u5c5e\u6027 \u7279\u6027\u5de5\u5382\u51fd\u6570\u501f\u52a9\u51fd\u6570\u5f0f\u7f16\u7a0b\u6a21\u5f0f\uff0c\u907f\u514d\u91cd\u590d\u7f16\u5199\u8bfb\u503c\u65b9\u6cd5\u548c\u8bbe\u503c\u65b9\u6cd5\u3002</p> <p>\u63cf\u8ff0\u7b26\u7684\u7528\u6cd5\u662f\uff0c\u521b\u5efa\u4e00\u4e2a\u5b9e\u4f8b\u4f5c\u4e3a\u53e6\u4e00\u4e2a\u7c7b\u7684\u7c7b\u5c5e\u6027</p> <p> </p> \u89c9\u5f97\u6709\u7528\u7684\u8001\u94c1\u4eec\u53ef\u4ee5\"\u5fae\u4fe1\"\u8d5e\u52a9\u4e00\u676f82\u5e74\u7684\u96ea\u78a7\u5466\u3002"},{"location":"blog/archive/2024/","title":"2024","text":""},{"location":"blog/archive/2023/","title":"2023","text":""},{"location":"blog/category/istio/","title":"istio","text":""},{"location":"blog/category/life/","title":"life","text":""},{"location":"blog/category/devops/","title":"devops","text":""},{"location":"blog/category/k8s/","title":"k8s","text":""},{"location":"blog/category/database/","title":"database","text":""},{"location":"blog/category/docker/","title":"docker","text":""},{"location":"blog/category/sys/","title":"sys","text":""},{"location":"blog/category/monitor/","title":"monitor","text":""},{"location":"blog/page/2/","title":"Index","text":""},{"location":"blog/page/3/","title":"Index","text":""},{"location":"blog/archive/2023/page/2/","title":"2023","text":""},{"location":"blog/category/devops/page/2/","title":"devops","text":""}]}